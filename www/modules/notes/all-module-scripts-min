GO.notes.CategoryDialog=function(b){if(!b){b={}}this.buildForm();var a=function(){this.propertiesPanel.items.items[0].focus()};b.maximizable=true;b.layout="fit";b.modal=false;b.resizable=false;b.width=700;b.height=500;b.closeAction="hide";b.title=GO.notes.lang.category;b.items=this.formPanel;b.focus=a.createDelegate(this);b.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.notes.CategoryDialog.superclass.constructor.call(this,b);this.addEvents({save:true})};Ext.extend(GO.notes.CategoryDialog,Ext.Window,{show:function(a){if(!this.rendered){this.render(Ext.getBody())}this.tabPanel.setActiveTab(0);if(!a){a=0}this.setCategoryId(a);if(this.category_id>0){this.formPanel.load({url:GO.settings.modules.notes.url+"json.php",success:function(b,c){this.setWritePermission(c.result.data.write_permission);this.readPermissionsTab.setAcl(c.result.data.acl_id);this.selectUser.setRemoteText(c.result.data.user_name);GO.notes.CategoryDialog.superclass.show.call(this)},failure:function(b,c){Ext.Msg.alert(GO.lang.strError,c.result.feedback)},scope:this})}else{this.formPanel.form.reset();this.setWritePermission(true);GO.notes.CategoryDialog.superclass.show.call(this)}},setWritePermission:function(a){this.buttons[0].setDisabled(!a);this.buttons[1].setDisabled(!a)},setCategoryId:function(a){this.formPanel.form.baseParams.category_id=a;this.category_id=a},submitForm:function(a){this.formPanel.form.submit({url:GO.settings.modules.notes.url+"action.php",params:{task:"save_category"},waitMsg:GO.lang.waitMsgSave,success:function(b,c){this.fireEvent("save",this);if(a){this.hide()}else{if(c.result.category_id){this.setCategoryId(c.result.category_id);this.readPermissionsTab.setAcl(c.result.acl_id)}}},failure:function(b,c){if(c.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,c.result.feedback)}},scope:this})},buildForm:function(){this.propertiesPanel=new Ext.Panel({url:GO.settings.modules.notes.url+"action.php",border:false,baseParams:{task:"category"},title:GO.lang.strProperties,cls:"go-form-panel",waitMsgTarget:true,layout:"form",autoScroll:true,items:[this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.has_admin_permission,value:GO.settings.user_id,anchor:"100%"}),{xtype:"textfield",name:"name",anchor:"100%",allowBlank:false,fieldLabel:GO.lang.strName}]});var a=[this.propertiesPanel];this.readPermissionsTab=new GO.grid.PermissionsPanel({});a.push(this.readPermissionsTab);this.tabPanel=new Ext.TabPanel({activeTab:0,deferredRender:false,border:false,items:a,anchor:"100% 100%"});this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,url:GO.settings.modules.notes.url+"action.php",border:false,baseParams:{task:"category"},items:this.tabPanel})}});GO.notes.NotesGrid=function(b){if(!b){b={}}var a={fields:["id","category_id","user_name","ctime","mtime","name","content"],columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name",sortable:false,hidden:true},{header:GO.lang.strCtime,dataIndex:"ctime",hidden:true},{header:GO.lang.strMtime,dataIndex:"mtime"}]};if(GO.customfields){GO.customfields.addColumns(4,a)}b.title=GO.notes.lang.notes;b.layout="fit";b.autoScroll=true;b.split=true;b.store=new GO.data.JsonStore({url:GO.settings.modules.notes.url+"json.php",baseParams:{task:"notes"},root:"results",id:"id",totalProperty:"total",fields:a.fields,remoteSort:true});b.store.on("load",function(){if(b.store.reader.jsonData.feedback){alert(b.store.reader.jsonData.feedback)}},this);b.paging=true;var c=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:a.columns});b.cm=c;b.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});b.sm=new Ext.grid.RowSelectionModel();b.loadMask=true;this.searchField=new GO.form.SearchField({store:b.store,width:320});b.tbar=[GO.lang.strSearch+":",this.searchField];GO.notes.NotesGrid.superclass.constructor.call(this,b)};Ext.extend(GO.notes.NotesGrid,GO.grid.GridPanel,{});GO.notes.NoteDialog=Ext.extend(GO.dialog.TabbedFormDialog,{customFieldType:4,initComponent:function(){Ext.apply(this,{goDialogId:"note",title:GO.notes.lang.note,formControllerUrl:GO.url("notes/note")});GO.notes.NoteDialog.superclass.initComponent.call(this)},afterLoad:function(a){this.selectCategory.setRemoteText(a.result.data.category_name)},afterLoadNew:function(a){if(!a.category_id){a.category_id=GO.notes.defaultCategory.id;a.category_name=GO.notes.defaultCategory.name}this.selectCategory.setValue(a.category_id);if(a.category_name){this.selectCategory.setRemoteText(a.category_name)}},buildForm:function(){this.selectLinkField=new GO.form.SelectLink({anchor:"100%"});this.propertiesPanel=new Ext.Panel({title:GO.lang.strProperties,cls:"go-form-panel",layout:"form",items:[{xtype:"textfield",name:"name",width:300,anchor:"100%",maxLength:100,allowBlank:false,fieldLabel:GO.lang.strName},this.selectCategory=new GO.form.ComboBox({fieldLabel:GO.notes.lang.category_id,hiddenName:"category_id",anchor:"100%",emptyText:GO.lang.strPleaseSelect,store:GO.notes.writableCategoriesStore,pageSize:parseInt(GO.settings.max_rows_list),valueField:"id",displayField:"name",mode:"remote",triggerAction:"all",editable:true,selectOnFocus:true,forceSelection:true,allowBlank:false}),this.selectLinkField,{xtype:"textarea",name:"content",anchor:"100% -80",hideLabel:true}]});this.addPanel(this.propertiesPanel)}});GO.notes.NotePanel=Ext.extend(GO.DisplayPanel,{link_type:4,loadParams:{task:"note_with_items"},idParam:"note_id",loadUrl:GO.settings.modules.notes.url+"json.php",stateId:"no-note-panel",editGoDialogId:"note",editHandler:function(){GO.notes.showNoteDialog(this.link_id)},initComponent:function(){this.template='<table class="display-panel" cellpadding="0" cellspacing="0" border="0"><tr><td colspan="2" class="display-panel-heading">{name}</td></tr><tr><td>ID:</td><td>{id}</td></tr><tr><td colspan="2">{content}</td></tr></table>';if(GO.customfields){this.template+=GO.customfields.displayPanelTemplate}if(GO.tasks){this.template+=GO.tasks.TaskTemplate}if(GO.calendar){this.template+=GO.calendar.EventTemplate}this.template+=GO.linksTemplate;if(GO.files){Ext.apply(this.templateConfig,GO.files.filesTemplateConfig);this.template+=GO.files.filesTemplate}Ext.apply(this.templateConfig,GO.linksTemplateConfig);if(GO.comments){this.template+=GO.comments.displayPanelTemplate}GO.notes.NotePanel.superclass.initComponent.call(this)}});GO.notes.ManageCategoriesGrid=function(a){if(!a){a={}}a.layout="fit";a.autoScroll=true;a.split=true;a.store=GO.notes.writableAdminCategoriesStore;a.border=false;a.paging=true;var b=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name",sortable:false}]});a.cm=b;a.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;this.categoryDialog=new GO.notes.CategoryDialog();this.categoryDialog.on("save",function(){this.store.reload();this.changed=true},this);a.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",disabled:!GO.settings.modules.notes.write_permission,handler:function(){this.categoryDialog.show()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",disabled:!GO.settings.modules.notes.write_permission,handler:function(){this.deleteSelected();this.changed=true},scope:this},"-",new GO.form.SearchField({store:a.store,width:150})];GO.notes.ManageCategoriesGrid.superclass.constructor.call(this,a);this.on("rowdblclick",function(d,e){var c=d.getStore().getAt(e);this.categoryDialog.show(c.data.id)},this);GO.notes.writableAdminCategoriesStore.load()};Ext.extend(GO.notes.ManageCategoriesGrid,GO.grid.GridPanel,{changed:false});GO.notes.ManageCategoriesDialog=function(a){if(!a){a={}}this.categoriesGrid=new GO.notes.ManageCategoriesGrid();a.maximizable=true;a.layout="fit";a.modal=false;a.resizable=true;a.width=600;a.height=400;a.closeAction="hide";a.title=GO.notes.lang.manageCategories;a.items=this.categoriesGrid;a.buttons=[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.notes.ManageCategoriesDialog.superclass.constructor.call(this,a);this.on("hide",function(){if(this.categoriesGrid.changed){this.fireEvent("change");this.categoriesGrid.changed=false}},this);this.addEvents({change:true})};Ext.extend(GO.notes.ManageCategoriesDialog,Ext.Window,{});GO.notes.writableCategoriesStore=new GO.data.JsonStore({url:GO.settings.modules.notes.url+"json.php",baseParams:{auth_type:"write",task:"categories"},root:"results",id:"id",totalProperty:"total",fields:["id","name","user_name"],remoteSort:true});GO.notes.writableAdminCategoriesStore=new GO.data.JsonStore({url:GO.settings.modules.notes.url+"json.php",baseParams:{auth_type:"write",task:"categories"},root:"results",id:"id",totalProperty:"total",fields:["id","name","user_name"],remoteSort:true});GO.notes.readableCategoriesStore=new GO.data.JsonStore({url:GO.settings.modules.notes.url+"json.php",baseParams:{task:"categories",auth_type:"read",limit:GO.settings.config.nav_page_size},root:"results",id:"id",totalProperty:"total",fields:["id","user_name","acl_id","name","checked"],remoteSort:true});GO.notes.MainPanel=function(a){if(!a){a={}}this.westPanel=new GO.grid.MultiSelectGrid({region:"west",id:"no-west-panel",title:GO.notes.lang.categories,loadMask:true,store:GO.notes.readableCategoriesStore,width:210,split:true,allowNoSelection:true,bbar:new GO.SmallPagingToolbar({items:[this.searchField=new GO.form.SearchField({store:GO.notes.readableCategoriesStore,width:120,emptyText:GO.lang.strSearch})],store:GO.notes.readableCategoriesStore,pageSize:GO.settings.config.nav_page_size})});this.westPanel.on("change",function(d,c,b){if(b.length){this.centerPanel.store.baseParams.categories=Ext.encode(c);this.centerPanel.store.reload();this.category_ids=c;if(b.length){this.category_id=b[0].data.id;this.category_name=b[0].data.name}delete this.centerPanel.store.baseParams.categories}},this);this.westPanel.store.on("load",function(){for(var b=0,d=false;b<this.westPanel.store.data.length&&!d;b++){var c=this.westPanel.store.data.items[b];if(c.data.checked){this.category_id=c.data.id;this.category_name=c.data.name;d=true}}this.centerPanel.store.load()},this);this.centerPanel=new GO.notes.NotesGrid({region:"center",id:"no-center-panel",border:true});this.centerPanel.on("delayedrowselect",function(b,d,c){this.eastPanel.load(c.data.id)},this);this.centerPanel.on("rowdblclick",function(b,c){this.eastPanel.editHandler()},this);this.centerPanel.store.on("load",function(){this.centerPanel.setTitle(this.centerPanel.store.reader.jsonData.grid_title);this.getTopToolbar().items.get("add").setDisabled(!this.centerPanel.store.reader.jsonData.data.write_permission);this.getTopToolbar().items.get("delete").setDisabled(!this.centerPanel.store.reader.jsonData.data.write_permission);if(this.eastPanel.data.category_id!=this.category_id){this.eastPanel.reset()}},this);this.eastPanel=new GO.notes.NotePanel({region:"east",id:"no-east-panel",width:440,border:true});a.tbar=new Ext.Toolbar({cls:"go-head-tb",items:[{iconCls:"btn-add",itemId:"add",disabled:true,text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.eastPanel.reset();GO.notes.showNoteDialog(0,{category_id:this.category_id,category_name:this.category_name})},scope:this},{disabled:true,itemId:"delete",iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.centerPanel.deleteSelected({callback:this.eastPanel.gridDeleteCallback,scope:this.eastPanel})},scope:this},{iconCls:"no-btn-categories",text:GO.notes.lang.manageCategories,cls:"x-btn-text-icon",handler:function(){if(!this.categoriesDialog){this.categoriesDialog=new GO.notes.ManageCategoriesDialog();this.categoriesDialog.on("change",function(){this.westPanel.store.reload();GO.notes.writableCategoriesStore.reload()},this)}this.categoriesDialog.show()},scope:this}]});a.items=[this.westPanel,this.centerPanel,this.eastPanel];a.layout="border";GO.notes.MainPanel.superclass.constructor.call(this,a)};Ext.extend(GO.notes.MainPanel,Ext.Panel,{afterRender:function(){GO.dialogListeners.add("note",{scope:this,save:function(){this.centerPanel.store.reload()}});GO.notes.readableCategoriesStore.load();GO.notes.MainPanel.superclass.afterRender.call(this)}});GO.notes.showNoteDialog=function(b,a){if(!GO.notes.noteDialog){GO.notes.noteDialog=new GO.notes.NoteDialog()}GO.notes.noteDialog.show(b,a)};GO.moduleManager.addModule("notes",GO.notes.MainPanel,{title:GO.notes.lang.notes,iconCls:"go-tab-icon-notes"});GO.linkHandlers[4]=function(b){if(!GO.notes.linkWindow){var a=new GO.notes.NotePanel();GO.notes.linkWindow=new GO.LinkViewWindow({title:GO.notes.lang.note,items:a,notePanel:a,closeAction:"hide"})}GO.notes.linkWindow.notePanel.load(b);GO.notes.linkWindow.show()};GO.linkPreviewPanels[4]=function(a){a=a||{};return new GO.notes.NotePanel(a)};GO.newMenuItems.push({text:GO.notes.lang.note,iconCls:"go-link-icon-4",handler:function(a,b){GO.notes.showNoteDialog(0,{link_config:a.parentMenu.link_config})}});