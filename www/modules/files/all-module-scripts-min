GO.files.FilePropertiesDialog=function(b){if(!b){b={}}this.goDialogId="file";this.propertiesPanel=new Ext.Panel({layout:"form",title:GO.lang.strProperties,cls:"go-form-panel",waitMsgTarget:true,labelWidth:100,defaultType:"textfield",items:[{fieldLabel:GO.lang.strName,name:"name",anchor:"100%",validator:function(e){return !e.match(/[&\/:\*\?"<>|\\]/)}},{xtype:"plainfield",fieldLabel:GO.lang.strLocation,name:"path"},new GO.form.HtmlComponent({html:"<hr />"}),{xtype:"plainfield",fieldLabel:GO.lang.strCtime,name:"ctime"},{xtype:"plainfield",fieldLabel:GO.lang.strMtime,name:"mtime"},{xtype:"plainfield",fieldLabel:GO.lang.Atime,name:"atime"},new GO.form.HtmlComponent({html:"<hr />"}),{xtype:"plainfield",fieldLabel:GO.lang.strType,name:"type"},{xtype:"plainfield",fieldLabel:GO.lang.strSize,name:"size"}]});this.commentsPanel=new Ext.Panel({layout:"form",labelWidth:70,title:GO.files.lang.comments,border:false,items:new Ext.form.TextArea({name:"comments",fieldLabel:"",hideLabel:true,anchor:"100% 100%"})});this.versionsGrid=new GO.files.VersionsGrid();var a=[this.propertiesPanel,this.commentsPanel,this.versionsGrid];if(GO.workflow){this.workflowPanel=new GO.workflow.FilePropertiesPanel();a.push(this.workflowPanel)}if(GO.customfields&&GO.customfields.types["6"]){for(var c=0;c<GO.customfields.types["6"].panels.length;c++){a.push(GO.customfields.types["6"].panels[c])}}this.tabPanel=new Ext.TabPanel({activeTab:0,deferredRender:false,doLayoutOnTabChange:true,enableTabScroll:true,border:false,anchor:"100% 100%",hideLabel:true,items:a});this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,border:false,defaultType:"textfield",items:this.tabPanel});var d=[this.linkBrowseButton=new Ext.Button({iconCls:"btn-link",cls:"x-btn-text-icon",text:GO.lang.cmdBrowseLinks,disabled:true,handler:function(){if(!GO.linkBrowser){GO.linkBrowser=new GO.LinkBrowser()}GO.linkBrowser.show({link_id:this.file_id,link_type:"6",folder_id:"0"})},scope:this}),{iconCls:"btn-save",text:GO.lang.download,cls:"x-btn-text-icon",handler:function(){window.location.href=GO.settings.modules.files.url+"download.php?mode=download&id="+this.file_id},scope:this}];if(GO.settings.modules.gota&&GO.settings.modules.gota.read_permission){d.push({iconCls:"btn-edit",text:GO.files.lang.downloadGOTA,cls:"x-btn-text-icon",handler:function(){if(!deployJava.isWebStartInstalled("1.6.0")){Ext.MessageBox.alert(GO.lang.strError,GO.lang.noJava)}else{window.location.href=GO.settings.modules.gota.url+"jnlp.php?id="+this.file_id}},scope:this})}GO.files.FilePropertiesDialog.superclass.constructor.call(this,{title:GO.lang.strProperties,layout:"fit",width:650,height:550,closeAction:"hide",items:this.formPanel,maximizable:true,collapsible:true,tbar:d,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});this.formPanel.form.on("actioncomplete",function(e,f){if(f.type=="load"){this.updateCfTabs(f.result.data.folder_id,f.result.data.cf_permissions)}},this);this.addEvents({rename:true,save:true})};Ext.extend(GO.files.FilePropertiesDialog,GO.Window,{folder_id:0,show:function(b,a){a=a||{};this.setFileID(b);if(!this.rendered){this.render(Ext.getBody())}this.formPanel.form.reset();this.tabPanel.setActiveTab(0);var c={file_id:b,task:"file_properties"};if(a.loadParams){Ext.apply(c,a.loadParams)}this.formPanel.form.load({url:GO.settings.modules.files.url+"json.php",params:c,success:function(d,e){this.setWritePermission(e.result.data.write_permission);this.fireEvent("fileCommentsEdit",this);if(e.result.data.file_id){this.setFileID(e.result.data.file_id)}this.folder_id=e.result.data.folder_id;GO.files.FilePropertiesDialog.superclass.show.call(this)},failure:function(d,e){Ext.MessageBox.alert(GO.lang.strError,e.result.feedback)},scope:this})},setFileID:function(a){this.file_id=a;this.versionsGrid.setFileID(a);this.linkBrowseButton.setDisabled(a<1)},setWritePermission:function(a){var b=this.formPanel.form;b.findField("name").setDisabled(!a)},save:function(a){this.formPanel.form.submit({url:GO.settings.modules.files.url+"action.php",params:{file_id:this.file_id,task:"file_properties"},waitMsg:GO.lang.waitMsgSave,success:function(b,c){if(c.result.path){this.formPanel.form.findField("path").setValue(c.result.path);this.fireEvent("rename",this,this.folder_id)}this.fireEvent("save",this,this.file_id,this.folder_id);if(a){this.hide()}},failure:function(c,d){var b="";if(d.failureType=="client"){b=GO.lang.strErrorsInForm}else{b=d.result.feedback}Ext.MessageBox.alert(GO.lang.strError,b)},scope:this})},updateCfTabs:function(a,c){for(var b=0;b<this.tabPanel.items.items.length;b++){var e=this.tabPanel.items.items[b].category_id;if(e>0){if(c.allowed_from_cf_module&&typeof(c.allowed_for_folder)!="undefined"&&c.allowed_for_folder.limit){var d=c.allowed_for_folder.categories.indexOf(this.tabPanel.items.items[b].category_id.toString())>=0;if(d){this.tabPanel.unhideTabStripItem(this.tabPanel.items.items[b])}else{this.tabPanel.hideTabStripItem(this.tabPanel.items.items[b])}}else{if(typeof(c.allowed_for_folder)=="undefined"){this.tabPanel.hideTabStripItem(this.tabPanel.items.items[b])}else{this.tabPanel.unhideTabStripItem(this.tabPanel.items.items[b])}}}}}});GO.files.FolderPropertiesDialog=function(a){if(!a){a={}}this.goDialogId="folder";this.propertiesPanel=new Ext.Panel({layout:"form",title:GO.lang.strProperties,cls:"go-form-panel",waitMsgTarget:true,defaultType:"textfield",labelWidth:100,border:false,items:[{fieldLabel:GO.lang.strName,name:"name",anchor:"100%",validator:function(b){return !b.match(/[&\/:\*\?"<>|\\]/)}},{xtype:"plainfield",fieldLabel:GO.lang.strLocation,name:"path"},new GO.form.HtmlComponent({html:"<hr />"}),{xtype:"plainfield",fieldLabel:GO.lang.strCtime,name:"ctime"},{xtype:"plainfield",fieldLabel:GO.lang.strMtime,name:"mtime"},{xtype:"plainfield",fieldLabel:GO.lang.Atime,name:"atime"},{xtype:"htmlcomponent",html:"<hr />"},{xtype:"plainfield",fieldLabel:GO.lang.strType,name:"type"},{xtype:"plainfield",fieldLabel:GO.lang.strSize,name:"size"},new Ext.form.Checkbox({boxLabel:GO.files.lang.activateSharing,name:"share",checked:false,hideLabel:true}),new Ext.form.Checkbox({boxLabel:GO.files.lang.notifyChanges,name:"notify",checked:false,hideLabel:true}),this.applyStateCheckbox=new Ext.form.Checkbox({boxLabel:GO.files.lang.applyState,name:"apply_state",checked:false,hideLabel:true})]});this.readPermissionsTab=new GO.grid.PermissionsPanel({});this.commentsPanel=new Ext.Panel({layout:"form",labelWidth:70,title:GO.files.lang.comments,border:false,items:new Ext.form.TextArea({name:"comments",fieldLabel:"",hideLabel:true,anchor:"100% 100%"})});this.tabPanel=new Ext.TabPanel({activeTab:0,deferredRender:false,border:false,anchor:"100% 100%",hideLabel:true,items:[this.propertiesPanel,this.commentsPanel,this.readPermissionsTab]});if(GO.workflow){this.workflowPanel=new GO.workflow.FolderPropertiesPanel();this.tabPanel.insert(2,this.workflowPanel)}this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,border:false,defaultType:"textfield",items:this.tabPanel});GO.files.FolderPropertiesDialog.superclass.constructor.call(this,{title:GO.lang.strProperties,layout:"fit",width:500,height:400,closeAction:"hide",items:this.formPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});if(GO.customfields){Ext.Ajax.request({url:GO.settings.modules.files.url+"json.php",params:{task:"is_admin"},success:function(b,c){var e=Ext.decode(b.responseText);if(e.success&&e.has_admin){this.customfieldCategoryPanel=new Ext.FormPanel({waitMsgTarget:true,title:GO.files.lang.categoriesFiles,labelWidth:150,width:800,defaultType:"checkbox",border:false,layout:"form",defaults:{anchor:"100%"},cls:"go-form-panel",waitMsgTarget:true,items:[this.limitCB=new Ext.form.Checkbox({name:"limit",hideLabel:true,boxLabel:GO.files.lang.applyLimits}),this.cfCategoriesFieldset=new Ext.form.FieldSet({title:GO.customfields.lang.categories,layout:"form",style:"margin:3px;padding:0;padding-left:3px;",autoHeight:true}),this.applyRecursivelyCB=new Ext.form.Checkbox({name:"recursive",hideLabel:true,boxLabel:GO.files.lang.applyRecursively,checked:false})]});for(var d=0;d<GO.customfields.types["6"].panels.length;d++){this.cfCategoriesFieldset.add(new Ext.form.Checkbox({name:"cat_"+GO.customfields.types["6"].panels[d].category_id,hideLabel:true,boxLabel:GO.customfields.types["6"].panels[d].title,checked:false}))}this.limitCB.on("check",function(g,f){if(f){this.cfCategoriesFieldset.enable()}else{this.cfCategoriesFieldset.disable()}},this);this.applyRecursivelyCB.on("check",function(g,f){if(f){Ext.MessageBox.show({title:GO.files.lang.pleaseConfirm,msg:GO.files.lang.applyRecursivelyRUSure,buttons:Ext.MessageBox.YESNO,fn:function(h){this.applyRecursivelyCB.setValue(h=="yes")},animEl:"mb4",icon:Ext.MessageBox.QUESTION,scope:this})}},this);this.customfieldCategoryPanel.on("show",this.customfieldCategoriesPanelShownHandler,this);this.tabPanel.add(this.customfieldCategoryPanel);this.setSize(800,400)}else{if(!e.success){this.reload();alert(e.feedback)}}},scope:this})}this.addEvents({rename:true})};Ext.extend(GO.files.FolderPropertiesDialog,GO.Window,{parent_id:0,show:function(a){this.folder_id=a;if(!this.rendered){this.render(Ext.getBody())}this.formPanel.form.load({url:GO.settings.modules.files.url+"json.php",params:{folder_id:a,task:"folder_properties"},success:function(c,d){var b=this.formPanel.form.findField("share");b.setValue(d.result.data.acl_id>0);this.parent_id=d.result.data.parent_id;this.readPermissionsTab.setAcl(d.result.data.acl_id);this.setWritePermission(d.result.data.is_home_dir,d.result.data.write_permission,d.result.data.is_owner);this.tabPanel.setActiveTab(0);GO.files.FolderPropertiesDialog.superclass.show.call(this)},failure:function(b,c){Ext.MessageBox.alert(GO.lang.strError,c.result.feedback)},scope:this})},setWritePermission:function(b,a,d){var c=this.formPanel.form;c.findField("name").setDisabled(b||!a);c.findField("share").setDisabled(b||!a);c.findField("apply_state").setDisabled(!(d||GO.settings.has_admin_permission));this.readPermissionsTab.setDisabled(this.readPermissionsTab.acl_id==0)},save:function(a){this.formPanel.form.submit({url:GO.settings.modules.files.url+"action.php",params:{folder_id:this.folder_id,task:"folder_properties"},waitMsg:GO.lang.waitMsgSave,success:function(b,c){if(c.result.acl_id){this.readPermissionsTab.setAcl(c.result.acl_id)}if(c.result.path){this.formPanel.form.findField("path").setValue(c.result.path);this.fireEvent("rename",this,this.parent_id)}this.fireEvent("save",this,this.folder_id);if(GO.customfields){this.submitAllowedCfCategories(a)}if(a){this.hide()}},failure:function(c,d){var b="";if(d.failureType=="client"){b=GO.lang.strErrorsInForm}else{b=d.result.feedback}Ext.MessageBox.alert(GO.lang.strError,b)},scope:this})},submitAllowedCfCategories:function(a){this.customfieldCategoryPanel.form.submit({waitMsg:GO.lang.waitMsgSave,url:GO.settings.modules.files.url+"action.php",params:{task:"save_folder_limits",folder_id:this.folder_id},success:function(b,c){if(a){this.hide()}},failure:function(b,c){if(c.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,c.result.feedback)}},scope:this})},uncheckCategoryCBs:function(){for(var a=0;a<this.cfCategoriesFieldset.items.items.length;a++){this.cfCategoriesFieldset.items.items[a].setValue(false)}},loadCustomfieldCategoriesForm:function(){this.uncheckCategoryCBs();this.customfieldCategoryPanel.form.load({url:GO.settings.modules.files.url+"json.php",params:{task:"folder_cf_categories",folder_id:this.folder_id},waitMsg:GO.lang.waitMsgLoad,success:function(b,c){var a=Ext.decode(c.response.responseText);if(a.data.limit){this.cfCategoriesFieldset.enable()}else{this.cfCategoriesFieldset.disable()}this.applyRecursivelyCB.setValue(false)},failure:function(a,b){if(b.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,b.result.feedback)}},scope:this})},customfieldCategoriesPanelShownHandler:function(){this.loadCustomfieldCategoriesForm()}});GO.files.FilesContextMenu=function(a){if(!a){a={}}a.shadow="frame";a.minWidth=180;this.downloadButton=new Ext.menu.Item({iconCls:"btn-save",text:GO.lang.download,cls:"x-btn-text-icon",handler:function(){window.location.href=GO.settings.modules.files.url+"download.php?mode=download&id="+this.records[0].data.id},scope:this});this.gotaButton=new Ext.menu.Item({iconCls:"btn-edit",text:GO.files.lang.downloadGOTA,cls:"x-btn-text-icon",handler:function(){if(!deployJava.isWebStartInstalled("1.6.0")){Ext.MessageBox.alert(GO.lang.strError,GO.lang.noJava)}else{window.location.href=GO.settings.modules.gota.url+"jnlp.php?id="+this.records[0].data.id}},scope:this});this.deleteButton=new Ext.menu.Item({iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.fireEvent("delete",this,this.records,this.clickedAt)},scope:this});this.cutButton=new Ext.menu.Item({iconCls:"btn-cut",text:GO.lang.cut,cls:"x-btn-text-icon",handler:function(){this.fireEvent("cut",this,this.records,this.clickedAt)},scope:this});this.copyButton=new Ext.menu.Item({iconCls:"btn-copy",text:GO.lang.copy,cls:"x-btn-text-icon",handler:function(){this.fireEvent("copy",this,this.records,this.clickedAt)},scope:this});this.compressButton=new Ext.menu.Item({iconCls:"btn-compress",text:GO.lang.compress,cls:"x-btn-text-icon",handler:function(){this.fireEvent("compress",this,this.records,this.clickedAt)},scope:this});this.decompressButton=new Ext.menu.Item({iconCls:"btn-decompress",text:GO.lang.decompress,cls:"x-btn-text-icon",handler:function(){this.fireEvent("decompress",this,this.records,this.clickedAt)},scope:this});a.items=[this.downloadButton];if(GO.settings.modules.gota&&GO.settings.modules.gota.read_permission){a.items.push(this.gotaButton)}a.items.push({iconCls:"btn-properties",text:GO.lang.strProperties,handler:function(){this.fireEvent("properties",this,this.records)},scope:this});a.items.push(new Ext.menu.Separator());a.items.push(this.cutButton);a.items.push(this.copyButton);a.items.push(new Ext.menu.Separator());a.items.push(this.deleteButton);a.items.push(this.compressSeparator=new Ext.menu.Separator());a.items.push(this.compressButton);a.items.push(this.decompressButton);if(GO.settings.modules.email){this.downloadLinkButton=new Ext.menu.Item({iconCls:"btn-email",text:GO.files.lang.emailDownloadLink,cls:"x-btn-text-icon",handler:function(){this.fireEvent("download_link",this,this.records,this.clickedAt)},scope:this});a.items.push(this.downloadLinkButton)}GO.files.FilesContextMenu.superclass.constructor.call(this,a);this.addEvents({properties:true,paste:true,cut:true,copy:true,"delete":true,compress:true,decompress:true,download_link:true})};Ext.extend(GO.files.FilesContextMenu,Ext.menu.Menu,{clickedAt:"grid",records:[],showAt:function(c,b,a){if(a){this.clickedAt=a}var d="";this.records=b;if(b.length=="1"){d=b[0].data.extension;switch(d){case"zip":case"tar":case"tgz":case"gz":this.downloadButton.show();this.gotaButton.show();this.decompressButton.show();this.compressButton.hide();this.downloadLinkButton.show();break;case"":case"folder":this.downloadButton.hide();this.gotaButton.hide();this.decompressButton.hide();this.compressButton.show();this.downloadLinkButton.hide();break;default:this.downloadButton.show();this.gotaButton.show();this.compressButton.show();this.decompressButton.hide();this.downloadLinkButton.show();break}}else{this.compressButton.show();this.decompressButton.hide();this.downloadButton.hide();this.gotaButton.hide()}GO.files.FilesContextMenu.superclass.showAt.call(this,c)}});GO.files.TemplateWindow=function(a){this.gridStore=new GO.data.JsonStore({url:GO.settings.modules.files.url+"json.php",baseParams:{task:"templates",writable_only:"true"},root:"results",totalProperty:"total",id:"id",fields:["id","name","type","grid_display"],remoteSort:true});this.gridStore.on("load",function(){this.firstLoad=false},this,{single:true});this.gridStore.load();this.gridPanel=new GO.grid.GridPanel({region:"center",layout:"fit",split:true,paging:true,store:this.gridStore,columns:[{header:GO.lang.strName,dataIndex:"grid_display",sortable:true},{header:GO.lang.strType,dataIndex:"type",sortable:false}],view:new Ext.grid.GridView({autoFill:true,forceFit:true}),sm:new Ext.grid.RowSelectionModel(),loadMask:true,tbar:[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",scope:this,handler:function(){this.showTemplate()}},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",scope:this,handler:function(){this.gridPanel.deleteSelected()}}]});this.gridPanel.on("rowdblclick",function(b){this.showTemplate(b.selModel.selections.keys[0])},this);GO.files.TemplateWindow.superclass.constructor.call(this,{title:GO.files.lang.manageTemplates,layout:"fit",width:500,height:400,closeAction:"hide",items:this.gridPanel,buttons:[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.files.TemplateWindow,Ext.Window,{firstLoad:true,showTemplate:function(a){if(!this.templateDialog){this.uploadFile=new GO.form.UploadFile({inputName:"file",max:1});this.downloadButton=new Ext.Button({handler:function(){document.location.href="download_template.php?template_id="+this.template_id},disabled:true,text:GO.files.lang.downloadTemplate,scope:this});this.formPanel=new Ext.form.FormPanel({title:GO.lang.strProperties,cls:"go-form-panel",waitMsgTarget:true,labelWidth:85,defaultType:"textfield",fileUpload:true,items:[{fieldLabel:GO.lang.strName,name:"name",id:"template-name",anchor:"100%",allowBlank:false},new GO.form.HtmlComponent({html:"<br />"}),this.uploadFile,new GO.form.HtmlComponent({html:"<br />"}),this.downloadButton]});var b=[{text:GO.lang.cmdOk,handler:function(){this.saveTemplate(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.saveTemplate(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.templateDialog.hide()},scope:this}];this.templateDialog=new Ext.Window({layout:"fit",modal:false,height:400,width:400,closeAction:"hide",title:GO.files.lang.template,items:[this.templateTabPanel=new Ext.TabPanel({activeTab:0,border:false,items:[this.formPanel,this.readPermissionsTab=new GO.grid.PermissionsPanel({})]})],buttons:b,focus:function(){Ext.get("template-name").focus()}})}this.template_id=a;this.templateTabPanel.setActiveTab(0);if(this.template_id>0){this.readPermissionsTab.setDisabled(false);this.loadTemplate()}else{this.formPanel.form.reset();this.readPermissionsTab.setAcl(0);this.downloadButton.setDisabled(true)}this.templateDialog.show()},loadTemplate:function(){this.formPanel.form.load({url:GO.settings.modules.files.url+"json.php",params:{template_id:this.template_id,task:"template"},success:function(a,b){this.readPermissionsTab.setAcl(b.result.data.acl_id);this.downloadButton.setDisabled(false)},scope:this})},saveTemplate:function(a){this.formPanel.form.submit({waitMsg:GO.lang.waitMsgSave,url:GO.settings.modules.files.url+"action.php",params:{task:"save_template",template_id:this.template_id},success:function(b,c){this.template_id=c.result.template_id;this.gridStore.reload();this.uploadFile.clearQueue();if(this.template_id&&!a){this.readPermissionsTab.setAcl(c.result.acl_id)}if(a){this.templateDialog.hide()}},failure:function(b,c){if(c.failureType!="client"){Ext.MessageBox.alert(GO.lang.strError,c.result.feedback)}},scope:this})}});GO.files.filesTemplate='<tpl if="values.files && values.files.length">{[this.collapsibleSectionHeader(GO.files.lang.files, "files-"+values.panelId, "files")]}<table class="display-panel" cellpadding="0" cellspacing="0" border="0" id="files-{panelId}"><tr><td class="table_header_links" style="width:100%">'+GO.lang.strName+'</td><td class="table_header_links" style="white-space:nowrap">'+GO.lang.strMtime+'</td><td class="table_header_links">&nbsp;</td></tr><tpl if="!files.length"><tr><td colspan="4">'+GO.lang.strNoItems+'</td></tr></tpl><tpl for="files"><tr><td><a class="go-grid-icon filetype filetype-{extension}" href="#" onclick="<tpl if="extension!=\'folder\'">GO.linkHandlers[6].call(this, {id});</tpl><tpl if="extension==\'folder\'">GO.linkHandlers[17].call(this, {id});</tpl>">{name}</a></td><td style="white-space:nowrap">{mtime}</td><tpl if="extension!=\'folder\'"><td style="white-space:nowrap"><a style="display:block" class="go-icon btn-edit" href="#files_{[xindex-1]}">&nbsp;</a></td></tpl><tpl if="extension==\'folder\'"><td style="white-space:nowrap"><a style="display:block" class="go-icon btn-files" href="#files_{[xindex-1]}">&nbsp;</a></td></tpl></tr></tpl><tr><td colspan="4"><a class="display-panel-browse" href="#browsefiles">'+GO.lang.browse+"</a></td></tr></table></tpl>";GO.files.filesTemplateConfig={getPath:function(a){return a.replace(/\'/g,"\\'")}};GO.files.ImageViewer=Ext.extend(GO.Window,{originalImgSize:false,viewerImages:Array(),currentImgIndex:0,initComponent:function(){this.border=false;this.plain=true;this.maximizable=true;this.width=640;this.height=Ext.getBody().getHeight()-80;this.bodyStyle="text-align:center;vertical-align:middle";this.title=GO.files.lang.imageViewer;this.autoScroll=true;this.tbar=[this.previousButton=new Ext.Button({iconCls:"btn-left-arrow",text:GO.lang.cmdPrevious,handler:function(){this.loadImage(this.currentImgIndex-1)},scope:this}),this.nextButton=new Ext.Button({iconCls:"btn-right-arrow",text:GO.lang.cmdNext,handler:function(){this.loadImage(this.currentImgIndex+1)},scope:this}),"-",{iconCls:"btn-save",text:GO.lang.download,handler:function(){document.location.replace(this.viewerImages[this.currentImgIndex].download_path)},scope:this},"-",this.normalSizeBtn=new Ext.Button({text:GO.files.lang.normalSize,iconCls:"fs-btn-normal-size",handler:function(){this.imgEl.setSize(this.originalImgSize.width,this.originalImgSize.height)},scope:this}),this.fitImageBtn=new Ext.Button({text:GO.files.lang.fitImage,iconCls:"fs-btn-fit-image",handler:function(){this.syncImgSize()},scope:this})];GO.files.ImageViewer.superclass.initComponent.call(this);this.on("resize",this.syncImgSize,this)},show:function(a,b){GO.files.ImageViewer.superclass.show.call(this);this.viewerImages=a;this.loadImage(b)},loadImage:function(a){this.body.mask(GO.lang.waitMsgLoad);this.setTitle(this.viewerImages[a].name);this.currentImgIndex=a;if(this.imgEl){this.imgEl.remove()}this.originalImgSize=false;this.imgEl=this.body.createChild({tag:"img",src:this.viewerImages[a].src,cls:"fs-img-viewer"});if(!this.viewerImages[a].download_path){this.viewerImages[a].download_path=this.viewerImages[a].src}this.imgEl.initDD(null);this.syncImgSize();if(this.viewerImages.length==1){this.previousButton.hide();this.nextButton.hide()}else{this.previousButton.show();this.nextButton.show();this.previousButton.setDisabled(a==0);this.nextButton.setDisabled(a==(this.viewerImages.length-1))}},syncImgSize:function(){if(this.imgEl){if(!this.imgEl.dom.complete){this.syncImgSize.defer(100,this)}else{var f=this.imgEl.getSize();if(!this.originalImgSize){this.originalImgSize=f}var c=this.body.getSize();var e=f.height;var a=f.width;if(this.originalImgSize.width>c.width){a=c.width;e=this.originalImgSize.height*c.width/this.originalImgSize.width}if(e>c.height){var d=c.height/e;a=a*d;e=e*d}if(a!=this.originalImgSize.width||e!=this.originalImgSize.height){this.normalSizeBtn.setDisabled(false);this.fitImageBtn.setDisabled(false);this.imgEl.setWidth(a);this.imgEl.setHeight(e);this.imgEl.setPositioning({left:0,top:0})}else{this.normalSizeBtn.setDisabled(true);this.fitImageBtn.setDisabled(true)}if(e<c.height){var b=(c.height-e)/2;this.imgEl.setStyle("margin-top",b+"px")}this.body.unmask()}}}});GO.files.ThumbsPanel=Ext.extend(Ext.Panel,{store:false,initComponent:function(){this.bbar=new Ext.PagingToolbar({cls:"go-paging-tb",store:this.store,pageSize:parseInt(GO.settings.max_rows_list),displayInfo:true,displayMsg:GO.lang.displayingItems,emptyMsg:GO.lang.strNoItems});var a=new Ext.XTemplate('<tpl for=".">','<div class="fs-thumb-wrap" id="{name}">','<div class="fs-thumb"><img src="{thumb_url}" title="{name}"></div>','<span class="x-editable">{shortName}</span></div>',"</tpl>",'<div class="x-clear"></div>');this.items=[this.view=new Ext.DataView({store:this.store,tpl:a,autoHeight:true,multiSelect:true,overClass:"fs-view-over",selectedClass:"fs-view-selected",itemSelector:"div.fs-thumb-wrap",prepareData:function(b){b.shortName=Ext.util.Format.ellipsis(b.name,20);return b}})];this.autoScroll=true;this.view.on("render",function(){var b=new GO.files.ThumbsDragZone(this.view,{containerScroll:true,ddGroup:"FilesDD"});var c=new GO.files.ThumbsDropZone(this.view,{notifyDrop:this.onNotifyDrop.createDelegate(this)})},this);this.addEvents({drop:true});GO.files.ThumbsPanel.superclass.initComponent.call(this)},onBeforeLoad:function(){this.body.mask(GO.lang.waitMsgLoad)},onStoreLoad:function(){this.body.unmask()},setStore:function(a){if(this.store){this.store.un("beforeload",this.onBeforeLoad,this);this.store.un("load",this.onStoreLoad,this);this.store=false}if(a){this.store=a;this.store.on("beforeload",this.onBeforeLoad,this);this.store.on("load",this.onStoreLoad,this)}this.view.bindStore(this.store)},deleteSelected:function(c){if(!c){c=this.deleteConfig}if(!c.deleteParam){c.deleteParam="delete_keys"}var e=[];var b=this.view.getSelectedRecords();for(var d=0;d<b.length;d++){e.push(b[d].data.type_id)}var f={};f[c.deleteParam]=Ext.encode(e);var a={store:this.store,params:f,count:e.length};if(c.callback){a.callback=c.callback}if(c.success){a.success=c.success}if(c.failure){a.failure=c.failure}if(c.scope){a.scope=c.scope}GO.deleteItems(a)},onNotifyDrop:function(a,f,c){var d=a.getDragData(f);if(a.dragData){var b=this.view.store.getAt(d.ddel.viewIndex);if(b&&b.data.extension=="folder"){this.fireEvent("drop",b.data.id,c.selections);return true}}}});GO.files.ThumbsDropZone=function(a,b){this.view=a;GO.files.ThumbsDropZone.superclass.constructor.call(this,a.getEl(),b)};Ext.extend(GO.files.ThumbsDropZone,Ext.dd.DropTarget,{ddGroup:"FilesDD",copy:false,notifyOver:function(a,f,c){var d=f.getTarget(".fs-thumb-wrap");if(d){var b=this.view.store.getAt(d.viewIndex);if(b){if(b.data.extension=="folder"){return this.dropAllowed}}}return false}});GO.files.ThumbsDragZone=function(a,b){this.view=a;GO.files.ThumbsDragZone.superclass.constructor.call(this,a.getEl(),b)};Ext.extend(GO.files.ThumbsDragZone,Ext.dd.DragZone,{ddGroup:"FilesDD",getDragData:function(j){if(j.ctrlKey){return false}var k=j.getTarget(".fs-thumb-wrap");if(k){var l=this.view;if(!l.isSelected(k)){l.onClick(j)}var b=l.getSelectedNodes();var c=l.getSelectedRecords();var d={nodes:b,selections:c};if(b.length==1){d.ddel=k;d.single=true}else{var a=document.createElement("div");a.className="multi-proxy";for(var f=0,h=b.length;f<h;f++){a.appendChild(b[f].firstChild.firstChild.cloneNode(true));if((f+1)%3==0){a.appendChild(document.createElement("br"))}}var g=document.createElement("div");g.innerHTML=f+" images selected";a.appendChild(g);d.ddel=a;d.multi=true}return d}return false},afterRepair:function(){for(var b=0,a=this.dragData.nodes.length;b<a;b++){Ext.fly(this.dragData.nodes[b]).frame("#8db2e3",1)}this.dragging=false},getRepairXY:function(b){if(!this.dragData.multi){var a=Ext.Element.fly(this.dragData.ddel).getXY();a[0]+=3;a[1]+=3;return a}return false}});GO.files.SaveAsDialog=Ext.extend(GO.Window,{handler:function(){},initComponent:function(){this.layout="border";this.title=GO.files.lang.saveFile;this.height=450;this.width=750;this.border=false;this.collapsible=true;this.maximizable=true;this.closeAction="hide";this.buttons=[{text:GO.lang.cmdOk,handler:function(){if(this.nameField.isValid()){var d=this.fb.gridStore.getRange();for(var c=0;c<d.length;c++){if(d[c].data.extension!="folder"&&d[c].data.name==this.nameField.getValue()){var b=new Ext.Template(GO.files.lang.confirmOverwrite);if(!confirm(b.apply({filename:d[c].data.name}))){return false}break}}this.handler.call(this.scope,this,this.fb.folder_id,this.nameField.getValue())}else{this.nameField.focus()}},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];this.fb=new GO.files.FileBrowser({region:"center",border:false,loadDelayed:true,hideActionButtons:true,treeCollapsed:false,filePanelCollapsed:true,fileClickHandler:function(b){},scope:this});this.fb.on("fileselected",function(c,b){if(b.data.extension!="folder"){this.formPanel.form.findField("filename").setValue(b.data.name)}},this);this.nameField=new Ext.form.TextField({fieldLabel:GO.lang.strName,name:"filename",anchor:"100%",validator:function(b){return !b.match(/[&\/:\*\?"<>|\\]/)}});var a=function(){this.nameField.focus(true)};this.focus=a.createDelegate(this);this.formPanel=new Ext.form.FormPanel({region:"north",cls:"go-form-panel",height:32,items:this.nameField});this.items=[this.fb,this.formPanel];GO.files.SaveAsDialog.superclass.initComponent.call(this)},show:function(a){this.nameField.setValue(a.filename.replace(/[&\/:\*\?"<>|\\]/g,""));var b=GO.util.getFileExtension(a.filename);this.fb.setFilesFilter(b);if(!a.scope){a.scope=this}if(a.handler){this.handler=a.handler.createDelegate(a.scope)}GO.files.SaveAsDialog.superclass.show.call(this)}});GO.files.VersionsGrid=function(a){if(!a){a={}}a.title=GO.files.lang.olderVersions;a.layout="fit";a.autoScroll=true;a.split=true;a.store=new GO.data.JsonStore({url:GO.settings.modules.files.url+"json.php",baseParams:{task:"versions"},root:"results",totalProperty:"total",id:"path",fields:["path","name","type","size","mtime","grid_display","extension","timestamp","thumb_url"],remoteSort:true});var c=Ext.id();a.paging=true;var b=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:GO.lang.strName,dataIndex:"grid_display",sortable:true,id:c},{header:GO.lang.strSize,dataIndex:"size",width:80,sortable:true},{header:GO.lang.strMtime,dataIndex:"mtime",sortable:true,width:100}]});a.cm=b;a.autoExpandColumn=c;a.view=new Ext.grid.GridView({emptyText:GO.lang.strNoItems});a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;GO.files.VersionsGrid.superclass.constructor.call(this,a);this.on("rowdblclick",function(e,f){var d=e.getStore().getAt(f);GO.files.openFile(d)},this)};Ext.extend(GO.files.VersionsGrid,GO.grid.GridPanel,{onShow:function(){GO.files.VersionsGrid.superclass.onShow.call(this);this.store.load()},setFileID:function(a){this.store.baseParams.file_id=a;this.store.loaded=false}});GO.files.NewFolderDialog=function(a){if(!a){a={}}this.newFolderNameField=new Ext.form.TextField({fieldLabel:GO.lang.strName,name:"name",value:GO.files.lang.newFolder,allowBlank:false,anchor:"100%",validator:function(c){return !c.match(/[&\/:\*\?"<>|\\]/)}});this.newFolderFormPanel=new Ext.form.FormPanel({url:GO.settings.modules.files.url+"action.php",baseParams:{folder_id:0},defaultType:"textfield",labelWidth:75,autoHeight:true,cls:"go-form-panel",waitMsgTarget:true,items:this.newFolderNameField});var b=function(){this.newFolderNameField.focus(true)};a.collapsible=false;a.maximizable=false;a.modal=false;a.resizable=false;a.width=500;a.items=this.newFolderFormPanel;a.autoHeight=true;a.closeAction="hide";a.focus=b.createDelegate(this);a.title=GO.files.lang.addFolder;a.buttons=[{text:GO.lang.cmdOk,handler:function(){this.newFolderFormPanel.form.submit({url:GO.settings.modules.files.url+"action.php",params:{task:"new_folder"},waitMsg:GO.lang.waitMsgSave,success:function(c,d){this.fireEvent("save",d.result);this.hide()},failure:function(d,e){var c="";if(e.failureType=="client"){c=GO.lang.strErrorsInForm}else{c=e.result.feedback}Ext.MessageBox.alert(GO.lang.strError,c)},scope:this})},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.files.NewFolderDialog.superclass.constructor.call(this,a);this.addEvents({save:true})};Ext.extend(GO.files.NewFolderDialog,Ext.Window,{show:function(a){if(!this.rendered){this.render(Ext.getBody())}this.newFolderFormPanel.baseParams.folder_id=a;this.newFolderFormPanel.form.reset();GO.files.NewFolderDialog.superclass.show.call(this)}});GO.files.UploadDialog=function(d){if(!d){d={}}this.uploadFile=new GO.form.UploadFile({inputName:"attachments",addText:GO.lang.smallUpload});var c=[this.uploadFile,new Ext.Button({text:GO.lang.largeUpload,handler:function(){if(!deployJava.isWebStartInstalled("1.5.0")){Ext.MessageBox.alert(GO.lang.strError,GO.lang.noJava)}else{window.open(GO.settings.modules.files.url+"jupload/index.php?id="+this.folder_id);this.hide()}},scope:this}),{border:false,html:GO.files.lang.uploadProperties,bodyStyle:"padding:20px 0px 10px"},{xtype:"textarea",name:"comments",fieldLabel:GO.files.lang.comments,anchor:"100%",height:100}];if(GO.customfields&&GO.customfields.types["6"]){var b,f;for(var e=0;e<GO.customfields.types["6"].panels.length;e++){var a=GO.customfields.types["6"].panels[e];b={xtype:"fieldset",title:a.title,items:[],autoHeight:true};for(var e=0;e<a.customfields.length;e++){f=GO.customfields.getFormField(a.customfields[e]);b.items.push(f)}c.push(b)}}this.upForm=new Ext.form.FormPanel({fileUpload:true,border:false,waitMsgTarget:true,autoHeight:true,baseParams:{task:"upload"},items:c,cls:"go-form-panel"});d.collapsible=false;d.maximizable=false;d.modal=true;d.layout="fit";d.resizable=false;d.width=500;d.items={autoScroll:true,border:false,items:[this.upForm]};d.height=400;d.autoScroll=true;d.closeAction="hide";d.title=GO.lang.uploadFiles;d.buttons=[{text:GO.lang.cmdOk,handler:this.uploadHandler,scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.files.UploadDialog.superclass.constructor.call(this,d);this.addEvents({upload:true})};Ext.extend(GO.files.UploadDialog,Ext.Window,{show:function(a){if(!this.rendered){this.render(Ext.getBody())}this.upForm.form.reset();this.folder_id=a;GO.files.UploadDialog.superclass.show.call(this)},uploadHandler:function(){this.upForm.form.submit({url:GO.settings.modules.files.url+"action.php",waitMsg:GO.lang.waitMsgUpload,success:function(a,b){this.uploadFile.clearQueue();this.hide();this.fireEvent("upload",b)},failure:function(b,c){var a="";if(c.failureType=="client"){a=GO.lang.strErrorsInForm}else{a=c.result.feedback}Ext.MessageBox.alert(GO.lang.strError,a)},scope:this})}});GO.files.SelectFile=Ext.extend(Ext.form.TriggerField,{triggerClass:"fs-form-file-select",filesFilter:"",root_folder_id:0,files_folder_id:0,onTriggerClick:function(){GO.files.createSelectFileBrowser();GO.selectFileBrowser.setFileClickHandler(function(a){if(a){this.setValue(a.data.path)}else{this.setValue(GO.selectFileBrowser.path)}GO.selectFileBrowserWindow.hide()},this);GO.selectFileBrowser.setFilesFilter(this.filesFilter);GO.selectFileBrowser.setRootID(this.root_folder_id,this.files_folder_id);GO.selectFileBrowserWindow.show()}});Ext.ComponentMgr.registerType("selectfile",GO.files.SelectFile);GO.moduleManager.onModuleReady("customfields",function(){GO.customfields.nonGridTypes.push("file");GO.customfields.dataTypes.file={label:GO.files.lang.file,getFormField:function(a,b){return{xtype:"selectfile",fieldLabel:a.name,name:a.dataname,anchor:"-20"}}}},this);Ext.namespace("GO.files");GO.files.FileRecord=Ext.data.Record.create([{name:"type_id",type:"string"},{name:"id",type:"string"},{name:"name",type:"string"},{name:"type",type:"string"},{name:"mtime"},{name:"extension"},{name:"timestamp"},{name:"thumb_url",type:"string"}]);GO.files.FileBrowser=function(c){if(!c){c={}}if(!c.id){c.id=Ext.id()}this.treeLoader=new Ext.tree.TreeLoader({dataUrl:GO.settings.modules.files.url+"json.php",baseParams:{task:"tree",root_folder_id:0,expand_folder_id:0},preloadChildren:true});this.treeLoader.on("beforeload",function(){var e=this.treePanel.getEl();if(e){e.mask(GO.lang.waitMsgLoad)}},this);this.treeLoader.on("load",function(){var e=this.treePanel.getEl();if(e){e.unmask()}},this);this.treePanel=new Ext.tree.TreePanel({region:"west",layout:"fit",split:true,autoScroll:true,width:200,animate:true,loader:this.treeLoader,collapsed:c.treeCollapsed,rootVisible:false,containerScroll:true,collapsible:true,collapseMode:"mini",header:false,ddAppendOnly:true,ddGroup:"FilesDD",enableDD:true,selModel:new Ext.tree.MultiSelectionModel()});this.rootNode=new Ext.tree.AsyncTreeNode({text:"",draggable:false,id:"root",iconCls:"folder-default"});this.rootNode.on("load",function(e){if(!this.folder_id){this.folder_id=e.childNodes[0].id}this.setFolderID(this.folder_id)},this);this.treePanel.setRootNode(this.rootNode);this.treePanel.on("click",function(e){this.setFolderID(e.id,true)},this);this.treePanel.on("contextmenu",function(h,j){j.stopEvent();var g=this.treePanel.getSelectionModel();if(!g.isSelected(h)){g.clearSelections();g.select(h)}var f=this.getSelectedTreeRecords();var i=j.getXY();this.filesContextMenu.showAt(i,f,"tree")},this);this.treePanel.on("beforenodedrop",function(h){if(h.data.selections){var g=h.data.selections}else{var f={};f.data={};f.data.extension="folder";f.data.id=h.data.node.id;f.data.type_id="d:"+h.data.node.id;var g=[f]}this.paste("cut",h.target.id,g)},this);this.treePanel.on("nodedragover",function(h){if(!h.dropNode){for(var f=0;f<h.data.selections.length;f++){if(h.data.selections[f].data.extension=="folder"){var k=h.data.selections[f].data.id;var j=h.data.selections[f].data.parent_id;var e=h.target.id;if(k==e||j==e){return false}var g=this.treePanel.getNodeById(k);if(g.parentNode.id==e||h.target.isAncestor(g)){return false}return true}}}else{var l=this.treePanel.getNodeById(h.dropNode.id).parentNode.id;if(l==h.target.id){return false}return true}},this);var a={fields:["type_id","id","name","type","size","mtime","extension","timestamp","thumb_url","path","acl_id"],columns:[{id:"name",header:GO.lang.strName,dataIndex:"name",renderer:function(f,h,g){var e=g.get("acl_id")>0?"folder-shared":"filetype filetype-"+g.get("extension");return'<div class="go-grid-icon '+e+'">'+f+"</div>"}},{id:"type",header:GO.lang.strType,dataIndex:"type",sortable:true,hidden:true,width:100},{id:"size",header:GO.lang.strSize,dataIndex:"size",renderer:function(e){return e=="-"?e:Ext.util.Format.fileSize(e)},hidden:true,width:100},{id:"mtime",header:GO.lang.strMtime,dataIndex:"mtime",width:120}]};if(GO.customfields){GO.customfields.addColumns(6,a)}this.gridStore=new GO.data.JsonStore({url:GO.settings.modules.files.url+"json.php",baseParams:{task:"grid"},root:"results",totalProperty:"total",id:"type_id",fields:a.fields,remoteSort:true});this.gridStore.on("load",this.onStoreLoad,this);if(c.filesFilter){this.setFilesFilter(c.filesFilter)}this.gridPanel=new GO.files.FilesGrid({id:c.id+"-fs-grid",store:this.gridStore,deleteConfig:{scope:this,success:function(){var e=this.treePanel.getNodeById(this.folder_id);if(e){e.reload()}}},cm:new Ext.grid.ColumnModel({defaults:{sortable:true},columns:a.columns})});this.gridPanel.on("delayedrowselect",function(e,g,f){this.fireEvent("fileselected",this,f)},this);this.gridPanel.on("render",function(){var e=new Ext.dd.DropTarget(this.gridPanel.getView().mainBody,{ddGroup:"FilesDD",copy:false,notifyOver:this.onGridNotifyOver,notifyDrop:this.onGridNotifyDrop.createDelegate(this)})},this);this.gridPanel.on("rowdblclick",this.onGridDoubleClick,this);this.gridPanel.on("beforestatesave",function(e,f){if(this.gridStore.reader.jsonData.lock_state){if(this.gridStore.reader.jsonData.may_apply_state){this.saveCMState(f)}return false}},this);this.filesContextMenu=new GO.files.FilesContextMenu();this.filesContextMenu.on("properties",function(f,e){this.showPropertiesDialog(e[0])},this);this.filesContextMenu.on("cut",function(f,e){this.onCutCopy("cut",e)},this);this.filesContextMenu.on("copy",function(f,e){this.onCutCopy("copy",e)},this);this.filesContextMenu.on("delete",function(g,f,e){this.onDelete(e)},this);this.filesContextMenu.on("compress",function(g,f,e){this.onCompress(f)},this);this.filesContextMenu.on("decompress",function(f,e){this.onDecompress(e)},this);this.filesContextMenu.on("download_link",function(f,e){this.onDownloadLink(e)},this);this.gridPanel.on("rowcontextmenu",this.onGridRowContextMenu,this);this.newMenu=new Ext.menu.Menu({items:[]});this.newButton=new Ext.Button({text:GO.lang.cmdNew,iconCls:"btn-add",menu:this.newMenu});this.locationTextField=new Ext.form.TextField({fieldLabel:GO.lang.strLocation,name:"files-location",anchor:"100%"});this.locationPanel=new Ext.Panel({region:"north",layout:"form",border:false,baseCls:"x-plain",height:32,labelWidth:75,plain:true,cls:"go-files-location-panel",items:this.locationTextField});this.upButton=new Ext.Button({iconCls:"btn-up",text:GO.lang.up,cls:"x-btn-text-icon",handler:function(){this.setFolderID(this.parentID)},scope:this,disabled:true});this.pasteButton=new Ext.Button({iconCls:"btn-paste",text:GO.lang.paste,cls:"x-btn-text-icon",handler:this.onPaste,scope:this,disabled:true});this.deleteButton=new Ext.Button({iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.onDelete("grid")},scope:this});this.cutButton=new Ext.Button({iconCls:"btn-cut",text:GO.lang.cut,cls:"x-btn-text-icon",handler:function(){var e=this.getSelectedGridRecords();this.onCutCopy("cut",e)},scope:this});this.copyButton=new Ext.Button({iconCls:"btn-copy",text:GO.lang.copy,cls:"x-btn-text-icon",handler:function(){var e=this.getSelectedGridRecords();this.onCutCopy("copy",e)},scope:this});this.emptyListButton=new Ext.Button({iconCls:"btn-refresh",text:GO.files.lang.emptyList,cls:"x-btn-text-icon",hidden:true,handler:function(){this.gridStore.baseParams.empty_new_files=true;this.gridStore.load();delete this.gridStore.baseParams.empty_new_files},scope:this});var d=[];d.push(this.newButton);this.uploadMenu=new Ext.menu.Menu({items:[]});this.uploadButton=new Ext.Button({iconCls:"btn-upload",text:GO.lang.upload,cls:"x-btn-text-icon",menu:this.uploadMenu});if(!c.hideActionButtons){d.push(this.uploadButton);var b=deconcept.SWFObjectUtil.getPlayerVersion();if(!GO.settings.config.disable_flash_upload&&b.major>0){this.uploadMenu.add({text:GO.lang.smallUpload,handler:function(){if(!this.uploadFlashDialog){var e=Math.floor(GO.settings.config.max_file_size/1048576)+"MB";this.uploadFlashDialog=new GO.UploadFlashDialog({uploadPanel:new Ext.ux.SwfUploadPanel({post_params:{task:"upload_file"},upload_url:GO.settings.modules.files.url+"action.php",labelWidth:110,file_size_limit:e,single_file_select:false,confirm_delete:false,remove_completed:false}),title:GO.files.lang.files});this.uploadFlashDialog.on("fileUploadComplete",function(h,f,g){this.sendOverwrite({folder_id:this.folder_id,task:"overwrite"})},this)}this.uploadFlashDialog.show()},scope:this})}else{this.uploadForm=new GO.UploadPCForm({waitMsgTarget:c.id,baseParams:{task:"upload_file"},url:GO.settings.modules.files.url+"action.php",addText:GO.lang.smallUpload});this.uploadForm.on("upload",function(g,f){this.uploadMenu.hide();this.sendOverwrite({folder_id:this.folder_id,task:"overwrite"})},this);this.uploadMenu.add(this.uploadForm)}this.uploadMenu.add({text:GO.lang.largeUpload,handler:function(){GO.currentFilesStore=this.gridStore;if(!deployJava.isWebStartInstalled("1.5.0")){Ext.MessageBox.alert(GO.lang.strError,GO.lang.noJava)}else{GO.util.popup({url:GO.settings.modules.files.url+"jupload/index.php?id="+encodeURIComponent(this.folder_id),width:660,height:500,target:"jupload"})}},scope:this});d.push("-")}d.push(this.upButton);d.push({iconCls:"btn-refresh",text:GO.lang.cmdRefresh,handler:function(){this.refresh(true)},scope:this});if(!c.hideActionButtons){d.push("-");d.push(this.copyButton);d.push(this.cutButton);d.push(this.pasteButton);d.push("-");d.push(this.deleteButton);d.push("-")}d.push(this.thumbsToggle=new Ext.Button({text:GO.files.lang.thumbnails,iconCls:"btn-thumbnails",enableToggle:true,toggleHandler:function(f,g){if(g){this.cardPanel.getLayout().setActiveItem(1)}else{this.cardPanel.getLayout().setActiveItem(0)}var e=this.gridStore.reader.jsonData.thumbs=="1";if(e!=g){Ext.Ajax.request({url:GO.settings.modules.files.url+"action.php",params:{task:"set_view",id:this.folder_id,thumbs:g?"1":"0"}})}},scope:this}));if(!c.hideActionButtons){d.push("-");d.push(this.emptyListButton)}d.push(this.stateLockedButton=new Ext.Button({iconCls:"btn-settings",text:GO.files.lang.stateLocked,cls:"x-btn-text-icon",hidden:true,disabled:true,scope:this}));c.keys=[{ctrl:true,key:Ext.EventObject.C,fn:function(){var e=this.getSelectedGridRecords();this.onCutCopy("copy",e)},scope:this},{ctrl:true,key:Ext.EventObject.X,fn:function(){var e=this.getSelectedGridRecords();this.onCutCopy("cut",e)},scope:this},{ctrl:true,key:Ext.EventObject.V,fn:function(){this.onPaste()},scope:this}];c.layout="border";c.tbar=new Ext.Toolbar({cls:"go-head-tb",items:d});this.thumbsPanel=new GO.files.ThumbsPanel({store:this.gridStore});this.thumbsPanel.view.on("click",function(g,h,i,j){var f=g.store.getAt(h);this.fireEvent("fileselected",this,f)},this);this.thumbsPanel.view.on("dblclick",function(g,h,i,j){var f=g.store.getAt(h);this.fireEvent("filedblclicked",this,f);if(f.data.extension=="folder"){this.setFolderID(f.data.id,true)}else{if(this.fileClickHandler){this.fileClickHandler.call(this.scope,f)}else{GO.files.openFile(f,this.getActiveGridStore(),j)}}},this);this.thumbsPanel.view.on("contextmenu",function(f,h,i,k){if(!f.isSelected(h)){f.clearSelections();f.selectRange(h,h)}var g=f.getSelectedRecords();k.stopEvent();this.contextTreeID=i.id;var j=k.getXY();this.filesContextMenu.showAt(j,g)},this);this.thumbsPanel.on("drop",function(f,e){this.paste("cut",f,e)},this);this.cardPanel=new Ext.Panel({region:"center",layout:"card",id:c.id+"-card-panel",activeItem:0,deferredRender:false,border:false,anchor:"100% 100%",items:[this.gridPanel,this.thumbsPanel]});this.eastPanel=new Ext.Panel({region:"east",layout:"fit",collapsed:c.filePanelCollapsed,width:450,collapseMode:"mini",collapsible:true,split:true,border:false,title:"&nbsp;"});this.filePanel=new GO.files.FilePanel({id:c.id+"-file-panel",expandListenObject:this.eastPanel});this.eastPanel.add(this.filePanel);this.folderPanel=new GO.files.FolderPanel({id:c.id+"-folder-panel",hidden:true,expandListenObject:this.eastPanel});this.eastPanel.add(this.folderPanel);c.items=[this.locationPanel,this.treePanel,this.cardPanel,this.eastPanel];GO.files.FileBrowser.superclass.constructor.call(this,c);this.addEvents({fileselected:true,filedblclicked:true});this.on("fileselected",function(e,f){if(f.data.extension!="folder"){this.folderPanel.setVisible(false);this.filePanel.setVisible(true);this.filePanel.load(f.id.substr(2))}else{this.filePanel.setVisible(false);this.folderPanel.setVisible(true);this.folderPanel.load(f.id.substr(2))}},this)};Ext.extend(GO.files.FileBrowser,Ext.Panel,{fileClickHandler:false,scope:this,pasteSelections:Array(),pasteMode:"cut",path:"",saveCMState:function(a){Ext.Ajax.request({url:GO.settings.modules.files.url+"action.php",params:{task:"save_state",folder_id:this.folder_id,state:Ext.encode(a)},scope:this})},onStoreLoad:function(b){var c;if(b.reader.jsonData.lock_state&&b.reader.jsonData.cm_state!=""){c=Ext.decode(b.reader.jsonData.cm_state)}else{c=Ext.state.Manager.get(this.gridPanel.id)}if(c){this.gridPanel.applyStoredState(c);if(b.reader.jsonData.lock_state&&b.reader.jsonData.cm_state==""){this.saveCMState(c)}}this.stateLockedButton.setVisible(b.reader.jsonData.lock_state);if(!GO.util.empty(b.reader.jsonData.feedback)){alert(b.reader.jsonData.feedback)}this.path=b.reader.jsonData.path;this.setWritePermission(b.reader.jsonData.write_permission);this.thumbsToggle.toggle(b.reader.jsonData.thumbs=="1");if(this.folder_id=="new"){var a=b.reader.jsonData.num_files;var d=this.treePanel.getNodeById("new");if(d){d.setText(GO.files.lang.newFiles+" ("+a+")")}}this.emptyListButton.setVisible(this.folder_id=="new"&&a>0);if(b.reader.jsonData.refreshed){var d=this.treePanel.getNodeById(this.folder_id);if(d){delete d.attributes.children;d.reload()}}this.parentID=b.reader.jsonData.parent_id;if(this.parentID==0||!this.treePanel.getNodeById(this.parentID)){this.upButton.setDisabled(true)}else{this.upButton.setDisabled(false)}if(this.filePanel.link_id>0&&!b.getById("f:"+this.filePanel.link_id)){this.filePanel.reset()}},setFileClickHandler:function(b,a){this.fileClickHandler=b;this.scope=a},setFilesFilter:function(a){var b=this.gridStore.baseParams.files_filter;this.gridStore.baseParams.files_filter=a;if((b!=undefined)&&b!=a){this.gridStore.reload()}},afterRender:function(){GO.files.FileBrowser.superclass.afterRender.call(this);GO.files.filePropertiesDialogListeners={scope:this,rename:function(b,a){if(this.folder_id==a){this.getActiveGridStore().load()}}};GO.files.folderPropertiesDialogListeners={scope:this,save:function(b,a){this.setFolderID(a,true)},rename:function(c,b){var a=this.treePanel.getNodeById(b);if(a){delete a.attributes.children;a.reload()}}};this.buildNewMenu()},setRootID:function(b,a){this.folder_id=a;this.treeLoader.baseParams.root_folder_id=b;this.treeLoader.baseParams.expand_folder_id=a;this.rootNode.reload({callback:function(){delete this.treeLoader.baseParams.expand_folder_id},scope:this})},buildNewMenu:function(){this.newMenu.removeAll();Ext.Ajax.request({url:GO.settings.modules.files.url+"json.php",params:{task:"templates"},callback:function(b,g,a){if(!g){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{this.newMenu.add({iconCls:"btn-add-folder",text:GO.lang.folder,cls:"x-btn-text-icon",handler:this.promptNewFolder,scope:this});var f=Ext.decode(a.responseText);if(f.results.length){this.newMenu.add("-");for(var c=0;c<f.results.length;c++){var e=f.results[c];var d=new Ext.menu.Item({iconCls:"filetype filetype-"+e.extension,text:e.name,template_id:e.id,handler:function(h){this.createFileFromTemplate(h.template_id)},scope:this});this.newMenu.add(d)}}if(GO.settings.modules.files.write_permission){this.newMenu.add("-");this.newMenu.add({iconCls:"btn-templates",text:GO.files.lang.manageTemplates,cls:"x-btn-text-icon",handler:function(){if(!this.templatesWindow){this.templatesWindow=new GO.files.TemplateWindow();this.templatesWindow.gridStore.on("datachanged",function(){if(!this.templatesWindow.firstLoad){this.buildNewMenu()}},this)}this.templatesWindow.show()},scope:this})}}},scope:this})},createFileFromTemplate:function(a,c){if(!c||c==""){Ext.Msg.prompt(GO.files.lang.enterName,GO.files.lang.pleaseEnterName,function(e,d){if(e=="cancel"){return false}else{this.createFileFromTemplate(a,d)}},this)}else{var b=this.getActiveGridStore();b.baseParams.template_id=a;b.baseParams.template_name=c;b.load({callback:function(){if(b.reader.jsonData.new_id){var d=b.getById("f:"+b.reader.jsonData.new_id);GO.files.openFile(d)}},scope:this});delete b.baseParams.template_id;delete b.baseParams.template_name}},onDecompress:function(b){var d=[];for(var c=0;c<b.length;c++){d.push(b[c].data.path)}if(d.length){var a=this.getActiveGridStore();a.baseParams.decompress_sources=Ext.encode(d);a.load({callback:function(){if(!a.reader.jsonData.decompress_success){Ext.Msg.alert(GO.lang.strError,a.reader.jsonData.decompress_feedback)}},scope:this});delete a.baseParams.decompress_sources}},onCompress:function(c,b){var f=[];var e=0;if(c.length==1&&!c[0].data.path&&c[0].data.id>0){e=c[0].data.id}else{for(var d=0;d<c.length;d++){f.push(c[d].data.path)}}if(f.length||e>0){if(!b||b==""){Ext.Msg.prompt(GO.files.lang.enterName,GO.files.lang.pleaseEnterNameArchive,function(h,g){if(h=="ok"){this.onCompress(c,g)}},this)}else{var a=this.getActiveGridStore();a.baseParams.compress_sources=Ext.encode(f);a.baseParams.archive_name=b;a.baseParams.compress_id=e;a.load({callback:function(){if(!a.reader.jsonData.compress_success){Ext.Msg.alert(GO.lang.strError,a.reader.jsonData.compress_feedback)}},scope:this});delete a.baseParams.compress_sources;delete a.baseParams.archive_name;delete a.baseParams.compress_id}}else{alert("You can't compress that folder")}},getSelectedTreeRecords:function(){var d=this.treePanel.getSelectionModel();var b=d.getSelectedNodes();var a=[];for(var c=0;c<b.length;c++){a.push({data:{type_id:"d:"+b[c].id,id:b[c].id,extension:"folder"}})}return a},getSelectedGridRecords:function(){if(this.cardPanel.getLayout().activeItem.selModel){var a=this.gridPanel.getSelectionModel();return a.getSelections()}else{return this.thumbsPanel.view.getSelectedRecords()}},getActiveGridStore:function(){return this.gridStore},onCutCopy:function(b,a){this.pasteSelections=a;this.pasteMode=b;if(this.pasteSelections.length){this.pasteButton.setDisabled(false)}},onPaste:function(){this.paste(this.pasteMode,this.folder_id,this.pasteSelections)},onDelete:function(a){if(a=="tree"){var b=this.getSelectedTreeRecords();GO.deleteItems({url:GO.settings.modules.files.url+"action.php",params:{task:"delete",id:b[0].data.id},count:1,callback:function(f){if(f.success){var e=this.treePanel.getNodeById(b[0].data.id);if(e){var d=e.parentNode.id;e.remove();var c=this.treePanel.getNodeById(this.folder_id);if(!c){this.setFolderID(d)}}}},scope:this})}else{if(this.cardPanel.getLayout().activeItem.selModel){this.gridPanel.deleteSelected({callback:function(){var c=this.treePanel.getNodeById(this.folder_id);if(c){delete c.attributes.children;c.reload()}},scope:this})}else{this.thumbsPanel.deleteSelected({callback:function(){var c=this.treePanel.getNodeById(this.folder_id);if(c){delete c.attributes.children;c.reload()}},scope:this})}}},onDownloadLink:function(a){this.file_data=a[0].data;if(!this.expireDateWindow){this.expireForm=new Ext.form.FormPanel({items:[new Ext.DatePicker({itemId:"expire_time",name:"expire_time",format:GO.settings.date_format,hideLabel:true})]});this.expireDateWindow=new GO.Window({title:GO.files.lang.expireTime,height:218,width:224,layout:"fit",border:false,maximizable:true,collapsible:true,closeAction:"hide",items:[this.expireForm]});this.expireForm.items.get("expire_time").on("select",function(c,b){GO.email.showComposer({loadUrl:GO.settings.modules.files.url+"json.php",loadParams:{task:"sendfile",file_id:this.file_data.id,expire_time:parseInt(b.setDate(b.getDate())/1000)}});this.expireDateWindow.hide()},this)}this.expireDateWindow.show()},onGridNotifyOver:function(a,g,d){var f=a.getDragData(g);if(d.grid){var b=d.grid.store.data.items[f.rowIndex];if(b){if(b.data.extension=="folder"){for(var c=0;c<d.selections.length;c++){if(d.selections[c].data.id==b.data.id){return false}}return this.dropAllowed}}}return false},onGridNotifyDrop:function(a,h,f){if(f.grid){var j=f.grid.getSelectionModel();var d=j.getSelections();var g=a.getDragData(h);var b=f.grid.store.data.items[g.rowIndex];if(b.data.extension=="folder"){for(var c=0;c<f.selections.length;c++){if(f.selections[c].data.id==b.data.id){return false}}this.paste("cut",b.data.id,f.selections)}}else{return false}},onGridRowContextMenu:function(a,f,d){var b=a.getSelectionModel().getSelections();var c=d.getXY();this.filesContextMenu.showAt(c,b,"grid")},paste:function(d,a,b){var f=Array();for(var c=0;c<b.length;c++){f.push(b[c].data.type_id)}var e={task:"paste",paste_sources:Ext.encode(f),paste_destination:a,paste_mode:d,id:this.folder_id};this.sendOverwrite(e)},refresh:function(a){var b=this.treePanel.getNodeById(this.folder_id);this.treeLoader.baseParams.expand_folder_id=this.folder_id;if(a){this.treeLoader.baseParams.sync_folder_id=this.folder_id}this.expandPath=false;if(b){this.expandPath=b.getPath()}this.rootNode.reload((function(){this.treeLoader.baseParams.expand_folder_id=0;if(this.expandPath){this.treePanel.expandPath(this.expandPath)}}).createDelegate(this));if(a){delete this.treeLoader.baseParams.sync_folder_id}},sendOverwrite:function(a){if(!a.command){a.command="ask"}this.overwriteParams=a;this.getEl().mask(GO.lang.waitMsgSave);Ext.Ajax.request({url:GO.settings.modules.files.url+"action.php",params:this.overwriteParams,callback:function(n,k,e){this.getEl().unmask();var h=Ext.decode(this.overwriteParams.paste_sources);var m=this.overwriteParams.paste_destination;if(!k){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var c=Ext.decode(e.responseText);if(!c.success&&!c.file_exists){if(this.overwriteDialog){this.overwriteDialog.hide()}Ext.MessageBox.alert(GO.lang.strError,c.feedback);this.refresh()}else{if(c.file_exists){if(!this.overwriteDialog){this.overwriteDialog=new Ext.Window({width:500,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,title:GO.lang.fileExists,modal:false,buttons:[{text:GO.lang.cmdYes,handler:function(){this.overwriteParams.command="yes";this.sendOverwrite(this.overwriteParams)},scope:this},{text:GO.lang.cmdYesToAll,handler:function(){this.overwriteParams.command="yestoall";this.sendOverwrite(this.overwriteParams)},scope:this},{text:GO.lang.cmdNo,handler:function(){this.overwriteParams.command="no";this.sendOverwrite(this.overwriteParams)},scope:this},{text:GO.lang.cmdNoToAll,handler:function(){this.overwriteParams.command="notoall";this.sendOverwrite(this.overwriteParams)},scope:this},{text:GO.lang.cmdCancel,handler:function(){this.getActiveGridStore().reload();this.overwriteDialog.hide()},scope:this}]});this.overwriteDialog.render(Ext.getBody())}var l=new Ext.Template(GO.lang.overwriteFile);l.overwrite(this.overwriteDialog.body,{file:c.file_exists});this.overwriteDialog.show()}else{var j=this.getActiveGridStore();if(!m||m==this.folder_id){j.reload()}else{if(h){for(var f=0;f<h.length;f++){var g=j.getById(h[f]);if(g){j.reload();break}}}}var b=this.treePanel.getNodeById(m);if(b){b.attributes.children=[];b.attributes.childrenRendered=false;b.reload()}if(h){for(var f=0;f<h.length;f++){var d=this.treePanel.getNodeById(h[f]);if(d){d.remove()}}}if(this.overwriteDialog){this.overwriteDialog.hide()}}}}},scope:this})},promptNewFolder:function(){if(!this.newFolderWindow){this.newFolderWindow=new GO.files.NewFolderDialog();this.newFolderWindow.on("save",function(){this.getActiveGridStore().reload();var a=this.treePanel.getNodeById(this.folder_id);if(a){delete a.attributes.children;a.reload()}},this)}this.newFolderWindow.show(this.folder_id)},onGridDoubleClick:function(c,d,f){var a=c.getSelectionModel();var b=a.getSelected();this.fireEvent("filedblclicked",this,b);if(b.data.extension=="folder"){this.setFolderID(b.data.id,true)}else{if(this.fileClickHandler){this.fileClickHandler.call(this.scope,b)}else{if(this.filePanel.loading){this.onGridDoubleClick.defer(200,this,[c,d,f])}else{GO.files.openFile(b,this.getActiveGridStore(),f)}}}},setWritePermission:function(a){this.newButton.setDisabled(!a);this.deleteButton.setDisabled(!a);this.uploadButton.setDisabled(!a);this.cutButton.setDisabled(!a);this.pasteButton.setDisabled(!a||!this.pasteSelections.length)},setFolderID:function(b,a){this.folder_id=b;this.gridStore.baseParams.id=b;this.getActiveGridStore().load({callback:function(){var d=this.treePanel.getNodeById(b);if(d){this.treePanel.getSelectionModel().select(d);var c=new String();c=d.getPath("text");c=c.substring(2);this.locationTextField.setValue(c)}if(a){if(d){d.expand()}}this.focus()},scope:this})},showGridPropertiesDialog:function(){var a=this.gridPanel.getSelectionModel();var b=a.getSelections();if(b.length==0){Ext.Msg.alert(GO.lang.strError,GO.lang.noItemSelected)}else{if(b.length>1){Ext.Msg.alert(GO.lang.strError,GO.files.lang.errorOneItem)}else{this.showPropertiesDialog(b[0])}}},showPropertiesDialog:function(a){if(a.data.extension=="folder"){GO.files.showFolderPropertiesDialog(a.data.id)}else{GO.files.showFilePropertiesDialog(a.data.id)}}});GO.files.showFilePropertiesDialog=function(a){if(!GO.files.filePropertiesDialog){GO.files.filePropertiesDialog=new GO.files.FilePropertiesDialog()}if(GO.files.filePropertiesDialogListeners){GO.files.filePropertiesDialog.on(GO.files.filePropertiesDialogListeners);delete GO.files.filePropertiesDialogListeners}GO.files.filePropertiesDialog.show(a)};GO.files.showFolderPropertiesDialog=function(a){if(!GO.files.folderPropertiesDialog){GO.files.folderPropertiesDialog=new GO.files.FolderPropertiesDialog()}if(GO.files.folderPropertiesDialogListeners){GO.files.folderPropertiesDialog.on(GO.files.folderPropertiesDialogListeners);delete GO.files.folderPropertiesDialogListeners}GO.files.folderPropertiesDialog.show(a)};GO.mainLayout.onReady(function(){if(GO.workflowLinkHandlers){GO.workflowLinkHandlers[6]=function(b,a){GO.files.showFilePropertiesDialog(b+"",{loadParams:{process_file_id:a}});GO.files.filePropertiesDialog.tabPanel.setActiveTab(3)}}});GO.files.FilesObservable=function(){GO.files.FilesObservable.superclass.constructor.call(this);this.addEvents({beforeopenfile:true})};Ext.extend(GO.files.FilesObservable,Ext.util.Observable);GO.files.filesObservable=new GO.files.FilesObservable();GO.files.openFilePath=function(b){var d="";var c=b.lastIndexOf(".");if(c){d=b.substring(c,b.length)}var a={data:{path:b,extension:d}};GO.files.openFile(a)};GO.files.openFile=function(b,c,j){if(GO.files.filesObservable.fireEvent("beforeopenfile",b,c,j)){var d=b.data.id?"id":"path";switch(b.data.extension){case"bmp":case"png":case"gif":case"jpg":case"jpeg":case"xmind":if(!this.imageViewer){this.imageViewer=new GO.files.ImageViewer({closeAction:"hide"})}var g=0;var a=Array();if(c){for(var f=0;f<c.data.items.length;f++){var h=c.data.items[f].data;if(h.extension=="jpg"||h.extension=="png"||h.extension=="gif"||h.extension=="bmp"||h.extension=="jpeg"){a.push({name:h.name,src:GO.settings.modules.files.url+"download.php?mode=download&"+d+"="+h[d]})}else{if(h.extension=="xmind"){a.push({name:h.name,src:GO.settings.config.host+"controls/thumb.php?src="+h.path+"&w=600",download_path:GO.settings.modules.files.url+"download.php?mode=download&"+d+"="+h[d]})}}if(h[d]==b.data[d]){g=a.length-1}}}else{if(b.data.extension=="xmind"){a.push({name:b.data.name,src:GO.settings.config.host+"controls/thumb.php?src="+b.data.path+"&w=600",download_path:GO.settings.modules.files.url+"download.php?mode=download&"+d+"="+b.data[d]})}else{a.push({name:b.data.name,src:GO.settings.modules.files.url+"download.php?mode=download&"+d+"="+b.data[d]})}}this.imageViewer.show(a,g);break;case"php":case"js":case"docx":case"xlsx":case"pptx":case"dwg":case"doc":case"odt":case"ods":case"xls":case"ppt":case"odp":case"txt":if(d=="id"&&GO.settings.modules.gota&&GO.settings.modules.gota.read_permission){if(!GO.files.noJavaNotified&&!deployJava.isWebStartInstalled("1.6.0")){GO.files.noJavaNotified=true;Ext.MessageBox.alert(GO.lang.strError,GO.lang.noJava);window.open(GO.settings.modules.files.url+"download.php?mode=download&"+d+"="+b.data[d])}else{document.location=GO.settings.modules.gota.url+"jnlp.php?"+d+"="+b.data.id}}else{window.open(GO.settings.modules.files.url+"download.php?mode=download&"+d+"="+b.data[d])}break;case"eml":if(GO.mailings){GO.linkHandlers[9].call(this,0,{file_id:b.data.id});break}default:window.open(GO.settings.modules.files.url+"download.php?mode=download&"+d+"="+b.data[d]);break}}};GO.files.openFolder=function(b,a){if(!GO.files.fileBrowser){GO.files.fileBrowser=new GO.files.FileBrowser({id:"popupfb",border:false,treeRootVisible:true,filePanelCollapsed:true});GO.files.fileBrowserWin=new GO.Window({title:GO.files.lang.fileBrowser,height:500,width:900,layout:"fit",border:false,maximizable:true,collapsible:true,closeAction:"hide",items:GO.files.fileBrowser})}GO.files.fileBrowser.setRootID(b,a);GO.files.fileBrowserWin.show();return GO.files.fileBrowser};GO.files.createSelectFileBrowser=function(){if(!GO.selectFileBrowser){GO.selectFileBrowser=new GO.files.FileBrowser({border:false,filePanelCollapsed:true,treeCollapsed:false});GO.selectFileBrowserWindow=new GO.Window({title:GO.lang.strSelectFiles,height:500,width:750,modal:true,layout:"fit",border:false,collapsible:true,maximizable:true,closeAction:"hide",items:GO.selectFileBrowser,buttons:[{text:GO.lang.cmdOk,handler:function(){var a=GO.selectFileBrowser.getSelectedGridRecords();GO.selectFileBrowser.fileClickHandler.call(GO.selectFileBrowser.scope,a[0])},scope:this},{text:GO.lang.cmdClose,handler:function(){GO.selectFileBrowserWindow.hide()},scope:this}]})}};GO.linkHandlers[6]=function(c,a){if(!GO.files.linkFileWindow){var b=new GO.files.FilePanel();GO.files.linkFileWindow=new GO.LinkViewWindow({title:GO.files.lang.file,items:b,filePanel:b,closeAction:"hide"})}GO.files.linkFileWindow.filePanel.load(c);GO.files.linkFileWindow.show()};GO.linkPreviewPanels[6]=function(a){a=a||{};return new GO.files.FilePanel(a)};GO.linkHandlers[17]=function(c,a){if(!GO.files.linkFolderWindow){var b=new GO.files.FolderPanel();GO.files.linkFolderWindow=new GO.LinkViewWindow({title:GO.files.lang.folder,items:b,filePanel:b,closeAction:"hide"})}GO.files.linkFolderWindow.filePanel.load(c);GO.files.linkFolderWindow.show()};GO.linkPreviewPanels[17]=function(a){a=a||{};return new GO.files.FolderPanel(a)};GO.moduleManager.addModule("files",GO.files.FileBrowser,{title:GO.files.lang.files,iconCls:"go-tab-icon-files"});GO.files.FilePanel=Ext.extend(GO.DisplayPanel,{link_type:6,loadParams:{task:"file_with_items"},idParam:"file_id",loadUrl:GO.settings.modules.files.url+"json.php",noFileBrowser:true,stateId:"fs-file-panel",extraTemplateProperties:"",editGoDialogId:"file",editHandler:function(){if(GO.settings.modules.gota&&GO.settings.modules.gota.read_permission){if(!deployJava.isWebStartInstalled("1.6.0")){Ext.MessageBox.alert(GO.lang.strError,GO.lang.noJava);window.location.href=GO.settings.modules.files.url+"download.php?mode=download&id="+this.link_id}else{window.location.href=GO.settings.modules.gota.url+"jnlp.php?id="+this.link_id}}else{window.location.href=GO.settings.modules.files.url+"download.php?mode=download&id="+this.link_id}},createTopToolbar:function(){var a=GO.files.FilePanel.superclass.createTopToolbar.call(this);a.splice(1,0,{iconCls:"btn-settings",text:GO.lang.strProperties,cls:"x-btn-text-icon",handler:function(){GO.files.showFilePropertiesDialog(this.link_id+"")},scope:this});return a},reset:function(){GO.files.FilePanel.superclass.reset.call(this);this.setTitle("&nbsp;")},setData:function(a){this.setTitle(a.name);GO.files.FilePanel.superclass.setData.call(this,a)},initTemplate:function(){this.template='<table class="display-panel" cellpadding="0" cellspacing="0" border="0"><tr><td>'+GO.lang.strLocation+":</td><td>{location}</td></tr><tr><td>"+GO.lang.strType+":</td><td colspan=>{type}</td></tr><tr><td>"+GO.lang.strSize+":</td><td>{size}</td></tr><tr><td>"+GO.lang.strCtime+":</td><td>{ctime}</td></tr><tr><td>"+GO.lang.strMtime+":</td><td>{mtime}</td></tr><tpl if=\"!GO.util.empty(image_src)\"><tr><td colspan=\"2\"><img style=\"cursor:pointer;\" src=\"{image_src}\" onclick=\"javascript:GO.files.openFile(new Ext.data.Record({'name':'{image_name}','path':'{image_path}','extension':'{image_extension}','download_path':'{download_path}'}));\" /></td></tr></tpl>"+this.extraTemplateProperties+'<tpl if="!GO.util.empty(comment)"><tr><td colspan="2" class="display-panel-heading">'+GO.files.lang.comments+'</td></tr><tr><td colspan="2">{comment}</td></tr></tpl></table>';if(GO.customfields){this.template+=GO.customfields.displayPanelTemplate}if(GO.tasks){this.template+=GO.tasks.TaskTemplate}if(GO.calendar){this.template+=GO.calendar.EventTemplate}this.template+=GO.linksTemplate;Ext.apply(this.templateConfig,GO.linksTemplateConfig);if(GO.comments){this.template+=GO.comments.displayPanelTemplate}GO.files.FilePanel.superclass.initTemplate.call(this)}});GO.files.FolderPanel=Ext.extend(GO.DisplayPanel,{link_type:17,loadParams:{task:"folder_with_items"},idParam:"folder_id",loadUrl:GO.settings.modules.files.url+"json.php",noFileBrowser:true,editGoDialogId:"folder",editHandler:function(){},createTopToolbar:function(){var a=GO.files.FilePanel.superclass.createTopToolbar.call(this);a.splice(1,0,{iconCls:"btn-settings",text:GO.lang.strProperties,cls:"x-btn-text-icon",handler:function(){GO.files.showFolderPropertiesDialog(this.link_id+"")},scope:this});return a},setData:function(a){this.setTitle(a.name);this.topToolbar.items.items[0].setVisible(false);GO.files.FolderPanel.superclass.setData.call(this,a)},initTemplate:function(){this.template='<table class="display-panel" cellpadding="0" cellspacing="0" border="0"><tr><td>'+GO.lang.strLocation+":</td><td>{location}</td></tr><tr><td>"+GO.lang.strType+":</td><td>{type}</td></tr><tr><td>"+GO.lang.strCtime+":</td><td>{ctime}</td></tr><tr><td>"+GO.lang.strMtime+':</td><td>{mtime}</td></tr><tpl if="!GO.util.empty(comment)"><tr><td colspan="2" class="display-panel-heading">'+GO.files.lang.comments+'</td></tr><tr><td colspan="2">{comment}</td></tr></tpl></table>';if(GO.customfields){this.template+=GO.customfields.displayPanelTemplate}if(GO.tasks){this.template+=GO.tasks.TaskTemplate}if(GO.calendar){this.template+=GO.calendar.EventTemplate}this.template+=GO.linksTemplate;Ext.apply(this.templateConfig,GO.linksTemplateConfig);if(GO.comments){this.template+=GO.comments.displayPanelTemplate}GO.files.FolderPanel.superclass.initTemplate.call(this)}});GO.files.FilesGrid=function(a){a=a||{};a.layout="fit";a.split=true;a.paging=true;a.autoExpandColumn="name";a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;a.enableDragDrop=true;a.ddGroup="FilesDD";GO.files.FilesGrid.superclass.constructor.call(this,a)};Ext.extend(GO.files.FilesGrid,GO.grid.GridPanel,{applyStoredState:function(a){this.stateful=false;GO.files.FilesGrid.superclass.applyState.call(this,a);if(this.rendered){this.reconfigure(this.store,this.getColumnModel());this.getColumnModel().setColumnWidth(0,this.getColumnModel().getColumnWidth(0))}this.enableState.defer(500,this)},enableState:function(){this.stateful=true}});GO.files.SelectFilesDialog=function(a){if(!a){a={}}a.layout="border";a.modal=false;a.resizable=true;a.maximizable=true;a.width=600;a.height=400;a.closeAction="hide";a.title=GO.files.lang.selectFiles;this.filesGrid=new GO.files.SelectFilesGrid({region:"center",id:"fs_select_files_grid"});this.treeLoader=new Ext.tree.TreeLoader({dataUrl:GO.settings.modules.files.url+"json.php",baseParams:{task:"tree",root_folder_id:0,expand_folder_id:0},preloadChildren:true});this.treeLoader.on("beforeload",function(){var b=this.treePanel.getEl();if(b){b.mask(GO.lang.waitMsgLoad)}},this);this.treeLoader.on("load",function(){var b=this.treePanel.getEl();if(b){b.unmask()}},this);this.treePanel=new Ext.tree.TreePanel({region:"west",layout:"fit",split:true,autoScroll:true,width:200,animate:true,collapsible:true,collapseMode:"mini",loader:this.treeLoader,rootVisible:false,containerScroll:true,header:false,selModel:new Ext.tree.MultiSelectionModel()});this.rootNode=new Ext.tree.AsyncTreeNode({text:"",draggable:false,id:"root",iconCls:"folder-default"});this.rootNode.on("load",function(b){if(!this.folder_id){this.folder_id=b.childNodes[0].id}this.setFolderID(this.folder_id)},this);this.treePanel.setRootNode(this.rootNode);this.treePanel.on("click",function(b){this.setFolderID(b.id,true)},this);a.items=[this.treePanel,this.filesGrid];a.tbar=[{text:GO.lang.selectAll,handler:function(){this.filesGrid.selectAllFiles(this.root_id)},scope:this}];a.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.files.SelectFilesDialog.superclass.constructor.call(this,a);this.addEvents({save:true})};Ext.extend(GO.files.SelectFilesDialog,Ext.Window,{folder_id:0,submitForm:function(b){var a=this.filesGrid.getSelectedFiles(true);this.filesGrid.removeSelectedFiles();this.fireEvent("save",this,a);this.hide()},setRootID:function(b,a){this.folder_id=a;this.root_id=b;this.treeLoader.baseParams.root_folder_id=b;this.treeLoader.baseParams.expand_folder_id=a;this.rootNode.reload({callback:function(){delete this.treeLoader.baseParams.expand_folder_id},scope:this})},setFolderID:function(a,b){this.folder_id=a;this.filesGrid.store.baseParams.id=a;this.filesGrid.store.load({callback:function(){var c=this.treePanel.getNodeById(a);if(c){this.treePanel.getSelectionModel().select(c)}if(b&&c){c.expand()}this.focus()},scope:this})},show:function(a){this.setRootID(a);GO.files.SelectFilesDialog.superclass.show.call(this)}});GO.files.SelectFilesGrid=function(b){if(!b){b={}}b.layout="fit";b.autoScroll=true;b.split=true;this.checkColumn=new GO.grid.CheckColumn({header:"&nbsp;",dataIndex:"checked",width:20,sortable:false});this.checkColumn.on("change",function(d,e){this.changed=true},this);b.plugins=this.checkColumn;var a={fields:["type_id","id","name","type","size","mtime","extension","timestamp","thumb_url","path","acl_id"],columns:[this.checkColumn,{id:"name",header:GO.lang.strName,dataIndex:"name",renderer:function(e,g,f){var d=f.get("acl_id")>0?"folder-shared":"filetype filetype-"+f.get("extension");return'<div class="go-grid-icon '+d+'">'+e+"</div>"}},{id:"type",header:GO.lang.strType,dataIndex:"type",sortable:true,hidden:true,width:100},{id:"size",header:GO.lang.strSize,dataIndex:"size",renderer:function(d){return d=="-"?d:Ext.util.Format.fileSize(d)},hidden:true,width:100},{id:"mtime",header:GO.lang.strMtime,dataIndex:"mtime",width:120}]};b.store=new GO.data.JsonStore({url:GO.settings.modules.files.url+"json.php",baseParams:{task:"grid",show_files_only:1},root:"results",totalProperty:"total",id:"type_id",fields:a.fields,remoteSort:true});b.paging=true;var c=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:a.columns});b.cm=c;b.autoExpandColumn="name";b.view=new Ext.grid.GridView({emptyText:GO.lang.strNoItems}),b.sm=new Ext.grid.RowSelectionModel();b.loadMask=true;b.clicksToEdit=1;GO.files.SelectFilesGrid.superclass.constructor.call(this,b);this.store.on("beforeload",function(){this.getModifiedRecords()},this);this.store.on("load",function(){for(var e=0;e<this.store.data.items.length;e++){var d=this.store.data.items[e];if(this.fileSelected(d.id)){d.set("checked","1")}}},this);this.on("afteredit",this.afterEdit,this);this.on("beforeedit",this.beforeEdit,this);this.addEvents({afternoedit:true});this.on("afternoedit",this.afterNoEdit,this)};Ext.extend(GO.files.SelectFilesGrid,GO.grid.EditorGridPanel,{changed:false,selectedFiles:[],selectFile:function(b){var a=b.substr(0,1);if(a=="f"){this.selectedFiles.push(b)}},deselectFile:function(b){for(var a=0;a<this.selectedFiles.length;a++){if(this.selectedFiles[a]==b){this.selectedFiles.splice(a,1)}}},fileSelected:function(b){for(var a=0;a<this.selectedFiles.length;a++){if(this.selectedFiles[a]==b){return true}}return false},getModifiedRecords:function(){var b=this.store.getModifiedRecords();for(var c=0;c<b.length;c++){var a=b[c];if(a.data.checked=="1"){if(!this.fileSelected(a.id)){this.selectFile(a.id)}}else{this.deselectFile(a.id)}}},getSelectedFiles:function(a){if(a){this.getModifiedRecords()}return this.selectedFiles},removeSelectedFiles:function(){this.selectedFiles=[];this.store.rejectChanges()},selectAllFiles:function(a){Ext.Ajax.request({url:GO.settings.modules.files.url+"json.php",params:{task:"get_all_file_ids",folder_id:a},callback:function(c,e,b){var d=Ext.decode(b.responseText);if(d.success&&d.results){this.selectedFiles=d.results;this.store.reload()}},scope:this})},iconRenderer:function(c,a,b){return'<div class="'+b.data.iconCls+'"></div>'},onEditComplete:function(b,d,a){GO.billing.DeliveriesGrid.superclass.onEditComplete.call(this,b,d,a);if(a!="undefined"&&String(d)===String(a)){var c=b.record;var g=this.colModel.getDataIndex(b.col);d=this.postEditValue(d,a,c,g);var f={grid:this,record:c,field:g,originalValue:a,value:d,row:b.row,column:b.col,cancel:false};this.fireEvent("afternoedit",f)}},afterNoEdit:function(a){a.record.set(a.field,this.currentOriginalValue)},afterEdit:function(b){this.changed=true;b.record.set(b.field,GO.util.unlocalizeNumber(b.value));var a=b.record.data},beforeEdit:function(d){var b=d.record.id.substr(0,1);if(b=="f"){return false}else{var c=this.colModel.getColumnId(d.column);var a=this.colModel.getColumnById(c);this.currentOriginalValue=d.value;if(a&&a.editor&&a.editor.decimals){d.record.set(d.field,GO.util.numberFormat(d.value))}}},numberRenderer:function(a){return GO.util.numberFormat(a)}});