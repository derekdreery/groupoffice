GO.moduleManager.onModuleReady("email",function(){Ext.override(GO.email.MessagePanel,{initComponent:GO.email.MessagePanel.prototype.initComponent.createSequence(function(){this.on("load",function(c,f,a,e,b){if(b){GO.smime.passwordsInSession[e.account_id]=true}if(e.smime_encrypted){var d=this.body.down(".message-header").createChild({html:GO.smime.lang.messageEncrypted,style:"margin:4px 0px"})}if(e.smime_signed){var d=this.body.down(".message-header").createChild({html:GO.smime.lang.messageSigned,style:"cursor:pointer;text-decoration:underline;margin:4px 0px"});d.on("click",function(){if(!this.certWin){this.certWin=new GO.Window({title:GO.smime.lang.smimeCert,width:500,height:300,closeAction:"hide",layout:"fit",items:[this.certPanel=new Ext.Panel({bodyStyle:"padding:10px"})]})}this.certWin.show();if(!this.data.path){this.data.path=""}this.certPanel.load(GO.settings.modules.smime.url+"verify.php?uid="+this.uid+"&account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&filepath="+this.data.path)},this)}})})})});GO.moduleManager.onModuleReady("email",function(){Ext.override(GO.email.AccountDialog,{initComponent:GO.email.AccountDialog.prototype.initComponent.createInterceptor(function(){this.propertiesPanel.fileUpload=true;this.propertiesPanel.bodyCfg.enctype="multipart/form-data";this.smimePanel=new Ext.Panel({cls:"go-form-panel",title:GO.smime.lang.settings,disabled:true,items:[{xtype:"fieldset",labelWidth:160,title:GO.smime.lang.pkcs12Cert,items:[{xtype:"label",html:GO.smime.lang.pkcs12CertInfo},{xtype:"textfield",fieldLabel:GO.settings.config.product_name+" "+GO.lang.strPassword,inputType:"password",name:"smime_password",width:200},this.uploadFile=new GO.form.UploadFile({addText:GO.smime.lang.selectPkcs12Cert,inputName:"cert",max:1}),this.deleteCert=new Ext.form.Checkbox({boxLabel:GO.smime.lang.deleteCert,labelSeparator:"",name:"delete_cert",allowBlank:true,hideLabel:true,disabled:true})]},{xtype:"checkbox",hideLabel:true,boxLabel:GO.smime.lang.alwaysSign,name:"always_sign"}]});this.tabPanel.add(this.smimePanel);this.on("show",function(){this.smimePanel.setDisabled(true)},this);this.propertiesPanel.form.on("actioncomplete",function(a,b){if(b.type=="submit"){this.uploadFile.clearQueue();this.deleteCert.setDisabled(!b.result.cert)}else{this.smimePanel.setDisabled(false);this.deleteCert.setDisabled(!b.result.data.cert)}},this)})})});Ext.ns("GO.smime");GO.smime.passwordsInSession={};GO.moduleManager.onModuleReady("email",function(){Ext.override(GO.email.EmailComposer,{initComponent:GO.email.EmailComposer.prototype.initComponent.createSequence(function(){this.optionsMenu.add(["-",this.signCheck=new Ext.menu.CheckItem({text:GO.smime.lang.sign,checked:false,listeners:{checkchange:function(a,b){this.sendParams.sign_smime=b?"1":"0"},scope:this}}),this.encryptCheck=new Ext.menu.CheckItem({text:GO.smime.lang.encrypt,checked:false,listeners:{checkchange:function(a,b){this.sendParams.encrypt_smime=b?"1":"0"},scope:this}})]);this.on("afterShowAndLoad",function(){this.signCheck.setChecked(false);this.encryptCheck.setChecked(false);this.sendParams.encrypt_smime="0";this.sendParams.sign_smime="0";this.checkSmimeSupport()},this);this.fromCombo.on("change",function(){this.checkSmimeSupport()},this);this.on("beforesendmail",this.askPassword,this)}),askPassword:function(){if(!GO.smime.passwordsInSession[this.fromCombo.getValue()]&&this.sendParams.sign_smime=="1"){if(!this.passwordDialog){this.passwordDialog=new GO.dialog.PasswordDialog({title:GO.smime.lang.enterPassword,fn:function(b,a){if(b=="cancel"){return false}Ext.Ajax.request({url:GO.settings.modules.smime.url+"checkpassword.php",success:function(c){var d=Ext.decode(c.responseText);if(d.success){GO.smime.passwordsInSession[this.fromCombo.getValue()]=true;this.sendMail()}else{this.askPassword()}},params:{account_id:this.fromCombo.getValue(),password:a},scope:this})},scope:this})}this.passwordDialog.show();return false}else{return true}},checkSmimeSupport:function(){var b=this.fromCombo.getValue();var a=this.fromCombo.store.getById(b);this.signCheck.setDisabled(!a.json.has_smime_cert);if(a.json.has_smime_cert&&a.json.always_sign=="1"){this.signCheck.setChecked(true);this.sendParams.sign_smime="1"}if(!a.json.has_smime_cert){this.signCheck.setChecked(false);this.sendParams.sign_smime="0"}}})});