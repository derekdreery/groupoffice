Ext.namespace("GO.projects.stores");GO.projects.stores.bookableProjects=new GO.data.JsonStore({url:GO.settings.modules.projects.url+"json.php",baseParams:{task:"projects",auth_type:"book"},root:"results",totalProperty:"total",id:"id",fields:["id","name"]});GO.projects.stores.bookableProjects.on("load",function(){GO.projects.stores.bookableProjects.loaded=true;GO.projects.enableHoursPanel()},this);GO.projects.stores.readableFees=new GO.data.JsonStore({url:GO.settings.modules.projects.url+"json.php",baseParams:{task:"fees",auth_type:"read"},root:"results",totalProperty:"total",id:"id",fields:["id","name"]});GO.projects.stores.readableFees.on("load",function(){GO.projects.stores.readableFees.loaded=true;GO.projects.enableHoursPanel()},this);GO.projects.enableHoursPanel=function(){var A=GO.projects.stores.readableFees.getCount()>0&&GO.projects.stores.bookableProjects.getCount()>0;GO.projects.addHoursPanel.setDisabled(!A)};GO.projects.HoursGrid=function(A){if(!A){A={}}A.store=new GO.data.JsonStore({url:GO.settings.modules.projects.url+"json.php",baseParams:{task:"hours"},root:"results",totalProperty:"total",id:"id",fields:["id","units","user_name","date","fee_name","comments","project_name"]});if(A.project_id){this.setProjectId(A.project_id)}A.paging=true;A.columns=[{header:GO.lang.strHours,dataIndex:"units",width:30},{header:GO.projects.lang.project,dataIndex:"project_name"},{header:GO.lang.strUser,dataIndex:"user_name"},{header:GO.lang.strDate,dataIndex:"date"},{header:GO.projects.lang.fee,dataIndex:"fee_name"}];A.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.projects.lang.noHours,enableRowBody:true,showPreview:true,getRowClass:function(B,E,D,C){if(this.showPreview){D.body='<p class="pm-hours-comments">'+B.data.comments+"</p>";return"x-grid3-row-expanded"}return"x-grid3-row-collapsed"}}),A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;A.tbar=[{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected()},scope:this}];GO.projects.HoursGrid.superclass.constructor.call(this,A)};Ext.extend(GO.projects.HoursGrid,GO.grid.GridPanel,{project_id:0,loaded_project_id:0,afterRender:function(){GO.projects.HoursGrid.superclass.afterRender.call(this);this.on("rowdblclick",function(A,B,C){if(!this.hoursDialog){this.hoursPanel=new GO.projects.AddHoursPanel();this.hoursPanel.on("save",function(){this.hoursDialog.hide();this.store.reload()},this);this.hoursDialog=new Ext.Window({title:GO.lang.strHours,width:600,autoHeight:true,items:this.hoursPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.hoursPanel.submit()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hoursDialog.hide()},scope:this}]})}this.hoursDialog.show();this.hoursPanel.setHoursId(A.selModel.selections.keys[0])},this)},onShow:function(){GO.projects.HoursGrid.superclass.onShow.call(this);if(this.loaded_project_id!=this.project_id){this.loaded_project_id=this.project_id;this.store.load()}},setProjectId:function(A){this.project_id=A;this.store.baseParams.project_id=A}});GO.projects.AddHoursPanel=function(C){if(!C){C={}}this.unitsField=new GO.form.NumberField({name:"units",width:40,allowBlank:false,fieldLabel:GO.projects.lang.units,value:GO.util.numberFormat("0",2,GO.settings.decimal_seperator,GO.settings.thousands_seperator)});var D=new Ext.form.TextArea({name:"comments",anchor:"100%",height:"100",allowBlank:true,fieldLabel:GO.lang.strDescription});var B=new Date();var A=new Ext.form.DateField({name:"date",anchor:"100%",format:GO.settings.date_format,allowBlank:false,fieldLabel:GO.lang.strDate,value:B.format(GO.settings.date_format)});this.selectProject=new GO.projects.SelectProject({anchor:"100%"});this.selectFee=new GO.projects.SelectFee({anchor:"100%"});C.layout="column",C.cls="go-form-panel";C.baseParams={task:"hours_entry"};C.defaults={border:false};C.items=[{layout:"form",columnWidth:0.5,items:[this.unitsField,A,this.selectProject,this.selectFee]},{layout:"form",columnWidth:0.5,items:[D]}];if(C.saveButton){C.items.push({columnWidth:1,layout:"form",bodyStyle:"padding:0 0 5px 5px",items:C.saveButton})}C.waitMsgTarget=true;GO.projects.AddHoursPanel.superclass.constructor.call(this,C);this.addEvents({save:true})};Ext.extend(GO.projects.AddHoursPanel,Ext.form.FormPanel,{submit:function(){this.form.submit({url:GO.settings.modules.projects.url+"action.php",params:{task:"save_hours"},waitMsg:GO.lang.waitMsgSave,success:function(A,B){this.reset();this.fireEvent("save",this)},failure:function(A,B){Ext.MessageBox.alert(GO.lang.strError,B.result.feedback)},scope:this})},load:function(){GO.projects.AddHoursPanel.superclass.load.call(this,{url:GO.settings.modules.projects.url+"json.php",waitMsg:GO.lang.waitMsgLoad,success:function(A,B){this.selectProject.setRemoteText(B.result.data.project_name)},failure:function(A,B){Ext.Msg.alert(GO.lang.strError,B.result.feedback)},scope:this})},reset:function(){this.form.reset();this.selectProject.selectFirst();this.selectFee.selectFirst()},setHoursId:function(A){this.form.baseParams.hours_id=A;this.hours_id=A;this.load()}});GO.projects.HoursPanel=function(A){if(!A){A={}}var B=new Ext.Button({text:GO.lang.cmdAdd,handler:function(){this.addHoursPanel.submit()},scope:this});this.addHoursPanel=GO.projects.addHoursPanel=new GO.projects.AddHoursPanel({region:"north",height:180,title:GO.projects.lang.timeTracking,split:true,border:true,collapsible:true,disabled:true,saveButton:B});this.addHoursPanel.on("save",function(){this.hoursGrid.store.reload()},this);this.hoursGrid=new GO.projects.HoursGrid({region:"center",border:true});A.layout="border";A.items=[this.addHoursPanel,this.hoursGrid];GO.projects.HoursPanel.superclass.constructor.call(this,A)};Ext.extend(GO.projects.HoursPanel,Ext.Panel);GO.projects.MSGrid=function(A){if(!A){A={}}A.store=new GO.data.JsonStore({url:GO.settings.modules.projects.url+"json.php",baseParams:{task:"milestones"},root:"results",totalProperty:"total",id:"id",fields:["id","completed","completion_time","name","user_name","due_time","project_name","description","project_id","late"],remoteSort:true});if(A.project_id){this.setProjectId(A.project_id)}var B=new GO.grid.CheckColumn({header:"",dataIndex:"completed",width:30,sortable:false,header:'<div class="tasks-complete-icon"></div>'});B.on("change",function(C,D){this.store.baseParams.completed_milestone_id=C.data.id;this.store.baseParams.checked=D;this.store.load();delete this.store.baseParams.completed_task_id;delete this.store.baseParams.checked},this);A.plugins=B;A.autoExpandColumn=1;A.paging=true;A.columns=[B,{header:GO.lang.strName,dataIndex:"name",sortable:true,renderer:function(E,D,C){if(C.data.late){D.css="projects-late-cell"}else{if(C.data.completed){D.css="projects-completed-cell"}}return E}},{header:GO.lang.strUser,dataIndex:"user_name",width:120},{header:GO.projects.lang.due,dataIndex:"due_time",width:100,sortable:true},{header:GO.projects.lang.completionTime,dataIndex:"completion_time",width:100,sortable:true}];A.view=new Ext.grid.GridView({emptyText:GO.projects.lang.noMilestones,enableRowBody:true,showPreview:true,getRowClass:function(C,F,E,D){if(this.showPreview){E.body='<p class="pm-hours-comments">'+C.data.description+"</p>";return"x-grid3-row-expanded"}return"x-grid3-row-collapsed"}}),A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;A.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.msDialog.show()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected()},scope:this}];this.msDialog=new GO.projects.MSDialog();this.msDialog.on("save",function(){this.store.reload()},this);GO.projects.MSGrid.superclass.constructor.call(this,A)};Ext.extend(GO.projects.MSGrid,GO.grid.GridPanel,{project_id:0,loaded_project_id:0,afterRender:function(){GO.projects.MSGrid.superclass.afterRender.call(this);this.on("rowdblclick",function(A,B,C){this.msDialog.show({milestone_id:A.selModel.selections.keys[0]})},this)},setProjectId:function(A){this.project_id=A;this.store.baseParams.project_id=A;this.msDialog.msPanel.setProjectId(A);if(this.loaded_project_id!=this.project_id){this.loaded_project_id=this.project_id;this.store.load()}}});GO.projects.AddMSPanel=function(D){if(!D){D={}}var A=new Ext.form.TextField({name:"name",anchor:"100%",allowBlank:true,fieldLabel:GO.lang.strName});var E=new Ext.form.TextArea({name:"description",anchor:"100%",height:"70",allowBlank:true,fieldLabel:GO.lang.strDescription});var C=new Date();var B=new Ext.form.DateField({name:"due_date",anchor:"100%",format:GO.settings.date_format,allowBlank:false,fieldLabel:"Due",value:C.format(GO.settings.date_format)});this.selectUser=new GO.form.SelectUser({fieldLabel:GO.projects.lang.responsible,anchor:"100%"});D.layout="column",D.baseParams={task:"milestone"};D.defaults={border:false};D.autoHeight=true;D.items=[{layout:"form",columnWidth:0.5,cls:"go-form-panel",items:[A,this.selectUser,B]},{layout:"form",columnWidth:0.5,cls:"go-form-panel",items:[E]}];if(D.saveButton){D.items.push({columnWidth:1,layout:"form",bodyStyle:"padding:0 0 5px 5px",items:D.saveButton})}D.waitMsgTarget=true;GO.projects.AddMSPanel.superclass.constructor.call(this,D);this.addEvents({save:true})};Ext.extend(GO.projects.AddMSPanel,Ext.form.FormPanel,{submit:function(){this.form.submit({url:GO.settings.modules.projects.url+"action.php",params:{task:"save_milestone"},waitMsg:GO.lang.waitMsgSave,success:function(A,B){this.reset();this.fireEvent("save",this)},failure:function(A,B){Ext.MessageBox.alert(GO.lang.strError,B.result.feedback)},scope:this})},load:function(){GO.projects.AddMSPanel.superclass.load.call(this,{url:GO.settings.modules.projects.url+"json.php",waitMsg:GO.lang.waitMsgLoad,success:function(A,B){this.form.baseParams.project_id=B.result.data.project_id;this.selectUser.setRemoteText(B.result.data.user_name)},failure:function(A,B){Ext.Msg.alert(GO.lang.strError,B.result.feedback)},scope:this})},reset:function(){this.form.reset()},setMSId:function(A){this.form.baseParams.milestone_id=A;this.ms_id=A;if(this.ms_id>0){this.load()}},setProjectId:function(A){this.form.baseParams.project_id=A;this.project_id=A}});GO.projects.MSPanel=function(A){if(!A){A={}}var B=new Ext.Button({text:GO.lang.cmdAdd,handler:function(){this.addMSPanel.submit()},scope:this});this.addMSPanel=new GO.projects.AddMSPanel({region:"north",autoHeight:true,split:true,border:true,saveButton:B});this.addMSPanel.on("save",function(){this.msGrid.store.reload()},this);this.msGrid=new GO.projects.MSGrid({region:"center",border:true});A.layout="border";A.items=[this.addMSPanel,this.msGrid];GO.projects.MSPanel.superclass.constructor.call(this,A)};Ext.extend(GO.projects.MSPanel,Ext.Panel,{setProjectId:function(A){this.project_id=A;this.addMSPanel.setProjectId(A);this.msGrid.setProjectId(A)}});GO.projects.MSDialog=function(A){if(!A){A={}}this.msPanel=new GO.projects.AddMSPanel();this.msPanel.on("save",function(){this.hide();this.fireEvent("save")},this);var B=function(){this.unitsField.focus()};A.maximizable=true;A.layout="fit";A.modal=false;A.resizable=false;A.width=600;A.autoHeight=true;A.closeAction="hide";A.title=GO.projects.lang.milestone;A.items=this.msPanel;A.buttons=[{text:GO.lang.cmdOk,handler:function(){this.msPanel.submit()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.projects.MSDialog.superclass.constructor.call(this,A);this.addEvents({save:true})};Ext.extend(GO.projects.MSDialog,Ext.Window,{show:function(A){if(!this.rendered){this.render(Ext.getBody())}if(!A){A={}}if(!A.milestone_id){A.milestone_id=0}this.msPanel.setMSId(A.milestone_id);GO.projects.MSDialog.superclass.show.call(this)}});GO.projects.SummaryPanel=Ext.extend(Ext.Panel,{initComponent:function(){this.layout="border";this.store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({totalProperty:"count",root:"results",id:"id",fields:["id","name","customer","description","items"]}),baseParams:{task:"summary"},proxy:new Ext.data.HttpProxy({url:GO.settings.modules.projects.url+"json.php"}),groupField:"customer",sortInfo:{field:"id",direction:"DESC"},remoteSort:true});this.centerPanel=new GO.grid.GridPanel({title:GO.projects.lang.activeProjects,region:"center",store:this.store,columns:[{header:GO.projects.lang.project,dataIndex:"customer",width:120},{header:GO.lang.strName,dataIndex:"name",sortable:true,renderer:function(C,B,A){if(A.data.late){B.css="projects-late-cell"}else{if(A.data.completed){B.css="projects-completed-cell"}}return C}}],view:new Ext.grid.GroupingView({autoFill:true,forceFit:true,hideGroupedColumn:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})',emptyText:GO.projects.lang.noProjects,showGroupName:false,enableRowBody:true,showPreview:true,getRowClass:function(A,D,C,B){if(this.showPreview&&A.data.description.length){C.body=A.data.description;return"x-grid3-row-expanded"}return"x-grid3-row-collapsed"}}),sm:new Ext.grid.RowSelectionModel({singleSelect:true}),loadMask:true});this.centerPanel.on("rowclick",function(C){var A=C.getSelectionModel();var B=A.getSelected();this.projectPanel.loadProject(B.id)},this);this.projectPanel=new GO.projects.ProjectPanel({title:GO.projects.lang.projectInfo,region:"east",width:400,split:true});this.projectPanel.on("milestonecheck",function(A,B){var C=Ext.get("pm-sum-milestone-"+A);if(B){C.addClass("projects-completed")}else{C.removeClass("projects-completed")}},this);this.items=[this.centerPanel,this.projectPanel];GO.projects.SummaryPanel.superclass.initComponent.call(this)},afterRender:function(){this.store.load();GO.projects.SummaryPanel.superclass.afterRender.call(this)}});GO.projects.ProjectDialog=function(A){if(!A){A={}}this.linksPanel=new GO.grid.LinksPanel({title:GO.lang.strLinks});if(GO.files){this.fileBrowser=new GO.files.FileBrowser({title:GO.lang.strFiles,treeRootVisible:true,treeCollapsed:true,disabled:true})}this.buildForm();var B=function(){this.nameField.focus()};A.iconCls="go-module-icon-projects";A.maximizable=true;A.layout="fit";A.modal=false;A.resizable=false;A.width=700;A.height=500;A.closeAction="hide";A.title=GO.projects.lang.project;A.items=this.formPanel;A.focus=B.createDelegate(this);A.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.projects.ProjectDialog.superclass.constructor.call(this,A);this.addEvents({save:true})};Ext.extend(GO.projects.ProjectDialog,Ext.Window,{show:function(A){if(!this.rendered){this.render(Ext.getBody())}if(!A){A={}}this.propertiesPanel.show();if(!A.project_id){A.project_id=0}this.setProjectId(A.project_id);if(A.project_id>0){this.formPanel.load({url:GO.settings.modules.projects.url+"json.php",waitMsg:GO.lang.waitMsgLoad,success:function(B,C){this.setValues(A.values);if(GO.files){this.fileBrowser.setRootPath(C.result.data.files_path);this.fileBrowser.setDisabled(false)}this.setWritePermission(C.result.data.write_permission);this.readPermissionsTab.setAcl(C.result.data.acl_read);this.writePermissionsTab.setAcl(C.result.data.acl_write);this.bookPermissionsTab.setAcl(C.result.data.acl_book);GO.projects.ProjectDialog.superclass.show.call(this)},failure:function(B,C){Ext.Msg.alert(GO.lang.strError,C.result.feedback)},scope:this})}else{this.formPanel.form.reset();this.linksPanel.setDisabled(true);this.setWritePermission(true);if(GO.files){this.fileBrowser.setDisabled(true)}this.setValues(A.values);GO.projects.ProjectDialog.superclass.show.call(this)}},setWritePermission:function(A){this.buttons[0].setDisabled(!A);this.buttons[1].setDisabled(!A);this.linksPanel.setWritePermission(A)},setValues:function(A){if(A){for(var B in A){var C=this.formPanel.form.findField(B);if(C){C.setValue(A[B])}}}},setProjectId:function(A){this.formPanel.form.baseParams.project_id=A;this.project_id=A;this.linksPanel.loadLinks(A,5);this.msPanel.setProjectId(A)},submitForm:function(A){this.formPanel.form.submit({url:GO.settings.modules.projects.url+"action.php",params:{task:"save_project"},waitMsg:GO.lang.waitMsgSave,success:function(B,C){this.fireEvent("save",this);if(A){this.hide()}else{if(C.result.project_id){this.setProjectId(C.result.project_id);if(GO.files&&C.result.files_path){this.fileBrowser.setRootPath(C.result.files_path);this.fileBrowser.setDisabled(false)}this.readPermissionsTab.setAcl(C.result.acl_read);this.writePermissionsTab.setAcl(C.result.acl_write);this.bookPermissionsTab.setAcl(C.result.acl_book)}}},failure:function(B,C){if(C.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,C.result.feedback)}},scope:this})},buildForm:function(){B=[this.nameField=new Ext.form.TextField({name:"name",anchor:"100%",allowBlank:false,fieldLabel:GO.lang.strSubject})];if(GO.addressbook){var A=new GO.addressbook.SelectCompany({anchor:"100%",fieldLabel:GO.lang.customer,name:"customer"});B.push(A)}var D=new Ext.form.TextArea({name:"description",anchor:"100%",height:100,allowBlank:true,fieldLabel:GO.lang.strDescription});B.push(D);var E=new Ext.form.Checkbox({boxLabel:GO.projects.lang.archiveProject,name:"archived",checked:false,width:"auto",labelSeparator:"",hideLabel:true});B.push(E);this.propertiesPanel=new Ext.Panel({url:GO.settings.modules.projects.url+"action.php",border:false,baseParams:{task:"project"},title:GO.lang.strProperties,cls:"go-form-panel",layout:"form",autoScroll:true,items:B});this.msPanel=new GO.projects.MSGrid({title:GO.projects.lang.milestones});this.readPermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strReadPermissions});this.writePermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strWritePermissions});this.bookPermissionsTab=new GO.grid.PermissionsPanel({title:GO.projects.lang.bookPermission});var B=[this.propertiesPanel,this.msPanel,this.linksPanel];if(GO.files){B.push(this.fileBrowser)}B.push(this.readPermissionsTab);B.push(this.writePermissionsTab);B.push(this.bookPermissionsTab);if(GO.customfields&&GO.customfields.types["5"]){for(var C=0;C<GO.customfields.types["5"].panels.length;C++){B.push(GO.customfields.types["5"].panels[C])}}this.tabPanel=new Ext.TabPanel({activeTab:0,deferredRender:false,border:false,items:B,anchor:"100% 100%"});this.formPanel=new Ext.form.FormPanel({url:GO.settings.modules.projects.url+"action.php",border:false,baseParams:{task:"project"},items:this.tabPanel})}});GO.projects.ProjectsPanel=function(A){if(!A){A={}}A.store=new GO.data.JsonStore({url:GO.settings.modules.projects.url+"json.php",baseParams:{task:"projects"},root:"results",totalProperty:"total",id:"id",fields:["id","name","description"]});A.store.on("load",function(){GO.projects.stores.bookableProjects.reload()});A.paging=true,A.autoExpandColumn=1;A.autoExpandMax=2500;A.enableColumnHide=false;A.enableColumnMove=false;A.columns=[{header:GO.lang.strName,dataIndex:"name",width:200},{header:GO.lang.strDescription,dataIndex:"description"}];A.view=new Ext.grid.GridView({emptyText:GO.projects.lang.noProjects}),A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;A.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){if(GO.projects.max_projects>0&&this.store.totalLength>=GO.projects.max_projects){Ext.Msg.alert(GO.lang.strError,GO.projects.lang.maxProjectsReached)}else{GO.projects.projectDialog.show()}},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected()},scope:this}];if(GO.projects.max_projects>0){A.bbar=new Ext.PagingToolbar({store:A.store,pageSize:parseInt(GO.settings.max_rows_list),displayInfo:true,displayMsg:GO.lang.displayingItems+". "+GO.lang.strMax+" "+GO.projects.max_projects,emptyMsg:GO.lang.strNoItems})}GO.projects.ProjectsPanel.superclass.constructor.call(this,A)};Ext.extend(GO.projects.ProjectsPanel,GO.grid.GridPanel,{afterRender:function(){GO.projects.ProjectsPanel.superclass.afterRender.call(this);GO.projects.projectDialog.on("save",function(){this.store.reload()},this);this.on("rowdblclick",function(A,B,C){GO.projects.projectDialog.show({project_id:A.selModel.selections.keys[0]})},this);this.store.load()}});GO.projects.ProjectPanel=function(A){Ext.apply(this,A);this.autoScroll=true;this.newMenuButton=new GO.NewMenuButton();this.tbar=[this.editButton=new Ext.Button({iconCls:"btn-edit",text:GO.lang.cmdEdit,cls:"x-btn-text-icon",handler:function(){GO.projects.projectDialog.show({project_id:this.data.id})},scope:this,disabled:true}),{iconCls:"btn-link",cls:"x-btn-text-icon",text:GO.lang.cmdBrowseLinks,handler:function(){GO.linkBrowser.show({link_id:this.data.id,link_type:"5",folder_id:"0"})},scope:this},this.newMenuButton];GO.projects.ProjectPanel.superclass.constructor.call(this)};Ext.extend(GO.projects.ProjectPanel,Ext.Panel,{afterRender:function(){GO.projects.ProjectPanel.superclass.afterRender.call(this);this.body.on("click",this.onBodyClick,this)},initComponent:function(){var B='<div><table class="display-panel" cellpadding="0" cellspacing="0" border="0"><tr><td colspan="2" class="display-panel-heading">'+GO.projects.lang.informationAbout+' <b>{name}</b></td></tr><tr><td colspan="2" class="display-panel-description">{description}</td></tr><tpl if="customer.length"><tr><td>'+GO.lang.customer+':</td><td>{customer}</b></td></tr></tpl></table><tpl if="milestones.length"><table class="display-panel" cellpadding="0" cellspacing="0" border="0"><tr><td colspan="4" class="display-panel-heading">'+GO.projects.lang.milestones+'</td></tr><tr><td class="table_header_links" style="width:16px">&nbsp;</td><td class="table_header_links">'+GO.lang.strName+'</td><td class="table_header_links">'+GO.projects.lang.assignedTo+'</td><td class="table_header_links">'+GO.projects.lang.due+'</td></tr><tpl for="milestones"><tr id="pm-milestone-row-{id}" class="{[this.getClass(values)]}"><td style="width:16px"><input id="pm-milestone-cb-{id}" type="checkbox" {[ values.completed ? "checked" : "" ]} /></td><td><div class="projects-milestone">{name}</div></td><td>{user_name}</td><td>{due_time}</td></tr><tpl if="description.length"><tr><td></td><td colspan="3" class="project-item-description">{description}</td></tr></tpl></tpl></tpl>'+GO.linksTemplate;if(GO.customfields){B+=GO.customfields.displayPanelTemplate}var A={getClass:function(D){var C="";var F=new Date();var E=Date.parseDate(D.due_time,GO.settings.date_format);if(E<F){C="projects-late "}if(D.completed){C+="projects-completed"}return C}};if(GO.files){Ext.apply(A,GO.files.filesTemplateConfig);B+=GO.files.filesTemplate}Ext.apply(A,GO.linksTemplateConfig);B+="</div>";this.template=new Ext.XTemplate(B,A);this.addEvents({milestonecheck:true});GO.projects.ProjectPanel.superclass.initComponent.call(this)},loadProject:function(A){this.body.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.projects.url+"json.php",params:{task:"project_with_items",project_id:A},callback:function(C,E,B){this.body.unmask();if(!E){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var D=Ext.decode(B.responseText);this.setData(D.data)}},scope:this})},onBodyClick:function(C,B){if(B.tagName=="INPUT"){C.preventDefault();var E=B.id;var A=E.replace("pm-milestone-cb-","");var D=Ext.get(E.replace("cb","row"));Ext.Ajax.request({url:GO.settings.modules.projects.url+"action.php",params:{task:"check_milestone",milestone_id:A,checked:B.checked},callback:function(H,J,F){try{if(!J){throw GO.lang.strRequestError}var I=Ext.decode(F.responseText);if(!I.success){throw I.feedback}if(!B.checked){D.addClass("projects-completed");B.checked=true}else{D.removeClass("projects-completed");B.checked=false}this.fireEvent("milestonecheck",A,B.checked)}catch(G){Ext.MessageBox.alert(GO.lang.strError,G)}},scope:this})}},setData:function(A){this.data=A;this.editButton.setDisabled(!A.write_permission);if(A.write_permission){this.newMenuButton.setLinkConfig({id:this.data.id,type:5,text:this.data.name,callback:function(){this.loadProject(this.data.id)},scope:this})}this.template.overwrite(this.body,A)}});GO.projects.SelectProject=function(A){Ext.apply(this,A);if(!this.company_name){this.company_name=""}this.store=GO.projects.stores.bookableProjects;GO.projects.SelectProject.superclass.constructor.call(this,{displayField:"name",hiddenName:"project_id",valueField:"id",triggerAction:"all",mode:"local",editable:false,selectOnFocus:true,forceSelection:true,typeAhead:true,fieldLabel:GO.projects.lang.project})};Ext.extend(GO.projects.SelectProject,GO.form.ComboBox,{afterRender:function(){GO.projects.SelectProject.superclass.afterRender.call(this);this.store.load({callback:function(){this.selectFirst()},scope:this},this)}});GO.projects.SelectFee=function(A){Ext.apply(this,A);if(!this.company_name){this.company_name=""}this.store=GO.projects.stores.readableFees;GO.projects.SelectFee.superclass.constructor.call(this,{displayField:"name",hiddenName:"fee_id",valueField:"id",triggerAction:"all",mode:"local",editable:false,selectOnFocus:true,forceSelection:true,typeAhead:true,fieldLabel:GO.projects.lang.fee})};Ext.extend(GO.projects.SelectFee,GO.form.ComboBox,{afterRender:function(){GO.projects.SelectFee.superclass.afterRender.call(this);this.store.load({callback:function(){this.selectFirst()},scope:this},this)}});GO.projects.FeesGrid=function(A){if(!A){A={}}A.store=new GO.data.JsonStore({url:GO.settings.modules.projects.url+"json.php",baseParams:{task:"writable_fees"},root:"results",totalProperty:"total",id:"id",fields:["id","name","internal_value","external_value","time"],remoteSort:true});A.store.on("load",function(){GO.projects.stores.readableFees.reload()});A.autoExpandColumn=1;A.paging=false;A.columns=[{header:GO.lang.strName,dataIndex:"name"},{header:GO.projects.lang.internalFee,dataIndex:"internal_value"},{header:GO.projects.lang.externalFee,dataIndex:"external_value"},{header:GO.projects.lang.unitValue,dataIndex:"time"}];A.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.projects.lang.noFees}),A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;A.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){if(!this.feesDialog){this.feesDialog=new GO.projects.FeeDialog();this.feesDialog.on("save",function(){this.store.reload()},this)}this.feesDialog.show()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected()},scope:this}];GO.projects.FeesGrid.superclass.constructor.call(this,A)};Ext.extend(GO.projects.FeesGrid,GO.grid.GridPanel,{afterRender:function(){GO.projects.FeesGrid.superclass.afterRender.call(this);this.on("rowdblclick",function(A,B,C){if(!this.feesDialog){this.feesDialog=new GO.projects.FeeDialog();this.feesDialog.on("save",function(){this.store.reload();GO.projects.stores.readableFees.reload()},this)}this.feesDialog.show({fee_id:A.selModel.selections.keys[0]})},this);this.store.load()}});GO.projects.FeeDialog=function(A){if(!A){A={}}this.buildForm();this.permissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strPermissions});this.tabPanel=new Ext.TabPanel({activeTab:0,layoutOnTabChange:true,border:false,items:[this.formPanel,this.permissionsTab]});var B=function(){this.nameField.focus()};A.maximizable=true;A.layout="fit";A.modal=false;A.resizable=false;A.width=400;A.height=400;A.closeAction="hide";A.title=GO.projects.lang.fee;A.items=this.tabPanel;A.focus=B.createDelegate(this);A.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm();this.hide()},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.projects.FeeDialog.superclass.constructor.call(this,A);this.addEvents({save:true})};Ext.extend(GO.projects.FeeDialog,Ext.Window,{show:function(A){if(!this.rendered){this.render(Ext.getBody())}if(!A){A={}}if(!A.fee_id){A.fee_id=0}this.setFeeId(A.fee_id);if(A.fee_id>0){this.formPanel.load({url:GO.settings.modules.projects.url+"json.php",waitMsg:GO.lang.waitMsgLoad,success:function(B,C){this.permissionsTab.setAcl(C.result.data.acl_id);GO.projects.FeeDialog.superclass.show.call(this)},failure:function(B,C){Ext.Msg.alert(GO.lang.strError,C.result.feedback)},scope:this})}else{this.formPanel.form.reset();this.permissionsPanel.setDisabled(true);GO.projects.FeeDialog.superclass.show.call(this)}},setFeeId:function(A){this.formPanel.form.baseParams.fee_id=A;this.fee_id=A},submitForm:function(){this.formPanel.form.submit({url:GO.settings.modules.projects.url+"action.php",params:{task:"save_fee"},waitMsg:GO.lang.waitMsgSave,success:function(A,B){if(B.result.fee_id){this.permissionsTab.setAcl(B.result.acl_id);this.setFeeId(B.result.fee_id)}this.fireEvent("save",this)},failure:function(A,B){Ext.MessageBox.alert(GO.lang.strError,B.result.feedback)},scope:this})},buildForm:function(){this.nameField=new Ext.form.TextField({name:"name",fieldLabel:GO.lang.strName,anchor:"100%",allowBlack:false});var C=new GO.form.NumberField({name:"time",width:40,allowBlank:false,fieldLabel:GO.projects.lang.valueMinutes,decimals:0,value:GO.util.numberFormat("60",0,GO.settings.decimal_seperator,GO.settings.thousands_seperator)});var B=new GO.form.NumberField({name:"internal_value",width:40,allowBlank:false,fieldLabel:GO.projects.lang.internalFee,value:GO.util.numberFormat("0",2,GO.settings.decimal_seperator,GO.settings.thousands_seperator)});var A=new GO.form.NumberField({name:"external_value",width:40,allowBlank:false,fieldLabel:GO.projects.lang.externalFee,value:GO.util.numberFormat("0",2,GO.settings.decimal_seperator,GO.settings.thousands_seperator)});this.formPanel=new Ext.form.FormPanel({title:GO.lang.strProperties,border:false,cls:"go-form-panel",baseParams:{task:"fee"},autoHeight:true,items:[this.nameField,C,B,A]})}});GO.projects.ReportPanel=function(D){if(!D){D={}}var A=new Ext.Button({text:GO.lang.cmdApply,handler:this.loadReport,scope:this});var F=new Ext.Panel({border:false,cls:"go-form-text-panel",html:GO.projects.lang.datefieldsInfo});this.groupBy=new Ext.form.ComboBox({fieldLabel:GO.projects.lang.groupHoursBy,hiddenName:"group_by",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["project_id",GO.projects.lang.projects],["user_id",GO.lang.users],["customer",GO.lang.customer]]}),value:"project_id",valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true});var C=new Date();var E=C.add(Date.MONTH,-1);var G=E.getFirstDateOfMonth();var B=E.getLastDateOfMonth();this.startDate=new Ext.form.DateField({name:"start_date",format:GO.settings.date_format,allowBlank:true,fieldLabel:GO.lang.strStart,value:G.format(GO.settings.date_format)});this.endDate=new Ext.form.DateField({name:"emd_date",format:GO.settings.date_format,allowBlank:true,fieldLabel:GO.lang.strEnd,value:B.format(GO.settings.date_format)});this.setReportPanel=new Ext.form.FormPanel({region:"north",height:180,title:GO.projects.lang.reports,cls:"go-form-panel",split:true,border:true,collapsible:true,items:[F,this.groupBy,this.startDate,this.endDate,A]});this.setReportPanel.on("save",function(){this.reportGrid.store.reload()},this);this.reportGrid=new GO.projects.ReportGrid({region:"center",border:true});D.layout="border";D.items=[this.setReportPanel,this.reportGrid];GO.projects.ReportPanel.superclass.constructor.call(this,D)};Ext.extend(GO.projects.ReportPanel,Ext.Panel,{loadReport:function(){this.reportGrid.store.baseParams.group_by=this.groupBy.getValue();var A=this.startDate.getValue();var B=this.endDate.getValue();this.reportGrid.store.baseParams.start_date=A?A.format(GO.settings.date_format):"";this.reportGrid.store.baseParams.end_date=B?B.format(GO.settings.date_format):"";this.reportGrid.store.load()},afterRender:function(){this.loadReport();GO.projects.ReportPanel.superclass.afterRender.call(this)}});GO.projects.ReportGrid=function(A){if(!A){A={}}A.store=new GO.data.JsonStore({url:GO.settings.modules.projects.url+"json.php",baseParams:{task:"report"},root:"results",fields:["name","units","days","int_fee_value","ext_fee_value","user_id","customer","project_id"],remoteSort:true});A.paging=true;A.columns=[{header:GO.lang.strName,dataIndex:"name",sortable:true},{header:GO.projects.lang.units,dataIndex:"units",width:100,sortable:true},{header:GO.lang.strDays,dataIndex:"days",width:100,sortable:true},{header:GO.projects.lang.internalFee,dataIndex:"int_fee_value",width:100,sortable:true},{header:GO.projects.lang.externalFee,dataIndex:"ext_fee_value",width:100,sortable:true}];A.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.projects.lang.noData});A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;GO.projects.ReportGrid.superclass.constructor.call(this,A)};Ext.extend(GO.projects.ReportGrid,GO.grid.GridPanel,{afterRender:function(){GO.projects.ReportGrid.superclass.afterRender.call(this);this.on("rowdblclick",function(C,D,E){if(!this.hoursDialog){this.hoursPanel=new GO.projects.HoursGrid({border:false});this.hoursDialog=new Ext.Window({title:GO.projects.lang.reportDetails,width:600,height:400,layout:"fit",items:this.hoursPanel,closeAction:"hide",buttons:[{text:GO.lang.cmdClose,handler:function(){this.hoursDialog.hide()},scope:this}]})}var B=C.getSelectionModel();var A=B.getSelected();this.hoursPanel.store.baseParams.start_date=this.store.baseParams.start_date;this.hoursPanel.store.baseParams.end_date=this.store.baseParams.end_date;this.hoursPanel.store.baseParams[this.store.baseParams.group_by]=A.data[this.store.baseParams.group_by];this.hoursPanel.store.load();this.hoursDialog.show()},this)}});GO.projects.MainPanel=function(D){if(!D){D={}}this.summaryPanel=new GO.projects.SummaryPanel({layout:"fit",border:false});this.summaryPanel.store.on("load",function(){this.navMenu.select(0)},this);this.hoursPanel=new GO.projects.HoursPanel({border:false});this.hoursPanel.on("show",function(){this.hoursPanel.hoursGrid.store.baseParams.user_id=GO.settings.user_id;this.hoursPanel.hoursGrid.store.load()},this);var C=[["pm_summary",GO.projects.lang.summary],["pm_nav_time",GO.projects.lang.timeTracking]];var B=[this.summaryPanel,this.hoursPanel];C.push(["pm_nav_reports",GO.projects.lang.reports]);this.reportPanel=new GO.projects.ReportPanel({border:false,layout:"fit"});B.push(this.reportPanel);if(GO.settings.modules.projects.write_permission){C.push(["pm_nav_projects",GO.projects.lang.projectAdministration]);C.push(["pm_nav_fees",GO.projects.lang.feeAdministration]);this.projectsPanel=new GO.projects.ProjectsPanel({title:GO.projects.lang.projectAdministration,layout:"fit",border:true});B.push(this.projectsPanel);this.feesPanel=new GO.projects.FeesGrid({title:GO.projects.lang.feeAdministration,layout:"fit"});B.push(this.feesPanel)}var A=new Ext.data.SimpleStore({fields:["dom_id","name"],data:C});this.navMenu=new GO.grid.SimpleSelectList({store:A});this.navMenu.on("click",function(E,F){this.cardPanel.getLayout().setActiveItem(F)},this);this.navPanel=new Ext.Panel({region:"west",title:GO.lang.menu,autoScroll:true,width:150,split:true,resizable:true,items:this.navMenu});this.cardPanel=new Ext.Panel({region:"center",layout:"card",border:false,activeItem:0,layoutConfig:{deferredRender:true},items:B});D.items=[this.navPanel,this.cardPanel];D.layout="border";GO.projects.MainPanel.superclass.constructor.call(this,D)};Ext.extend(GO.projects.MainPanel,Ext.Panel,{afterRender:function(){GO.projects.MainPanel.superclass.afterRender.call(this)}});GO.mainLayout.onReady(function(){GO.projects.projectDialog=new GO.projects.ProjectDialog()});GO.moduleManager.addModule("projects",GO.projects.MainPanel,{title:GO.projects.lang.projects,iconCls:"go-tab-icon-projects"});GO.linkHandlers[5]=function(C){var A=new GO.projects.ProjectPanel();var B=new GO.LinkViewWindow({title:GO.projects.lang.project,items:A});A.loadProject(C);B.show()};