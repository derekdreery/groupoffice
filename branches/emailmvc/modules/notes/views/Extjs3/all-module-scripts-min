GO.notes.CategoryDialog=Ext.extend(GO.dialog.TabbedFormDialog,{initComponent:function(){Ext.apply(this,{title:GO.notes.lang.category,formControllerUrl:GO.url("notes/category")});GO.notes.CategoryDialog.superclass.initComponent.call(this)},buildForm:function(){this.propertiesPanel=new Ext.Panel({url:GO.settings.modules.notes.url+"action.php",border:false,baseParams:{task:"category"},title:GO.lang.strProperties,cls:"go-form-panel",waitMsgTarget:true,layout:"form",autoScroll:true,items:[{xtype:"textfield",name:"name",anchor:"100%",allowBlank:false,fieldLabel:GO.lang.strName},this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.has_admin_permission,value:GO.settings.user_id,anchor:"100%"})]});this.addPanel(this.propertiesPanel);this.addPermissionsPanel(new GO.grid.PermissionsPanel())}});GO.notes.NotesGrid=function(b){if(!b){b={}}var a={fields:["id","category_id","user_name","ctime","mtime","name","content"],columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name",sortable:false,hidden:true},{header:GO.lang.strCtime,dataIndex:"ctime",hidden:true},{header:GO.lang.strMtime,dataIndex:"mtime"}]};if(GO.customfields){GO.customfields.addColumns(4,a)}b.title=GO.notes.lang.notes;b.layout="fit";b.autoScroll=true;b.split=true;b.store=new GO.data.JsonStore({url:GO.url("notes/note/grid"),root:"results",id:"id",totalProperty:"total",fields:a.fields,remoteSort:true});b.store.on("load",function(){if(b.store.reader.jsonData.feedback){alert(b.store.reader.jsonData.feedback)}},this);b.paging=true;var c=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:a.columns});b.cm=c;b.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});b.sm=new Ext.grid.RowSelectionModel();b.loadMask=true;this.searchField=new GO.form.SearchField({store:b.store,width:320});b.tbar=[GO.lang.strSearch+":",this.searchField];GO.notes.NotesGrid.superclass.constructor.call(this,b)};Ext.extend(GO.notes.NotesGrid,GO.grid.GridPanel,{});GO.notes.NoteDialog=Ext.extend(GO.dialog.TabbedFormDialog,{customFieldType:4,initComponent:function(){Ext.apply(this,{goDialogId:"note",title:GO.notes.lang.note,formControllerUrl:GO.url("notes/note")});GO.notes.NoteDialog.superclass.initComponent.call(this)},afterLoad:function(c,a,b){if(!c){if(!a.category_id){a.category_id=GO.notes.defaultCategory.id;a.category_name=GO.notes.defaultCategory.name}this.selectCategory.setValue(a.category_id);if(a.category_name){this.selectCategory.setRemoteText(a.category_name)}}},buildForm:function(){this.selectLinkField=new GO.form.SelectLink({anchor:"100%"});this.propertiesPanel=new Ext.Panel({title:GO.lang.strProperties,cls:"go-form-panel",layout:"form",items:[{xtype:"textfield",name:"name",width:300,anchor:"100%",maxLength:100,allowBlank:false,fieldLabel:GO.lang.strName},this.selectCategory=new GO.form.ComboBox({fieldLabel:GO.notes.lang.category_id,hiddenName:"category_id",anchor:"100%",emptyText:GO.lang.strPleaseSelect,store:GO.notes.writableCategoriesStore,pageSize:parseInt(GO.settings.max_rows_list),valueField:"id",displayField:"name",mode:"remote",triggerAction:"all",editable:true,selectOnFocus:true,forceSelection:true,allowBlank:false}),this.selectLinkField,{xtype:"textarea",name:"content",anchor:"100% -80",hideLabel:true}]});this.addPanel(this.propertiesPanel)}});GO.notes.NotePanel=Ext.extend(GO.DisplayPanel,{link_type:4,stateId:"no-note-panel",editGoDialogId:"note",editHandler:function(){GO.notes.showNoteDialog(this.link_id)},initComponent:function(){this.loadUrl=GO.url("notes/note/display");this.template='<table class="display-panel" cellpadding="0" cellspacing="0" border="0"><tr><td colspan="2" class="display-panel-heading">{name}</td></tr><tr><td>ID:</td><td>{id}</td></tr><tr><td colspan="2">{content}</td></tr></table>';if(GO.customfields){this.template+=GO.customfields.displayPanelTemplate}if(GO.tasks){this.template+=GO.tasks.TaskTemplate}if(GO.calendar){this.template+=GO.calendar.EventTemplate}this.template+=GO.linksTemplate;if(GO.files){Ext.apply(this.templateConfig,GO.files.filesTemplateConfig);this.template+=GO.files.filesTemplate}Ext.apply(this.templateConfig,GO.linksTemplateConfig);if(GO.comments){this.template+=GO.comments.displayPanelTemplate}GO.notes.NotePanel.superclass.initComponent.call(this)}});GO.notes.ManageCategoriesGrid=Ext.extend(GO.grid.GridPanel,{changed:false,initComponent:function(){Ext.apply(this,{standardTbar:true,standardTbarDisabled:!GO.settings.modules.notes.write_permission,store:GO.notes.writableAdminCategoriesStore,border:false,paging:true,view:new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems}),cm:new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name",sortable:false}]})});GO.notes.ManageCategoriesGrid.superclass.initComponent.call(this);GO.notes.writableAdminCategoriesStore.load()},dblClick:function(b,a,c){this.showCategoryDialog(a.id)},btnAdd:function(){this.showCategoryDialog()},showCategoryDialog:function(a){if(!this.categoryDialog){this.categoryDialog=new GO.notes.CategoryDialog();this.categoryDialog.on("save",function(){this.store.load();this.changed=true},this)}this.categoryDialog.show(a)},deleteSelected:function(){GO.notes.ManageCategoriesGrid.superclass.deleteSelected.call(this);this.changed=true}});GO.notes.ManageCategoriesDialog=function(a){if(!a){a={}}this.categoriesGrid=new GO.notes.ManageCategoriesGrid();a.maximizable=true;a.layout="fit";a.modal=false;a.resizable=true;a.width=600;a.height=400;a.closeAction="hide";a.title=GO.notes.lang.manageCategories;a.items=this.categoriesGrid;a.buttons=[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.notes.ManageCategoriesDialog.superclass.constructor.call(this,a);this.on("hide",function(){if(this.categoriesGrid.changed){this.fireEvent("change");this.categoriesGrid.changed=false}},this);this.addEvents({change:true})};Ext.extend(GO.notes.ManageCategoriesDialog,GO.Window,{});GO.notes.writableCategoriesStore=new GO.data.JsonStore({url:GO.url("notes/category/grid"),baseParams:{permissionLevel:GO.permissionLevels.write},fields:["id","name","user_name"]});GO.notes.writableAdminCategoriesStore=new GO.data.JsonStore({url:GO.url("notes/category/grid"),baseParams:{permissionLevel:GO.permissionLevels.write},fields:["id","name","user_name"]});GO.notes.readableCategoriesStore=new GO.data.JsonStore({url:GO.url("notes/category/grid"),baseParams:{limit:GO.settings.config.nav_page_size},fields:["id","user_name","acl_id","name","checked"]});GO.notes.MainPanel=function(a){if(!a){a={}}this.westPanel=new GO.grid.MultiSelectGrid({region:"west",id:"no-west-panel",title:GO.notes.lang.categories,loadMask:true,store:GO.notes.readableCategoriesStore,width:210,split:true,allowNoSelection:true,bbar:new GO.SmallPagingToolbar({items:[this.searchField=new GO.form.SearchField({store:GO.notes.readableCategoriesStore,width:120,emptyText:GO.lang.strSearch})],store:GO.notes.readableCategoriesStore,pageSize:GO.settings.config.nav_page_size})});this.westPanel.on("change",function(d,c,b){if(b.length){this.centerPanel.store.baseParams.categories=Ext.encode(c);this.centerPanel.store.reload();this.category_ids=c;if(b.length){this.category_id=b[0].data.id;this.category_name=b[0].data.name}delete this.centerPanel.store.baseParams.categories}},this);this.westPanel.store.on("load",function(){for(var b=0,d=false;b<this.westPanel.store.data.length&&!d;b++){var c=this.westPanel.store.data.items[b];if(c.data.checked){this.category_id=c.data.id;this.category_name=c.data.name;d=true}}this.centerPanel.store.load()},this);this.centerPanel=new GO.notes.NotesGrid({region:"center",id:"no-center-panel",border:true});this.centerPanel.on("delayedrowselect",function(b,d,c){this.eastPanel.load(c.data.id)},this);this.centerPanel.on("rowdblclick",function(b,c){this.eastPanel.editHandler()},this);this.centerPanel.store.on("load",function(){this.centerPanel.setTitle(this.centerPanel.store.reader.jsonData.grid_title);if(this.eastPanel.data.category_id!=this.category_id){this.eastPanel.reset()}},this);this.eastPanel=new GO.notes.NotePanel({region:"east",id:"no-east-panel",width:440,border:true});a.tbar=new Ext.Toolbar({cls:"go-head-tb",items:[{iconCls:"btn-add",itemId:"add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.eastPanel.reset();GO.notes.showNoteDialog(0,{category_id:this.category_id,category_name:this.category_name})},scope:this},{itemId:"delete",iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.centerPanel.deleteSelected({callback:this.eastPanel.gridDeleteCallback,scope:this.eastPanel})},scope:this},{iconCls:"no-btn-categories",text:GO.notes.lang.manageCategories,cls:"x-btn-text-icon",handler:function(){if(!this.categoriesDialog){this.categoriesDialog=new GO.notes.ManageCategoriesDialog();this.categoriesDialog.on("change",function(){this.westPanel.store.reload();GO.notes.writableCategoriesStore.reload()},this)}this.categoriesDialog.show()},scope:this}]});a.items=[this.westPanel,this.centerPanel,this.eastPanel];a.layout="border";GO.notes.MainPanel.superclass.constructor.call(this,a)};Ext.extend(GO.notes.MainPanel,Ext.Panel,{afterRender:function(){GO.dialogListeners.add("note",{scope:this,save:function(){this.centerPanel.store.reload()}});GO.notes.readableCategoriesStore.load();GO.notes.MainPanel.superclass.afterRender.call(this)}});GO.notes.showNoteDialog=function(b,a){if(!GO.notes.noteDialog){GO.notes.noteDialog=new GO.notes.NoteDialog()}GO.notes.noteDialog.show(b,a)};GO.moduleManager.addModule("notes",GO.notes.MainPanel,{title:GO.notes.lang.notes,iconCls:"go-tab-icon-notes"});GO.linkHandlers[4]=function(b){if(!GO.notes.linkWindow){var a=new GO.notes.NotePanel();GO.notes.linkWindow=new GO.LinkViewWindow({title:GO.notes.lang.note,items:a,notePanel:a,closeAction:"hide"})}GO.notes.linkWindow.notePanel.load(b);GO.notes.linkWindow.show()};GO.linkPreviewPanels[4]=function(a){a=a||{};return new GO.notes.NotePanel(a)};GO.newMenuItems.push({text:GO.notes.lang.note,iconCls:"go-link-icon-4",handler:function(a,b){GO.notes.showNoteDialog(0,{link_config:a.parentMenu.link_config})}});