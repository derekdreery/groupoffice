GO.email.AliasesDialog=function(a){if(!a){a={}}this.aliasesGrid=new GO.email.AliasesGrid();a.layout="fit";a.modal=false;a.resizable=false;a.width=500;a.height=400;a.closeAction="hide";a.title=GO.email.lang.aliases;a.items=this.aliasesGrid;a.buttons=[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.email.AliasesDialog.superclass.constructor.call(this,a)};Ext.extend(GO.email.AliasesDialog,Ext.Window,{show:function(a){this.aliasesGrid.setAccountId(a);GO.email.AliasesDialog.superclass.show.call(this)}});GO.email.AliasDialog=function(b){if(!b){b={}}this.buildForm();var a=function(){this.formPanel.items.items[0].focus()};b.layout="fit";b.modal=false;b.resizable=false;b.width=500;b.autoHeight=true;b.closeAction="hide";b.title=GO.email.lang.alias;b.items=this.formPanel;b.focus=a.createDelegate(this);b.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.email.AliasDialog.superclass.constructor.call(this,b);this.addEvents({save:true})};Ext.extend(GO.email.AliasDialog,Ext.Window,{show:function(b,a){if(!this.rendered){this.render(Ext.getBody())}this.formPanel.form.reset();if(!b){b=0}this.setAliasId(b);if(this.alias_id>0){this.formPanel.load({url:GO.settings.modules.email.url+"json.php",waitMsg:GO.lang.waitMsgLoad,success:function(c,d){GO.email.AliasDialog.superclass.show.call(this)},failure:function(c,d){Ext.Msg.alert(GO.lang.strError,d.result.feedback)},scope:this})}else{GO.email.AliasDialog.superclass.show.call(this)}},setAliasId:function(a){this.formPanel.form.baseParams.alias_id=a;this.alias_id=a},submitForm:function(a){this.formPanel.form.submit({url:GO.settings.modules.email.url+"action.php",params:{task:"save_alias"},waitMsg:GO.lang.waitMsgSave,success:function(b,c){if(c.result.alias_id){this.setAliasId(c.result.alias_id)}this.fireEvent("save",this,this.alias_id);if(a){this.hide()}},failure:function(b,c){if(c.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,c.result.feedback)}},scope:this})},buildForm:function(){this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,url:GO.settings.modules.email.url+"action.php",border:false,baseParams:{task:"alias",account_id:0},cls:"go-form-panel",autoHeight:true,items:[{xtype:"textfield",name:"name",anchor:"100%",allowBlank:false,fieldLabel:GO.lang.strName},{xtype:"textfield",name:"email",anchor:"100%",allowBlank:false,fieldLabel:GO.email.lang.email},{xtype:"textarea",name:"signature",anchor:"100%",height:150,fieldLabel:GO.email.lang.signature}]})}});GO.email.AliasesGrid=function(a){if(!a){a={}}a.layout="fit";a.autoScroll=true;a.store=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"aliases"},root:"results",id:"id",totalProperty:"total",fields:["id","account_id","name","email","signature"],remoteSort:true});var b=new Ext.grid.ColumnModel([{header:GO.lang.strName,dataIndex:"name"},{header:GO.email.lang.email,dataIndex:"email"}]);b.defaultSortable=true;a.cm=b;a.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;this.aliasDialog=new GO.email.AliasDialog();this.aliasDialog.on("save",function(){this.store.reload();if(GO.email.aliasesStore.loaded){GO.email.aliasesStore.reload()}},this);a.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.aliasDialog.formPanel.baseParams.account_id=this.account_id;this.aliasDialog.show()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected({callback:function(){if(GO.email.aliasesStore.loaded){GO.email.aliasesStore.reload()}this.fireEvent("delete",this)},scope:this})},scope:this}];GO.email.AliasesGrid.superclass.constructor.call(this,a);this.on("rowdblclick",function(d,e){var c=d.getStore().getAt(e);this.aliasDialog.show(c.data.id)},this)};Ext.extend(GO.email.AliasesGrid,GO.grid.GridPanel,{setAccountId:function(a){if(this.store.baseParams.account_id!=a){this.store.baseParams.account_id=a;if(a==0){this.store.removeAll()}else{this.store.load()}}this.setDisabled(a==0);this.account_id=a}});GO.email.FoldersDialog=function(a){Ext.apply(this,a);this.foldersTree=new Ext.tree.TreePanel({animate:true,border:false,autoScroll:true,height:200,loader:new Ext.tree.TreeLoader({dataUrl:GO.settings.modules.email.url+"json.php",baseParams:{task:"tree-edit",account_id:0},preloadChildren:true,listeners:{beforeload:function(){this.body.mask(GO.lang.waitMsgLoad)},load:function(){this.body.unmask()},scope:this}})});this.rootNode=new Ext.tree.AsyncTreeNode({text:GO.email.lang.root,draggable:false,id:"account",folder_id:0,expanded:false});this.foldersTree.setRootNode(this.rootNode);this.rootNode.on("load",function(){this.rootNode.select()},this);this.foldersTree.on("checkchange",function(e,d){this.body.mask(GO.lang.waitMsgSave,"x-mask-loading");var c=d?"subscribe":"unsubscribe";Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:c,account_id:this.account_id,mailbox:e.attributes.mailbox},callback:function(g,h,f){if(!h){Ext.MessageBox.alert(GO.lang.strError,f.result.feedback)}this.body.unmask()},scope:this})},this);var b=new Ext.tree.TreeEditor(this.foldersTree,{ignoreNoChange:true});b.on("beforestartedit",function(d,c,e){if(d.editNode.attributes.folder_id==0||d.editNode.attributes.mailbox=="INBOX"){alert(GO.email.lang.cantEditFolder);return false}});b.on("beforecomplete",function(d,c,e){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"rename_folder",folder_id:d.editNode.attributes.folder_id,new_name:c},callback:function(g,h,f){if(!h){Ext.MessageBox.alert(GO.lang.strError,f.result.feedback)}else{return true}}})});GO.email.FoldersDialog.superclass.constructor.call(this,{layout:"fit",modal:false,shadow:false,minWidth:300,minHeight:300,height:400,width:500,plain:true,closeAction:"hide",title:GO.email.lang.folders,items:this.foldersTree,tbar:[{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",scope:this,handler:function(){var d=this.foldersTree.getSelectionModel();var c=d.getSelectedNode();if(!c||c.attributes.folder_id<1){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.selectFolderDelete)}else{if(c.attributes.mailbox=="INBOX"){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.cantDeleteInboxFolder)}else{GO.deleteItems({url:GO.settings.modules.email.url+"action.php",params:{task:"delete_folder",folder_id:c.attributes.folder_id},callback:function(e){if(e.success){c.remove()}else{Ext.MessageBox.alert(GO.lang.strError,e.feedback)}},count:1,scope:this})}}}},{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){var d=this.foldersTree.getSelectionModel();var c=d.getSelectedNode();if(!c){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.selectFolderAdd)}else{Ext.MessageBox.prompt(GO.lang.strName,GO.email.lang.enterFolderName,function(e,f){if(e=="ok"){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"add_folder",folder_id:c.attributes.folder_id,account_id:this.account_id,new_folder_name:f},callback:function(h,j,g){if(!j){Ext.MessageBox.alert(GO.lang.strError,g.result.errors)}else{var i=Ext.decode(g.responseText);if(i.success){delete c.attributes.children;c.reload()}else{Ext.MessageBox.alert(GO.lang.strError,i.feedback)}}},scope:this})}},this)}},scope:this},{iconCls:"btn-refresh",text:GO.lang.cmdRefresh,cls:"x-btn-text-icon",handler:function(){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"syncfolders",account_id:this.account_id},callback:function(d,e,c){if(!e){Ext.MessageBox.alert(GO.lang.strError,c.result.feedback)}else{this.rootNode.reload()}},scope:this})},scope:this}],buttons:[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.email.FoldersDialog,Ext.Window,{show:function(a){this.render(Ext.getBody());this.account_id=a;this.foldersTree.loader.baseParams.account_id=a;if(!this.rootNode.isExpanded()){this.rootNode.expand()}else{this.rootNode.reload()}GO.email.FoldersDialog.superclass.show.call(this)},getSubscribtionData:function(){var b=[];for(var a=0;a<this.allFoldersStore.data.items.length;a++){b[a]={id:this.allFoldersStore.data.items[a].get("id"),subscribed:this.allFoldersStore.data.items[a].get("subscribed"),name:this.allFoldersStore.data.items[a].get("name")}}return b}});GO.email.AccountDialog=function(a){Ext.apply(this,a);var f;var k;function j(l){return l=="1"?GO.lang.cmdYes:GO.lang.cmdNo}var h=new Ext.grid.ColumnModel([{header:GO.email.lang.field,dataIndex:"field"},{header:GO.email.lang.contains,dataIndex:"keyword"},{header:GO.email.lang.moveToFolder,dataIndex:"folder"},{header:GO.email.lang.markAsRead,dataIndex:"mark_as_read",renderer:j}]);h.defaultSortable=false;this.filtersDS=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{type:"filters",account_id:this.account_id},root:"results",id:"id",fields:["id","field","keyword","folder","mark_as_read"],remoteSort:false});var c=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){filter.showDialog(0,this.account_id,this.filtersDS)},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.filtersTab.deleteSelected()},scope:this}];this.filtersGrid=new GO.grid.GridPanel({layout:"fit",region:"center",border:false,loadMask:true,enableDragDrop:true,ddGroup:"EmailFiltersDD",ds:this.filtersDS,cm:h,view:new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems}),sm:new Ext.grid.RowSelectionModel()});this.filtersGrid.on("render",function(){var l=new Ext.dd.DropTarget(this.filtersGrid.getView().mainBody,{ddGroup:"EmailFiltersDD",copy:false,notifyDrop:this.onNotifyDrop.createDelegate(this)})},this);this.filtersGrid.on("rowdblclick",function(){var l=this.filtersGrid.getSelectionModel();var m=l.getSelected();filter.showDialog(m.data.id,this.account_id,this.filtersDS,GO.email.subscribedFoldersStore)},this);this.filtersTab=new Ext.Panel({title:GO.email.lang.filters,layout:"border",border:false,tbar:c,items:[{xtype:"panel",region:"north",height:25,border:true,html:GO.email.lang.orderFilters,bodyStyle:"padding:5px"},this.filtersGrid]});this.filtersTab.on("show",function(){if(this.filtersDS.baseParams.account_id!=this.account_id){this.filtersDS.baseParams={task:"filters",account_id:this.account_id};this.filtersDS.load()}},this);var g={title:GO.email.lang.incomingMail,layout:"form",defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,cls:"go-form-panel",waitMsgTarget:true,labelWidth:120,items:[f=new Ext.form.ComboBox({fieldLabel:GO.email.lang.type,hiddenName:"type",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["imap","IMAP"],["pop3","POP-3"]]}),value:"imap",valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,listeners:{change:function(){this.refreshNeeded=true},scope:this}}),new Ext.form.TextField({fieldLabel:GO.email.lang.host,name:"host",allowBlank:false,listeners:{change:function(){this.refreshNeeded=true},scope:this}}),new Ext.form.TextField({fieldLabel:GO.lang.strUsername,name:"username",allowBlank:false,listeners:{change:function(){this.refreshNeeded=true},scope:this}}),new Ext.form.TextField({fieldLabel:GO.lang.strPassword,name:"password",inputType:"password",allowBlank:false,listeners:{change:function(){this.refreshNeeded=true},scope:this}}),{xtype:"fieldset",title:GO.email.lang.advanced,collapsible:true,collapsed:true,autoHeight:true,autoWidth:true,defaultType:"textfield",labelWidth:75,labelAlign:"left",items:[k=new Ext.form.Checkbox({boxLabel:GO.email.lang.ssl,name:"use_ssl",checked:false,hideLabel:true}),new Ext.form.Checkbox({boxLabel:GO.email.lang.novalidateCert,name:"novalidate_cert",checked:false,hideLabel:true}),new Ext.form.TextField({fieldLabel:GO.email.lang.port,name:"port",value:"143",allowBlank:false}),new Ext.form.TextField({fieldLabel:GO.email.lang.rootMailbox,name:"mbroot"})]}]};var e=[this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.modules.email["write_permission"],anchor:"100%"}),{fieldLabel:GO.lang.strName,name:"name",allowBlank:false,anchor:"100%"},{fieldLabel:GO.lang.strEmail,name:"email",allowBlank:false,listeners:{change:function(){this.refreshNeeded=true},scope:this},anchor:"100%"},{xtype:"textarea",name:"signature",fieldLabel:GO.email.lang.signature,height:100,anchor:"100%"}];this.aliasesButton=new Ext.Button({text:GO.email.lang.manageAliases,handler:function(){if(!this.aliasesDialog){this.aliasesDialog=new GO.email.AliasesDialog()}this.aliasesDialog.show(this.account_id)},scope:this});if(GO.settings.modules.email.write_permission){e.push(this.aliasesButton)}var b={title:GO.lang.strProperties,layout:"form",anchor:"100% 100%",defaultType:"textfield",autoHeight:true,cls:"go-form-panel",labelWidth:100,items:e};var i={title:GO.email.lang.outgoingMail,layout:"form",defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,cls:"go-form-panel",labelWidth:120,items:[new Ext.form.TextField({fieldLabel:GO.email.lang.host,name:"smtp_host",allowBlank:false,value:GO.email.defaultSmtpHost}),this.encryptionField=new Ext.form.ComboBox({fieldLabel:GO.email.lang.encryption,hiddenName:"smtp_encryption",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.noEncryption],["tls","TLS"],["ssl","SSL"]]}),value:"",valueField:"value",displayField:"text",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.TextField({fieldLabel:GO.email.lang.port,name:"smtp_port",value:"25",allowBlank:false}),new Ext.form.TextField({fieldLabel:GO.lang.strUsername,name:"smtp_username"}),new Ext.form.TextField({fieldLabel:GO.lang.strPassword,name:"smtp_password",inputType:"password"})]};GO.email.subscribedFoldersStore=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"subscribed_folders",account_id:0},root:"data",fields:["id","name"]});this.foldersTab=new Ext.Panel({title:GO.email.lang.folders,autoHeight:true,layout:"form",cls:"go-form-panel",defaults:{anchor:"100%"},defaultType:"textfield",labelWidth:150,tbar:[{iconCls:"btn-add",text:GO.email.lang.manageFolders,cls:"x-btn-text-icon",scope:this,handler:function(){if(!this.foldersDialog){this.foldersDialog=new GO.email.FoldersDialog()}this.foldersDialog.show(this.account_id)}}],items:[new GO.form.ComboBoxReset({fieldLabel:GO.email.lang.sendItemsFolder,hiddenName:"sent",store:GO.email.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,emptyText:GO.lang.disabled}),new GO.form.ComboBoxReset({fieldLabel:GO.email.lang.trashFolder,hiddenName:"trash",store:GO.email.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,emptyText:GO.lang.disabled}),new GO.form.ComboBoxReset({fieldLabel:GO.email.lang.draftsFolder,hiddenName:"drafts",store:GO.email.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,emptyText:GO.lang.disabled})]});this.vacationPanel=new Ext.Panel({disabled:true,title:GO.email.lang.vacation,cls:"go-form-panel",layout:"form",autoScroll:true,items:[{xtype:"checkbox",name:"vacation_active",anchor:"-20",boxLabel:GO.email.lang.vacationActive,hideLabel:true},{xtype:"textfield",name:"vacation_subject",anchor:"-20",fieldLabel:GO.email.lang.vacationSubject},{xtype:"textarea",name:"vacation_body",anchor:"-20",fieldLabel:GO.email.lang.vacationBody,height:160}]});var d=[b,this.foldersTab,this.filtersTab,this.vacationPanel];if(GO.settings.modules.email.write_permission){d.splice(1,0,g,i)}this.propertiesPanel=new Ext.form.FormPanel({url:GO.settings.modules.email.url+"action.php",defaultType:"textfield",waitMsgTarget:true,labelWidth:120,border:false,items:[this.tabPanel=new Ext.TabPanel({hideLabel:true,deferredRender:false,activeTab:0,border:false,anchor:"100% 100%",items:d})]});f.on("select",function(o,l,m){var n=m==1?"110":"143";this.propertiesPanel.form.findField("port").setValue(n)},this);this.encryptionField.on("select",function(o,l,m){var n=l.data.value==""?"25":"465";this.propertiesPanel.form.findField("smtp_port").setValue(n)},this);k.on("check",function(n,m){if(f.getValue()=="imap"){var l=m?993:143;this.propertiesPanel.form.findField("port").setValue(l)}else{var l=m?995:110;this.propertiesPanel.form.findField("port").setValue(l)}},this);this.selectUser.on("select",function(n,l,m){if(GO.util.empty(this.account_id)){this.propertiesPanel.form.findField("email").setValue(l.data.email);this.propertiesPanel.form.findField("username").setValue(l.data.username);this.propertiesPanel.form.findField("name").setValue(l.data.name)}},this);GO.email.AccountDialog.superclass.constructor.call(this,{layout:"fit",modal:false,height:400,width:650,plain:true,closeAction:"hide",title:GO.email.lang.account,items:this.propertiesPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});this.addEvents({save:true})};Ext.extend(GO.email.AccountDialog,Ext.Window,{save:function(a){this.propertiesPanel.form.submit({url:GO.settings.modules.email.url+"action.php",params:{task:"save_account_properties",account_id:this.account_id},waitMsg:GO.lang.waitMsgSave,success:function(b,c){c.result.refreshNeeded=this.refreshNeeded||this.account_id==0;if(c.result.account_id){this.account_id=c.result.account_id;this.loadAccount(this.account_id)}this.refreshNeeded=false;this.fireEvent("save",this,c.result);if(a){this.hide()}},failure:function(c,d){var b="";if(d.failureType=="client"){b=GO.lang.strErrorsInForm}else{if(d.result){b=d.result.feedback}else{b=GO.lang.strRequestError}}Ext.MessageBox.alert(GO.lang.strError,b)},scope:this})},show:function(a){GO.email.AccountDialog.superclass.show.call(this);this.tabPanel.setActiveTab(0);this.aliasesButton.setDisabled(true);if(a){this.loadAccount(a);GO.email.subscribedFoldersStore.baseParams.account_id=a;GO.email.subscribedFoldersStore.load()}else{this.propertiesPanel.form.reset();this.account_id=0;this.foldersTab.setDisabled(true);this.filtersTab.setDisabled(true);this.vacationPanel.setDisabled(true);this.propertiesPanel.form.findField("name").setValue(GO.settings.name);this.propertiesPanel.form.findField("email").setValue(GO.settings.email);this.propertiesPanel.form.findField("username").setValue(GO.settings.username)}},loadAccount:function(a){this.propertiesPanel.form.load({url:GO.settings.modules.email.url+"json.php",params:{account_id:a,task:"account"},waitMsg:GO.lang.waitMsgLoad,success:function(b,c){this.refreshNeeded=false;this.account_id=a;this.selectUser.setRemoteValue(c.result.data.user_id,c.result.data.user_name);this.aliasesButton.setDisabled(false);this.foldersTab.setDisabled(c.result.data.type=="pop3");this.filtersTab.setDisabled(c.result.data.type=="pop3");var d=(typeof(c.result.data.vacation_subject)!="undefined");this.vacationPanel.setDisabled((!d&&!GO.systemusers)||c.result.data.hidetab)},scope:this})},onNotifyDrop:function(h,g,f){var k=this.filtersGrid.selModel.getSelections();var d=h.getDragData(g);var j=d.rowIndex;if(j=="undefined"){j=this.filtersGrid.store.data.length-1}for(c=0;c<k.length;c++){var b=this.filtersGrid.store.getById(k[c].id);if(!this.copy){this.filtersGrid.store.remove(this.filtersGrid.store.getById(k[c].id))}this.filtersGrid.store.insert(j,b)}var a={};for(var c=0;c<this.filtersGrid.store.data.items.length;c++){a[this.filtersGrid.store.data.items[c].get("id")]=c}Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"save_filters_sort_order",sort_order:Ext.encode(a)}})}});var filter=function(){return{showDialog:function(c,a,b){this.account_id=a;if(!this.win){this.formPanel=new Ext.form.FormPanel({layout:"form",defaults:{anchor:"100%"},defaultType:"textfield",labelWidth:125,autoHeight:true,cls:"go-form-panel",waitMsgTarget:true,items:[new Ext.form.ComboBox({fieldLabel:GO.email.lang.field,hiddenName:"field",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["from",GO.email.lang.sender],["subject",GO.email.lang.subject],["to",GO.email.lang.sendTo],["cc",GO.email.lang.ccField]]}),value:"from",valueField:"value",displayField:"text",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),{fieldLabel:GO.email.lang.keyword,name:"keyword",allowBlank:false},new Ext.form.ComboBox({fieldLabel:GO.email.lang.moveToFolder,hiddenName:"folder",store:GO.email.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,allowBlank:false}),new Ext.form.Checkbox({boxLabel:GO.email.lang.markAsRead,name:"mark_as_read",checked:false,hideLabel:true})]});this.win=new Ext.Window({title:GO.email.lang.filter,layout:"fit",modal:false,shadow:false,autoHeight:true,width:400,plain:false,closeAction:"hide",items:this.formPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.formPanel.form.submit({url:GO.settings.modules.email.url+"action.php",params:{task:"save_filter",filter_id:this.filter_id,account_id:this.account_id},waitMsg:GO.lang.waitMsgSave,success:function(d,e){if(e.result.filter_id){this.filter_id=e.result.filter_id}b.reload();this.win.hide()},failure:function(e,f){var d="";if(f.failureType=="client"){d=GO.lang.strErrorsInForm}else{d=f.result.feedback}Ext.MessageBox.alert(GO.lang.strError,d)},scope:this})},scope:this},{text:GO.lang.cmdClose,handler:function(){this.win.hide()},scope:this}]})}if(this.filter_id!=c){this.filter_id=c;if(this.filter_id>0){this.formPanel.load({url:GO.settings.modules.email.url+"json.php",params:{filter_id:c,task:"filter"}})}else{this.formPanel.form.reset()}}this.win.show()}}}();GO.email.SearchDialog=function(a){return{hasSearch:false,show:function(){if(!this.dialog){this.formPanel=new Ext.FormPanel({defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,bodyStyle:"padding:5px",labelWidth:125,items:[{fieldLabel:GO.email.lang.subject,name:"subject"},{fieldLabel:GO.email.lang.searchFrom,name:"from"},{fieldLabel:GO.email.lang.searchTo,name:"to"},{fieldLabel:GO.email.lang.searchCC,name:"cc"},{fieldLabel:GO.email.lang.body,name:"body"},new Ext.form.DateField({fieldLabel:GO.email.lang.recievedBefore,name:"before",format:GO.settings.date_format}),new Ext.form.DateField({fieldLabel:GO.email.lang.recievedSince,name:"since",format:GO.settings.date_format}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.flagged,name:"flagged",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.NA],["FLAGGED",GO.lang.cmdYes],["UNFLAGGED",GO.lang.cmdNo]]}),value:"",valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.answered,name:"answered",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.NA],["ANSWERED",GO.lang.cmdYes],["UNANSWERED",GO.lang.cmdNo]]}),value:"",valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.read,name:"seen",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.NA],["SEEN",GO.lang.cmdYes],["UNSEEN",GO.lang.cmdNo]]}),value:"",valueField:"value",displayField:"text",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true})]});this.dialog=new Ext.Window({layout:"fit",title:GO.lang.strSearch,modal:false,autoHeight:true,width:500,closeAction:"hide",items:this.formPanel,buttons:[{text:GO.lang.cmdOk,handler:this.doSearch,scope:this},{text:GO.lang.cmdReset,handler:function(){this.formPanel.form.reset()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.dialog.hide()},scope:this}],keys:[{key:Ext.EventObject.ENTER,fn:this.doSearch,scope:this}],focus:function(){this.formPanel.form.findField("subject").focus(true)}.createDelegate(this)})}this.dialog.show();if(GO.email.search_query){var b=GO.email.search_query;var c=(GO.email.search_type)?GO.email.search_type:GO.email.search_type_default;this.formPanel.form.findField("from").setValue((c=="from")?b:"");this.formPanel.form.findField("subject").setValue((c=="subject")?b:"");this.formPanel.form.findField("to").setValue((c=="to")?b:"");this.formPanel.form.findField("cc").setValue((c=="cc")?b:"")}},doSearch:function(){this.hasSearch=true;a.store.baseParams.query=this.buildQuery();a.store.load();this.dialog.hide()},buildQuery:function(){var i="";var e=this.formPanel.form;var j=e.findField("subject").getValue();var l=e.findField("from").getValue();var m=e.findField("to").getValue();var f=e.findField("cc").getValue();var g=e.findField("body").getValue();var k=e.findField("before").getValue();var h=e.findField("since").getValue();var c=e.findField("flagged").getValue();var b=e.findField("seen").getValue();var d=e.findField("answered").getValue();if(j!=""){i+='SUBJECT "'+j+'" '}if(l!=""){i+='FROM "'+l+'" '}if(m!=""){i+='TO "'+m+'" '}if(f!=""){i+='CC "'+f+'" '}if(g!=""){i+='BODY "'+g+'" '}if(k!=""){i+='BEFORE "'+k.format("d-M-Y")+'" '}if(h!=""){i+='SINCE "'+h.format("d-M-Y")+'" '}if(c!=""){i+=" "+c}if(b!=""){i+=" "+b}if(d!=""){i+=" "+d}return i}}};GO.email.MessagePanel=Ext.extend(Ext.Panel,{uid:0,initComponent:function(){GO.email.MessagePanel.superclass.initComponent.call(this);this.addEvents({attachmentClicked:true,zipOfAttachmentsClicked:true,linkClicked:true,emailClicked:true,load:true,reset:true});this.bodyId=Ext.id();this.attachmentsId=Ext.id();var a='<div class="message-header"><table class="message-header-table"><tr><td style="width:70px"><b>'+GO.email.lang.from+'</b></td><td>: {from} &lt;<a class="normal-link" href="#" onclick="GO.email.showAddressMenu(event, \'{sender}\', \'{[this.addSlashes(values.from)]}\');">{sender}</a>&gt;</td></tr><tr><td><b>'+GO.email.lang.subject+"</b></td><td>: {subject}</td></tr><tr><td><b>"+GO.lang.strDate+"</b></td><td>: {date}</td></tr><tr><td><b>"+GO.email.lang.to+'</b></td><td>: <tpl for="to">{name} <tpl if="email.length">&lt;<a class="normal-link" href="#" onclick="GO.email.showAddressMenu(event, \'{email}\', \'{[this.addSlashes(values.name)]}\');">{email}</a>&gt;; </tpl></tpl></td></tr><tpl if="cc.length"><tr><td><b>'+GO.email.lang.cc+'</b></td><td>: <tpl for="cc">{name} <tpl if="email.length">&lt;<a class="normal-link" href="#" onclick="GO.email.showAddressMenu(event, \'{email}\', \'{[this.addSlashes(values.name)]}\');">{email}</a>&gt;; </tpl></tpl></td></tr></tpl><tpl if="bcc.length"><tr><td><b>'+GO.email.lang.bcc+'</b></td><td>: <tpl for="bcc">{name} <tpl if="email.length">&lt;<a class="normal-link" href="#" onclick="GO.email.showAddressMenu(event, \'{email}\', \'{[this.addSlashes(values.name)]}\');">{email}</a>&gt;; </tpl></tpl></td></tr></tpl></table><tpl if="attachments.length"><table style="padding-top:5px;"><tr><td><b>'+GO.email.lang.attachments+':</b></td></tr><tr><td id="'+this.attachmentsId+'"><tpl for="attachments"><a class="filetype-link filetype-{extension}" id="'+this.attachmentsId+'_{index}" href="#">{name} ({human_size})</a> </tpl><tpl if="attachments.length&gt;1"><a class="filetype-link filetype-zip" id="'+this.attachmentsId+'_zipofall" href="#">'+GO.email.lang.downloadAllAsZip+'</a></tpl></td></tr></table></tpl><tpl if="blocked_images&gt;0"><div class="go-warning-msg em-blocked">'+GO.email.lang.blocked+' <a id="em-unblock" href="#" class="normal-link">'+GO.email.lang.unblock+'</a></div></tpl></div><div id="'+this.bodyId+'" class="message-body go-html-formatted">{body}</div>';this.template=new Ext.XTemplate(a,{addSlashes:function(b){b=GO.util.html_entity_decode(b,"ENT_QUOTES");b=GO.util.add_slashes(b);return b}});this.template.compile()},loadMessage:function(a,c,b,d){if(a){this.uid=a;this.params={uid:a,mailbox:c,account_id:b,task:"message"};if(d){this.params.passphrase=d}}this.el.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.email.url+"json.php",params:this.params,scope:this,callback:function(f,h,e){this.fireEvent("load",f,h,e);if(h){var g=Ext.decode(e.responseText);if(g.askPassphrase){if(!this.gnupgPasswordDialog){this.gnupgPasswordDialog=new GO.gnupg.PasswordDialog()}this.gnupgPasswordDialog.on("buttonpressed",function(i,j){if(i=="cancel"){this.reset();this.el.unmask()}else{this.loadMessage(a,c,b,j)}},this,{single:true});this.gnupgPasswordDialog.show()}else{this.setMessage(g);this.el.unmask()}if(g.feedback){GO.errorDialog.show(g.feedback)}}}})},reset:function(){this.data=false;this.uid=0;if(this.messageBodyEl){this.messageBodyEl.removeAllListeners()}if(this.attachmentsEl){this.attachmentsEl.removeAllListeners()}if(this.unblockEl){this.unblockEl.removeAllListeners()}this.body.update("");this.fireEvent("reset",this)},setMessage:function(a){this.data=a;if(this.messageBodyEl){this.messageBodyEl.removeAllListeners()}if(this.attachmentsEl){this.attachmentsEl.removeAllListeners()}if(this.unblockEl){this.unblockEl.removeAllListeners()}this.template.overwrite(this.body,a);this.unblockEl=Ext.get("em-unblock");if(this.unblockEl){this.unblockEl.on("click",function(){this.params.unblock="true";this.loadMessage()},this)}this.messageBodyEl=Ext.get(this.bodyId);this.messageBodyEl.on("click",this.onMessageBodyClick,this);this.messageBodyEl.on("contextmenu",this.onMessageBodyContextMenu,this);if(a.attachments.length){this.attachmentsEl=Ext.get(this.attachmentsId);this.attachmentsEl.on("click",this.openAttachment,this);if(this.attachmentContextMenu){this.attachmentsEl.on("contextmenu",this.onAttachmentContextMenu,this)}}this.body.scrollTo("top",0);if(this.data["new"]=="1"&&this.data.notification){if(confirm(GO.email.lang.sendNotification.replace("%s",this.data.notification))){var b={task:"notification",account_id:this.data.account_id,message_to:this.data.to,notification_to:this.data.notification,subject:this.data.subject};Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:b})}}},onAttachmentContextMenu:function(c,b){if(b.id.substr(0,this.attachmentsId.length)==this.attachmentsId){var a=b.id.substr(this.attachmentsId.length+1);if(a=="zipofall"){}else{c.preventDefault();var d=this.data.attachments[a];this.attachmentContextMenu.showAt(c.getXY(),d)}}},openAttachment:function(c,b){if(b.id.substr(0,this.attachmentsId.length)==this.attachmentsId){var a=b.id.substr(this.attachmentsId.length+1);if(a=="zipofall"){this.fireEvent("zipOfAttachmentsClicked")}else{var d=this.data.attachments[a];this.fireEvent("attachmentClicked",d,this)}}},launchAddressContextMenu:function(d,a){var f="";var b="";var c=a.indexOf("?");if(c>-1){b=a.substr(7,c-7);f=a.substr(c+1)}else{b=a.substr(7)}d.preventDefault();GO.email.addressContextMenu.showAt(d.getXY(),b,"",f)},onMessageBodyContextMenu:function(c,b){if(b.tagName!="A"){b=Ext.get(b).findParent("A",10);if(!b){return false}}if(b.tagName=="A"){var a=b.attributes.href.value;if(a.substr(0,6)=="mailto"){this.launchAddressContextMenu(c,a)}}},onMessageBodyClick:function(e,target){if(target.tagName!="A"){target=Ext.get(target).findParent("A",10);if(!target){return false}}if(target.tagName=="A"){var href=target.attributes.href.value;if(href.substr(0,6)=="mailto"){this.launchAddressContextMenu(e,href)}else{if(href.substr(0,3)=="go:"){e.preventDefault();var cmd="GO.mailFunctions."+href.substr(3);eval(cmd)}else{if(target.href&&target.href.indexOf("#")!=-1&&target.pathname==document.location.pathname){}else{e.preventDefault();this.fireEvent("linkClicked",href)}}}}}});GO.email.AccountsDialog=function(a){if(!a){a={}}this.accountsGrid=new GO.email.AccountsGrid({region:"center"});this.accountDialog=new GO.email.AccountDialog();a.maximizable=true;a.layout="fit";a.modal=false;a.resizable=true;a.border=false;a.width=600;a.height=400;a.closeAction="hide";a.title=GO.email.lang.accounts;var b;if(GO.settings.modules.email.write_permission){b=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.accountDialog.show()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.accountsGrid.deleteSelected({callback:function(){if(GO.email.aliasesStore.loaded){GO.email.aliasesStore.reload()}this.accountsGrid.fireEvent("delete",this)},scope:this})},scope:this}]}a.tbar=b;a.buttons=[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];a.items=this.accountsGrid;this.accountDialog.on("save",function(){this.accountsGrid.store.reload();if(GO.email.aliasesStore.loaded){GO.email.aliasesStore.reload()}},this);this.accountsGrid.on("rowdblclick",function(d,e){var c=d.getStore().getAt(e);this.accountDialog.show(c.data.id)},this);GO.email.AccountsDialog.superclass.constructor.call(this,a)};Ext.extend(GO.email.AccountsDialog,Ext.Window,{});GO.email.AccountsGrid=function(a){if(!a){a={}}a.layout="fit";a.border=false;a.autoScroll=true;a.store=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"accounts"},root:"results",totalProperty:"total",id:"id",fields:["id","email","host","user_name","username"],remoteSort:true,sortInfo:{field:"email",direction:"ASC"}});a.paging=true;var b=new Ext.grid.ColumnModel([{header:GO.lang.strEmail,dataIndex:"email"},{header:GO.lang.strUsername,dataIndex:"username"},{header:GO.lang.strOwner,dataIndex:"user_name",sortable:false},{header:GO.email.lang.host,dataIndex:"host"}]);b.defaultSortable=true;a.cm=b;a.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;GO.email.AccountsGrid.superclass.constructor.call(this,a);this.addEvents({"delete":true})};Ext.extend(GO.email.AccountsGrid,GO.grid.GridPanel,{});GO.email.MessagesGrid=function(a){if(!a){a={}}a.layout="fit";a.autoScroll=true;a.paging=true;if(a.region=="north"){this.searchtypeWidth=150;this.searchfieldWidth=320;a.cm=new Ext.grid.ColumnModel([{header:"&nbsp;",width:50,dataIndex:"icon",renderer:this.renderIcon,hideable:false,sortable:false},{header:GO.email.lang.from,dataIndex:"from",id:"from"},{header:GO.email.lang.subject,dataIndex:"subject"},{header:GO.lang.strDate,dataIndex:"date",width:65,align:"right"}]);a.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems,getRowClass:function(c,b){if(c.data["new"]=="1"){return"ml-new-row"}}})}else{this.searchtypeWidth=120;this.searchfieldWidth=150;a.cm=new Ext.grid.ColumnModel([{header:"&nbsp;",width:46,dataIndex:"icon",renderer:this.renderIcon,hideable:false,sortable:false},{header:GO.email.lang.message,dataIndex:"from",renderer:this.renderMessage,css:"white-space:normal;",id:"message"},{header:GO.lang.strDate,dataIndex:"date",width:65,align:"right"}]);a.bbar=new Ext.PagingToolbar({cls:"go-paging-tb",store:a.store,pageSize:parseInt(GO.settings.max_rows_list),displayInfo:true,displayMsg:GO.lang.displayingItemsShort,emptyMsg:GO.lang.strNoItems});a.autoExpandColumn="message";a.view=new Ext.grid.GridView({emptyText:GO.lang.strNoItems})}a.cm.defaultSortable=true;a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;a.border=false;a.split=true;a.enableDragDrop=true;a.ddGroup="EmailDD";a.animCollapse=false;this.searchType=new GO.form.ComboBox({width:this.searchtypeWidth,store:new Ext.data.SimpleStore({fields:["value","text"],data:[["from",GO.email.lang.searchFrom],["subject",GO.email.lang.subject],["to",GO.email.lang.searchTo],["cc",GO.email.lang.searchCC]]}),value:GO.email.search_type_default,valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true});this.searchField=new GO.form.SearchField({store:a.store,paramName:"search",emptyText:GO.lang.strSearch,width:this.searchfieldWidth});this.showUnreadButton=new Ext.Button({text:GO.email.lang.showUnread,enableToggle:true,toggleHandler:this.toggleUnread,pressed:false});a.tbar=[this.searchType,this.searchField,this.showUnreadButton];GO.email.MessagesGrid.superclass.constructor.call(this,a);this.getBottomToolbar().onClick=function(b){if(b=="refresh"){this.store.baseParams.refresh=true}Ext.PagingToolbar.prototype.onClick.call(this,b);if(b=="refresh"){delete this.store.baseParams.refresh}};this.searchType.on("select",function(c,b){GO.email.search_type=b.data.value;if(this.searchField.getValue()){GO.email.messagesGrid.store.baseParams.search=this.searchField.getValue();this.searchField.hasSearch=true;GO.email.messagesGrid.store.reload()}},this)};Ext.extend(GO.email.MessagesGrid,GO.grid.GridPanel,{show:function(){if(GO.email.messagesGrid.store.baseParams.unread!=undefined){this.showUnreadButton.toggle(GO.email.messagesGrid.store.baseParams.unread)}if(!GO.email.search_type){GO.email.search_type=GO.email.search_type_default}this.setSearchFields(GO.email.search_type,GO.email.search_query);GO.email.MessagesGrid.superclass.show.call(this)},resetSearch:function(){GO.email.search_type=GO.email.search_type_default;GO.email.search_query="";this.setSearchFields(GO.email.search_type,GO.email.search_query)},setSearchFields:function(a,b){this.searchType.setValue(a);this.searchField.setValue(b);this.searchField.hasSearch=(b)?true:false},toggleUnread:function(a,b){GO.email.messagesGrid.store.baseParams.unread=b;GO.email.messagesGrid.store.reload()},renderMessageSmallRes:function(b,c,a){if(a.data["new"]=="1"){return String.format('<div id="sbj_'+a.data.uid+'" class="NewSubject">{0}</div>{1}',b,a.data.subject)}else{return String.format('<div id="sbj_'+a.data.uid+'" class="Subject">{0}</div>{1}',b,a.data.subject)}},renderMessage:function(b,c,a){if(a.data["new"]=="1"){return String.format('<div id="sbj_'+a.data.uid+'" class="NewSubject">{0}</div>{1}',b,a.data.subject)}else{return String.format('<div id="sbj_'+a.data.uid+'" class="Subject">{0}</div>{1}',b,a.data.subject)}},renderIcon:function(d,b,a){var c="";if(a.data.answered=="1"){c+='<div class="email-grid-icon btn-message-answered"></div>'}else{c+='<div class="email-grid-icon btn-message"></div>'}if(a.data.attachments=="1"){c+='<div class="email-grid-icon ml-icon-attach"></div>'}else{}if(a.data.priority){if(a.data.priority<3){c+='<div class="email-grid-icon btn-high-priority"></div>'}if(a.data.priority>3){c+='<div class="email-grid-icon btn-low-priority"></div>'}}if(a.data.flagged==1){c+='<div class="email-grid-icon btn-flag"></div>'}return c},renderFlagged:function(b,c,a){var d="";if(a.data.flagged==1){d+='<div class="go-icon btn-flag"></div>'}if(a.data.attachments){d+='<div class="go-icon btn-attach"></div>'}return d}});GO.email.AccountsTree=function(b){if(!b){b={}}b.layout="fit";b.split=true;b.autoScroll=true;b.width=200;b.animate=true;b.loader=new Ext.tree.TreeLoader({dataUrl:GO.settings.modules.email.url+"json.php",baseParams:{task:"tree"},preloadChildren:true});b.containerScroll=true;b.rootVisible=false;b.collapseFirst=false;b.collapsible=true;b.containerScroll=true;b.enableDD=true;b.ddGroup="EmailDD";b.bbar=new Ext.Toolbar({cls:"go-paging-tb",items:[this.statusBar=new Ext.Panel({height:20,baseCls:"em-statusbar",border:false,plain:true})]});GO.email.AccountsTree.superclass.constructor.call(this,b);var a=new Ext.tree.AsyncTreeNode({text:"Root",id:"bs-folder-0",draggable:false,iconCls:"folder-default",expanded:false});this.setRootNode(a);this.on("nodedragover",function(c){if(c.source.dragData.node.id.indexOf("account")>-1&&c.target.id.indexOf("account")>-1){if(c.point!="append"){return true}else{c.target.collapse()}}if(c.point!="append"){return false}if(c.dropNode){return((this.getNodeById(c.dropNode.id).parentNode.id!=c.target.id)&&(c.source.dragData.node.attributes.account_id==c.target.attributes.account_id))}return true},this)};Ext.extend(GO.email.AccountsTree,Ext.tree.TreePanel,{setUsage:function(a){this.statusBar.body.update(a)},moveFolder:function(b,a,c){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"move_folder",account_id:b,source_id:c.id,target_id:a},callback:function(e,g,d){var f=Ext.decode(d.responseText);if(f.success){delete c.parentNode.attributes.children;c.parentNode.reload()}else{Ext.MessageBox.alert(GO.lang.strError,f.feedback)}},scope:this})}});GO.email.UnknownRecipientsDialog=Ext.extend(Ext.Window,{initComponent:function(){this.store=new GO.data.JsonStore({root:"recipients",fields:["email","name","first_name","middle_name","last_name"]});this.list=new GO.grid.SimpleSelectList({store:this.store});this.list.on("click",function(b,e){var a=b.store.data.items[e];if(!GO.addressbook.contactDialog){GO.addressbook.contactDialog=new GO.addressbook.ContactDialog()}var d=a.data.email;var f=d.lastIndexOf(".");if(f){var c=d.substring(f+1,d.length).toUpperCase();if(GO.lang.countries[c]){a.data.country=c}}GO.addressbook.contactDialog.show();GO.addressbook.contactDialog.formPanel.form.setValues(a.data);this.store.remove(a);if(this.store.getCount()==0){this.hide()}},this);this.title=GO.email.lang.addUnknownRecipients;this.layout="fit";this.modal=false;this.height=400;this.width=600;this.closable=true;this.closeAction="hide";this.items=new Ext.Panel({autoScroll:true,items:[new Ext.Panel({border:false,html:GO.email.lang.addUnknownRecipientsText}),this.list],cls:"go-form-panel"});GO.email.UnknownRecipientsDialog.superclass.initComponent.call(this)}});GO.email.AddressbookDialog=function(b){Ext.apply(this,b);var a=Array();this.usersStore=new GO.data.JsonStore({url:GO.settings.modules.users.url+"non_admin_json.php",baseParams:{task:"users"},id:"id",root:"results",fields:["id","username","name","company","logins","lastlogin","registration_time","address","zip","city","state","country","phone","email","waddress","wzip","wcity","wstate","wcountry","wphone"],totalProperty:"total",remoteSort:true});this.usersSearchField=new GO.form.SearchField({store:this.usersStore,width:320});this.usersGrid=new GO.grid.GridPanel({title:GO.addressbook.lang.users,paging:true,border:false,store:this.usersStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel(),tbar:[GO.lang.strSearch+": "," ",this.usersSearchField]});this.usersGrid.on("show",function(){this.usersStore.load()},this);a.push(this.usersGrid);this.userGroupsStore=new GO.data.JsonStore({url:GO.settings.modules.groups.url+"non_admin_json.php",baseParams:{task:"groups"},id:"id",root:"results",fields:["id","name","user_id","user_name"],totalProperty:"total",remoteSort:true});this.userGroupsGrid=new GO.grid.GridPanel({title:GO.email.lang.groups,paging:true,border:false,store:this.userGroupsStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strOwner,dataIndex:"user_name",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel()});this.userGroupsGrid.on("show",function(){this.userGroupsStore.load()},this);a.push(this.userGroupsGrid);if(GO.addressbook){this.contactsStore=new GO.data.JsonStore({url:GO.settings.modules.addressbook.url+"json.php",baseParams:{task:"contacts",require_email:true},root:"results",id:"id",totalProperty:"total",fields:["id","name","company_name","email","home_phone","work_phone","work_fax","cellular"],remoteSort:true});this.contactsSearchField=new GO.form.SearchField({store:this.contactsStore,width:320});this.contactsGrid=new GO.grid.GridPanel({title:GO.addressbook.lang.contacts,paging:true,border:false,store:this.contactsStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel(),tbar:[GO.lang.strSearch+": "," ",this.contactsSearchField]});this.contactsGrid.on("show",function(){this.contactsStore.load()},this);this.companiesStore=new GO.data.JsonStore({url:GO.settings.modules.addressbook.url+"json.php",baseParams:{task:"companies",require_email:true},root:"results",id:"id",totalProperty:"total",fields:["id","name","city","email","phone","homepage","address","zip"],remoteSort:true});this.companySearchField=new GO.form.SearchField({store:this.companiesStore,width:320});this.companyGrid=new GO.grid.GridPanel({title:GO.addressbook.lang.companies,paging:true,border:false,store:this.companiesStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel(),tbar:[GO.lang.strSearch+": "," ",this.companySearchField]});this.companyGrid.on("show",function(){this.companiesStore.load()},this);a.push(this.contactsGrid);a.push(this.companyGrid)}if(GO.mailings){this.mailingsGrid=new GO.grid.GridPanel({title:GO.mailings.lang.cmdPanelMailings,paging:false,border:false,store:GO.mailings.readableMailingsStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel()});this.mailingsGrid.on("show",function(){if(!GO.mailings.readableMailingsStore.loaded){GO.mailings.readableMailingsStore.load()}},this);a.push(this.mailingsGrid)}this.tabPanel=new Ext.TabPanel({activeTab:0,items:a,border:false});GO.email.AddressbookDialog.superclass.constructor.call(this,{layout:"fit",modal:false,height:400,width:600,closeAction:"hide",title:GO.addressbook.lang.addressbook,items:this.tabPanel,buttons:[{text:GO.email.lang.addToRecipients,handler:function(){this.addRecipients("to")},scope:this},{text:GO.email.lang.addToCC,handler:function(){this.addRecipients("cc")},scope:this},{text:GO.email.lang.addToBCC,handler:function(){this.addRecipients("bcc")},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});this.addEvents({addrecipients:true})};Ext.extend(GO.email.AddressbookDialog,Ext.Window,{addRecipients:function(f){var g="";var e=this.tabPanel.getLayout().activeItem;var c=e.selModel.getSelections();if(this.mailingsGrid&&e==this.mailingsGrid){var d=[];for(var b=0;b<c.length;b++){d.push(c[b].data.id)}this.el.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.mailings.url+"json.php",params:{task:"mailing_group_string",mailing_groups:d.join(",")},callback:function(j,k,i){g=i.responseText;this.fireEvent("addrecipients",f,g);this.el.unmask()},scope:this})}else{if(e==this.userGroupsGrid){var a=[];for(var b=0;b<c.length;b++){a.push(c[b].data.id)}this.el.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.groups.url+"non_admin_json.php",params:{task:"user_groups_string",user_groups:a.join(",")},callback:function(j,k,i){g=i.responseText;this.fireEvent("addrecipients",f,g);this.el.unmask()},scope:this})}else{var h=[];for(var b=0;b<c.length;b++){h.push('"'+c[b].data.name+'" <'+c[b].data.email+">")}g=h.join(", ");this.fireEvent("addrecipients",f,g)}}}});GO.email.EmailComposer=function(d){Ext.apply(d);var g=Ext.id();var e=[this.notifyCheck=new Ext.menu.CheckItem({text:GO.email.lang.notification,checked:false,checkHandler:function(i,j){this.sendParams.notification=j?"true":"false"},scope:this}),"-",'<div class="menu-title">'+GO.email.lang.priority+"</div>",{text:GO.email.lang.high,checked:false,group:g,checkHandler:function(){this.sendParams.priority="1"},scope:this},this.normalPriorityCheck=new Ext.menu.CheckItem({text:GO.email.lang.normal,checked:true,group:g,checkHandler:function(){this.sendParams.priority="3"},scope:this}),{text:GO.email.lang.low,checked:false,group:g,checkHandler:function(){this.sendParams.priority="5"},scope:this},"-",this.htmlCheck=new Ext.menu.CheckItem({text:GO.email.lang.htmlMarkup,checked:GO.email.useHtmlMarkup,listeners:{checkchange:function(i,k){if(this.bodyContentAtWindowOpen==this.editor.getValue()||confirm(GO.email.lang.confirmLostChanges)){this.setContentTypeHtml(k);this.showConfig.keepEditingMode=true;var j=this.formPanel.form.getValues();if(!this.showConfig.values){this.showConfig.values={}}Ext.apply(this.showConfig.values,j);delete this.showConfig.move;this.show(this.showConfig)}else{i.setChecked(!k,true)}},scope:this}})];if(GO.gnupg){e.push("-");e.push(this.encryptCheck=new Ext.menu.CheckItem({text:GO.gnupg.lang.encryptMessage,checked:false,listeners:{checkchange:function(i,j){if(this.formPanel.baseParams.content_type=="html"){if(!confirm(GO.gnupg.lang.confirmChangeToText)){i.setChecked(!j,true);return false}else{this.setContentTypeHtml(false);this.htmlCheck.setChecked(false,true);this.showConfig.keepEditingMode=true;this.show(this.showConfig)}}this.htmlCheck.setDisabled(j);this.sendParams.encrypt=j?"1":"0";return true},scope:this}}))}this.optionsMenu=new Ext.menu.Menu({items:e});this.showMenu=new Ext.menu.Menu({items:[this.formFieldCheck=new Ext.menu.CheckItem({text:GO.email.lang.sender,checked:true,checkHandler:this.onShowFieldCheck,scope:this}),this.ccFieldCheck=new Ext.menu.CheckItem({text:GO.email.lang.ccField,checked:false,checkHandler:this.onShowFieldCheck,scope:this}),this.bccFieldCheck=new Ext.menu.CheckItem({text:GO.email.lang.bccField,checked:false,checkHandler:this.onShowFieldCheck,scope:this})]});var f=new GO.plugins.HtmlEditorImageInsert();f.on("insert",function(i){this.inline_attachments.push({tmp_file:i.selectedRecord.get("id"),url:i.selectedUrl})},this);var b=[this.fromCombo=new Ext.form.ComboBox({store:GO.email.aliasesStore,fieldLabel:GO.email.lang.from,name:"alias_name",anchor:"100%",displayField:"name",valueField:"id",hiddenName:"alias_id",forceSelection:true,triggerAction:"all",mode:"local",tpl:'<tpl for="."><div class="x-combo-list-item">{name:htmlEncode}</div></tpl>',listeners:{beforeselect:function(j,n){var l=j.store.getById(j.getValue());var k=l.get(this.formPanel.baseParams.content_type+"_signature");var m=n.get(this.formPanel.baseParams.content_type+"_signature");var i=this.editor.getValue();if(GO.util.empty(k)){this.addSignature(n)}else{this.editor.setValue(i.replace(k,m))}},scope:this}}),this.toCombo=new GO.form.ComboBoxMulti({sep:",",fieldLabel:GO.email.lang.sendTo,name:"to",anchor:"100%",height:50,store:new Ext.data.JsonStore({url:BaseHref+"json.php",baseParams:{task:"email"},fields:["full_email"],root:"persons"}),displayField:"full_email"}),this.ccCombo=new GO.form.ComboBoxMulti({sep:",",fieldLabel:GO.email.lang.cc,name:"cc",anchor:"100%",height:50,store:new Ext.data.JsonStore({url:BaseHref+"json.php",baseParams:{task:"email"},fields:["full_email"],root:"persons"}),displayField:"full_email",hideTrigger:true,minChars:2,triggerAction:"all",selectOnFocus:false}),this.bccCombo=new GO.form.ComboBoxMulti({sep:",",fieldLabel:GO.email.lang.bcc,name:"bcc",anchor:"100%",height:50,store:new Ext.data.JsonStore({url:BaseHref+"json.php",baseParams:{task:"email"},fields:["full_email"],root:"persons"}),displayField:"full_email",hideTrigger:true,minChars:2,triggerAction:"all",selectOnFocus:false})];var c=-113;if(GO.mailings){this.selectLinkField=new GO.form.SelectLink({anchor:"100%"});c+=26;b.push(this.selectLinkField)}b.push(this.subjectField=new Ext.form.TextField({fieldLabel:GO.email.lang.subject,name:"subject",anchor:"100%"}));b.push(this.htmlEditor=new Ext.form.HtmlEditor({hideLabel:true,name:"body",anchor:"100% "+c,plugins:f}));b.push(this.textEditor=new Ext.form.TextArea({name:"textbody",anchor:"100% "+c,hideLabel:true}));this.formPanel=new Ext.form.FormPanel({border:false,labelWidth:100,waitMsgTarget:true,baseParams:{content_type:"html"},cls:"go-form-panel",defaultType:"textfield",items:b});this.formPanel.form.timeout=3000;this.htmlEditor.on("push",function(){this.bodyContentAtWindowOpen=this.htmlEditor.getValue()},this,{single:true});this.attachmentsStore=new Ext.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"attachments"},root:"results",fields:["tmp_name","name","size","type"],id:"tmp_name"});this.attachmentsStore.on("remove",this.updateAttachmentsButton,this);this.attachmentsStore.on("load",this.updateAttachmentsButton,this);if(GO.mailings){this.templatesStore=new GO.data.JsonStore({url:GO.settings.modules.mailings.url+"json.php",baseParams:{task:"authorized_templates"},root:"results",totalProperty:"total",id:"id",fields:["id","name","default_template"],remoteSort:true});this.templatesList=new GO.email.TemplatesList({store:this.templatesStore});this.templatesList.on("click",function(i,j){this.showConfig.template_id=j>0?i.store.data.items[j-1].id:0;if(this.templateDefault.checked){this.templatesStore.baseParams.default_template_id=this.showConfig.template_id;this.templatesStore.load();delete this.templatesStore.baseParams.default_template_id;this.templateDefault.setValue(false)}this.show(this.showConfig);this.templatesWindow.hide();this.templatesList.clearSelections()},this);this.defaultTemplatePanel=new Ext.FormPanel({autoHeight:true,cls:"go-form-panel",region:"south",items:[this.templateDefault=new Ext.form.Checkbox({name:"templateDefault",boxLabel:GO.email.lang.defaultTemplate,anchor:"100%",hideLabel:true,checked:false})]});this.templatesWindow=new Ext.Window({title:GO.email.lang.selectTemplate,layout:"border",modal:false,height:400,width:600,closable:true,closeAction:"hide",items:[new Ext.Panel({region:"center",autoScroll:true,items:[this.templatesList],cls:"go-form-panel"}),this.defaultTemplatePanel]})}var h=[this.sendButton=new Ext.Button({text:GO.email.lang.send,iconCls:"btn-send",handler:function(){this.sendMail()},scope:this}),{text:GO.email.lang.extraOptions,iconCls:"btn-settings",menu:this.optionsMenu},this.showMenuButton=new Ext.Button({text:GO.email.lang.show,iconCls:"btn-show",menu:this.showMenu}),this.attachmentsButton=new Ext.Button({text:GO.email.lang.attachments,iconCls:"btn-attach",handler:this.showAttachmentsDialog,scope:this}),this.saveButton=new Ext.Button({iconCls:"btn-save",text:GO.lang.cmdSave,handler:function(){this.sendMail(true)},scope:this})];if(GO.addressbook){h.push({text:GO.addressbook.lang.addressbook,iconCls:"btn-addressbook",handler:function(){if(!this.addressbookDialog){this.addressbookDialog=new GO.email.AddressbookDialog();this.addressbookDialog.on("addrecipients",function(l,j){var k=this.formPanel.form.findField(l);var i=k.getValue();if(i!=""&&i.substring(i.length-1,i.length)!=","&&i.substring(i.length-2,i.length-1)!=","){i+=", "}i+=j;k.setValue(i);if(l=="cc"){this.ccFieldCheck.setChecked(true)}else{if(l=="bcc"){this.bccFieldCheck.setChecked(true)}}},this)}this.addressbookDialog.show()},scope:this})}var a=function(){this.toCombo.focus()};GO.email.EmailComposer.superclass.constructor.call(this,{title:GO.email.lang.composeEmail,width:700,height:500,minWidth:300,minHeight:200,layout:"fit",maximizable:true,collapsible:true,animCollapse:false,plain:true,closeAction:"hide",buttonAlign:"center",focus:a.createDelegate(this),tbar:h,items:this.formPanel});this.addEvents({send:true})};Ext.extend(GO.email.EmailComposer,Ext.Window,{showConfig:{},autoSaveTask:{},lastAutoSave:false,bodyContentAtWindowOpen:false,setContentTypeHtml:function(a){this.formPanel.baseParams.content_type=a?"html":"plain";this.htmlEditor.getEl().up(".x-form-item").setDisplayed(a);this.textEditor.getEl().up(".x-form-item").setDisplayed(!a);this.editor=a?this.htmlEditor:this.textEditor},autoSave:function(){if(GO.util.empty(this.sendParams.mailing_group_id)&&this.lastAutoSave&&this.lastAutoSave!=this.editor.getValue()){this.sendMail(true,true)}this.lastAutoSave=this.editor.getValue()},startAutoSave:function(){this.lastAutoSave=false;Ext.TaskMgr.start(this.autoSaveTask)},stopAutoSave:function(){Ext.TaskMgr.stop(this.autoSaveTask)},afterRender:function(){GO.email.EmailComposer.superclass.afterRender.call(this);this.autoSaveTask={run:this.autoSave,scope:this,interval:120000};this.on("hide",this.stopAutoSave,this)},toComboVisible:true,updateAttachmentsButton:function(){var a=this.attachmentsStore.getCount()>0?GO.email.lang.attachments+" ("+this.attachmentsStore.getCount()+")":GO.email.lang.attachments;this.attachmentsButton.setText(a)},reset:function(a){this.showCC(false);this.showBCC(false);this.bccFieldCheck.setChecked(false);this.ccFieldCheck.setChecked(false);this.sendParams={task:"sendmail",notification:"false",priority:"3",draft_uid:0,inline_attachments:{}};this.inline_attachments=[];this.formPanel.form.reset();if(this.defaultAcccountId){this.fromCombo.setValue(this.defaultAcccountId)}this.notifyCheck.setChecked(false);this.normalPriorityCheck.setChecked(true);if(!a){this.attachmentsStore.removeAll();this.updateAttachmentsButton()}},showCC:function(a){this.ccCombo.getEl().up(".x-form-item").setDisplayed(a);if(a){this.ccCombo.onResize()}},showBCC:function(a){this.bccCombo.getEl().up(".x-form-item").setDisplayed(a);if(a){this.bccCombo.onResize()}},show:function(d){Ext.getBody().mask(GO.lang.waitMsgLoad);this.showConfig=d;if(!this.rendered){var c=function(){var h=this.fromCombo.store.getRange();if(h.length){if(!d.account_id){this.showConfig.account_id=h[0].data.account_id}this.render(Ext.getBody());this.show(this.showConfig);return}else{Ext.Msg.alert(GO.email.lang.noAccountTitle,GO.email.lang.noAccount)}};if(!GO.mailings){d.template_id=0;this.fromCombo.store.load({callback:c,scope:this})}else{this.templatesStore.load({callback:function(){this.fromCombo.store.load({callback:c,scope:this})},scope:this})}}else{if(d.template_id==undefined&&this.templatesStore&&this.templatesStore.getTotalCount()>1){Ext.getBody().unmask();this.templatesWindow.show()}else{if(d.template_id==undefined&&this.templatesStore&&this.templatesStore.getTotalCount()==1){d.template_id=this.templatesStore.data.items[0].get("id")}this.reset(d.keepEditingMode);var b=-1;if(d.account_id){b=this.fromCombo.store.findBy(function(h,i){return h.get("account_id")==d.account_id})}if(b==-1){b=0}this.fromCombo.setValue(this.fromCombo.store.data.items[b].id);if(d.values){this.formPanel.form.setValues(d.values)}if(!d.keepEditingMode){this.setContentTypeHtml(GO.email.useHtmlMarkup);this.htmlCheck.setChecked(GO.email.useHtmlMarkup,true);if(this.encryptCheck){this.encryptCheck.setChecked(false,true)}}this.toComboVisible=true;this.showMenuButton.setDisabled(false);this.toCombo.getEl().up(".x-form-item").setDisplayed(true);this.sendURL=GO.settings.modules.email.url+"action.php";this.saveButton.setDisabled(false);if(d.move){var g=this.getPosition();this.setPagePosition(g[0]+d.move,g[1]+d.move)}if(d.mailing_group_id>0){this.sendURL=GO.settings.modules.mailings.url+"action.php";this.toComboVisible=false;this.showMenuButton.setDisabled(true);this.toCombo.getEl().up(".x-form-item").setDisplayed(false);this.showCC(false);this.showBCC(false);this.sendParams.mailing_group_id=d.mailing_group_id;this.saveButton.setDisabled(true)}if(d.uid||d.template_id||d.loadUrl){if(!d.task){d.task="template"}if(d.task=="opendraft"){this.sendParams.draft_uid=d.uid}var e=this.fromCombo.store.getById(this.fromCombo.getValue());var f=d.loadParams?d.loadParams:{uid:d.uid,account_id:e.get("account_id"),task:d.task,mailbox:d.mailbox};if(d.mailing_group_id>0){f.mailing_group_id=d.mailing_group_id}if(d.template_id>0){f.template_id=d.template_id;f.to=this.toCombo.getValue()}var a=d.loadUrl?d.loadUrl:GO.settings.modules.email.url+"json.php";delete f.content_type;this.formPanel.form.load({url:a,params:f,waitMsg:GO.lang.waitMsgLoad,failure:function(h,i){Ext.Msg.alert(GO.lang.strError,i.result.feedback)},success:function(h,i){if(d.task=="reply"||d.task=="reply_all"){this.sendParams.reply_uid=d.uid;this.sendParams.reply_mailbox=d.mailbox}if(i.result.data.inline_attachments){this.inline_attachments=i.result.data.inline_attachments}if(i.result.data.attachments){this.attachmentsStore.loadData({results:i.result.data.attachments},true)}this.afterShowAndLoad(f.task!="opendraft")},scope:this})}else{this.afterShowAndLoad(true)}}}},afterShowAndLoad:function(a){if(a){this.addSignature()}if(this.formPanel.baseParams.content_type=="plain"){this.editor.selectText(0,0)}if(this.toCombo.getValue()==""){this.toCombo.focus()}else{this.editor.focus()}this.setEditorHeight();this.startAutoSave();this.bodyContentAtWindowOpen=this.editor.getValue();this.bccFieldCheck.setChecked(this.bccCombo.getValue()!="");this.ccFieldCheck.setChecked(this.ccCombo.getValue()!="");Ext.getBody().unmask();GO.email.EmailComposer.superclass.show.call(this)},addSignature:function(a){a=a||this.fromCombo.store.getById(this.fromCombo.getValue());var b=a.get(this.formPanel.baseParams.content_type+"_signature");if(!GO.util.empty(b)){if(this.formPanel.baseParams.content_type=="plain"){b="\n"+b+"\n"}else{b="<br />"+b+"<br />"}}this.editor.setValue(b+this.editor.getValue())},showAttachmentsDialog:function(){if(!this.attachmentsDialog){var b=[];b.push({iconCls:"btn-add",text:GO.email.lang.attachFilesPC,cls:"x-btn-text-icon",handler:function(){this.uploadDialog.show()},scope:this});if(GO.files){b.push({iconCls:"btn-add",text:GO.email.lang.attachFilesGO,cls:"x-btn-text-icon",handler:function(){if(!this.fileBrowser){this.fileBrowser=new GO.files.FileBrowser({border:false,fileClickHandler:this.addRemoteFiles,scope:this});this.fileBrowserWindow=new Ext.Window({title:GO.lang.strSelectFiles,height:480,width:680,layout:"fit",border:false,closeAction:"hide",items:this.fileBrowser,buttons:[{text:GO.lang.cmdOk,handler:this.addRemoteFiles,scope:this},{text:GO.lang.cmdClose,handler:function(){this.fileBrowserWindow.hide()},scope:this}]})}this.fileBrowserWindow.show()},scope:this})}b.push({iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){var d=this.attachmentsGrid.selModel.getSelections();for(var c=0;c<d.length;c++){this.attachmentsStore.remove(d[c])}},scope:this});this.attachmentsGrid=new GO.grid.GridPanel({store:this.attachmentsStore,loadMask:true,columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strSize,dataIndex:"size",renderer:function(c){return Ext.util.Format.fileSize(c)}},{header:GO.lang.strType,dataIndex:"type"}],sm:new Ext.grid.RowSelectionModel({singleSelect:false}),view:new Ext.grid.GridView({forceFit:true,autoFill:true}),tbar:b});this.attachmentsDialog=new Ext.Window({title:GO.email.lang.attachments,layout:"fit",modal:false,closeAction:"hide",minWidth:300,minHeight:300,height:400,width:600,items:this.attachmentsGrid,buttons:[{text:GO.lang.cmdClose,handler:function(){this.attachmentsDialog.hide()},scope:this}]});var a=new GO.form.UploadFile({inputName:"attachments",addText:GO.lang.smallUpload});this.upForm=new Ext.form.FormPanel({fileUpload:true,waitMsgTarget:true,items:[a,new Ext.Button({text:GO.lang.largeUpload,handler:function(){if(!deployJava.isWebStartInstalled("1.5.0")){Ext.MessageBox.alert(GO.lang.strError,GO.lang.noJava)}else{var c=this.local_path?"true":false;window.open(GO.settings.modules.email.url+"jupload/index.php");this.uploadDialog.hide();GO.attachmentsStore=this.attachmentsStore}},scope:this})],cls:"go-form-panel"});this.uploadDialog=new Ext.Window({title:GO.email.lang.uploadAttachments,layout:"fit",modal:true,height:300,width:300,items:this.upForm,closeAction:"hide",buttons:[{text:GO.email.lang.startTransfer,handler:function(){this.upForm.form.submit({waitMsg:GO.lang.waitMsgUpload,url:GO.settings.modules.email.url+"action.php",params:{task:"attach_file"},success:function(c,d){this.attachmentsStore.loadData({results:d.result.files},true);a.clearQueue();this.uploadDialog.hide()},scope:this})},scope:this},{text:GO.lang.cmdClose,handler:function(){this.uploadDialog.hide()},scope:this}]})}this.attachmentsDialog.show()},addRemoteFiles:function(){var a=Ext.data.Record.create([{name:"tmp_name"},{name:"id"},{name:"name"},{name:"type"},{name:"size"}]);var d=this.fileBrowser.getSelectedGridRecords();for(var c=0;c<d.length;c++){var b=new a({id:d[c].data.id,tmp_name:d[c].data.id,name:d[c].data.name,type:d[c].data.type,size:d[c].data.size});b.id=d[c].data.path;this.attachmentsStore.add(b)}this.updateAttachmentsButton();this.fileBrowserWindow.hide()},sendMail:function(b,d){if(this.uploadDialog&&this.uploadDialog.isVisible()){alert(GO.email.lang.closeUploadDialog);this.attachmentsDialog.show();this.uploadDialog.show();return false}if(d||this.subjectField.getValue()!=""||confirm(GO.email.lang.confirmEmptySubject)){if(this.attachmentsDialog&&this.attachmentsDialog.isVisible()){this.attachmentsDialog.hide()}if(this.attachmentsStore&&this.attachmentsStore.data.keys.length){var a=[];var c=this.attachmentsStore.getRange();for(var e=0;e<c.length;e++){a.push(Ext.util.Format.htmlDecode(c[e].get("tmp_name")))}this.sendParams.attachments=Ext.encode(a)}this.sendParams.inline_attachments=Ext.encode(this.inline_attachments);this.sendParams.draft=b;this.htmlEditor.syncValue();this.saveButton.setDisabled(true);this.sendButton.setDisabled(true);this.formPanel.form.submit({url:this.sendURL,params:this.sendParams,waitMsg:d?null:GO.lang.waitMsgSave,waitMsgTarget:d?null:this.formPanel.body,success:function(f,g){this.saveButton.setDisabled(false);this.sendButton.setDisabled(false);if(g.result.account_id){this.account_id=g.result.account_id}if(!b){if(this.callback){if(!this.scope){this.scope=this}var h=this.callback.createDelegate(this.scope);h.call()}if(GO.addressbook&&g.result.unknown_recipients&&g.result.unknown_recipients.length){if(!GO.email.unknownRecipientsDialog){GO.email.unknownRecipientsDialog=new GO.email.UnknownRecipientsDialog()}GO.email.unknownRecipientsDialog.store.loadData({recipients:g.result.unknown_recipients});GO.email.unknownRecipientsDialog.show()}this.fireEvent("send",this);this.hide()}else{this.sendParams.draft_uid=g.result.draft_uid;this.fireEvent("save",this)}},failure:function(g,h){if(!d){var f=h.result&&h.result.feedback?h.result.feedback:GO.lang.strRequestError;Ext.MessageBox.alert(GO.lang.strError,f)}this.saveButton.setDisabled(false);this.sendButton.setDisabled(false)},scope:this})}else{this.subjectField.focus()}},onShowFieldCheck:function(a,b){switch(a.id){case this.formFieldCheck.id:this.fromCombo.getEl().up(".x-form-item").setDisplayed(b);break;case this.ccFieldCheck.id:this.showCC(b);break;case this.bccFieldCheck.id:this.showBCC(b);break}this.setEditorHeight()},setEditorHeight:function(){var c=this.subjectField.getEl().up(".x-form-item");var b=c.getHeight()+c.getMargins("tb");if(GO.mailings){var a=this.selectLinkField.getEl().up(".x-form-item");b+=a.getHeight()+a.getMargins("tb")}if(this.toComboVisible){var g=this.toCombo.getEl().up(".x-form-item");b+=g.getHeight()+g.getMargins("tb")}var f;for(var e=0;e<this.showMenu.items.items.length;e++){if(this.showMenu.items.items[e].checked){if(e==0){f=this.fromCombo.getEl().up(".x-form-item")}else{f=this.toCombo.getEl().up(".x-form-item")}b+=f.getHeight()+f.getMargins("tb")}}b+=4;var d="100% -"+b;this.htmlEditor.anchor=d;delete this.htmlEditor.anchorSpec;this.textEditor.anchor=d;delete this.textEditor.anchorSpec;this.htmlEditor.syncSize();this.formPanel.doLayout()}});GO.email.TemplatesList=function(b){Ext.apply(b);var a=new Ext.XTemplate('<div id="template-0" class="go-item-wrap">'+GO.mailings.lang.noTemplate+"</div>",'<tpl for=".">','<div id="template-{id}" class="go-item-wrap"">{name}</div>','<tpl if="!GO.util.empty(default_template)"><div class="ml-template-default-spacer"></div></tpl>',"</tpl>");GO.email.TemplatesList.superclass.constructor.call(this,{store:b.store,tpl:a,singleSelect:true,autoHeight:true,overClass:"go-view-over",itemSelector:"div.go-item-wrap",selectedClass:"go-view-selected"})};Ext.extend(GO.email.TemplatesList,Ext.DataView,{onRender:function(b,a){this.el=b.createChild({tag:"div",cls:"go-select-list"});GO.email.TemplatesList.superclass.onRender.apply(this,arguments)}});Ext.namespace("GO.email");GO.email.EmailClient=function(c){if(!c){c={}}this.messagesStore=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{node:"",type:"messages"},root:"results",totalProperty:"total",id:"uid",fields:["uid","icon","flagged","attachments","new","subject","from","sender","size","date","priority","answered"],remoteSort:true});this.messagesStore.setDefaultSort("date","DESC");var b=Ext.state.Manager.get("em-msgs-top");if(b){b=Ext.decode(b)}else{b=screen.width<1024}var g={callback:function(){if(this.messagePanel.uid&&!this.messagesGrid.store.getById(this.messagePanel.uid)){this.messagePanel.reset()}},scope:this};this.leftMessagesGrid=new GO.email.MessagesGrid({id:"em-pnl-west",store:this.messagesStore,width:420,region:"west",hidden:b,deleteConfig:g,floatable:false,collapsible:true,collapseMode:"mini",split:true});this.addGridHandlers(this.leftMessagesGrid);this.topMessagesGrid=new GO.email.MessagesGrid({id:"em-pnl-north",store:this.messagesStore,height:250,region:"north",hidden:!b,deleteConfig:g,floatable:false,collapsible:true,collapseMode:"mini",split:true});this.addGridHandlers(this.topMessagesGrid);if(!this.topMessagesGrid.hidden){this.messagesGrid=this.topMessagesGrid}else{this.messagesGrid=this.leftMessagesGrid}GO.email.messagesGrid=this.messagesGrid;this.messagesGrid.store.on("beforeload",function(){if(this.messagesGrid.store.baseParams.search!=undefined){GO.email.search_query=this.messagesGrid.store.baseParams.search;this.searchDialog.hasSearch=false;delete (this.messagesGrid.store.baseParams.search)}else{if(this.searchDialog.hasSearch){this.messagesGrid.resetSearch()}}if(GO.email.search_query){this.searchDialog.hasSearch=false;var i=(GO.email.search_type)?GO.email.search_type:GO.email.search_type_default;this.messagesGrid.store.baseParams.query=i.toUpperCase()+' "'+GO.email.search_query+'"'}else{if(!this.searchDialog.hasSearch&&this.messagesGrid.store.baseParams.query){this.messagesGrid.resetSearch();delete (this.messagesGrid.store.baseParams.query)}}},this);this.messagesGrid.store.on("load",function(){var i=this.topMessagesGrid.getColumnModel();var n=this.messagesGrid.store.reader.jsonData.sent?GO.email.lang.to:GO.email.lang.from;i.setColumnHeader(i.getIndexById("from"),n);var m=this.messagesGrid.store.reader.jsonData.unseen;for(var j in m){this.updateFolderStatus(j,m[j])}if(this.messagesGrid.store.baseParams.query&&this.messagesGrid.store.baseParams.query!=""&&this.searchDialog.hasSearch){this.resetSearchButton.setVisible(true)}else{this.resetSearchButton.setVisible(false)}var k=this.treePanel.getSelectionModel();if(!k.getSelectedNode()){var l=this.treePanel.getNodeById("folder_"+this.messagesGrid.store.reader.jsonData.folder_id);if(l){k.select(l)}}this.messagesGrid.deleteConfig.noConfirmation=!this.messagesGrid.store.reader.jsonData.trash&&!GO.util.empty(this.messagesGrid.store.reader.jsonData.trash_folder)},this);GO.email.saveAsItems=GO.email.saveAsItems||[];for(var e=0;e<GO.email.saveAsItems.length;e++){GO.email.saveAsItems[e].scope=this}var d=[{text:GO.email.lang.markAsRead,handler:function(){this.doTaskOnMessages("mark_as_read")},scope:this,multiple:true},{text:GO.email.lang.markAsUnread,handler:function(){this.doTaskOnMessages("mark_as_unread")},scope:this,multiple:true},{text:GO.email.lang.flag,handler:function(){this.doTaskOnMessages("flag")},scope:this,multiple:true},{text:GO.email.lang.unflag,handler:function(){this.doTaskOnMessages("unflag")},scope:this,multiple:true},"-",{text:GO.email.lang.viewSource,handler:function(){var i=this.messagesGrid.selModel.getSelected();if(i){var j=window.open(GO.settings.modules.email.url+"source.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+encodeURIComponent(i.data.uid));j.focus()}},scope:this},"-",{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.messagesGrid.deleteSelected()},scope:this,multiple:true},"-",{iconCls:"btn-add",text:GO.email.lang.addSendersTo,cls:"x-btn-text-icon",menu:{items:[{text:GO.email.lang.to,field:"to",handler:this.addSendersTo,scope:this},{text:"CC",field:"cc",handler:this.addSendersTo,scope:this},{text:"BCC",field:"bcc",handler:this.addSendersTo,scope:this}]},multiple:true}];if(GO.email.saveAsItems&&GO.email.saveAsItems.length){this.saveAsMenu=new Ext.menu.Menu({items:GO.email.saveAsItems});this.saveAsMenu.on("show",function(n){var o=this.messagesGrid.getSelectionModel();var j=o.getSelections().length>1;var l=o.getSelections().length==0;for(var k=0;k<n.items.getCount();k++){var m=n.items.get(k);m.setDisabled(l||(!m.multiple&&j))}},this);d.push({iconCls:"btn-save",text:GO.lang.cmdSaveAs,menu:this.saveAsMenu,multiple:true})}this.gridContextMenu=new GO.menu.RecordsContextMenu({shadow:"frame",minWidth:180,items:d});this.treePanel=new GO.email.AccountsTree({id:"email-tree-panel",region:"west"});var a=new Ext.tree.AsyncTreeNode({text:GO.email.lang.accounts,draggable:false});this.treePanel.setRootNode(a);this.treeContextMenu=new Ext.menu.Menu({items:[this.addFolderButton=new Ext.menu.Item({iconCls:"btn-add",text:GO.email.lang.addFolder,handler:function(){Ext.MessageBox.prompt(GO.lang.strName,GO.email.lang.enterFolderName,function(i,k){if(i=="ok"){var l=this.treePanel.getSelectionModel();var j=l.getSelectedNode();Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"add_folder",folder_id:j.attributes.folder_id,account_id:j.attributes.account_id,new_folder_name:k},callback:function(n,p,m){if(!p){Ext.MessageBox.alert(GO.lang.strError,m.result.errors)}else{var o=Ext.decode(m.responseText);if(o.success){delete j.attributes.children;j.reload()}else{Ext.MessageBox.alert(GO.lang.strError,o.feedback)}}},scope:this})}},this)},scope:this}),this.renameFolderButton=new Ext.menu.Item({iconCls:"btn-edit",text:GO.email.lang.renameFolder,handler:function(){var j=this.treePanel.getSelectionModel();var i=j.getSelectedNode();if(!i||i.attributes.folder_id<1){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.selectFolderRename)}else{if(i.attributes.mailbox=="INBOX"){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.cantRenameInboxFolder)}else{Ext.MessageBox.prompt(GO.lang.strName,GO.email.lang.enterFolderName,function(k,m){if(k=="ok"){var n=this.treePanel.getSelectionModel();var l=n.getSelectedNode();this.el.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"rename_folder",folder_id:l.attributes.folder_id,new_name:m},callback:function(q,s,o){if(!s){Ext.MessageBox.alert(GO.lang.strError,o.result.errors);this.el.unmask()}else{var r=Ext.decode(o.responseText);if(r.success){delete l.parentNode.attributes.children;var p=function(){var t=this.treePanel.getNodeById("folder_"+this.folder_id);if(t){if(this.folder_id==t.attributes.folder_id){this.mailbox=t.attributes.mailbox;this.treePanel.getSelectionModel().select(t)}}this.el.unmask()};l.parentNode.reload(p.createDelegate(this))}else{Ext.MessageBox.alert(GO.lang.strError,r.feedback);this.el.unmask()}}},scope:this})}},this,false,i.attributes.name)}}},scope:this}),"-",{iconCls:"btn-delete",text:GO.email.lang.emptyFolder,handler:function(){var k=this.treePanel.getSelectionModel();var j=k.getSelectedNode();var i=new Ext.Template(GO.email.lang.emptyFolderConfirm);Ext.MessageBox.confirm(GO.lang.strConfirm,i.applyTemplate(j.attributes),function(l){if(l=="yes"){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"empty_folder",account_id:j.attributes.account_id,mailbox:j.attributes.mailbox},callback:function(){if(j.attributes.mailbox==this.mailbox){this.messagesGrid.store.removeAll()}this.updateFolderStatus(j.attributes.folder_id);this.updateNotificationEl()},scope:this})}},this)},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",scope:this,handler:function(){var j=this.treePanel.getSelectionModel();var i=j.getSelectedNode();if(!i||i.attributes.folder_id<1){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.selectFolderDelete)}else{if(i.attributes.mailbox=="INBOX"){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.cantDeleteInboxFolder)}else{GO.deleteItems({url:GO.settings.modules.email.url+"action.php",params:{task:"delete_folder",folder_id:i.attributes.folder_id},callback:function(k){if(k.success){i.remove();if(i.attributes.mailbox==this.messagesGrid.store.baseParams.mailbox){this.messagesGrid.store.removeAll()}}else{Ext.MessageBox.alert(GO.lang.strError,k.feedback)}},count:1,scope:this})}}}}]});this.treePanel.on("contextmenu",function(j,l){l.stopEvent();var i=this.treePanel.getSelectionModel();if(!i.isSelected(j)){i.clearSelections();i.select(j)}var k=l.getXY();this.addFolderButton.setDisabled(!j.attributes.canHaveChildren);this.treeContextMenu.showAt([k[0],k[1]])},this);this.treePanel.on("beforenodedrop",function(o){if(!o.dropNode){var t=o.data.selections,l=[];for(var m=0,n=t.length;m<n;m++){l.push(t[m].id)}if(l.length>0){if(this.account_id!=o.target.attributes.account_id){var k={task:"move",from_account_id:this.account_id,to_account_id:o.target.attributes.account_id,from_mailbox:this.mailbox,to_mailbox:o.target.attributes.mailbox,messages:Ext.encode(l)};Ext.MessageBox.progress(GO.email.lang.moving,"","");Ext.MessageBox.updateProgress(0,"0%","");var j=new GO.data.Connection({timeout:300000});var r=function(i){if(i){delete k.messages}j.request({url:GO.settings.modules.email.url+"action.php",params:k,callback:function(u,w,s){var v=Ext.decode(s.responseText);if(!v.success){alert(v.feedback);Ext.MessageBox.hide()}else{if(v["continue"]){Ext.MessageBox.updateProgress(v.progress,(v.progress*100)+"%","");r.call(this,[true])}else{this.messagesGrid.store.reload({callback:function(){if(this.messagePanel.uid&&!this.messagesGrid.store.getById(this.messagePanel.uid)){this.messagePanel.reset()}Ext.MessageBox.hide()},scope:this})}}},scope:this})};r.call(this)}else{if(this.mailbox==o.target.mailbox){return false}else{this.messagesGrid.store.baseParams.action="move";this.messagesGrid.store.baseParams.from_account_id=this.account_id;this.messagesGrid.store.baseParams.to_account_id=o.target.attributes.account_id;this.messagesGrid.store.baseParams.from_mailbox=this.mailbox;this.messagesGrid.store.baseParams.to_mailbox=o.target.attributes.mailbox;this.messagesGrid.store.baseParams.messages=Ext.encode(l);this.messagesGrid.store.reload({callback:function(){if(this.messagePanel.uid&&!this.messagesGrid.store.getById(this.messagePanel.uid)){this.messagePanel.reset()}},scope:this});delete this.messagesGrid.store.baseParams.action;delete this.messagesGrid.store.baseParams.from_mailbox;delete this.messagesGrid.store.baseParams.to_mailbox;delete this.messagesGrid.store.baseParams.messages;delete this.messagesGrid.store.baseParams.to_account_id;delete this.messagesGrid.store.baseParams.from_account_id}}}}else{if(o.source.dragData.node.id.indexOf("account")>-1&&o.target.id.indexOf("account")>-1&&o.point!="append"){var p=[];var q=this.treePanel.getRootNode().childNodes;for(var m=q.length;m>0;m--){p.push(q[m-1].attributes.account_id)}Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"save_accounts_sort_order",sort_order:Ext.encode(p)}})}else{this.treePanel.moveFolder(o.target.attributes.account_id,o.target.id,o.data.node)}}},this);a.on("load",function(i){this.body.unmask();if(i.childNodes[0]){var j=i.childNodes[0];this.updateNotificationEl();j.on("load",function(k){if(k.childNodes[0]){var l=k.childNodes[0];this.setAccount(l.attributes.account_id,l.attributes.folder_id,l.attributes.mailbox,l.parentNode.attributes.usage);this.checkMail.defer(this.checkMailInterval,this)}},this,{single:true})}},this);this.treePanel.on("beforeclick",function(i){if(i.attributes.folder_id==0){return false}},this);this.treePanel.on("click",function(j){if(j.attributes.folder_id>0){var k="";var i=j;while(i.parentNode&&k==""){if(i.attributes.usage){k=i.attributes.usage}else{i=i.parentNode}}this.setAccount(j.attributes.account_id,j.attributes.folder_id,j.attributes.mailbox,k)}},this);this.searchDialog=new GO.email.SearchDialog({store:this.messagesGrid.store});var f=[{iconCls:"btn-accounts",text:GO.email.lang.accounts,cls:"x-btn-text-icon",handler:function(){this.showAccountsDialog()},scope:this},{iconCls:"btn-toggle-window",text:GO.email.lang.toggleWindowPosition,cls:"x-btn-text-icon",handler:function(){this.moveGrid()},scope:this}];if(GO.gnupg){f.push("-");f.push({iconCls:"gpg-btn-settings",cls:"x-btn-text-icon",text:GO.gnupg.lang.encryptionSettings,handler:function(){if(!this.securityDialog){this.securityDialog=new GO.gnupg.SecurityDialog()}this.securityDialog.show()},scope:this})}var h=[{iconCls:"btn-compose",text:GO.email.lang.compose,cls:"x-btn-text-icon",handler:function(){GO.email.showComposer({account_id:this.account_id})},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.messagesGrid.deleteSelected()},scope:this},new Ext.Toolbar.Separator(),{iconCls:"btn-settings",text:GO.lang.administration,menu:{items:f}},{iconCls:"btn-refresh",text:GO.lang.cmdRefresh,cls:"x-btn-text-icon",handler:function(){this.refresh(true)},scope:this},{iconCls:"btn-search",text:GO.lang.strSearch,cls:"x-btn-text-icon",handler:function(){this.searchDialog.show()},scope:this},this.resetSearchButton=new Ext.Button({iconCls:"btn-delete",text:GO.email.lang.resetSearch,cls:"x-btn-text-icon",hidden:true,handler:function(){this.searchDialog.hasSearch=false;this.messagesGrid.store.baseParams.query="";this.messagesGrid.store.load({params:{start:0}})},scope:this}),"-",this.replyButton=new Ext.Button({disabled:true,iconCls:"btn-reply",text:GO.email.lang.reply,cls:"x-btn-text-icon",handler:function(){GO.email.showComposer({uid:this.messagePanel.uid,task:"reply",mailbox:this.mailbox,account_id:this.account_id})},scope:this}),this.replyAllButton=new Ext.Button({disabled:true,iconCls:"btn-reply-all",text:GO.email.lang.replyAll,cls:"x-btn-text-icon",handler:function(){GO.email.showComposer({uid:this.messagePanel.uid,task:"reply_all",mailbox:this.mailbox,account_id:this.account_id})},scope:this}),this.forwardButton=new Ext.Button({disabled:"true",iconCls:"btn-forward",text:GO.email.lang.forward,cls:"x-btn-text-icon",handler:function(){GO.email.showComposer({uid:this.messagePanel.uid,task:"forward",mailbox:this.mailbox,account_id:this.account_id})},scope:this}),this.printButton=new Ext.Button({disabled:true,iconCls:"btn-print",text:GO.lang.cmdPrint,cls:"x-btn-text-icon",handler:function(){this.messagePanel.body.print()},scope:this})];if(GO.mailings){h.push({iconCls:"btn-save",text:GO.lang.cmdSaveAs,menu:this.saveAsMenu})}h.push(new Ext.Toolbar.Separator());h.push(this.closeMessageButton=new Ext.Button({hidden:true,iconCls:"btn-close",text:GO.lang.cmdClose,cls:"x-btn-text-icon",handler:function(){this.messagesGrid.expand()},scope:this}));c.layout="border";c.tbar=new Ext.Toolbar({cls:"go-head-tb",items:h});this.messagePanel=new GO.email.MessagePanel({id:"email-message-panel",region:"center",autoScroll:true,titlebar:false,border:true,attachmentContextMenu:new GO.email.AttachmentContextMenu({emailClient:this})});c.items=[this.treePanel,{region:"center",titlebar:false,layout:"border",items:[this.messagePanel,this.topMessagesGrid,this.leftMessagesGrid]}];this.messagePanel.on("load",function(k,l,j){if(!l){this.messagePanel.uid=0}else{this.replyAllButton.setDisabled(false);this.replyButton.setDisabled(false);this.forwardButton.setDisabled(false);this.printButton.setDisabled(false);var i=this.messagesGrid.store.getById(this.messagePanel.uid);if(i.data["new"]==1){this.incrementFolderStatus(this.folder_id,-1);i.set("new","0")}}},this);this.messagePanel.on("reset",function(){this.replyAllButton.setDisabled(true);this.replyButton.setDisabled(true);this.forwardButton.setDisabled(true);this.printButton.setDisabled(true)},this);this.messagePanel.on("linkClicked",function(i){var j=window.open(i);j.focus()},this);this.messagePanel.on("attachmentClicked",this.openAttachment,this);this.messagePanel.on("zipOfAttachmentsClicked",this.openZipOfAttachments,this);GO.email.searchSender=function(i){if(this.rendered){GO.email.search_type="from";this.messagesGrid.store.baseParams.search=i;this.messagesGrid.setSearchFields("from",i);this.messagesGrid.store.load({params:{start:0}});if(GO.mainLayout.tabPanel){GO.mainLayout.tabPanel.setActiveTab(this.id)}}else{alert(GO.email.lang.loadEmailFirst)}};GO.email.searchSender=GO.email.searchSender.createDelegate(this);GO.email.EmailClient.superclass.constructor.call(this,c)};Ext.extend(GO.email.EmailClient,Ext.Panel,{moveGrid:function(){if(this.topMessagesGrid.isVisible()){this.messagesGrid=this.leftMessagesGrid;this.topMessagesGrid.hide()}else{this.messagesGrid=this.topMessagesGrid;this.leftMessagesGrid.hide()}this.messagesGrid.show();this.messagesGrid.ownerCt.doLayout();Ext.state.Manager.set("em-msgs-top",Ext.encode(this.topMessagesGrid.isVisible()))},addGridHandlers:function(a){a.on("rowcontextmenu",function(b,f,d){var c=d.getXY();this.gridContextMenu.showAt([c[0],c[1]],b.getSelectionModel().getSelections())},this);a.on("collapse",function(){this.closeMessageButton.setVisible(true)},this);a.on("expand",function(){this.closeMessageButton.setVisible(false)},this);a.on("rowdblclick",function(){if(this.messagesGrid.store.reader.jsonData.drafts){GO.email.showComposer({uid:this.messagePanel.uid,task:"opendraft",template_id:0,mailbox:this.mailbox,account_id:this.account_id})}else{this.messagesGrid.collapse()}},this);a.on("delayedrowselect",function(b,d,c){if(c.data.uid!=this.messagePanel.uid){this.messagePanel.loadMessage(c.data.uid,this.mailbox,this.account_id)}},this)},checkMailInterval:300000,justMarkedUnread:0,afterRender:function(){GO.email.EmailClient.superclass.afterRender.call(this);this.body.mask(GO.lang.waitMsgLoad);var a=Ext.get("notification-area");if(a){this.notificationEl=a.createChild({id:"ml-notify",tag:"a",href:"#",style:"display:none"});this.notificationEl.on("click",function(){this.show()},this)}},onShow:function(){if(this.notificationEl){this.notificationEl.setDisplayed(false)}GO.email.EmailClient.superclass.onShow.call(this)},updateNotificationEl:function(){if(this.notificationEl){var b=this.treePanel.getRootNode();var d=0;for(var a=0;a<b.childNodes.length;a++){d+=b.childNodes[a].attributes.inbox_new}var c=this.notificationEl.dom.innerHTML;if(c!=""&&d-this.justMarkedUnread>c){GO.playAlarm();this.notificationEl.setDisplayed(!this.isVisible())}this.notificationEl.update(d);this.justMarkedUnread=0}},saveAttachment:function(a){if(!GO.files.saveAsDialog){GO.files.saveAsDialog=new GO.files.SaveAsDialog()}GO.files.saveAsDialog.show({filename:a.name,handler:function(d,b,c){d.el.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"save_attachment",uid:this.messagePanel.uid,mailbox:this.mailbox,part:a.number,transfer:a.transfer,mime:a.mime,account_id:this.account_id,uuencoded_partnumber:a.uuencoded_partnumber,folder_id:b,filename:c},callback:function(f,h,e){d.el.unmask();if(!h){alert(GO.lang.strRequestError)}else{var g=Ext.decode(e.responseText);if(!g.success){alert(g.feedback)}else{d.hide()}}},scope:this})},scope:this})},openAttachment:function(h,b,g){if(h.mime.indexOf("message")>-1){GO.linkHandlers[9].call(this,0,{uid:this.messagePanel.uid,mailbox:this.mailbox,part:h.number,transfer:h.transfer,mime:h.mime,account_id:this.account_id})}else{switch(h.extension){case"dat":document.location.href=GO.settings.modules.email.url+"tnef.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+this.messagePanel.uid+"&part="+h.number+"&transfer="+h.transfer+"&mime="+h.mime+"&uuencoded_partnumber="+h.uuencoded_partnumber+"&filename="+encodeURIComponent(h.name);break;case"asc":if(!g&&GO.gnupg){Ext.Ajax.request({url:GO.settings.modules.gnupg.url+"action.php",params:{task:"check_public_key_attachment",account_id:this.account_id,mailbox:this.mailbox,uid:this.messagePanel.uid,part:h.number,uuencoded_partnumber:h.uuencoded_partnumber,transfer:h.transfer},callback:function(k,l,j){if(l){var i=Ext.decode(j.responseText);if(!i.is_public_key){document.location.href=GO.settings.modules.email.url+"attachment.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+this.messagePanel.uid+"&sender="+this.messagePanel.data.sender+"&part="+h.number+"&transfer="+h.transfer+"&mime="+h.mime+"&uuencoded_partnumber="+h.uuencoded_partnumber+"&filename="+encodeURIComponent(h.name)}else{if(confirm(GO.gnupg.lang.importPublicKeyAttachment)){Ext.Ajax.request({url:GO.settings.modules.gnupg.url+"action.php",params:{task:"import_public_key_attachment"},callback:function(o,p,n){if(p){var m=Ext.decode(n.responseText);alert(m.feedback)}else{alert(GO.lang.strRequestError)}}})}}}},scope:this});break}case"vcs":case"ics":if(!g){Ext.Ajax.request({url:GO.settings.modules.email.url+"json.php",params:{task:"icalendar_attachment",account_id:this.account_id,mailbox:this.mailbox,uid:this.messagePanel.uid,part:h.number,uuencoded_partnumber:h.uuencoded_partnumber,transfer:h.transfer},callback:function(k,l,j){if(l){var i=Ext.decode(j.responseText);if(!i.success){alert(i.feedback)}else{GO.calendar.eventDialog.show({values:i})}}else{alert(GO.lang.strRequestError)}},scope:this});break}case"bmp":case"png":case"gif":case"jpg":case"jpeg":if(GO.files&&!g){if(!this.imageViewer){this.imageViewer=new GO.files.ImageViewer({closeAction:"hide"})}var c=0;var a=Array();if(b){for(var d=0;d<b.data.attachments.length;d++){var f=b.data.attachments[d];var e=GO.util.getFileExtension(f.name);if(e=="jpg"||e=="png"||e=="gif"||e=="bmp"||e=="jpeg"){a.push({name:f.name,src:GO.settings.modules.email.url+"attachment.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+this.messagePanel.uid+"&part="+f.number+"&transfer="+f.transfer+"&mime="+f.mime+"&uuencoded_partnumber="+h.uuencoded_partnumber+"&filename="+encodeURIComponent(f.name)})}if(f.name==h.name){c=a.length-1}}this.imageViewer.show(a,c);break}}default:document.location.href=GO.settings.modules.email.url+"attachment.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+this.messagePanel.uid+"&sender="+this.messagePanel.data.sender+"&part="+h.number+"&transfer="+h.transfer+"&mime="+h.mime+"&uuencoded_partnumber="+h.uuencoded_partnumber+"&filename="+encodeURIComponent(h.name);break}}},openZipOfAttachments:function(){document.location.href=GO.settings.modules.email.url+"zip_attachments.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+this.messagePanel.uid},showComposer:function(a){GO.email.showComposer({account_id:this.account_id,values:a})},setAccount:function(b,a,d,c){if(a!=this.folder_id){this.messagePanel.reset();this.messagesGrid.getSelectionModel().clearSelections()}this.messagesGrid.expand();this.account_id=b;this.folder_id=a;this.mailbox=d;this.messagesGrid.store.baseParams.task="messages";this.messagesGrid.store.baseParams.account_id=b;this.messagesGrid.store.baseParams.folder_id=a;this.messagesGrid.store.baseParams.mailbox=d;this.messagesGrid.store.load({params:{start:0}});this.treePanel.setUsage(c)},updateFolderStatus:function(a,f){var b=Ext.get("status_"+a);var g=false;var c=this.treePanel.getNodeById("folder_"+a);if(c&&c.attributes.mailbox=="INBOX"){c.parentNode.attributes.inbox_new=f}if(b&&b.dom){var e=b.dom.innerHTML;var d=e==""?0:parseInt(e.substring(1,e.length-1));if(d!=f){if(f>0){b.dom.innerHTML="("+f+")"}else{b.dom.innerHTML=""}return true}}return false},incrementFolderStatus:function(c,a){var d=Ext.get("status_"+c);var e=d.dom.innerHTML;var b=0;if(e!=""){var b=parseInt(e.substring(1,e.length-1))}b+=a;this.updateFolderStatus(c,b);this.updateNotificationEl()},checkMail:function(){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"check_mail"},callback:function(c,f,b){if(f){var e=Ext.decode(b.responseText);for(var a in e.status){var d=this.updateFolderStatus(a,e.status[a].unseen);if(d&&this.messagesGrid.store.baseParams.folder_id==a){this.messagesGrid.store.reload()}}this.updateNotificationEl();this.checkMail.defer(this.checkMailInterval,this)}},scope:this})},refresh:function(a){if(a){this.treePanel.loader.baseParams.refresh=true}this.treePanel.root.reload();this.messagesStore.removeAll();if(a){delete this.treePanel.loader.baseParams.refresh}},showAccountsDialog:function(){if(!this.accountsDialog){this.accountsDialog=new GO.email.AccountsDialog();this.accountsDialog.accountDialog.on("save",function(b,a){if(a.refreshNeeded){this.refresh()}},this);this.accountsDialog.accountsGrid.on("delete",function(){this.refresh()},this);this.accountsDialog.accountsGrid.store.load()}this.accountsDialog.show()},doTaskOnMessages:function(a){var b=this.messagesGrid.selModel.selections.keys;if(b.length){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"flag_messages",account_id:this.account_id,mailbox:this.mailbox,action:a,messages:Ext.encode(b)},callback:function(e,k,d){if(!k){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var j=Ext.decode(d.responseText);if(!j.success){Ext.MessageBox.alert(GO.lang.strError,j.feedback)}else{var h;var g;var c=this.messagesGrid.selModel.getSelections();switch(a){case"mark_as_read":h="new";g=false;this.justMarkedUnread-=c.length;break;case"mark_as_unread":h="new";g=true;this.justMarkedUnread+=c.length;break;case"flag":h="flagged";g=true;break;case"unflag":h="flagged";g=false;break}for(var f=0;f<c.length;f++){c[f].set(h,g);c[f].commit()}this.updateFolderStatus(this.folder_id,j.unseen);this.updateNotificationEl()}}},scope:this})}},addSendersTo:function(g){var b=this.messagesGrid.getSelectionModel().getSelections();var j=[];for(var d=0;d<b.length;d++){j.push('"'+b[d].get("from")+'" <'+b[d].get("sender")+">")}var e=false;if(GO.email.composers){for(var d=GO.email.composers.length-1;d>=0;d--){if(GO.email.composers[d].isVisible()){e=GO.email.composers[d];break}}}if(e){var h=e.formPanel.form.findField(g.field);var a=h.getValue();if(a!=""){a+=", "}a+=j.join(", ");h.setValue(a);e.focus()}else{var c={values:{}};c.values[g.field]=j.join(", ");GO.email.showComposer(c)}}});GO.mainLayout.onReady(function(){GO.email.addressContextMenu=new GO.email.AddressContextMenu();GO.email.search_type_default="from"});GO.email.aliasesStore=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"all_aliases"},root:"results",id:"id",totalProperty:"total",fields:["id","account_id","name","email","html_signature","plain_signature"],remoteSort:true});GO.email.showComposer=function(a){a=a||{};GO.email.composers=GO.email.composers||[];var c;for(var b=0;b<GO.email.composers.length;b++){if(!GO.email.composers[b].isVisible()){c=GO.email.composers[b];break}}if(!c){a.move=30*GO.email.composers.length;c=new GO.email.EmailComposer();c.on("send",function(e){if(e.sendParams.reply_uid&&e.sendParams.reply_uid>0){var d=GO.email.messagesGrid.store.getById(e.sendParams.reply_uid);if(d){d.set("answered",true)}}if(GO.email.messagesGrid&&GO.email.messagesGrid.store.loaded&&(GO.email.messagesGrid.store.reader.jsonData.sent||(GO.email.messagesGrid.store.reader.jsonData.drafts&&e.sendParams.draft_uid&&e.sendParams.draft_uid>0))){GO.email.messagesGrid.store.reload()}});c.on("save",function(d){if(GO.email.messagesGrid&&GO.email.messagesGrid.store.loaded&&GO.email.messagesGrid.store.reader.jsonData.drafts){GO.email.messagesGrid.store.reload()}});GO.email.composers.push(c)}c.show(a);return c};GO.moduleManager.addModule("email",GO.email.EmailClient,{title:GO.lang.strEmail,iconCls:"go-tab-icon-email"});GO.email.showAddressMenu=function(c,b,a){var c=Ext.EventObject.setEvent(c);c.preventDefault();GO.email.addressContextMenu.showAt(c.getXY(),b,a)};GO.linkHandlers[9]=function(e,b){var c=new GO.email.MessagePanel({border:false,autoScroll:true});c.on("linkClicked",function(f){var g=window.open(f);g.focus()},this);c.on("attachmentClicked",function(g,f){if(g.mime.indexOf("message")>-1){b.part_number=g.number+".0";GO.linkHandlers[9].call(this,e,b)}else{if(f.data.path){document.location.href=GO.settings.modules.email.url+"mimepart.php?path="+encodeURIComponent(f.data.path)+"&part_number="+g.number}else{document.location.href=GO.settings.modules.email.url+"mimepart.php?uid="+b.uid+"&account_id="+b.account_id+"&transfer="+b.transfer+"&mailbox="+encodeURIComponent(b.mailbox)+"&part="+b.part+"&part_number="+g.number}}},this);c.on("zipOfAttachmentsClicked",function(){},this);var d=new Ext.Window({maximizable:true,collapsible:true,title:GO.email.lang.emailMessage,height:400,width:600,layout:"fit",items:c,tbar:[{iconCls:"btn-print",text:GO.lang.cmdPrint,cls:"x-btn-text-icon",handler:function(){c.body.print()}}],buttons:[{text:GO.lang.cmdClose,handler:function(){d.close()}}]});d.show();c.el.mask(GO.lang.strWaitMsgLoad);if(!b){b={}}b.id=e;var a="";if(b.account_id){b.task="message_attachment";a=GO.settings.modules.email.url+"json.php"}else{b.task="linked_message";a=GO.settings.modules.mailings.url+"json.php"}Ext.Ajax.request({url:a,params:b,scope:this,callback:function(g,i,f){var h=Ext.decode(f.responseText);c.setMessage(h);c.el.unmask()}})};GO.email.AddressContextMenu=function(a){if(!a){a={}}a.shadow="frame";a.minWidth=180;this.composeButton=new Ext.menu.Item({iconCls:"btn-compose",text:GO.email.lang.compose,cls:"x-btn-text-icon",handler:function(){var b={to:this.address};this.queryString=decodeURI(this.queryString);var d=this.queryString.split("&");var e;for(var c=0;c<d.length;c++){e=d[c].split("=");if(e.length==2){b[e[0]]=e[1]}}GO.email.showComposer({values:b})},scope:this});this.searchButton=new Ext.menu.Item({iconCls:"btn-search",text:GO.email.lang.searchGO,cls:"x-btn-text-icon",handler:function(){var b=new GO.grid.SearchPanel({query:this.address});GO.mainLayout.tabPanel.add(b);b.show()},scope:this});this.searchMessagesButton=new Ext.menu.Item({iconCls:"btn-search",text:GO.email.lang.searchOnSender,cls:"x-btn-text-icon",handler:function(){GO.email.searchSender(this.address)},scope:this});a.items=[this.composeButton,this.searchButton,this.searchMessagesButton];if(GO.addressbook){this.lookUpButton=new Ext.menu.Item({iconCls:"btn-addressbook",text:GO.addressbook.lang.searchOnSender,cls:"x-btn-text-icon",handler:function(){GO.addressbook.searchSender(this.address,this.personal)},scope:this});a.items.push(this.lookUpButton)}GO.email.AddressContextMenu.superclass.constructor.call(this,a)};Ext.extend(GO.email.AddressContextMenu,Ext.menu.Menu,{personal:"",address:"",showAt:function(c,a,b,d){this.queryString=d||"";this.address=a||"";this.personal=b||"";GO.email.AddressContextMenu.superclass.showAt.call(this,c)}});GO.email.AttachmentContextMenu=function(a){if(!a){a={}}a.shadow="frame";a.minWidth=180;this.downloadButton=new Ext.menu.Item({iconCls:"btn-download",text:GO.lang.download,cls:"x-btn-text-icon",handler:function(){this.emailClient.openAttachment(this.attachment,this.emailClient.messagePanel,true)},scope:this});a.items=[this.downloadButton];if(GO.files){this.saveButton=new Ext.menu.Item({iconCls:"btn-save",text:GO.lang.cmdSave,cls:"x-btn-text-icon",handler:function(){this.emailClient.saveAttachment(this.attachment)},scope:this});a.items.push(this.saveButton)}GO.email.AttachmentContextMenu.superclass.constructor.call(this,a)};Ext.extend(GO.email.AttachmentContextMenu,Ext.menu.Menu,{attachment:false,showAt:function(a,b){this.attachment=b;GO.email.AttachmentContextMenu.superclass.showAt.call(this,a)}});GO.email.SettingsPanel=function(a){if(!a){a={}}a.autoScroll=true;a.border=false;a.hideLabel=true;a.title=GO.lang.strEmail;a.hideMode="offsets";a.layout="form";a.bodyStyle="padding:5px";a.items=[{xtype:"fieldset",title:GO.email.defaultProgram,autoHeight:true,html:GO.email.defaultProgramInstructions.replace("{url}",GO.settings.modules.email.url+"register_email.php")},this.useHtml=new Ext.form.Checkbox({boxLabel:GO.email.lang.htmlMarkup,hideLabel:true,checked:GO.email.useHtmlMarkup,name:"use_html_markup"})];GO.email.SettingsPanel.superclass.constructor.call(this,a)};Ext.extend(GO.email.SettingsPanel,Ext.Panel,{onLoadSettings:function(a){},onSaveSettings:function(){GO.email.useHtmlMarkup=this.useHtml.getValue()}});GO.mainLayout.onReady(function(){GO.moduleManager.addSettingsPanel("email",GO.email.SettingsPanel)});