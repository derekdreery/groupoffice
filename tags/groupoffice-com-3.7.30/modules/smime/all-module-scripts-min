GO.moduleManager.onModuleReady("email",function(){Ext.override(GO.email.EmailClient,{initComponent:GO.email.EmailClient.prototype.initComponent.createSequence(function(){this.printButton.handler=function(){if(this.messagePanel.data.smime_signed){this.messagePanel.checkCert(true,function(){this.messagePanel.body.print()},this)}else{this.messagePanel.body.print()}}})});Ext.override(GO.email.MessagePanel,{initComponent:GO.email.MessagePanel.prototype.initComponent.createSequence(function(){this.on("load",function(c,f,a,e,b){if(b){GO.smime.passwordsInSession[e.account_id]=true}if(e.smime_encrypted){var d=this.body.down(".message-header").createChild({html:GO.smime.lang.messageEncrypted,cls:"smi-encrypt-notification"})}if(e.smime_signed){this.smimeLink=this.body.down(".message-header").createChild({html:GO.smime.lang.messageSigned,cls:"smi-sign-notification"});this.smimeLink.on("click",function(){this.checkCert()},this)}})}),checkCert:function(b,c,a){if(!b){if(!this.certWin){this.certWin=new GO.Window({title:GO.smime.lang.smimeCert,width:500,height:300,closeAction:"hide",layout:"fit",items:[this.certPanel=new Ext.Panel({bodyStyle:"padding:10px"})]})}this.certWin.show()}if(!this.data.path){this.data.path=""}Ext.Ajax.request({url:GO.settings.modules.smime.url+"verify.php?uid="+this.uid+"&account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&filepath="+this.data.path+"&email="+encodeURIComponent(this.data.sender),scope:this,callback:function(e,g,d){if(!g){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var f=Ext.decode(d.responseText);if(!b){this.certPanel.update(f.html)}this.smimeLink.update(f.text);this.smimeLink.addClass(f.cls);if(c&&a){c.call(a,this)}}}})}})});GO.moduleManager.onModuleReady("email",function(){Ext.override(GO.email.AccountDialog,{initComponent:GO.email.AccountDialog.prototype.initComponent.createInterceptor(function(){this.propertiesPanel.fileUpload=true;this.propertiesPanel.bodyCfg.enctype="multipart/form-data";this.smimePanel=new Ext.Panel({cls:"go-form-panel",title:GO.smime.lang.settings,disabled:true,items:[{xtype:"fieldset",labelWidth:160,title:GO.smime.lang.pkcs12Cert,items:[{id:"smimeHasCert",xtype:"label",style:"display:block;margin-bottom:15px",html:GO.smime.lang.youHaveAcert},{xtype:"label",html:GO.smime.lang.pkcs12CertInfo,style:"display:block;margin-bottom:10px"},{xtype:"textfield",fieldLabel:GO.settings.config.product_name+" "+GO.lang.strPassword,inputType:"password",name:"smime_password",width:200},this.uploadFile=new GO.form.UploadFile({addText:GO.smime.lang.selectPkcs12Cert,inputName:"cert",max:1}),this.deleteCert=new Ext.form.Checkbox({boxLabel:GO.smime.lang.deleteCert,labelSeparator:"",name:"delete_cert",allowBlank:true,hideLabel:true,disabled:true}),this.downloadButton=new Ext.Button({handler:function(){window.open(GO.settings.modules.smime.url+"download_pkcs12.php?account_id="+this.account_id)},text:GO.smime.lang.downloadCert,disabled:true,scope:this})]},{xtype:"checkbox",hideLabel:true,boxLabel:GO.smime.lang.alwaysSign,name:"always_sign"}]});this.tabPanel.add(this.smimePanel);this.on("show",function(){this.smimePanel.setDisabled(true)},this);this.propertiesPanel.form.on("actioncomplete",function(a,b){if(b.type=="submit"){this.uploadFile.clearQueue();this.deleteCert.setDisabled(!b.result.cert);this.downloadButton.setDisabled(!b.result.cert)}else{this.smimePanel.setDisabled(false);this.deleteCert.setDisabled(!b.result.data.cert);this.downloadButton.setDisabled(!b.result.data.cert);if(!b.result.data.cert){Ext.getCmp("smimeHasCert").hide()}else{Ext.getCmp("smimeHasCert").show()}}},this)})})});Ext.ns("GO.smime");GO.smime.passwordsInSession={};GO.moduleManager.onModuleReady("email",function(){Ext.override(GO.email.EmailComposer,{initComponent:GO.email.EmailComposer.prototype.initComponent.createSequence(function(){this.optionsMenu.add(["-",this.signCheck=new Ext.menu.CheckItem({text:GO.smime.lang.sign,checked:false,listeners:{checkchange:function(a,b){this.sendParams.sign_smime=b?"1":"0"},scope:this}}),this.encryptCheck=new Ext.menu.CheckItem({text:GO.smime.lang.encrypt,checked:false,listeners:{checkchange:function(a,b){this.sendParams.encrypt_smime=b?"1":"0"},scope:this}})]);this.on("afterShowAndLoad",function(){this.signCheck.setChecked(false);this.encryptCheck.setChecked(false);this.sendParams.encrypt_smime="0";this.sendParams.sign_smime="0";this.checkSmimeSupport()},this);this.fromCombo.on("change",function(){this.checkSmimeSupport()},this);this.on("beforesendmail",this.askPassword,this)}),askPassword:function(){var a=this.fromCombo.store.getById(this.fromCombo.getValue());if(!GO.smime.passwordsInSession[a.data.account_id]&&(this.sendParams.sign_smime=="1"||this.sendParams.encrypt_smime=="1")){if(!this.passwordDialog){this.passwordDialog=new GO.dialog.PasswordDialog({title:GO.smime.lang.enterPassword,fn:function(d,c){var b=this.fromCombo.store.getById(this.fromCombo.getValue());if(d=="cancel"){return false}Ext.Ajax.request({url:GO.settings.modules.smime.url+"checkpassword.php",success:function(f){var g=Ext.decode(f.responseText);if(g.success){var e=this.fromCombo.store.getById(this.fromCombo.getValue());GO.smime.passwordsInSession[e.data.account_id]=true;this.sendMail()}else{this.askPassword()}},params:{account_id:b.data.account_id,password:c},scope:this})},scope:this})}this.passwordDialog.show();return false}else{return true}},checkSmimeSupport:function(){var b=this.fromCombo.getValue();var a=this.fromCombo.store.getById(b);this.signCheck.setDisabled(!a.json.has_smime_cert);if(a.json.has_smime_cert&&a.json.always_sign=="1"){this.signCheck.setChecked(true);this.sendParams.sign_smime="1"}if(!a.json.has_smime_cert){this.signCheck.setChecked(false);this.sendParams.sign_smime="0"}}})});GO.smime.PublicCertsGrid=function(a){if(!a){a={}}a.layout="fit";a.autoScroll=true;a.split=true;a.store=new GO.data.JsonStore({url:GO.settings.modules.smime.url+"json.php",baseParams:{task:"public_certs"},root:"results",id:"id",totalProperty:"total",fields:["id","email"],autoLoad:true});var b=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:"email",dataIndex:"email"}]});a.cm=b;a.paging=true;a.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;a.tbar=[{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected()},scope:this}];a.listeners={scope:this,rowdblclick:function(d,e){var c=d.getStore().getAt(e);if(!this.certWin){this.certWin=new GO.Window({title:GO.smime.lang.smimeCert,width:500,height:300,closeAction:"hide",layout:"fit",items:[this.certPanel=new Ext.Panel({bodyStyle:"padding:10px"})]})}this.certWin.show();this.certPanel.load(GO.settings.modules.smime.url+"verify.php?cert_id="+c.id)}};GO.smime.PublicCertsGrid.superclass.constructor.call(this,a)};Ext.extend(GO.smime.PublicCertsGrid,GO.grid.GridPanel,{});GO.smime.PublicCertsWindow=Ext.extend(GO.Window,{initComponent:function(){this.title=GO.smime.lang.pubCerts;this.width=400;this.height=400;this.layout="fit";this.items=new GO.smime.PublicCertsGrid();this.closeAction="hide";this.buttons=[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.smime.PublicCertsWindow.superclass.initComponent.call(this)}});GO.moduleManager.onModuleReady("email",function(){Ext.override(GO.email.EmailClient,{initComponent:GO.email.EmailClient.prototype.initComponent.createSequence(function(){this.settingsMenu.add({iconCls:"btn-pub-certs",text:GO.smime.lang.pubCerts,handler:function(){if(!this.pubCertsWin){this.pubCertsWin=new GO.smime.PublicCertsWindow()}this.pubCertsWin.show()}})})})});