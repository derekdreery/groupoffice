GO.email.FoldersDialog=function(A){Ext.apply(this,A);this.foldersTree=new Ext.tree.TreePanel({animate:true,border:false,autoScroll:true,height:200,loader:new Ext.tree.TreeLoader({dataUrl:GO.settings.modules.email.url+"json.php",baseParams:{task:"tree-edit",account_id:0}})});this.rootNode=new Ext.tree.AsyncTreeNode({text:GO.email.lang.root,draggable:false,id:"account",folder_id:0,expanded:false});this.foldersTree.setRootNode(this.rootNode);this.rootNode.on("load",function(){this.rootNode.select()},this);this.foldersTree.on("checkchange",function(E,D){this.body.mask(GO.lang.waitMsgSave,"x-mask-loading");var C=D?"subscribe":"unsubscribe";Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:C,account_id:this.account_id,mailbox:E.attributes.mailbox},callback:function(G,H,F){if(!H){Ext.MessageBox.alert(GO.lang.strError,F.result.feedback)}this.body.unmask()},scope:this})},this);var B=new Ext.tree.TreeEditor(this.foldersTree,{ignoreNoChange:true});B.on("beforestartedit",function(D,C,E){if(D.editNode.attributes.folder_id==0||D.editNode.attributes.mailbox=="INBOX"){alert(GO.email.lang.cantEditFolder);return false}});B.on("beforecomplete",function(D,C,E){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"rename_folder",folder_id:D.editNode.attributes.folder_id,new_name:C},callback:function(G,H,F){if(!H){Ext.MessageBox.alert(GO.lang.strError,F.result.feedback)}else{return true}}})});GO.email.FoldersDialog.superclass.constructor.call(this,{layout:"fit",modal:false,shadow:false,minWidth:300,minHeight:300,height:400,width:500,plain:true,closeAction:"hide",title:GO.email.lang.folders,items:this.foldersTree,tbar:[{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",scope:this,handler:function(){var C=this.foldersTree.getSelectionModel();if(C.selNode==null||C.selNode.attributes.folder_id<1){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.selectFolderDelete)}else{if(C.selNode.attributes.mailbox=="INBOX"){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.cantDeleteInboxFolder)}else{GO.deleteItems({url:GO.settings.modules.email.url+"action.php",params:{task:"delete_folder",folder_id:C.selNode.attributes.folder_id},callback:function(){C.selNode.remove()},count:1,scope:this})}}}},{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){var C=this.foldersTree.getSelectionModel();if(C.selNode==null){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.selectFolderAdd)}else{Ext.MessageBox.prompt(GO.lang.strName,GO.email.lang.enterFolderName,function(D,E){if(D=="ok"){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"add_folder",folder_id:C.selNode.attributes.folder_id,account_id:this.account_id,new_folder_name:E},callback:function(G,I,F){if(!I){Ext.MessageBox.alert(GO.lang.strError,F.result.errors)}else{var H=Ext.decode(F.responseText);if(H.success){if(C.selNode.parentNode){C.selNode.parentNode.reload()}else{this.foldersTree.getRootNode().reload()}}else{Ext.MessageBox.alert(GO.lang.strError,H.feedback);this.foldersTree.getRootNode().reload()}}},scope:this})}},this)}},scope:this},{iconCls:"btn-refresh",text:GO.lang.cmdRefresh,cls:"x-btn-text-icon",handler:function(){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"syncfolders",account_id:this.account_id},callback:function(D,E,C){if(!E){Ext.MessageBox.alert(GO.lang.strError,C.result.feedback)}else{this.rootNode.reload()}},scope:this})},scope:this}],buttons:[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.email.FoldersDialog,Ext.Window,{show:function(A){this.account_id=A;this.foldersTree.loader.baseParams.account_id=A;if(!this.rootNode.isExpanded()){this.rootNode.expand()}else{this.rootNode.reload()}GO.email.FoldersDialog.superclass.show.call(this)},getSubscribtionData:function(){var B=[];for(var A=0;A<this.allFoldersStore.data.items.length;A++){B[A]={id:this.allFoldersStore.data.items[A].get("id"),subscribed:this.allFoldersStore.data.items[A].get("subscribed"),name:this.allFoldersStore.data.items[A].get("name")}}return B}});GO.email.AccountDialog=function(D){Ext.apply(this,D);var H;var C;function E(I){return I=="1"?GO.lang.cmdYes:GO.lang.cmdNo}var A=new Ext.grid.ColumnModel([{header:GO.email.lang.field,dataIndex:"field"},{header:GO.email.lang.contains,dataIndex:"keyword"},{header:GO.email.lang.moveToFolder,dataIndex:"folder"},{header:GO.email.lang.markAsRead,dataIndex:"mark_as_read",renderer:E}]);A.defaultSortable=false;this.filtersDS=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{type:"filters",account_id:this.account_id},root:"results",id:"id",fields:["id","field","keyword","folder","mark_as_read"],remoteSort:false});this.filtersTab=new GO.grid.GridPanel({title:GO.email.lang.filters,layout:"fit",border:true,ds:this.filtersDS,cm:A,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),sm:new Ext.grid.RowSelectionModel(),tbar:[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){filter.showDialog(0,this.account_id,this.filtersDS)},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.filtersTab.deleteSelected()},scope:this}]});this.filtersTab.on("rowdblclick",function(){var I=this.filtersTab.getSelectionModel();var J=I.getSelected();filter.showDialog(J.data.id,this.account_id,this.filtersDS)},this);this.filtersTab.on("show",function(){if(this.filtersDS.baseParams.account_id!=this.account_id){this.filtersDS.baseParams={task:"filters",account_id:this.account_id};this.filtersDS.load()}},this);var G={title:GO.email.lang.incomingMail,layout:"form",defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,cls:"go-form-panel",waitMsgTarget:true,labelWidth:120,items:[H=new Ext.form.ComboBox({fieldLabel:GO.email.lang.type,hiddenName:"type",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["imap","IMAP"],["pop3","POP-3"]]}),value:"imap",valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.TextField({fieldLabel:GO.email.lang.host,name:"host",allowBlank:false}),new Ext.form.TextField({fieldLabel:GO.lang.strUsername,name:"username",allowBlank:false}),new Ext.form.TextField({fieldLabel:GO.lang.strPassword,name:"password",inputType:"password",allowBlank:false}),{xtype:"fieldset",title:GO.email.lang.advanced,collapsible:true,collapsed:true,autoHeight:true,autoWidth:true,defaultType:"textfield",labelWidth:75,labelAlign:"left",items:[C=new Ext.form.Checkbox({boxLabel:GO.email.lang.ssl,name:"ssl",checked:false,hideLabel:true}),new Ext.form.Checkbox({boxLabel:GO.email.lang.tls,name:"tls",checked:false,hideLabel:true}),new Ext.form.Checkbox({boxLabel:GO.email.lang.novalidateCert,name:"novalidate_cert",checked:false,hideLabel:true}),new Ext.form.TextField({fieldLabel:GO.email.lang.port,name:"port",value:"143",allowBlank:false}),new Ext.form.TextField({fieldLabel:GO.email.lang.rootMailbox,name:"mbroot"})]}]};var B={title:GO.lang.strProperties,layout:"form",anchor:"100% 100%",defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,cls:"go-form-panel",labelWidth:100,items:[this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.modules.email["write_permission"]}),{fieldLabel:GO.lang.strName,name:"name",allowBlank:false},{fieldLabel:GO.lang.strEmail,name:"email",allowBlank:false}]};var F={title:GO.email.lang.outgoingMail,layout:"form",defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,cls:"go-form-panel",labelWidth:120,items:[new Ext.form.TextField({fieldLabel:GO.email.lang.host,name:"smtp_host",allowBlank:false}),this.encryptionField=new Ext.form.ComboBox({fieldLabel:GO.email.lang.encryption,hiddenName:"smtp_encryption",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["8",GO.email.lang.noEncryption],["2","TLS"],["4","SSL"]]}),value:"8",valueField:"value",displayField:"text",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.TextField({fieldLabel:GO.email.lang.port,name:"smtp_port",value:"25",allowBlank:false}),new Ext.form.TextField({fieldLabel:GO.lang.strUsername,name:"smtp_username"}),new Ext.form.TextField({fieldLabel:GO.lang.strPassword,name:"smtp_password",inputType:"password"})]};this.subscribedFoldersStore=new Ext.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"subscribed_folders",account_id:0},root:"data",fields:["id","name"]});this.foldersTab=new Ext.Panel({title:GO.email.lang.folders,autoHeight:true,layout:"form",cls:"go-form-panel",defaults:{anchor:"100%"},defaultType:"textfield",labelWidth:150,tbar:[{iconCls:"btn-add",text:GO.email.lang.manageFolders,cls:"x-btn-text-icon",scope:this,handler:function(){if(!this.foldersDialog){this.foldersDialog=new GO.email.FoldersDialog()}this.foldersDialog.show(this.account_id)}}],items:[new Ext.form.ComboBox({fieldLabel:GO.email.lang.sendItemsFolder,hiddenName:"sent",store:this.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.trashFolder,hiddenName:"trash",store:this.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.draftsFolder,hiddenName:"drafts",store:this.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true})]});this.vacationPanel=new Ext.Panel({disabled:true,title:GO.email.lang.vacation,cls:"go-form-panel",layout:"form",autoScroll:true,items:[{xtype:"checkbox",name:"vacation_active",anchor:"-20",boxLabel:GO.email.lang.vacationActive,hideLabel:true},{xtype:"textfield",name:"vacation_subject",anchor:"-20",fieldLabel:GO.email.lang.vacationSubject},{xtype:"textarea",name:"vacation_body",anchor:"-20",fieldLabel:GO.email.lang.vacationBody}]});this.propertiesPanel=new Ext.form.FormPanel({url:GO.settings.modules.email.url+"action.php",defaultType:"textfield",waitMsgTarget:true,labelWidth:120,border:false,items:[this.tabPanel=new Ext.TabPanel({hideLabel:true,deferredRender:false,activeTab:0,border:false,anchor:"100% 100%",items:[B,G,F,this.foldersTab,this.filtersTab,this.vacationPanel]})]});H.on("select",function(L,I,J){var K=J==1?"110":"143";this.propertiesPanel.form.findField("port").setValue(K)},this);this.encryptionField.on("select",function(L,I,J){var K=I.data.value==8?"25":"465";this.propertiesPanel.form.findField("smtp_port").setValue(K)},this);C.on("check",function(J,I){if(H.getValue()=="imap"){this.propertiesPanel.form.findField("port").setValue(993)}else{this.propertiesPanel.form.findField("port").setValue(995)}},this);this.selectUser.on("select",function(K,I,J){this.propertiesPanel.form.findField("email").setValue(I.data.email);this.propertiesPanel.form.findField("username").setValue(I.data.username);this.propertiesPanel.form.findField("name").setValue(I.data.name)},this);GO.email.AccountDialog.superclass.constructor.call(this,{layout:"fit",modal:false,height:400,width:650,plain:true,closeAction:"hide",title:GO.email.lang.account,items:this.propertiesPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});this.addEvents({save:true})};Ext.extend(GO.email.AccountDialog,Ext.Window,{save:function(A){this.propertiesPanel.form.submit({url:GO.settings.modules.email.url+"action.php",params:{task:"save_account_properties",account_id:this.account_id},waitMsg:GO.lang.waitMsgSave,success:function(B,C){if(C.result.account_id){this.account_id=C.result.account_id;this.loadAccount(this.account_id)}this.fireEvent("save",this);if(A){this.hide()}},failure:function(C,D){var B="";if(D.failureType=="client"){B=GO.lang.strErrorsInForm}else{B=D.result.feedback}Ext.MessageBox.alert(GO.lang.strError,B)},scope:this})},show:function(A){GO.email.AccountDialog.superclass.show.call(this);this.tabPanel.setActiveTab(0);if(A){this.loadAccount(A);this.subscribedFoldersStore.baseParams.account_id=A;this.subscribedFoldersStore.load()}else{this.propertiesPanel.form.reset();this.account_id=0;this.foldersTab.setDisabled(true);this.filtersTab.setDisabled(true);this.vacationPanel.setDisabled(true);this.propertiesPanel.form.findField("name").setValue(GO.settings.name);this.propertiesPanel.form.findField("email").setValue(GO.settings.email);this.propertiesPanel.form.findField("username").setValue(GO.settings.username)}},loadAccount:function(A){this.propertiesPanel.form.load({url:GO.settings.modules.email.url+"json.php",params:{account_id:A,task:"account"},waitMsg:GO.lang.waitMsgLoad,success:function(B,C){this.account_id=A;this.selectUser.setRemoteValue(C.result.data.user_id,C.result.data.user_name);this.foldersTab.setDisabled(false);this.filtersTab.setDisabled(false);this.vacationPanel.setDisabled(typeof (C.result.data.vacation_subject)=="undefined")},scope:this})}});filter=function(){return{showDialog:function(D,B,C){if(!this.win){var A=new Ext.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"subscribed_folders",hideInbox:"true",account_id:B},root:"data",fields:["id","name"]});this.formPanel=new Ext.form.FormPanel({layout:"form",defaults:{anchor:"100%"},defaultType:"textfield",labelWidth:125,autoHeight:true,cls:"go-form-panel",waitMsgTarget:true,items:[new Ext.form.ComboBox({fieldLabel:GO.email.lang.field,hiddenName:"field",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["sender",GO.email.lang.sender],["subject",GO.email.lang.subject],["to",GO.email.lang.sendTo],["cc",GO.email.lang.ccField]]}),value:"sender",valueField:"value",displayField:"text",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),{fieldLabel:GO.email.lang.keyword,name:"keyword",allowBlank:false},new Ext.form.ComboBox({fieldLabel:GO.email.lang.moveToFolder,hiddenName:"folder",store:A,valueField:"name",displayField:"name",typeAhead:true,mode:"remote",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,allowBlank:false}),new Ext.form.Checkbox({boxLabel:GO.email.lang.markAsRead,name:"mark_as_read",checked:false,hideLabel:true})]});this.win=new Ext.Window({title:GO.email.lang.filter,layout:"fit",modal:false,shadow:false,autoHeight:true,width:400,plain:false,closeAction:"hide",items:this.formPanel,buttons:[{id:"ok",text:GO.lang.cmdOk,handler:function(){this.formPanel.form.submit({url:GO.settings.modules.email.url+"action.php",params:{task:"save_filter",filter_id:this.filter_id,account_id:B},waitMsg:GO.lang.waitMsgSave,success:function(E,F){if(F.result.filter_id){this.filter_id=F.result.filter_id}C.reload();this.win.hide()},failure:function(F,G){var E="";if(G.failureType=="client"){E=GO.lang.strErrorsInForm}else{E=G.result.feedback}Ext.MessageBox.alert(GO.lang.strError,E)},scope:this})},scope:this},{id:"close",text:GO.lang.cmdClose,handler:function(){this.win.hide()},scope:this}]})}if(this.filter_id!=D){this.filter_id=D;if(this.filter_id>0){this.formPanel.load({url:GO.settings.modules.email.url+"json.php",params:{filter_id:D,task:"filter"}})}else{this.formPanel.form.reset()}}this.win.show()}}}();GO.email.SearchDialog=function(A){return{show:function(){if(!this.dialog){this.formPanel=new Ext.FormPanel({defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,bodyStyle:"padding:5px",labelWidth:125,items:[{fieldLabel:GO.email.lang.subject,name:"subject",id:"search-subject"},{fieldLabel:GO.email.lang.from,name:"from"},{fieldLabel:GO.email.lang.to,name:"to"},{fieldLabel:GO.email.lang.cc,name:"cc"},{fieldLabel:GO.email.lang.body,name:"body"},new Ext.form.DateField({fieldLabel:GO.email.lang.recievedBefore,name:"before",format:GO.settings.date_format}),new Ext.form.DateField({fieldLabel:GO.email.lang.recievedSince,name:"since",format:GO.settings.date_format}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.flagged,name:"flagged",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.NA],["FLAGGED",GO.lang.cmdYes],["UNFLAGGED",GO.lang.cmdNo]]}),value:"",valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.answered,name:"answered",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.NA],["ANSWERED",GO.lang.cmdYes],["UNANSWERED",GO.lang.cmdNo]]}),value:"",valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.read,name:"seen",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.NA],["SEEN",GO.lang.cmdYes],["UNSEEN",GO.lang.cmdNo]]}),value:"",valueField:"value",displayField:"text",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true})]});this.dialog=new Ext.Window({layout:"fit",title:GO.lang.strSearch,modal:false,autoHeight:true,width:500,closeAction:"hide",items:this.formPanel,buttons:[{text:GO.lang.cmdOk,handler:this.doSearch,scope:this},{text:GO.lang.cmdReset,handler:function(){this.formPanel.form.reset()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.dialog.hide()},scope:this}],keys:[{key:Ext.EventObject.ENTER,fn:this.doSearch,scope:this}],focus:function(){Ext.get("search-subject").focus(true)}})}this.dialog.show()},doSearch:function(){A.store.baseParams.query=this.buildQuery();A.store.load();this.dialog.hide()},buildQuery:function(){var I="";var E=this.formPanel.form;var J=E.findField("subject").getValue();var L=E.findField("from").getValue();var M=E.findField("to").getValue();var F=E.findField("cc").getValue();var G=E.findField("body").getValue();var K=E.findField("before").getValue();var H=E.findField("since").getValue();var C=E.findField("flagged").getValue();var B=E.findField("seen").getValue();var D=E.findField("answered").getValue();if(J!=""){I+='SUBJECT "'+J+'" '}if(L!=""){I+='FROM "'+L+'" '}if(M!=""){I+='TO "'+M+'" '}if(F!=""){I+='CC "'+F+'" '}if(G!=""){I+='BODY "'+G+'" '}if(K!=""){I+='BEFORE "'+K.format("d-M-Y")+'" '}if(H!=""){I+='SINCE "'+H.format("d-M-Y")+'" '}if(C!=""){I+=" "+C}if(B!=""){I+=" "+B}if(D!=""){I+=" "+D}return I}}};GO.email.LinksDialog=function(A){Ext.apply(this,A);this.store=new GO.data.JsonStore({url:BaseHref+"json.php",root:"results",totalProperty:"total",fields:["icon","link_type","name","type","url","mtime","id","module"],remoteSort:true,baseParams:{task:"links"}});this.SearchField=new GO.form.SearchField({store:this.store,width:320,id:"email-links-search"});this.grid=new GO.grid.GridPanel({paging:true,store:this.store,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:"",width:28,dataIndex:"icon",renderer:this.IconRenderer},{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strType,dataIndex:"type",sortable:true},{header:GO.lang.strMtime,dataIndex:"mtime",sortable:true}],sm:new Ext.grid.RowSelectionModel(),tbar:[GO.lang.strSearch+": "," ",this.SearchField]});Ext.Window.superclass.constructor.call(this,{layout:"fit",modal:false,minWidth:300,minHeight:300,height:400,width:600,plain:true,closeAction:"hide",title:GO.lang.strLinkItems,items:this.grid,focus:function(){Ext.getCmp("email-links-search").focus(true)},buttons:[{id:"ok",text:GO.lang.cmdOk,handler:function(){this.linkItems()},scope:this},{id:"close",text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.email.LinksDialog,Ext.Window,{IconRenderer:function(C,A,B){return'<div class="go-link-icon-'+B.data.link_type+' "></div>'},linkItems:function(){var A=this.grid.getSelectionModel();var C=A.getSelections();var B=[];for(var D=0;D<C.length;D++){B.push({link_id:C[D].data.id,link_type:C[D].data.link_type})}var F=this.messagesGrid.selModel.selections.keys;var G=this.messagesGrid.store.baseParams.mailbox;var E=this.messagesGrid.store.baseParams.account_id;Ext.Ajax.request({url:GO.settings.modules.mailings.url+"action.php",params:{task:"link_messages",links:Ext.encode(B),uids:Ext.encode(F),mailbox:G,account_id:E},callback:function(I,J,H){if(!J){Ext.MessageBox.alert(GO.lang.strError,H.result.errors)}else{this.hide()}},scope:this})}});GO.email.MessagePanel=Ext.extend(Ext.Panel,{initComponent:function(){GO.email.MessagePanel.superclass.initComponent.call(this);this.addEvents({attachmentClicked:true,zipOfAttachmentsClicked:true,linkClicked:true,emailClicked:true});this.bodyId=Ext.id();this.attachmentsId=Ext.id();var A='<div class="message-header"><table class="message-header-table"><tr><td style="width:70px"><b>'+GO.email.lang.from+'</b></td><td>: {full_from} (<a class="normal-link" onclick="GO.email.searchSender(\'{sender}\');" href="#">'+GO.email.lang.searchOnSender+"</a>";if(GO.addressbook){A+=' | <a class="normal-link" onclick="GO.addressbook.searchSender(\'{sender}\', \'{from}\');" href="#">'+GO.addressbook.lang.searchOnSender+"</a>"}A+=")</td></tr><tr><td><b>"+GO.email.lang.subject+"</b></td><td>: {subject}</td></tr><tr><td><b>"+GO.lang.strDate+"</b></td><td>: {date}</td></tr><tr><td><b>"+GO.lang.strSize+"</b></td><td>: {size}</td></tr><tr><td><b>"+GO.email.lang.to+'</b></td><td>: {to}</td></tr><tpl if="cc.length"><tr><td><b>'+GO.email.lang.cc+'</b></td><td>: {cc}</td></tr></tpl><tpl if="bcc.length"><tr><td><b>'+GO.email.lang.bcc+'</b></td><td>: {bcc}</td></tr></tpl></table><tpl if="attachments.length"><table style="padding-top:5px;"><tr><td><b>'+GO.email.lang.attachments+':</b></td></tr><tr><td id="'+this.attachmentsId+'"><tpl for="attachments"><a class="filetype-link filetype-{extension}" id="'+this.attachmentsId+'_{index}" href="#">{name}</a> </tpl><tpl if="attachments.length&gt;1"><a class="filetype-link filetype-zip" id="'+this.attachmentsId+'_zipofall" href="#">'+GO.email.lang.downloadAllAsZip+'</a></tpl></td></tr></table></tpl></div><div id="'+this.bodyId+'" class="message-body">{body}</div>';this.template=new Ext.XTemplate('<div class="message-header">','<table class="message-header-table">','<tr><td style="width:70px"><b>'+GO.email.lang.from+'</b></td><td>: {full_from} (<a class="normal-link" onclick="GO.email.searchSender(\'{sender}\');" href="#">'+GO.email.lang.searchOnSender+'</a> | <a class="normal-link" onclick="GO.addressbook.searchSender(\'{sender}\', \'{from}\');" href="#">'+GO.addressbook.lang.searchOnSender+"</a>)</td></tr>","<tr><td><b>"+GO.email.lang.subject+"</b></td><td>: {subject}</td></tr>","<tr><td><b>"+GO.lang.strDate+"</b></td><td>: {date}</td></tr>","<tr><td><b>"+GO.lang.strSize+"</b></td><td>: {size}</td></tr>","<tr><td><b>"+GO.email.lang.to+"</b></td><td>: {to}</td></tr>",'<tpl if="cc.length">',"<tr><td><b>"+GO.email.lang.cc+"</b></td><td>: {cc}</td></tr>","</tpl>",'<tpl if="bcc.length">',"<tr><td><b>"+GO.email.lang.bcc+"</b></td><td>: {bcc}</td></tr>","</tpl>","</table>",'<tpl if="attachments.length">','<table style="padding-top:5px;">',"<tr><td><b>"+GO.email.lang.attachments+':</b></td></tr><tr><td id="'+this.attachmentsId+'">','<tpl for="attachments">','<a class="filetype-link filetype-{extension}" id="'+this.attachmentsId+'_{index}" href="#">{name}</a> ',"</tpl>",'<tpl if="attachments.length&gt;1">','<a class="filetype-link filetype-zip" id="'+this.attachmentsId+'_zipofall" href="#">'+GO.email.lang.downloadAllAsZip+"</a>","</tpl>","</td></tr>","</table>","</tpl>","</div>",'<div id="'+this.bodyId+'" class="message-body">{body}</div>')},setMessage:function(A){this.data=A;if(this.messageBodyEl){this.messageBodyEl.removeAllListeners()}if(this.attachmentsEl){this.attachmentsEl.removeAllListeners()}this.template.overwrite(this.body,A);this.messageBodyEl=Ext.get(this.bodyId);this.messageBodyEl.on("click",this.onMessageBodyClick,this);if(A.attachments.length){this.attachmentsEl=Ext.get(this.attachmentsId);this.attachmentsEl.on("click",this.openAttachment,this)}this.body.scrollTo("top",0);if(this.data["new"]&&this.data.notification){if(confirm(GO.email.lang.sendNotification.replace("%s",this.data.notification))){var B={task:"notification",account_id:this.data.account_id,notification_to:this.data.notification,subject:this.data.subject};Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:B})}}},openAttachment:function(C,B){if(B.id.substr(0,this.attachmentsId.length)==this.attachmentsId){var A=B.id.substr(this.attachmentsId.length+1);if(A=="zipofall"){this.fireEvent("zipOfAttachmentsClicked")}else{var D=this.data.attachments[A];this.fireEvent("attachmentClicked",D,this)}}},onMessageBodyClick:function(E,D){E.preventDefault();if(D.tagName=="A"){var A=D.attributes.href.value;if(A.substr(0,6)=="mailto"){var C=A.indexOf("?");if(C>0){var B=A.substr(7,C-8)}else{var B=A.substr(7)}this.fireEvent("emailClicked",B)}else{this.fireEvent("linkClicked",A)}}}});GO.email.AccountsDialog=function(A){if(!A){A={}}this.accountsGrid=new GO.email.AccountsGrid();A.maximizable=true;A.layout="fit";A.modal=false;A.resizable=false;A.width=500;A.height=400;A.closeAction="hide";A.title=GO.email.lang.accounts;A.items=this.accountsGrid;A.ddGroup="EmailAccountsDD";A.buttons=[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.email.AccountsDialog.superclass.constructor.call(this,A)};Ext.extend(GO.email.AccountsDialog,Ext.Window,{});GO.email.AccountsGrid=function(A){if(!A){A={}}A.layout="fit";A.autoScroll=true;A.store=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"accounts"},root:"results",totalProperty:"total",id:"id",fields:["id","email","host","user_name"],remoteSort:true});A.store.setDefaultSort("utime","asc");A.paging=true;var B=new Ext.grid.ColumnModel([{header:GO.lang.strEmail,dataIndex:"email"},{header:GO.lang.strOwner,dataIndex:"user_name",sortable:false},{header:GO.email.lang.host,dataIndex:"host"}]);B.defaultSortable=true;A.cm=B;A.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;A.border=false;A.enableDragDrop=true;A.ddGroup="EmailAccountsDD";A.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.accountDialog.show()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected()},scope:this}];GO.email.AccountsGrid.superclass.constructor.call(this,A);this.accountDialog=new GO.email.AccountDialog();this.accountDialog.on("save",function(){this.store.reload()},this);this.on("rowdblclick",function(D,E){var C=D.getStore().getAt(E);this.accountDialog.show(C.data.id)},this)};Ext.extend(GO.email.AccountsGrid,GO.grid.GridPanel,{afterRender:function(){GO.email.AccountsDialog.superclass.afterRender.call(this);var A=new Ext.dd.DropTarget(this.getView().mainBody,{ddGroup:"EmailAccountsDD",copy:false,notifyDrop:this.onNotifyDrop.createDelegate(this)})},onNotifyDrop:function(G,F,E){var I=this.selModel.getSelections();var D=G.getDragData(F);var H=D.rowIndex;if(H=="undefined"){H=this.store.data.length-1}for(C=0;C<I.length;C++){var B=this.store.getById(I[C].id);if(!this.copy){this.store.remove(this.store.getById(I[C].id))}this.store.insert(H,B)}var A={};for(var C=0;C<this.store.data.items.length;C++){A[this.store.data.items[C].get("id")]=C}Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"save_accounts_sort_order",sort_order:Ext.encode(A)}})}});GO.email.MessagesGrid=function(A){if(!A){A={}}A.layout="fit";A.autoScroll=true;A.store=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{node:"",type:"messages"},root:"results",totalProperty:"total",id:"uid",fields:["uid","icon","flagged","attachments","new","subject","from","size","date","priority","answered"],remoteSort:true});A.store.setDefaultSort("date","DESC");A.paging=true;if(A.region=="north"){A.cm=new Ext.grid.ColumnModel([{header:"&nbsp;",width:50,dataIndex:"icon",renderer:this.renderIcon,hideable:false,sortable:false},{header:GO.email.lang.from,dataIndex:"from"},{header:GO.email.lang.subject,dataIndex:"subject"},{header:GO.lang.strDate,dataIndex:"date",width:65,align:"right"}]);A.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems,getRowClass:function(C,B){if(C.data["new"]=="1"){return"ml-new-row"}}})}else{A.cm=new Ext.grid.ColumnModel([{header:"&nbsp;",width:46,dataIndex:"icon",renderer:this.renderIcon,hideable:false,sortable:false},{header:GO.email.lang.message,dataIndex:"from",renderer:this.renderMessage,css:"white-space:normal;"},{header:GO.lang.strDate,dataIndex:"date",width:65,align:"right"}]);A.autoExpandColumn=1;A.view=new Ext.grid.GridView({emptyText:GO.lang.strNoItems})}A.cm.defaultSortable=true;A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;A.border=false;A.split=true;A.minSize=200;A.enableDragDrop=true;A.ddGroup="EmailDD";GO.email.MessagesGrid.superclass.constructor.call(this,A)};Ext.extend(GO.email.MessagesGrid,GO.grid.GridPanel,{renderMessageSmallRes:function(B,C,A){if(A.data["new"]=="1"){return String.format('<div id="sbj_'+A.data.uid+'" class="NewSubject">{0}</div>{1}',B,A.data.subject)}else{return String.format('<div id="sbj_'+A.data.uid+'" class="Subject">{0}</div>{1}',B,A.data.subject)}},renderMessage:function(B,C,A){if(A.data["new"]=="1"){return String.format('<div id="sbj_'+A.data.uid+'" class="NewSubject">{0}</div>{1}',B,A.data.subject)}else{return String.format('<div id="sbj_'+A.data.uid+'" class="Subject">{0}</div>{1}',B,A.data.subject)}},renderIcon:function(D,B,A){var C="";if(A.data.answered=="1"){C+='<div class="email-grid-icon btn-message-answered"></div>'}else{C+='<div class="email-grid-icon btn-message"></div>'}if(A.data.attachments){C+='<div class="email-grid-icon ml-icon-attach"></div>'}else{}if(A.data.priority){if(A.data.priority<3){C+='<div class="email-grid-icon btn-high-priority"></div>'}if(A.data.priority>3){C+='<div class="email-grid-icon btn-low-priority"></div>'}}if(A.data.flagged==1){C+='<div class="email-grid-icon btn-flag"></div>'}return C},renderFlagged:function(B,C,A){var D="";if(A.data.flagged==1){D+='<div class="go-icon btn-flag"></div>'}if(A.data.attachments){D+='<div class="go-icon btn-attach"></div>'}return D}});GO.email.AccountsTree=function(B){if(!B){B={}}B.title=GO.email.lang.categories;B.layout="fit";B.split=true;B.autoScroll=true;B.width=200;B.animate=true;B.loader=new Ext.tree.TreeLoader({dataUrl:GO.settings.modules.email.url+"json.php",baseParams:{task:"tree"},preloadChildren:true});B.containerScroll=true;B.rootVisible=false;B.collapseFirst=false;B.collapsible=true;B.ddAppendOnly=true;B.containerScroll=true;B.enableDrop=true;B.ddGroup="EmailDD";GO.email.AccountsTree.superclass.constructor.call(this,B);var A=new Ext.tree.AsyncTreeNode({text:"Root",id:"bs-folder-0",draggable:false,iconCls:"folder-default",expanded:false});this.setRootNode(A)};Ext.extend(GO.email.AccountsTree,Ext.tree.TreePanel,{});GO.email.UnknownRecipientsDialog=Ext.extend(Ext.Window,{initComponent:function(){this.store=new GO.data.JsonStore({root:"recipients",fields:["email","name","first_name","middle_name","last_name"]});this.list=new GO.grid.SimpleSelectList({store:this.store});this.list.on("click",function(B,C){var A=B.store.data.items[C];if(!GO.addressbook.contactDialog){GO.addressbook.contactDialog=new GO.addressbook.ContactDialog()}GO.addressbook.contactDialog.show();GO.addressbook.contactDialog.formPanel.form.setValues(A.data);this.store.remove(A);if(this.store.getCount()==0){this.hide()}},this);this.title=GO.email.lang.addUnknownRecipients;this.layout="fit";this.modal=false;this.height=400;this.width=600;this.closable=true;this.closeAction="hide";this.items=new Ext.Panel({autoScroll:true,items:[new Ext.Panel({border:false,html:GO.email.lang.addUnknownRecipientsText}),this.list],cls:"go-form-panel"});GO.email.UnknownRecipientsDialog.superclass.initComponent.call(this)}});GO.email.AddressbookDialog=function(B){Ext.apply(this,B);var A=Array();this.usersStore=new GO.data.JsonStore({url:GO.settings.modules.users.url+"json.php",baseParams:{task:"users"},id:"id",root:"results",fields:["id","username","name","company","logins","lastlogin","registration_time","address","zip","city","state","country","phone","email","waddress","wzip","wcity","wstate","wcountry","wphone"],remoteSort:true});this.usersSearchField=new GO.form.SearchField({store:this.usersStore,width:320});this.usersGrid=new GO.grid.GridPanel({id:"select-users-grid",title:GO.addressbook.lang.users,paging:true,border:false,store:this.usersStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel(),tbar:[GO.lang.strSearch+": "," ",this.usersSearchField]});this.usersGrid.on("show",function(){this.usersStore.load()},this);A.push(this.usersGrid);if(GO.addressbook){this.contactsStore=new GO.data.JsonStore({url:GO.settings.modules.addressbook.url+"json.php",baseParams:{task:"contacts"},root:"results",id:"id",fields:["id","name","company_name","email","home_phone","work_phone","work_fax","cellular"],remoteSort:true});this.contactsSearchField=new GO.form.SearchField({store:this.contactsStore,width:320});this.contactsGrid=new GO.grid.GridPanel({id:"select-contacts-grid",title:GO.addressbook.lang.contacts,paging:true,border:false,store:this.contactsStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel(),tbar:[GO.lang.strSearch+": "," ",this.contactsSearchField]});this.contactsGrid.on("show",function(){this.contactsStore.load()},this);this.companiesStore=new GO.data.JsonStore({url:GO.settings.modules.addressbook.url+"json.php",baseParams:{task:"companies"},root:"results",id:"id",fields:["id","name","city","email","phone","homepage","address","zip"],remoteSort:true});this.companySearchField=new GO.form.SearchField({store:this.companiesStore,width:320});this.companyGrid=new GO.grid.GridPanel({id:"select-companies-grid",title:GO.addressbook.lang.companies,paging:true,border:false,store:this.companiesStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel(),tbar:[GO.lang.strSearch+": "," ",this.companySearchField]});this.companyGrid.on("show",function(){this.companiesStore.load()},this);A.push(this.contactsGrid);A.push(this.companyGrid)}this.tabPanel=new Ext.TabPanel({activeTab:0,items:A});Ext.Window.superclass.constructor.call(this,{layout:"fit",modal:false,height:400,width:600,closeAction:"hide",title:GO.addressbook.lang.addressbook,items:this.tabPanel,buttons:[{text:GO.email.lang.addToRecipients,handler:function(){this.addRecipients("to")},scope:this},{text:GO.email.lang.addToCC,handler:function(){this.addRecipients("cc")},scope:this},{text:GO.email.lang.addToBCC,handler:function(){this.addRecipients("bcc")},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});this.addEvents({addrecipients:true})};Ext.extend(GO.email.AddressbookDialog,Ext.Window,{addRecipients:function(C){var B;switch(this.tabPanel.getLayout().activeItem.id){case"select-users-grid":B=this.usersGrid;break;case"select-contacts-grid":B=this.contactsGrid;break;case"select-companies-grid":B=this.companiesGrid;break}var A=B.selModel.getSelections();this.fireEvent("addrecipients",C,A)}});GO.email.EmailComposer=function(B){Ext.apply(B);this.optionsMenu=new Ext.menu.Menu({id:"optionsMenu",items:[this.notifyCheck=new Ext.menu.CheckItem({text:GO.email.lang.notification,checked:false,checkHandler:function(E,F){this.sendParams.notification=F?"true":"false"},scope:this}),"-",'<b class="menu-title">'+GO.email.lang.priority+"</b>",{text:GO.email.lang.high,checked:false,group:"priority",checkHandler:function(){this.sendParams.priority="1"},scope:this},this.normalPriorityCheck=new Ext.menu.CheckItem({text:GO.email.lang.normal,checked:true,group:"priority",checkHandler:function(){this.sendParams.priority="3"},scope:this}),{text:GO.email.lang.low,checked:false,group:"priority",checkHandler:function(){this.sendParams.priority="5"},scope:this}]});this.showMenu=new Ext.menu.Menu({id:"showMenu",items:[this.formFieldCheck=new Ext.menu.CheckItem({id:"fromFieldCheck",text:GO.email.lang.sender,checked:true,checkHandler:this.onShowFieldCheck,scope:this}),this.ccFieldCheck=new Ext.menu.CheckItem({id:"ccFieldCheck",text:GO.email.lang.ccField,checked:false,checkHandler:this.onShowFieldCheck,scope:this}),this.bccFieldCheck=new Ext.menu.CheckItem({id:"bccFieldCheck",text:GO.email.lang.bccField,checked:false,checkHandler:this.onShowFieldCheck,scope:this})]});var C=new GO.plugins.HtmlEditorImageInsert();C.on("insert",function(E){this.inline_attachments.push({tmp_file:E.selectedPath,url:E.selectedUrl})},this);this.selectLinkField=new GO.form.SelectLink({anchor:"100%"});this.formPanel=new Ext.form.FormPanel({border:false,labelWidth:100,waitMsgTarget:true,cls:"go-form-panel",url:"save-form.php",defaultType:"textfield",items:[this.fromCombo=new Ext.form.ComboBox({store:new Ext.data.JsonStore({url:BaseHref+"modules/email/json.php",baseParams:{task:"accounts",personal_only:true},fields:["id","email"],root:"results",totalProperty:"total",id:"id"}),fieldLabel:GO.email.lang.from,name:"account_name",anchor:"100%",displayField:"email",valueField:"id",hiddenName:"account_id",forceSelection:true,triggerAction:"all",mode:"local"}),this.toCombo=new GO.form.ComboBoxMulti({sep:",",fieldLabel:GO.email.lang.sendTo,name:"to",anchor:"100%",height:50,store:new Ext.data.JsonStore({url:BaseHref+"json.php",baseParams:{task:"email"},fields:["full_email"],root:"persons"}),displayField:"full_email"}),this.ccCombo=new GO.form.ComboBoxMulti({sep:",",id:"cc",fieldLabel:GO.email.lang.cc,name:"cc",anchor:"100%",height:50,store:new Ext.data.JsonStore({url:BaseHref+"json.php",baseParams:{task:"email"},fields:["full_email"],root:"persons"}),displayField:"full_email",hideTrigger:true,minChars:2,triggerAction:"all",selectOnFocus:false}),this.bccCombo=new GO.form.ComboBoxMulti({sep:",",id:"bcc",fieldLabel:GO.email.lang.bcc,name:"bcc",anchor:"100%",height:50,store:new Ext.data.JsonStore({url:BaseHref+"json.php",baseParams:{task:"email"},fields:["full_email"],root:"persons"}),displayField:"full_email",hideTrigger:true,minChars:2,triggerAction:"all",selectOnFocus:false}),this.selectLinkField,this.subjectField=new Ext.form.TextField({fieldLabel:GO.email.lang.subject,name:"subject",anchor:"100%"}),this.htmlEditor=new Ext.form.HtmlEditor({hideLabel:true,name:"body",anchor:"100% -130",plugins:C})]});this.attachmentsStore=new Ext.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"attachments"},root:"results",fields:["tmp_name","name","size","type"],id:"tmp_name"});this.attachmentsStore.on("remove",this.updateAttachmentsButton,this);this.attachmentsStore.on("load",this.updateAttachmentsButton,this);if(GO.mailings){this.templatesStore=new GO.data.JsonStore({url:GO.settings.modules.mailings.url+"json.php",baseParams:{task:"authorized_templates"},root:"results",totalProperty:"total",id:"id",fields:["id","name"],remoteSort:true});this.templatesList=new GO.email.TemplatesList({store:this.templatesStore});this.templatesList.on("click",function(E,F){this.showConfig.template_id=F>0?E.store.data.items[F-1].id:0;this.show(this.showConfig);this.templatesWindow.hide();this.templatesList.clearSelections()},this);this.templatesWindow=new Ext.Window({title:GO.email.lang.selectTemplate,layout:"fit",modal:false,height:400,width:600,closable:true,closeAction:"hide",items:new Ext.Panel({autoScroll:true,items:this.templatesList,cls:"go-form-panel"})})}var D=[{text:GO.email.lang.send,iconCls:"btn-send",handler:function(){this.sendMail()},scope:this},{text:GO.email.lang.extraOptions,iconCls:"btn-settings",menu:this.optionsMenu},this.showMenuButton=new Ext.Button({text:GO.email.lang.show,iconCls:"btn-show",menu:this.showMenu}),this.attachmentsButton=new Ext.Button({text:GO.email.lang.attachments,iconCls:"btn-attach",handler:this.showAttachmentsDialog,scope:this}),this.saveButton=new Ext.Button({iconCls:"btn-save",text:GO.lang.cmdSave,handler:function(){this.sendMail(true)},scope:this})];if(GO.addressbook){D.push({text:GO.addressbook.lang.addressbook,iconCls:"btn-addressbook",handler:function(){if(!this.addressbookDialog){this.addressbookDialog=new GO.email.AddressbookDialog();this.addressbookDialog.on("addrecipients",function(J,G){var H=this.formPanel.form.findField(J);var I=[];for(var F=0;F<G.length;F++){I.push('"'+G[F].data.name+'" <'+G[F].data.email+">")}var E=H.getValue();if(E!=""){E+=","}E+=I.join(",");H.setValue(E);if(J=="cc"){this.ccFieldCheck.setChecked(true)}else{if(J=="bcc"){this.bccFieldCheck.setChecked(true)}}},this)}this.addressbookDialog.show()},scope:this})}var A=function(){this.toCombo.focus()};GO.email.EmailComposer.superclass.constructor.call(this,{title:GO.email.lang.composeEmail,width:700,height:500,minWidth:300,minHeight:200,layout:"fit",maximizable:true,collapsible:true,plain:true,closeAction:"hide",buttonAlign:"center",focus:A.createDelegate(this),tbar:D,items:this.formPanel});this.addEvents({send:true})};Ext.extend(GO.email.EmailComposer,Ext.Window,{afterRender:function(){GO.email.EmailComposer.superclass.afterRender.call(this);this.on("resize",this.setEditorHeight,this)},toComboVisible:true,updateAttachmentsButton:function(){var A=this.attachmentsStore.getCount()>0?GO.email.lang.attachments+" ("+this.attachmentsStore.getCount()+")":GO.email.lang.attachments;this.attachmentsButton.setText(A)},reset:function(){this.sendParams={task:"sendmail",notification:"false",priority:"3",inline_attachments:{}};this.inline_attachments=Array();this.formPanel.form.reset();if(this.defaultAcccountId){this.fromCombo.setValue(this.defaultAcccountId)}this.notifyCheck.setChecked(false);this.normalPriorityCheck.setChecked(true);if(this.attachmentsGrid){this.attachmentsGrid.store.loadData({results:[]})}},show:function(B){if(!this.rendered){this.fromCombo.store.on("load",function(){var D=this.fromCombo.store.getRange();if(D.length){if(!B.account_id){B.account_id=D[0].data.id}this.render(Ext.getBody());this.show(B)}else{Ext.Msg.alert(GO.email.lang.noAccountTitle,GO.email.lang.noAccount)}},this,{single:true});if(!GO.mailings){B.template_id=0;this.fromCombo.store.load()}else{this.templatesStore.load({callback:function(){this.fromCombo.store.load()},scope:this})}}else{if(B.template_id==undefined&&this.templatesStore&&this.templatesStore.getTotalCount()>1){this.showConfig=B;this.templatesWindow.show()}else{this.toComboVisible=true;this.showMenuButton.setDisabled(false);this.toCombo.getEl().up(".x-form-item").setDisplayed(true);this.sendURL=GO.settings.modules.email.url+"action.php";this.saveButton.setDisabled(false);if(B.template_id==undefined&&this.templatesStore&&this.templatesStore.getTotalCount()==1){B.template_id=this.templatesStore.data.items[0].get("id")}this.attachmentsStore.removeAll();this.inline_attachments=[];this.reset();if(B.account_id){this.fromCombo.setValue(B.account_id)}else{this.fromCombo.setValue(this.fromCombo.store.data.items[0].id)}if(B.values){this.formPanel.form.setValues(B.values)}GO.email.EmailComposer.superclass.show.call(this);if(B.uid||B.template_id||B.loadUrl){if(!B.task){B.task="template"}var C=B.loadParams?B.loadParams:{uid:B.uid,account_id:this.fromCombo.getValue(),task:B.task,mailbox:B.mailbox,template_id:B.template_id};if(B.template_id>0){C.to=this.toCombo.getValue()}var A=B.loadUrl?B.loadUrl:GO.settings.modules.email.url+"json.php";if(B.mailing_group_id>0){this.sendURL=GO.settings.modules.mailings.url+"action.php";this.toComboVisible=false;this.showMenuButton.setDisabled(true);this.toCombo.getEl().up(".x-form-item").setDisplayed(false);this.ccCombo.getEl().up(".x-form-item").setDisplayed(false);this.bccCombo.getEl().up(".x-form-item").setDisplayed(false);this.sendParams.mailing_group_id=B.mailing_group_id;C.mailing_group_id=B.mailing_group_id;this.saveButton.setDisabled(true)}this.formPanel.form.load({url:A,params:C,waitMsg:GO.lang.waitMsgLoad,success:function(D,E){if(B.task=="reply"||B.task=="reply_all"){this.sendParams.reply_uid=B.uid;this.sendParams.reply_mailbox=B.mailbox}if(E.result.data.inline_attachments){this.inline_attachments=E.result.data.inline_attachments}if(E.result.data.attachments){this.attachmentsStore.loadData({results:E.result.data.attachments},true)}if(E.result.replace_personal_fields){this.sendParams.replace_personal_fields="1"}if(E.result.data.cc){this.ccFieldCheck.setChecked(true)}else{this.ccFieldCheck.setChecked(false)}if(this.toCombo.getValue()==""){this.toCombo.focus()}else{this.htmlEditor.focus()}},scope:this})}if(!this.showed){this.showed=true;this.ccCombo.getEl().up(".x-form-item").setDisplayed(false);this.bccCombo.getEl().up(".x-form-item").setDisplayed(false)}}}},showAttachmentsDialog:function(){if(!this.attachmentsDialog){var B=[];B.push({id:"add-local",iconCls:"btn-add",text:GO.email.lang.attachFilesPC,cls:"x-btn-text-icon",handler:function(){this.uploadDialog.show()},scope:this});if(GO.files){B.push({id:"add-remote",iconCls:"btn-add",text:GO.email.lang.attachFilesGO,cls:"x-btn-text-icon",handler:function(){if(!this.fileBrowser){this.fileBrowser=new GO.files.FileBrowser({border:false,fileClickHandler:this.addRemoteFiles,scope:this});this.fileBrowserWindow=new Ext.Window({title:GO.lang.strSelectFiles,height:400,width:600,layout:"fit",border:false,closeAction:"hide",items:this.fileBrowser,buttons:[{text:GO.lang.cmdOk,handler:this.addRemoteFiles,scope:this},{text:GO.lang.cmdClose,handler:function(){this.fileBrowserWindow.hide()},scope:this}]})}this.fileBrowserWindow.show()},scope:this})}B.push({id:"delete",iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){var D=this.attachmentsGrid.selModel.getSelections();for(var C=0;C<D.length;C++){this.attachmentsStore.remove(D[C])}},scope:this});this.attachmentsGrid=new Ext.grid.GridPanel({id:"groups-grid-overview-users",store:this.attachmentsStore,columns:[{id:"name",header:GO.lang.strName,dataIndex:"name"},{id:"size",header:GO.lang.strSize,dataIndex:"size"},{id:"type",header:GO.lang.strType,dataIndex:"type"}],sm:new Ext.grid.RowSelectionModel({singleSelect:false}),view:new Ext.grid.GridView({forceFit:true,autoFill:true}),tbar:B});this.attachmentsDialog=new Ext.Window({title:GO.email.lang.attachments,layout:"fit",modal:false,closeAction:"hide",minWidth:300,minHeight:300,height:400,width:600,items:this.attachmentsGrid,buttons:[{text:GO.lang.cmdClose,handler:function(){this.attachmentsDialog.hide()},scope:this}]});var A=new GO.form.UploadFile({inputName:"attachments",addText:GO.lang.smallUpload});this.upForm=new Ext.form.FormPanel({fileUpload:true,waitMsgTarget:true,items:[A,new Ext.Button({text:GO.lang.largeUpload,handler:function(){if(!deployJava.isWebStartInstalled("1.6.0")){Ext.MessageBox.alert(GO.lang.strError,GO.lang.noJava)}else{var C=this.local_path?"true":false;GO.util.popup(GO.settings.modules.email.url+"jupload/index.php","640","500");this.uploadDialog.hide();GO.attachmentsStore=this.attachmentsStore}},scope:this})],cls:"go-form-panel"});this.uploadDialog=new Ext.Window({title:GO.email.lang.uploadAttachments,layout:"fit",modal:false,height:300,width:300,items:this.upForm,buttons:[{text:GO.email.lang.startTransfer,handler:function(){this.upForm.form.submit({waitMsg:GO.lang.waitMsgUpload,url:GO.settings.modules.email.url+"action.php",params:{task:"attach_file"},success:function(C,D){this.attachmentsStore.loadData({results:D.result.files},true);A.clearQueue();this.uploadDialog.hide()},scope:this})},scope:this},{text:GO.lang.cmdClose,handler:function(){this.uploadDialog.hide()},scope:this}]})}this.attachmentsDialog.show()},addRemoteFiles:function(){var A=Ext.data.Record.create([{name:"tmp_name"},{name:"name"},{name:"type"},{name:"size"}]);var D=this.fileBrowser.gridPanel.selModel.selections.items;for(var C=0;C<D.length;C++){var B=new A({id:D[C].data.path,tmp_name:D[C].data.path,name:D[C].data.name,type:D[C].data.type,size:D[C].data.size});B.id=D[C].data.path;this.attachmentsStore.add(B)}this.updateAttachmentsButton();this.fileBrowserWindow.hide()},sendMail:function(A){if(this.attachmentsStore&&this.attachmentsStore.data.keys.length){this.sendParams.attachments=Ext.encode(this.attachmentsStore.data.keys)}this.sendParams.inline_attachments=Ext.encode(this.inline_attachments);this.sendParams.draft=A;this.formPanel.form.submit({url:this.sendURL,params:this.sendParams,waitMsg:GO.lang.waitMsgSave,waitMsgTarget:this.formPanel.body,success:function(B,C){if(C.result.account_id){this.account_id=C.result.account_id}if(this.callback){if(!this.scope){this.scope=this}var D=this.callback.createDelegate(this.scope);D.call()}if(GO.addressbook&&C.result.unknown_recipients&&C.result.unknown_recipients.length){if(!GO.email.unknownRecipientsDialog){GO.email.unknownRecipientsDialog=new GO.email.UnknownRecipientsDialog()}GO.email.unknownRecipientsDialog.store.loadData({recipients:C.result.unknown_recipients});GO.email.unknownRecipientsDialog.show()}this.fireEvent("send",this);this.hide()},failure:function(B,C){Ext.MessageBox.alert(GO.lang.strError,C.result.feedback)},scope:this})},onShowFieldCheck:function(A,B){switch(A.id){case"fromFieldCheck":this.fromCombo.getEl().up(".x-form-item").setDisplayed(B);break;case"ccFieldCheck":this.ccCombo.getEl().up(".x-form-item").setDisplayed(B);break;case"bccFieldCheck":this.bccCombo.getEl().up(".x-form-item").setDisplayed(B);break}this.setEditorHeight()},setEditorHeight:function(){var A=this.subjectField.el.getHeight()+this.selectLinkField.el.getHeight();if(this.toComboVisible){A+=this.toCombo.el.getHeight()+3}for(var C=0;C<this.showMenu.items.items.length;C++){if(this.showMenu.items.items[C].checked){switch(this.showMenu.items.items[C].id){case"fromFieldCheck":A+=this.fromCombo.el.getHeight()+3;break;default:A+=this.toCombo.el.getHeight()+3;break}}}var D=this.getInnerHeight();var B=D-A;this.htmlEditor.setHeight(B);this.htmlEditor.setWidth(this.getInnerWidth()-10);this.htmlEditor.syncSize()}});GO.email.TemplatesList=function(B){Ext.apply(B);var A=new Ext.XTemplate('<div id="template-0" class="go-item-wrap">No template</div>','<tpl for=".">','<div id="template-{id}" class="go-item-wrap">{name}</div>',"</tpl>");GO.email.TemplatesList.superclass.constructor.call(this,{store:B.store,tpl:A,singleSelect:true,autoHeight:true,overClass:"go-view-over",itemSelector:"div.go-item-wrap",selectedClass:"go-view-selected"})};Ext.extend(GO.email.TemplatesList,Ext.DataView,{onRender:function(B,A){this.el=B.createChild({tag:"div",cls:"go-select-list"});GO.email.TemplatesList.superclass.onRender.apply(this,arguments)}});Ext.namespace("GO.email");GO.email.EmailClient=function(B){if(!B){B={}}var C={id:"email-grid-panel"};if(screen.width>1024){C.region="west";C.width=420}else{C.region="north";C.height=250}this.messagesGrid=new GO.email.MessagesGrid(C);this.messagesGrid.store.on("load",function(){var G=this.messagesGrid.store.reader.jsonData.unseen;for(var F in G){this.updateFolderStatus(F,G[F])}if(this.messagesGrid.store.baseParams.query&&this.messagesGrid.store.baseParams.query!=""){this.resetSearchButton.setVisible(true)}else{this.resetSearchButton.setVisible(false)}},this);this.messagesGrid.on("rowdblclick",function(){if(this.messagesGrid.store.reader.jsonData.drafts){GO.email.Composer.show({uid:this.previewedUid,task:"opendraft",template_id:0,mailbox:this.mailbox,account_id:this.account_id})}else{this.messagesGrid.collapse()}},this);this.messagesGrid.on("collapse",function(){this.closeMessageButton.setVisible(true)},this);this.messagesGrid.on("expand",function(){this.closeMessageButton.setVisible(false)},this);this.messagesGrid.on("rowclick",function(H,I,J){var F=H.getSelectionModel();var G=F.getSelected();if(!J.ctrlKey&&!J.shiftKey){if(G.data.uid!=this.previewedUid){this.previewedUid=G.data.uid;this.messagePanel.el.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.email.url+"json.php",params:{uid:G.data.uid,mailbox:this.mailbox,account_id:this.account_id,task:"message"},scope:this,callback:function(L,N,K){if(!N){this.previewedUid=0}else{this.replyAllButton.setDisabled(false);this.replyButton.setDisabled(false);this.forwardButton.setDisabled(false);this.printButton.setDisabled(false);if(G.data["new"]==1){this.incrementFolderStatus(this.folder_id,-1);G.set("new","0")}var M=Ext.decode(K.responseText);this.messagePanel.setMessage(M);this.messagePanel.el.unmask()}}})}}},this);var D=new Ext.menu.Menu({shadow:"frame",minWidth:180,items:[{text:GO.email.lang.markAsRead,handler:function(){this.doTaskOnMessages("mark_as_read")},scope:this},{text:GO.email.lang.markAsUnread,handler:function(){this.doTaskOnMessages("mark_as_unread")},scope:this},{text:GO.email.lang.flag,handler:function(){this.doTaskOnMessages("flag")},scope:this},{text:GO.email.lang.unflag,handler:function(){this.doTaskOnMessages("unflag")},scope:this},"-",{text:GO.email.lang.viewSource,handler:function(){var F=this.messagesGrid.selModel.getSelected();if(F){window.open(GO.settings.modules.email.url+"source.php?account_id="+this.account_id+"&mailbox="+escape(this.mailbox)+"&uid="+escape(F.data.uid))}},scope:this},"-",{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.messagesGrid.deleteSelected()},scope:this}]});this.messagesGrid.addListener("rowcontextmenu",function(F,I,H){H.stopEvent();if(this.messagesGrid.getSelectionModel().isSelected(I)!==true){this.messagesGrid.getSelectionModel().clearSelections();this.messagesGrid.getSelectionModel().selectRow(I)}var G=H.getXY();D.showAt([G[0],G[1]])},this);this.treePanel=new GO.email.AccountsTree({id:"email-tree-panel",region:"west"});var A=new Ext.tree.AsyncTreeNode({text:GO.email.lang.accounts,draggable:false});this.treePanel.setRootNode(A);this.treeContextMenu=new Ext.menu.Menu({items:[{iconCls:"btn-delete",text:GO.email.lang.emptyFolder,handler:function(){var F=new Ext.Template(GO.email.lang.emptyFolderConfirm);Ext.MessageBox.confirm(GO.lang.strConfirm,F.applyTemplate(this.emptyFolderNode),function(G){if(G=="yes"){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"empty_folder",account_id:this.emptyFolderNode.account_id,mailbox:this.emptyFolderNode.mailbox},callback:function(){if(this.emptyFolderNode.mailbox==this.mailbox){this.messagesGrid.store.removeAll()}this.updateFolderStatus(this.emptyFolderNode.folder_id)},scope:this})}},this)},scope:this}]});this.treePanel.on("contextmenu",function(F,H){H.stopEvent();this.emptyFolderNode=F.attributes;var G=H.getXY();this.treeContextMenu.showAt([G[0],G[1]])},this);this.treePanel.on("beforenodedrop",function(J){var H=J.data.selections,I=[];for(var G=0,F=H.length;G<F;G++){if(this.account_id!=J.target.attributes.account_id){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.cross_account_move);return false}else{if(this.mailbox==J.target.mailbox){return false}else{I.push(H[G].id)}}}if(I.length>0){this.messagesGrid.store.reload({params:{action:"move",from_mailbox:this.mailbox,to_mailbox:J.target.attributes.mailbox,messages:Ext.encode(I)},callback:function(){},scope:this})}},this);A.on("load",function(F){this.refresh.defer(this.checkMailInterval,this);this.body.unmask();if(F.childNodes[0]){var G=F.childNodes[0];this.updateNotificationEl();G.on("load",function(H){if(H.childNodes[0]){if(this.messagesGrid.store.baseParams.folder_id){var H=this.treePanel.getNodeById("folder_"+this.messagesGrid.store.baseParams.folder_id);this.messagesGrid.store.reload()}else{var I=H.childNodes[0];this.setAccount(I.attributes.account_id,I.attributes.folder_id,I.attributes.mailbox)}}},this,{single:true})}},this);this.treePanel.on("beforeclick",function(F){if(F.attributes.folder_id==0){return false}},this);this.treePanel.on("click",function(F){if(F.attributes.folder_id>0){this.setAccount(F.attributes.account_id,F.attributes.folder_id,F.attributes.mailbox)}},this);this.searchDialog=new GO.email.SearchDialog({store:this.messagesGrid.store});var E=[{iconCls:"btn-compose",text:GO.email.lang.compose,cls:"x-btn-text-icon",handler:function(){GO.email.Composer.show({account_id:this.account_id})},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.messagesGrid.deleteSelected()},scope:this},new Ext.Toolbar.Separator(),{iconCls:"btn-accounts",text:GO.email.lang.accounts,cls:"x-btn-text-icon",handler:function(){this.showAccountsDialog()},scope:this},{iconCls:"btn-refresh",text:GO.lang.cmdRefresh,cls:"x-btn-text-icon",handler:function(){this.refresh()},scope:this},{iconCls:"btn-search",text:GO.lang.strSearch,cls:"x-btn-text-icon",handler:function(){this.searchDialog.show()},scope:this},this.resetSearchButton=new Ext.Button({iconCls:"btn-delete",text:GO.email.lang.resetSearch,cls:"x-btn-text-icon",hidden:true,handler:function(){this.messagesGrid.store.baseParams.query="";this.messagesGrid.store.load()},scope:this}),"-",this.replyButton=new Ext.Button({disabled:true,iconCls:"btn-reply",text:GO.email.lang.reply,cls:"x-btn-text-icon",handler:function(){GO.email.Composer.show({uid:this.previewedUid,task:"reply",mailbox:this.mailbox,account_id:this.account_id})},scope:this}),this.replyAllButton=new Ext.Button({disabled:true,iconCls:"btn-reply-all",text:GO.email.lang.replyAll,cls:"x-btn-text-icon",handler:function(){GO.email.Composer.show({uid:this.previewedUid,task:"reply_all",mailbox:this.mailbox,account_id:this.account_id})},scope:this}),this.forwardButton=new Ext.Button({disabled:"true",iconCls:"btn-forward",text:GO.email.lang.forward,cls:"x-btn-text-icon",handler:function(){GO.email.Composer.show({uid:this.previewedUid,task:"forward",mailbox:this.mailbox,account_id:this.account_id})},scope:this}),this.printButton=new Ext.Button({disabled:true,iconCls:"btn-print",text:GO.lang.cmdPrint,cls:"x-btn-text-icon",handler:function(){var F=window.open("about:blank");if(!F.opener){F.opener=self}F.document.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n<html>\n<head>\n<title>Group-Office</title><link href="'+GO.settings.config.theme_url+'images/favicon.ico" rel="shotcut icon" /><link href="'+BaseHref+'ext/resources/css/ext-all.css" type="text/css" rel="stylesheet" /><link href="'+GO.settings.config.theme_url+'style.css" type="text/css" rel="stylesheet" /><link href="'+GO.settings.modules.email.url+"themes/"+GO.settings.theme+'/style.css" type="text/css" rel="stylesheet" /></head><body>'+this.messagePanel.body.dom.innerHTML+"</body></html>");F.document.close();F.focus()},scope:this})];if(GO.mailings){E.push({iconCls:"btn-link",text:GO.lang.cmdLink,cls:"x-btn-text-icon",handler:function(){if(!this.messagesGrid.selModel.selections.keys.length){Ext.MessageBox.alert(GO.lang.strError,GO.lang.noItemSelected)}else{this.linksDialog=new GO.email.LinksDialog({messagesGrid:this.messagesGrid});this.linksDialog.show()}},scope:this})}E.push(new Ext.Toolbar.Separator());E.push(this.closeMessageButton=new Ext.Button({hidden:true,iconCls:"btn-close",text:GO.lang.cmdClose,cls:"x-btn-text-icon",handler:function(){this.messagesGrid.expand()},scope:this}));B.layout="border";B.tbar=new Ext.Toolbar({cls:"go-head-tb",items:E});B.items=[this.treePanel,{region:"center",titlebar:false,layout:"border",items:[this.messagesGrid,this.messagePanel=new GO.email.MessagePanel({id:"email-message-panel",region:"center",autoScroll:true,titlebar:false,border:true})]}];this.messagePanel.on("linkClicked",function(F){window.open(F)},this);this.messagePanel.on("attachmentClicked",this.openAttachment,this);this.messagePanel.on("zipOfAttachmentsClicked",this.openZipOfAttachments,this);this.messagePanel.on("emailClicked",function(F){this.showComposer({to:F})},this);GO.email.searchSender=function(F){this.messagesGrid.store.baseParams.query='FROM "'+F+'"';this.messagesGrid.store.load()};GO.email.searchSender=GO.email.searchSender.createDelegate(this);GO.email.EmailClient.superclass.constructor.call(this,B)};Ext.extend(GO.email.EmailClient,Ext.Panel,{checkMailInterval:300000,afterRender:function(){GO.email.Composer.on("send",function(C){if(C.sendParams.reply_uid&&C.sendParams.reply_uid>0){var B=this.messagesGrid.store.getById(C.sendParams.reply_uid);if(B){B.set("answered",true)}}},this);GO.email.EmailClient.superclass.afterRender.call(this);this.body.mask(GO.lang.waitMsgLoad);var A=Ext.get("notification-area");if(A){this.notificationEl=A.createChild({id:"ml-notify",tag:"div",html:"",style:"display:none"})}},onShow:function(){if(this.notificationEl){this.notificationEl.setDisplayed(false)}GO.email.EmailClient.superclass.onShow.call(this)},updateNotificationEl:function(){if(this.notificationEl){var B=this.treePanel.getRootNode();var D=0;for(var A=0;A<B.childNodes.length;A++){D+=B.childNodes[A].attributes.inbox_new}var C=this.notificationEl.dom.innerHTML;if(C!=""&&D>C){GO.playAlarm();this.notificationEl.setDisplayed(!this.isVisible())}this.notificationEl.update(D)}},openAttachment:function(A){if(A.mime.indexOf("message")>-1){GO.linkHandlers[9].call(this,0,{uid:this.previewedUid,mailbox:this.mailbox,part:A.number,transfer:this.transfer,mime:A.mime,account_id:this.account_id})}else{switch(A.extension){case"dat":document.location.href=GO.settings.modules.email.url+"tnef.php?account_id="+this.account_id+"&mailbox="+escape(this.mailbox)+"&uid="+this.previewedUid+"&part="+A.number+"&transfer="+A.transfer+"&mime="+A.mime+"&filename="+escape(A.name);break;default:document.location.href=GO.settings.modules.email.url+"attachment.php?account_id="+this.account_id+"&mailbox="+escape(this.mailbox)+"&uid="+this.previewedUid+"&part="+A.number+"&transfer="+A.transfer+"&mime="+A.mime+"&filename="+escape(A.name);break}}},openZipOfAttachments:function(){document.location.href=GO.settings.modules.email.url+"zip_attachments.php?account_id="+this.account_id+"&mailbox="+escape(this.mailbox)+"&uid="+this.previewedUid},showComposer:function(A){GO.email.Composer.show({account_id:this.account_id,values:A})},setAccount:function(B,A,C){this.messagesGrid.expand();this.account_id=B;this.folder_id=A;this.mailbox=C;this.messagesGrid.store.baseParams.task="messages";this.messagesGrid.store.baseParams.account_id=B;this.messagesGrid.store.baseParams.folder_id=A;this.messagesGrid.store.baseParams.mailbox=C;this.messagesGrid.store.load()},updateFolderStatus:function(A,D){var B=Ext.get("status_"+A);var C=this.treePanel.getNodeById("folder_"+A);if(C&&C.attributes.mailbox=="INBOX"){C.parentNode.attributes.inbox_new=D;this.updateNotificationEl()}if(D>0){B.dom.innerHTML="("+D+")"}else{B.dom.innerHTML=""}},incrementFolderStatus:function(C,A){var D=Ext.get("status_"+C);var E=D.dom.innerHTML;var B=0;if(E!=""){var B=parseInt(E.substring(1,E.length-1))}B+=A;this.updateFolderStatus(C,B)},refresh:function(){this.treePanel.root.reload()},showAccountsDialog:function(){if(!this.accountsDialog){this.accountsDialog=new GO.email.AccountsDialog();this.accountsDialog.accountsGrid.store.on("load",function(){this.accountsDialog.accountsGrid.store.on("load",this.refresh,this)},this);this.accountsDialog.accountsGrid.store.load()}this.accountsDialog.show()},doTaskOnMessages:function(A){var B=this.messagesGrid.selModel.selections.keys;if(B.length){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"flag_messages",account_id:this.account_id,mailbox:this.mailbox,action:A,messages:Ext.encode(B)},callback:function(E,J,D){if(!J){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var I=Ext.decode(D.responseText);if(!I.success){Ext.MessageBox.alert(GO.lang.strError,I.feedback)}else{this.updateFolderStatus(this.folder_id,I.unseen);var H;var G;switch(A){case"mark_as_read":H="new";G=false;break;case"mark_as_unread":H="new";G=true;break;case"flag":H="flagged";G=true;break;case"unflag":H="flagged";G=false;break}var C=this.messagesGrid.selModel.getSelections();for(var F=0;F<C.length;F++){C[F].set(H,G);C[F].commit()}}}},scope:this})}}});GO.mainLayout.onReady(function(){GO.email.Composer=new GO.email.EmailComposer()});GO.moduleManager.addModule("email",GO.email.EmailClient,{title:GO.lang.strEmail,iconCls:"go-tab-icon-email"});GO.linkHandlers[9]=function(D,A){var B=new GO.email.MessagePanel({border:false,autoScroll:true});B.on("linkClicked",function(E){window.open(E)},this);B.on("attachmentClicked",function(F,E){if(E.data.path){document.location.href=GO.settings.modules.email.url+"mimepart.php?path="+escape(E.data.path)+"&part_number="+F.number}else{document.location.href=GO.settings.modules.email.url+"mimepart.php?uid="+A.uid+"&account_id="+A.account_id+"&transfer="+F.transfer+"&mailbox="+escape(A.mailbox)+"&part="+A.part+"&part_number="+F.number}},this);B.on("zipOfAttachmentsClicked",function(){},this);B.on("emailClicked",function(E){GO.email.Composer.show({values:{to:E}})},this);var C=new Ext.Window({maximizable:true,title:GO.email.lang.emailMessage,height:400,width:600,layout:"fit",items:B,buttons:[{text:GO.lang.cmdClose,handler:function(){C.close()}}]});C.show();B.el.mask(GO.lang.strWaitMsgLoad);if(!A){A={}}A.id=D;A.task="linked_message";Ext.Ajax.request({url:GO.settings.modules.mailings.url+"json.php",params:A,scope:this,callback:function(F,H,E){var G=Ext.decode(E.responseText);B.setMessage(G);B.el.unmask()}})};