GO.calendar.EventDialog=function(A){this.calendar=A;this.buildForm();var B=function(){this.subjectField.focus()};this.win=new Ext.Window({layout:"fit",modal:false,resizable:false,width:560,height:400,closeAction:"hide",title:GO.calendar.lang.appointment,items:this.formPanel,focus:B.createDelegate(this),buttons:[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.win.hide()},scope:this}]});this.win.render(Ext.getBody());this.addEvents({save:true})};Ext.extend(GO.calendar.EventDialog,Ext.util.Observable,{show:function(B){if(B.oldDomId){this.oldDomId=B.oldDomId}else{this.oldDomId=false}propertiesPanel.show();if(!B.event_id){B.event_id=0}this.selectCalendar.container.up("div.x-form-item").setDisplayed(false);this.setEventId(B.event_id);if(B.event_id>0){this.formPanel.load({url:GO.settings.modules.calendar.url+"json.php",success:function(D,E){this.win.show();this.participants_event_id=E.result.data.participants_event_id;this.formPanel.form.baseParams.calendar_id=E.result.data.calendar_id;this.changeRepeat(E.result.data.repeat_type);this.setValues(B.values);this.participantsPanel.setDisabled(false);this.setWritePermission(E.result.data.write_permission);this.selectCalendar.setRemoteText(E.result.data.calendar_name);this.selectCalendar.container.up("div.x-form-item").setDisplayed(true)},failure:function(D,E){Ext.Msg.alert(GO.lang.strError,E.result.feedback)},scope:this})}else{if(B.exception_event_id){this.formPanel.load({url:GO.settings.modules.calendar.url+"json.php",params:{event_id:B.exception_event_id},waitMsg:GO.lang.waitMsgLoad,success:function(D,E){this.win.show();this.participants_event_id=E.result.data.participants_event_id;this.formPanel.form.baseParams.exception_event_id=B.exception_event_id;this.formPanel.form.baseParams.exceptionDate=B.exceptionDate;this.formPanel.form.findField("repeat_type").setValue(0);this.changeRepeat(0);this.setValues(B.values);this.participantsPanel.setDisabled(false);this.selectCalendar.setRemoteText(E.result.data.calendar_name);this.selectCalendar.container.up("div.x-form-item").setDisplayed(true);this.setWritePermission(E.result.data.write_permission)},failure:function(D,E){Ext.Msg.alert(GO.lang.strError,E.result.feedback)},scope:this})}else{delete this.formPanel.form.baseParams.exception_event_id;delete this.formPanel.form.baseParams.exceptionDate;this.formPanel.form.reset();this.participantsPanel.setDisabled(true);this.setWritePermission(true);this.win.show();if(!B.values){var A=new Date();B.values={};var C=parseInt(A.format("i"));if(C>45){C="45"}else{if(C>30){C="30"}else{if(C>15){C="15"}else{C="00"}}}B.values.start_date=new Date();B.values.start_hour=A.format("H");B.values.start_min=C;B.values.end_date=new Date();B.values.end_hour=A.add(Date.HOUR,1).format("H");B.values.end_min=C}this.setValues(B.values);if(!B.calendar_id){B.calendar_id=GO.calendar.defaultCalendar.id;B.calendar_name=GO.calendar.defaultCalendar.name}this.selectCalendar.setValue(B.calendar_id);if(B.calendar_name){this.selectCalendar.container.up("div.x-form-item").setDisplayed(true);this.selectCalendar.setRemoteText(B.calendar_name)}}}if(B&&B.link_config){this.link_config=B.link_config;if(B.link_config.type_id){this.selectLinkField.setValue(B.link_config.type_id);this.selectLinkField.setRemoteText(B.link_config.text);this.setValues({subject:B.link_config.text})}}else{delete this.link_config}},setWritePermission:function(A){this.win.buttons[0].setDisabled(!A);this.win.buttons[1].setDisabled(!A)},setValues:function(A){if(A){for(var B in A){var C=this.formPanel.form.findField(B);if(C){C.setValue(A[B])}}}},setEventId:function(A){this.formPanel.form.baseParams.event_id=A;this.event_id=A;this.participantsStore.baseParams.event_id=A;this.selectLinkField.container.up("div.x-form-item").setDisplayed(A==0)},setCurrentDate:function(){var B={};var A=new Date();B.start_date=A.format(GO.settings.date_format);B.start_hour=A.format("H");B.start_min="00";B.end_date=A.format(GO.settings.date_format);B.end_hour=A.add(Date.HOUR,1).format("H");B.end_min="00";this.formPanel.form.setValues(B)},submitForm:function(A){this.formPanel.form.submit({url:GO.settings.modules.calendar.url+"action.php",params:{task:"save_event"},waitMsg:GO.lang.waitMsgSave,success:function(C,E){if(E.result.event_id){this.setEventId(E.result.event_id);this.participants_event_id=E.result.event_id;this.participantsPanel.setDisabled(false)}var B=this.formPanel.form.findField("start_date").getValue();if(!this.formPanel.form.findField("all_day_event").getValue()){B=B.add(Date.HOUR,this.formPanel.form.findField("start_hour").getValue());B=B.add(Date.MINUTE,this.formPanel.form.findField("start_min").getValue())}var F=this.formPanel.form.findField("end_date").getValue();if(!this.formPanel.form.findField("all_day_event").getValue()){F=F.add(Date.HOUR,this.formPanel.form.findField("end_hour").getValue());F=F.add(Date.MINUTE,this.formPanel.form.findField("end_min").getValue())}var D={id:Ext.id(),calendar_id:this.formPanel.form.baseParams.calendar_id,event_id:this.event_id,name:this.subjectField.getValue(),start_time:B.format("U"),end_time:F.format("U"),startDate:B,endDate:F,tooltip:"",background:this.formPanel.form.findField("background").getValue(),location:this.formPanel.form.findField("location").getValue(),repeats:this.formPanel.form.findField("repeat_type").getValue()>0,"private":false};this.fireEvent("save",D,this.oldDomId);if(this.link_config&&this.link_config.callback){this.link_config.callback.call(this)}if(A){this.win.hide()}},failure:function(B,C){if(C.failureType=="client"){error=GO.lang.strErrorsInForm}else{error=C.result.feedback}Ext.MessageBox.alert(GO.lang.strError,error)},scope:this})},buildForm:function(){this.selectLinkField=new GO.form.SelectLink({});var a=Array();if(GO.settings.time_format.substr(0,1)=="G"){var d=40;var G="G"}else{var d=60;var G="g a"}for(var Z=0;Z<24;Z++){var c=Date.parseDate(Z,"G");a.push([c.format("G"),c.format(G)])}var V=[["00","00"],["05","05"],["10","10"],["15","15"],["20","20"],["25","25"],["30","30"],["35","35"],["40","40"],["45","45"],["50","50"],["55","55"]];this.subjectField=new Ext.form.TextField({name:"subject",allowBlank:false,fieldLabel:GO.lang.strSubject});var L=new Ext.form.TextField({name:"location",allowBlank:true,fieldLabel:GO.lang.strLocation});var X=new Ext.form.TextArea({name:"description",height:100,allowBlank:true,fieldLabel:GO.lang.strDescription});var E=function(){if(F.getValue()>b.getValue()){b.setValue(F.getValue())}var j=P.getValue();var k=I.getValue();var l=M.getValue();var i=B.getValue();if(j>k){I.setValue(j)}if(j==k&&l>i){B.setValue(l)}if(N.getValue()>0){if(K.getValue()==""){H.setValue(true)}else{var h=b.getValue();if(K.getValue()<h){K.setValue(h.add(Date.DAY,1))}}}};var F=new Ext.form.DateField({name:"start_date",width:100,format:GO.settings.date_format,allowBlank:false,fieldLabel:GO.lang.strStart,listeners:{change:{fn:E,scope:this}}});var P=new Ext.form.ComboBox({hiddenName:"start_hour",store:new Ext.data.SimpleStore({fields:["value","text"],data:a}),valueField:"value",displayField:"text",mode:"local",triggerAction:"all",selectOnFocus:true,width:d,labelSeparator:"",hideLabel:true,listeners:{change:{fn:E,scope:this}}});var M=new Ext.form.ComboBox({name:"start_min",store:new Ext.data.SimpleStore({fields:["value","text"],data:V}),displayField:"text",mode:"local",triggerAction:"all",selectOnFocus:true,width:40,labelSeparator:"",hideLabel:true,listeners:{change:{fn:E,scope:this}}});var b=new Ext.form.DateField({name:"end_date",width:100,format:GO.settings.date_format,allowBlank:false,fieldLabel:GO.lang.strEnd,listeners:{change:{fn:E,scope:this}}});var I=new Ext.form.ComboBox({hiddenName:"end_hour",store:new Ext.data.SimpleStore({fields:["value","text"],data:a}),displayField:"text",valueField:"value",mode:"local",triggerAction:"all",selectOnFocus:true,width:d,labelSeparator:"",hideLabel:true,listeners:{change:{fn:E,scope:this}}});var B=new Ext.form.ComboBox({name:"end_min",store:new Ext.data.SimpleStore({fields:["value","text"],data:V}),displayField:"text",mode:"local",triggerAction:"all",selectOnFocus:true,width:40,labelSeparator:"",hideLabel:true,listeners:{change:{fn:E,scope:this}}});var O=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.allDay,name:"all_day_event",checked:false,width:"auto",labelSeparator:"",hideLabel:true});O.on("check",function(i,h){P.setDisabled(h);I.setDisabled(h);M.setDisabled(h);B.setDisabled(h)},this);var e=new Ext.form.ComboBox({hiddenName:"status",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,fieldLabel:"Status",mode:"local",value:"ACCEPTED",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["NEEDS-ACTION",GO.calendar.lang.needsAction],["ACCEPTED",GO.calendar.lang.accepted],["DECLINED",GO.calendar.lang.declined],["TENTATIVE",GO.calendar.lang.tentative],["DELEGATED",GO.calendar.lang.delegated]]})});var f=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.busy,name:"busy",checked:true,width:"auto",labelSeparator:"",hideLabel:true});propertiesPanel=new Ext.Panel({hideMode:"offsets",title:GO.lang.strProperties,defaults:{anchor:"-20"},bodyStyle:"padding:5px",layout:"form",autoScroll:true,items:[this.subjectField,L,this.selectLinkField,X,{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:F},{items:P},{items:M},{bodyStyle:"white-space:nowrap;",items:O}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:b},{items:I},{items:B}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:e},{items:f}]},this.selectCalendar=new GO.form.ComboBox({fieldLabel:GO.calendar.lang.calendar,hiddenName:"calendar_id",anchor:"-20",emptyText:GO.lang.strPleaseSelect,store:new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_calendars"},root:"results",id:"id",totalProperty:"total",fields:["id","name"],remoteSort:true}),pageSize:parseInt(GO.settings.max_rows_list),valueField:"id",displayField:"name",typeAhead:true,mode:"remote",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,allowBlank:false})]});var U=new Ext.form.ComboBox({fieldLabel:GO.calendar.lang.repeatEvery,hiddenName:"repeat_every",triggerAction:"all",editable:false,selectOnFocus:true,width:50,forceSelection:true,mode:"local",value:"1",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10","10"],["11","11"],["12","12"]]})});var N=new Ext.form.ComboBox({hiddenName:"repeat_type",triggerAction:"all",editable:false,selectOnFocus:true,width:200,forceSelection:true,mode:"local",value:"0",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["0",GO.calendar.lang.noRecurrence],["1",GO.calendar.lang.days],["2",GO.calendar.lang.weeks],["3",GO.calendar.lang.monthsByDate],["4",GO.calendar.lang.monthsByDay],["5",GO.calendar.lang.years]]}),hideLabel:true,listeners:{change:E}});N.on("select",function(i,h){this.changeRepeat(h.data.value)},this);var T=new Ext.form.ComboBox({hiddenName:"month_time",triggerAction:"all",selectOnFocus:true,disabled:true,width:80,forceSelection:true,fieldLabel:GO.calendar.lang.atDays,mode:"local",value:"1",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["1",GO.lang.strFirst],["2",GO.lang.strSecond],["3",GO.lang.strThird],["4",GO.lang.strFourth]]})});var R=[];for(var Y=0;Y<7;Y++){R[Y]=new Ext.form.Checkbox({boxLabel:GO.lang.shortDays[Y],id:"frm_repeat_days_"+Y,name:"repeat_days_"+Y,disabled:true,checked:false,width:"auto",hideLabel:true,laelSeperator:""})}var K=new Ext.form.DateField({name:"repeat_end_date",width:100,disabled:true,format:GO.settings.date_format,allowBlank:true,fieldLabel:GO.calendar.lang.repeatUntil,listeners:{change:{fn:E,scope:this}}});var H=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.repeatForever,name:"repeat_forever",checked:true,disabled:true,width:"auto",hideLabel:true,laelSeperator:""});var D=new Ext.Panel({title:GO.calendar.lang.recurrence,bodyStyle:"padding: 5px",layout:"form",hideMode:"offsets",autoScroll:true,items:[{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:U},{items:N}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px;white-space:nowrap"},items:[{items:T},{items:R[0]},{items:R[1]},{items:R[2]},{items:R[3]},{items:R[4]},{items:R[5]},{items:R[6]}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:K},{items:H}]}]});var J=[["0",GO.calendar.lang.noReminder]];for(var Z=1;Z<60;Z++){J.push([Z,Z])}var W=new Ext.form.ComboBox({fieldLabel:GO.calendar.lang.reminder,hiddenName:"reminder_value",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,mode:"local",value:"0",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:J})});var S=new Ext.form.ComboBox({hiddenName:"reminder_multiplier",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,mode:"local",value:"60",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["60",GO.lang.strMinutes],["3600",GO.lang.strHours],["86400",GO.lang.strDays]]}),hideLabel:true,labelSeperator:""});this.participantsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"participants"},root:"results",id:"id",fields:["id","name","email","available","status"],remoteSort:true});this.participantsStore.setDefaultSort("name","ASC");var A=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.showAddParticipantsDialog()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.participantsPanel.deleteSelected()},scope:this},{iconCls:"btn-availability",text:GO.calendar.lang.checkAvailability,cls:"x-btn-text-icon",handler:function(){this.checkAvailability()},scope:this}];if(GO.email){A.push({iconCls:"btn-invite",text:GO.calendar.lang.sendInvitation,cls:"x-btn-text-icon",handler:function(){if(!GO.settings.modules.email){Ext.Msg.alert(GO.lang.strError,GO.calendar.lang.emailSendingNotConfigured)}else{GO.email.Composer.show({loadUrl:GO.settings.modules.calendar.url+"json.php",loadParams:{task:"invitation",event_id:this.event_id},template_id:0})}},scope:this})}this.participantsPanel=new GO.grid.GridPanel({title:GO.calendar.lang.participants,store:this.participantsStore,border:false,columns:[{header:GO.lang.strName,dataIndex:"name",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",sortable:true},{header:GO.lang.strStatus,dataIndex:"status",sortable:true,renderer:function(h){switch(h){case"2":return GO.calendar.lang.declined;break;case"1":return GO.calendar.lang.accepted;break;case"0":return GO.calendar.lang.notRespondedYet;break}}},{header:GO.lang.strAvailable,dataIndex:"available",sortable:false,renderer:function(h){var i="img-unknown";switch(h){case"1":i="img-available";break;case"0":i="img-unavailable";break}return'<div class="'+i+'"></div>'}}],view:new Ext.grid.GridView({autoFill:true,forceFit:true}),loadMask:{msg:GO.lang.waitMsgLoad},sm:new Ext.grid.RowSelectionModel({}),layout:"fit",tbar:A});this.participantsPanel.on("show",function(){if(!this.loadedParticipantsEventId||this.loadedParticipantsEventId!=this.participants_event_id){this.participantsStore.baseParams.event_id=this.participants_event_id;this.loadedParticipantsEventId=this.participants_event_id;this.participantsStore.load()}},this);var g=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.privateEvent,name:"private",checked:false,width:"auto",labelSeparator:"",hideLabel:true});var C=new Ext.Panel({title:GO.calendar.lang.options,bodyStyle:"padding:5px",layout:"form",hideMode:"offsets",autoScroll:true,items:[{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:W},{items:S}]},{xtype:"colorfield",fieldLabel:GO.lang.color,value:"EBF1E2",name:"background",colors:["EBF1E2","95C5D3","FFFF99","A68340","82BA80","F0AE67","66FF99","CC0099","CC99FF","996600","999900","FF0000","FF6600","FFFF00","FF9966","FF9900"]},g]});var Q=[propertiesPanel,D,C,this.participantsPanel];this.tabPanel=new Ext.TabPanel({activeTab:0,deferredRender:false,border:false,anchor:"100% 100%",hideLabel:true,items:Q});this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,url:GO.settings.modules.calendar.url+"action.php",border:false,baseParams:{task:"event"},items:this.tabPanel})},checkAvailability:function(){if(!this.availabilityWindow){this.availabilityStore=new Ext.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",root:"participants",fields:["name","email","freebusy"],baseParams:{task:"availability"}});var C=new Ext.XTemplate('<div id="availability_date"></div>','<table class="availability">',"<tr><td></td>",'<td colspan="4" class="availability_time">'+Date.parseDate("0","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("1","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("2","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("3","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("4","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("5","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("6","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("7","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("8","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("9","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("10","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("11","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("12","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("13","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("14","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("15","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("16","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("17","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("18","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("19","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("20","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("21","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("22","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("23","G").format(GO.settings.time_format)+"</td>",'<tpl for=".">',"<tr>","<td>{name}</td>",'<tpl if="this.hasFreeBusy(freebusy)">','<tpl for="freebusy">','<td id="time{time}"class="time {[values.busy == 1 ? "busy" : "free"]}"></td>',"</tpl>","</tpl>",'<tpl if="!this.hasFreeBusy(freebusy)">','<td colspan="96">'+GO.calendar.lang.noInformationAvailable+"</td>","</tpl>","</tr>","</tpl>","</table>",{hasFreeBusy:function(E){return E.length>0}});var D=new Ext.DataView({store:this.availabilityStore,tpl:C,autoHeight:true,emptyText:GO.calendar.lang.noParticipantsToDisplay,itemSelector:"td.time",overClass:"time-over"});var B=new Ext.Panel({layout:"fit",cls:"go-form-panel",waitMsgTarget:true,items:D,autoScroll:true});D.on("click",function(T,J,N){var K=N.id.substr(4);var O=K.indexOf(":");var P=K.substr(O+1);var S=K.substr(0,O);var U=Date.parseDate(this.availabilityStore.baseParams.date,"Y-m-d");var G=this.formPanel.form.findField("start_hour");var F=this.formPanel.form.findField("start_min");var R=this.formPanel.form.findField("start_date");var Q=this.formPanel.form.findField("end_hour");var M=this.formPanel.form.findField("end_min");var L=this.formPanel.form.findField("end_date");var I=Q.getValue()-G.getValue();var V=M.getValue()-F.getValue();G.setValue(S);F.setValue(P);R.setValue(U);var H=parseInt(S)+I;var E=parseInt(P)+V;if(E==0){E="00"}Q.setValue(H);M.setValue(E);L.setValue(U);propertiesPanel.show();this.availabilityWindow.hide()},this);this.availabilityStore.on("load",function(){var E=Date.parseDate(this.availabilityStore.baseParams.date,"Y-m-d");Ext.get("availability_date").update(E.format(GO.settings.date_format))},this);this.availabilityWindow=new Ext.Window({layout:"fit",modal:false,height:400,width:800,closeAction:"hide",title:GO.lang.strAvailability,items:B,tbar:[{iconCls:"btn-left-arrow",text:GO.calendar.lang.previousDay,cls:"x-btn-text-icon",handler:function(){var E=Date.parseDate(this.availabilityStore.baseParams.date,"Y-m-d").add(Date.DAY,-1);this.availabilityStore.baseParams.date=E.format("Y-m-d");this.availabilityStore.load()},scope:this},{iconCls:"btn-right-arrow",text:GO.calendar.lang.nextDay,cls:"x-btn-text-icon",handler:function(){var E=Date.parseDate(this.availabilityStore.baseParams.date,"Y-m-d").add(Date.DAY,1);this.availabilityStore.baseParams.date=E.format("Y-m-d");this.availabilityStore.load()},scope:this}],buttons:[{text:GO.lang.cmdClose,handler:function(){this.availabilityWindow.hide()},scope:this}]})}var A=this.formPanel.form.findField("start_date");A=A.getValue();this.availabilityStore.baseParams.date=A.format("Y-m-d");this.availabilityStore.baseParams.event_id=this.event_id;this.availabilityStore.load();this.availabilityWindow.show()},showAddParticipantsDialog:function(){if(!GO.addressbook){var A=new Ext.XTemplate(GO.lang.moduleRequired);Ext.Msg.alert(GO.lang.strError,A.apply({module:GO.calendar.lang.addressbook}));return false}if(!this.addParticipantsDialog){this.addParticipantsDialog=new GO.dialog.SelectEmail({handler:function(D){if(D.selModel.selections.keys.length>0){var E=D.selModel.getSelections();var B=Array();for(var C=0;C<E.length;C++){B.push({name:E[C].data.name,email:E[C].data.email})}this.participantsStore.baseParams.add_participants=Ext.encode(B);this.participantsStore.load();delete this.participantsStore.baseParams.add_participants}},scope:this})}this.addParticipantsDialog.show()},changeRepeat:function(B){var A=this.formPanel.form;switch(B){case"0":this.disableDays(true);A.findField("month_time").setDisabled(true);A.findField("repeat_forever").setDisabled(true);A.findField("repeat_end_date").setDisabled(true);A.findField("repeat_every").setDisabled(true);break;case"1":this.disableDays(true);A.findField("month_time").setDisabled(true);A.findField("repeat_forever").setDisabled(false);A.findField("repeat_end_date").setDisabled(false);A.findField("repeat_every").setDisabled(false);break;case"2":this.disableDays(false);A.findField("month_time").setDisabled(true);A.findField("repeat_forever").setDisabled(false);A.findField("repeat_end_date").setDisabled(false);A.findField("repeat_every").setDisabled(false);break;case"3":this.disableDays(true);A.findField("month_time").setDisabled(true);A.findField("repeat_forever").setDisabled(false);A.findField("repeat_end_date").setDisabled(false);A.findField("repeat_every").setDisabled(false);break;case"4":this.disableDays(false);A.findField("month_time").setDisabled(false);A.findField("repeat_forever").setDisabled(false);A.findField("repeat_end_date").setDisabled(false);A.findField("repeat_every").setDisabled(false);break;case"5":this.disableDays(true);A.findField("month_time").setDisabled(true);A.findField("repeat_forever").setDisabled(false);A.findField("repeat_end_date").setDisabled(false);A.findField("repeat_every").setDisabled(false);break}},disableDays:function(B){for(var A=0;A<7;A++){this.formPanel.form.findField("repeat_days_"+A).setDisabled(B)}}});GO.grid.CalendarGrid=Ext.extend(Ext.Panel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,dragEvent:false,appointments:Array(),appointmentsMap:{},allDayAppointments:Array(),allDayAppointmentsMap:[],allDayEventRows:0,allDayColumns:Array(),remoteEvents:Array(),domIds:Array(),days:1,loaded:false,writePermission:false,scrollOffset:19,selected:Array(),initComponent:function(){GO.grid.CalendarGrid.superclass.initComponent.call(this);this.addEvents({create:true,move:true,eventResize:true,eventDblClick:true});if(this.store){this.setStore(this.store,true)}if(!this.startDate){var A=new Date();this.startDate=Date.parseDate(A.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate},doLayout:function(){GO.grid.CalendarGrid.superclass.doLayout.call(this);if(this.rendered){this.setDate(this.startDate,this.days,false);this.body.setStyle("overflow","hidden");this.body.unselectable();if(this.daysGridRendered){this.cacheGridCells()}this.setStore(this.store)}},renderDaysGrid:function(){this.daysGridRendered=true;this.body.update("");var K=this.container.getSize(true);var H=(K.width-40-this.scrollOffset)/this.days;H=Math.floor(H);this.headingsTable=Ext.DomHelper.append(this.body,{tag:"table",id:Ext.id(),cls:"x-calGrid-headings-table",style:"width:"+K.width+"px;"},true);var A=Ext.DomHelper.append(this.headingsTable,{tag:"tbody"},true);this.headingsRow=Ext.DomHelper.append(A,{tag:"tr",children:{tag:"td",style:"width:37px",cls:"x-calGrid-heading"}},true);this.allDayTable=Ext.DomHelper.append(this.body,{tag:"table",id:Ext.id(),cls:"x-calGrid-all-day-table",style:"width:"+K.width+"px;"},true);var A=Ext.DomHelper.append(this.allDayTable,{tag:"tbody"},true);this.allDayRow=Ext.DomHelper.append(A,{tag:"tr",children:{tag:"td",style:"width:40px",cls:"x-calGrid-all-day-first-col"}},true);var S=GO.settings.date_format.indexOf("Y");var O="D "+GO.settings.date_format.substring(0,S-1);this.allDayColumns=Array();for(var Q=0;Q<this.days;Q++){var N=this.startDate.add(Date.DAY,Q);var F=Ext.DomHelper.append(this.headingsRow,{tag:"td",cls:"x-calGrid-heading",style:"width:"+(H)+"px",html:N.format(O)});var M=Ext.DomHelper.append(this.allDayRow,{tag:"td",id:"all_day_"+Q,cls:"x-calGrid-all-day-container",style:"width:"+(H)+"px;height:0px"},true);this.allDayColumns.push(M)}Ext.DomHelper.append(this.headingsRow,{tag:"td",style:"width:"+(this.scrollOffset-3)+"px;height:0px",cls:"x-calGrid-heading"});Ext.DomHelper.append(this.allDayRow,{tag:"td",style:"width:"+(this.scrollOffset-3)+"px;height:0px",cls:"x-calGrid-all-day-container"});this.gridContainer=Ext.DomHelper.append(this.body,{tag:"div",cls:"x-calGrid-grid-container"},true);var L=this.headingsTable.getHeight();var P=K.height-L;this.gridContainer.setSize(K.width,P);this.gridTable=Ext.DomHelper.append(this.gridContainer,{tag:"table",id:Ext.id(),cls:"x-calGrid-table",style:"width:"+K.width-this.scrollWidth+"px;"},true);this.tbody=Ext.DomHelper.append(this.gridTable,{tag:"tbody"},true);this.gridTable.on("mousedown",this.startSelection,this);this.gridContainer.on("mousemove",this.onEventDragMouseMove,this);this.body.on("mouseup",this.onEventDragMouseUp,this);this.allDayTable.on("mousemove",this.onAllDayEventDragMouseMove,this);this.body.on("mouseup",this.onAllDayEventDragMouseUp,this);var D=Ext.DomHelper.append(this.tbody,{tag:"tr"});var G=Ext.DomHelper.append(D,{tag:"td",style:"width:40px"},true);var J=true;for(var R=0;R<48;R++){if(J){var E=GO.settings.time_format.substr(0,1)=="G"?"G:i":"g a";Ext.DomHelper.append(G,{tag:"div",id:"head"+R,cls:"x-calGrid-timeHead",html:Date.parseDate(R/2,"G").format(E),style:"width:40px"},true);J=false}else{Ext.DomHelper.append(G,{tag:"div",id:"head"+R,cls:"x-calGrid-timeHead",style:"width:40px"},true);J=true}}this.gridCells=[];for(var Q=0;Q<this.days;Q++){this.gridCells[Q]=[];var I=Ext.DomHelper.append(D,{tag:"td",id:"dayCol"+Q,style:"width:"+H+"px"},true);var J=true;var C="x-calGrid-evenRow";for(var R=0;R<48;R++){if(J){C="x-calGrid-evenRow";J=false}else{C="x-calGrid-unevenRow";J=true}var B=Ext.DomHelper.append(I,{tag:"div",id:"day"+Q+"_row"+R,cls:C},true);this.gridCells[Q].push(B)}}this.gridX=0;this.gridY=0;this.gridContainer.on("scroll",this.storeScrollPosition,this);this.daysRendered=this.days;this.selector=Ext.DomHelper.append(this.body,{tag:"div",id:Ext.id(),cls:"x-calGrid-selector"},true);this.cacheGridCells();this.gridTableHeight=this.gridTable.getHeight()},createHeadings:function(){},cacheGridCells:function(){this.gridTable.xy=this.gridTable.getXY();var A=this.gridTable.getY();var B=this.gridCells[0][0].getSize();var J=this.gridCells[0][0].getXY();var I=J[0];var G=J[1]-A;for(var H=0;H<this.days;H++){var D=I+(H*B.width);for(var F=0;F<48;F++){var C=G+(F*B.height);if(this.gridCells[H]){this.gridCells[H][F].xy=[D,C];this.gridCells[H][F].size=B}else{alert("hoi")}}}var E=this.gridCells[0][0];this.snapCol={x:E.size["width"],y:E.size["height"]}},syncSize:function(){this.autoSizeGrid();this.cacheGridCells();var A=this.gridCells[0][0];this.snapCol={x:A.size["width"],y:A.size["height"]}},autoSizeGrid:function(){},increaseAllDayContainer:function(){var B=this.allDayContainer.getHeight();var A=this.gridContainer.getHeight();this.allDayContainer.setHeight(B+20);this.gridContainer.setHeight(A-20);this.allDayEventRows++},resetAllDayContainer:function(){if(this.allDayEventRows>0){var B=this.allDayContainer.getHeight();var A=this.gridContainer.getHeight();this.allDayContainer.setHeight(0);this.gridContainer.setHeight(A+B);this.allDayEventRows=0;this.allDayAppointments=Array()}},onResize:function(D,B,A,C){if(this.daysRendered==this.days){if(this.loaded){this.load()}}},setStore:function(A,B){if(!B&&this.store){this.store.un("beforeload",this.mask,this);this.store.un("datachanged",this.reload)}if(A){A.on("beforeload",this.mask,this);A.on("datachanged",this.reload,this)}this.store=A;if(A){}},setStoreBaseParams:function(){this.store.baseParams.start_time=this.startDate.format(this.dateTimeFormat);this.store.baseParams.end_time=this.endDate.format(this.dateTimeFormat)},getFirstDateOfWeek:function(A){var B=A.getDay();var C=this.firstWeekday-B;if(C>0){C-=7}return A.add(Date.DAY,C)},mask:function(){if(this.rendered){this.body.mask(GO.lang.waitMsgLoad,"x-mask-loading")}},unmask:function(){if(this.rendered){this.body.unmask()}},getSnap:function(){return this.snapCol},getGridXY:function(){var A=Ext.get("day0_row0");return A.getXY()},getRowIdByXY:function(B,E){var A=this.getSnap();var C=(B-this.gridX)/A.x;var D=(E-this.gridY)/A.y;return"day"+C+"_row"+D},getRowNumberByY:function(C){var A=this.getSnap();var B=this.gridTable.getXY();return Math.floor((C-B[1])/A.y)},getDayByX:function(B){var A=this.getSnap();var C=this.gridTable.getXY();return Math.floor((B-C[0]-40)/A.x)},startSelection:function(D){if(this.writePermission&&!this.dragEvent){var C=D.getXY();this.clickedDay=this.getDayByX(C[0]);this.clickedRow=this.getRowNumberByY(C[1]);this.dragSnap=this.getSnap();this.selectorStartRow=Ext.get("day"+this.clickedDay+"_row"+this.clickedRow);if(this.selectorStartRow){var A=this.selectorStartRow.getXY();var B=this.selectorStartRow.getSize();this.selector.setVisible(true,false);this.selector.setXY(A);this.selector.setSize(B.width-3,B.height);if(!this.overlay){this.overlay=this.body.createProxy({tag:"div",cls:"x-resizable-overlay",html:"&#160;"});this.overlay.unselectable();this.overlay.enableDisplayMode("block");this.overlay.on("mousemove",this.onSelectionMouseMove,this);this.overlay.on("mouseup",this.onSelectionMouseUp,this)}this.overlay.setSize(Ext.lib.Dom.getViewWidth(true),Ext.lib.Dom.getViewHeight(true));this.overlay.show()}}},onSelectionMouseMove:function(C){var D=C.getXY();var B=this.selector.getXY();var A=this.snap(D[1]-B[1],this.dragSnap.y,0);this.selector.setHeight(A)},onSelectionMouseUp:function(A){this.overlay.hide();this.fireEvent("create",this,this.domToTimes(this.selector.id));this.clearSelection()},addDaysGridEvent:function(M,C){var G=Date.parseDate(M.startDate.format("Ymd"),"Ymd");var A=Date.parseDate(M.endDate.format("Ymd"),"Ymd");var E=this.startDate.format("U");var H=G.format("U");var I=Math.round((H-E)/86400);if(I<0){I=0}var K=A.format("U");var B=Math.round((K-E)/86400);if(B>this.days){B=this.days-1}if(I<this.days&&B>-1){var L=M.startDate.getHours()*2;var F=M.endDate.getHours()*2-1;var D=M.startDate.getMinutes();if(D>30){L+=2}else{if(D>0){L++}}var J=M.endDate.getMinutes();if(J>30){F+=2}else{if(J>0){F++}}if(F<L){F=L}if(L&&F&&(I==B)){return this.addGridEvent(M,I,L,F,C)}else{return this.addAllDayEvent(M,I,B)}}},getSelectedEvent:function(){if(this.selected){return this.elementToEvent(this.selected[0].id)}},isSelected:function(A){for(var B=0;B<this.selected.length;B++){if(this.selected[B].id==A){return true}}return false},clearEventSelection:function(){for(var A=0;A<this.selected.length;A++){this.selected[A].removeClass("x-calGrid-selected")}this.selected=[]},selectEventElement:function(A){if(!this.isSelected(A)){this.clearEventSelection();var D=this.getRelatedDomElements(A.id);for(var C=0;C<D.length;C++){var B=Ext.get(D[C]);B.addClass("x-calGrid-selected");this.selected.push(B)}}},removeEvent:function(E){var D=this.getRelatedDomElements(E);if(D){for(var B=0;B<D.length;B++){var C=Ext.get(D[B]);C.removeAllListeners();C.remove();this.unregisterDomId(D[B])}}if(this.appointmentsMap[E]){var A=this.appointmentsMap[E].day;var B=this.appointmentsMap[E].i;this.appointments[A].splice(B,1);this.calculateAppointments(A)}else{if(this.allDayAppointmentsMap[E]){this.allDayAppointmentsMap.splice(B,1)}}},unregisterDomId:function(D){delete this.remoteEvents[D];var B=false;for(var C in this.domIds){for(var A=0;A<this.domIds[C].length;A++){if(this.domIds[C][A]==D){this.domIds[C].splice(A,1);B=true;break}}if(B){break}}},addAllDayEvent:function(L,H,C){L.allDay=true;L.daySpan=C-H+1;if(H<0){H=0}if(C>this.days-1){C=this.days-1}var E=this.getSnap();if(H!=C){var K=GO.settings.date_format+" "+GO.settings.time_format;text='<span class="x-calGrid-event-time">'+L.startDate.format(K)+"</span> "+L.name}else{text=L.name}var I=C-H;var G=0;for(var F=H;F<=C;F++){var D=Ext.id();this.registerEvent(D,L);if(I>0){if(!this.domIds[L.id]){this.domIds[L.id]=[]}this.domIds[L.id].push(D)}var B=Ext.DomHelper.append(this.allDayColumns[F],{tag:"div",id:D,cls:"x-calGrid-all-day-event-container",style:"background-color:#"+L.background,html:text,qtip:L.tooltip},true);if(typeof (this.allDayAppointments[F])=="undefined"){this.allDayAppointments[F]=Array()}this.allDayAppointments[F].push(B);this.allDayAppointmentsMap[D]=F;B.on("mousedown",function(O,N){N=Ext.get(N).findParent("div.x-calGrid-all-day-event-container",2,true);this.selectEventElement(N);this.clickedEventId=N.id;this.eventMouseUp=false;this.startAllDayEventDrag(O,N.id)},this);B.on("dblclick",function(Q,N){var O={};var P=this.elementToEvent(this.clickedEventId);if(this.remoteEvents[this.clickedEventId]["repeats"]&&this.writePermission){this.handleRecurringEvent("eventDblClick",P,O)}else{this.fireEvent("eventDblClick",this,P,O)}},this);B.on("mouseup",function(){this.eventMouseUp=true},this)}var J=this.container.getSize();var M=this.headingsTable.getHeight();var A=J.height-M;this.gridContainer.setSize(J.width,A);return D},addGridEvent:function(L,J,M,H,B){var O='<span class="x-calGrid-event-time">'+L.startDate.format(GO.settings.time_format)+"</span> "+L.name;if(L.location!=""){O+=" @ "+L.location}var E=Ext.id();this.registerEvent(E,L);var F=this.getSnap();if(H>47){H=47}var A=this.gridContainer.insertFirst({tag:"div",id:E,cls:"x-calGrid-event-container",style:"background-color:#"+L.background,qtip:L.tooltip,children:{tag:"div",cls:"x-calGrid-event-body",html:O}});A.repeats=L.repeats;var I=Ext.get("day"+J+"_row"+M);var C=Ext.get("day"+J+"_row"+H);var D=I.getXY();var G=C.getXY();var N=G[1]-D[1]+F.y;A.setXY(D);A.setSize(F.x-2,N);A.on("mousedown",function(Q,P){P=Ext.get(P).findParent("div.x-calGrid-event-container",4,true);this.selectEventElement(P);this.clickedEventId=P.id;this.eventMouseUp=false;this.startEventDrag(Q,P.id)},this);A.on("dblclick",function(S,P){var Q={};var R=this.elementToEvent(this.clickedEventId);if(this.remoteEvents[this.clickedEventId]["repeats"]&&this.writePermission){this.handleRecurringEvent("eventDblClick",R,Q)}else{this.fireEvent("eventDblClick",this,R,Q)}},this);A.on("mouseup",function(){this.eventMouseUp=true},this);if(typeof (this.appointments[J])=="undefined"){this.appointments[J]=Array()}this.appointments[J].push(A);this.appointmentsMap[E]={day:J,i:this.appointments[J].length-1};if(this.writePermission&&!L["private"]){var K=new Ext.Resizable(A,{handles:"s",minHeight:F.y,maxWidth:A.getWidth(),heightIncrement:F.y,draggable:false,pinned:true});K.on("resize",function(R,T,X,Y,U){if(X>0){var Q=this.domToTimes(R.el.id,false);var S=Q.startDate.format("U");var W=Q.endDate.format("U");var Z={duration:W-S,dragDate:this.remoteEvents[R.el.id].startDate};var P=this.elementToEvent(R.el.id);var V=R.el.getX();this.clickedDay=this.getDayByX(V);if(this.remoteEvents[R.el.id]["repeats"]){P.day=this.clickedDay;this.handleRecurringEvent("eventResize",P,Z)}else{this.resizeAppointment(R.el.id,this.clickedDay);this.fireEvent("eventResize",this,P,Z)}}},this)}if(B){this.calculateAppointments(J)}return E},resizeAppointment:function(C,A){var B=this.findAppointment(A,C);this.appointments[A][B].size=this.appointments[A][B].getSize();this.remoteEvents[C].repeats=false;this.calculateAppointments(A)},calculateAppointments:function(M){if(typeof (this.appointments[M])!="undefined"){var J=this.getSnap();var O=this.gridTable.getY();var H=0;var E=Array();var H=0;this.appointments[M].sort(function(T,S){return T.getY()-S.getY()});var G=0;this.rows=Array();for(var F=0;F<48;F++){var C=this.gridCells[M][F];var R=C.xy[1];if(F==0){G=C.xy[0]+1}if(typeof (this.rows[F])=="undefined"){this.rows[F]=Array()}for(var N=0;N<this.appointments[M].length;N++){if(!this.appointments[M][N].xy){this.appointments[M][N].xy=this.appointments[M][N].getXY();this.appointments[M][N].xy[1]-=O}if(!this.appointments[M][N].size){this.appointments[M][N].size=this.appointments[M][N].getSize()}var P=this.appointments[M][N].xy;var D=this.appointments[M][N].size;if((C.xy[0]+C.size.width)>=P[0]&&C.xy[0]<=P[0]+D.width&&R+C.size.height<=P[1]+D.height&&R+C.size.height>P[1]){if(typeof (E[this.appointments[M][N].id])=="undefined"){var Q=0;while(typeof (this.rows[F][Q])!="undefined"){Q++}eventRowId=F;for(var K=R;K<P[1]+D.height-3;K+=J.y){if(typeof (this.rows[eventRowId])=="undefined"){this.rows[eventRowId]=Array()}this.rows[eventRowId][Q]=this.appointments[M][N].id;eventRowId++}this.rows[F][Q]=this.appointments[M][N].id;E[this.appointments[M][N].id]=Q}}}if(Q>H){H=Q}}var B=J.x/(H+1);for(var N=0;N<this.appointments[M].length;N++){if(!this.appointments[M][N].xy){this.appointments[M][N].xy=this.appointments[M][N].getXY();this.appointments[M][N].xy[1]-=O}if(!this.appointments[M][N].size){this.appointments[M][N].size=this.appointments[M][N].getSize()}var P=this.appointments[M][N].xy;var D=this.appointments[M][N].size;var F=Math.floor(P[1]/J.y);var L=(D.height-2)/J.y;var I=this.getEventWidth(E[this.appointments[M][N].id],H,F,L,B);this.appointments[M][N].setWidth(I);var A=E[this.appointments[M][N].id]*B;this.appointments[M][N].setX(G+A)}}},getEventWidth:function(E,B,A,G,D){var H=D;var C=E+1;while(C<=B){for(var F=0;F<G;F++){if(typeof (this.rows[A+F][C])!="undefined"){return H-3}}H+=D;C++}return H-3},inAppointmentsArray:function(C,B){for(var A=0;A<B.length;A++){if(B[A].id==C){return true}}return false},clearSelection:function(){this.selector.setVisible(false)},handleRecurringEvent:function(A,C,B){this.currentRecurringEvent=C;this.currentFireEvent=A;this.currentActionData=B;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,closable:false,title:GO.calendar.lang.recurringEvent,modal:false,html:GO.calendar.lang.editRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){this.currentActionData.singleInstance=true;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);if(!this.currentRecurringEvent.allDay){if(this.currentFireEvent=="eventResize"){this.resizeAppointment(this.currentRecurringEvent.domId,this.currentRecurringEvent.day)}else{if(this.currentFireEvent=="move"){this.moveAppointment(this.currentRecurringEvent.domId,this.currentRecurringEvent.oldPos,this.currentRecurringEvent.newPos)}}}this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){this.currentActionData.singleInstance=false;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()},snapPos:function(D,E,B){var F=E-D;var C=Math.floor(F/B);var G=F-(C*B);var A=B/2;if(G>A){C++}return D+(C*B)},snap:function(C,E,B){if(!E||!C){return C}var D=C;var A=C%E;if(A>0){if(A>(E/2)){D=C+(E-A)}else{D=C-A}}return Math.max(B,D)},clearGrid:function(){this.appointments=Array();this.allDayAppointments=Array();this.remoteEvents=Array();this.domIds=Array()},next:function(A){if(!A){A=this.days}this.setDate(this.startDate.add(Date.DAY,A))},setDays:function(B,A){this.setDate(this.configuredDate,B,A)},setDate:function(A,E,D){var C=this.startDate;var B=this.endDate;if(E){this.days=E}this.configuredDate=A;if(this.days>4){this.startDate=this.getFirstDateOfWeek(A)}else{this.startDate=A}this.endDate=this.startDate.add(Date.DAY,this.days);this.setStoreBaseParams();if(D){this.store.reload()}},reload:function(){this.load()},load:function(){var C=this.store.getRange();this.writePermission=this.store.reader.jsonData.write_permission;this.clearGrid();this.renderDaysGrid();this.scrollToLastPosition();for(var D=0,B=C.length;D<B;D++){var A=Date.parseDate(C[D].data.start_time,this.dateTimeFormat);var F=Date.parseDate(C[D].data.end_time,this.dateTimeFormat);var E=C[D].data;E.startDate=A;E.endDate=F;this.addDaysGridEvent(E)}for(var D=0;D<this.days;D++){this.calculateAppointments(D)}this.unmask();this.loaded=true},registerEvent:function(B,A){this.remoteEvents[B]=A},setNewEventId:function(B,A){this.remoteEvents[B].event_id=A},getEventDomElements:function(A){return GO.util.clone(this.domIds[A])},getRelatedDomElements:function(C){var B=this.remoteEvents[C];if(!B){return false}var A=this.getEventDomElements(B.id);if(!A){A=[C]}return A},elementToEvent:function(A,B){var C=this.domToTimes(A,B);this.remoteEvents[A]["domId"]=A;this.remoteEvents[A]["startDate"]=C.startDate;this.remoteEvents[A]["endDate"]=C.endDate;return this.remoteEvents[A]},domToTimes:function(D,J){if(!J){J=false}var B=Ext.get(D);if(!B){return false}var F=B.getXY();if(!J){var K=B.getSize();var I=this.getRowNumberByY(F[1]);if(I<0){I=0}var E=this.getRowNumberByY(F[1]+K.height);if(E<=I){E=I+1}}else{I=0;E=0}var H=this.getDayByX(F[0]);var C=this.startDate.add(Date.DAY,H);var A=C.add(Date.MINUTE,I*30);var G=C.add(Date.MINUTE,E*30);return{startDate:A,endDate:G,day:H}},scrollToRow:function(B){var A=this.getSnap();if(!A){return false}this.gridContainer.scrollTo("top",A.y*B)},scrollToLastPosition:function(){if(this.gridContainer){if(this.scrollPosition&&this.scrollPosition.top>0){this.gridContainer.scrollTo("top",this.scrollPosition.top)}else{this.scrollToRow(14)}}},storeScrollPosition:function(B,A){var C=Ext.get(A).getScroll();if(C.top>0){this.scrollPosition=Ext.get(A).getScroll()}},onShow:function(){GO.grid.CalendarGrid.superclass.onShow.call(this);this.scrollToLastPosition()},startEventDrag:function(B,A){if(this.writePermission&&!this.eventMouseUp){this.dragClickEventPosition=B.getXY();this.originalEvent=this.elementToEvent(A);if(!this.originalEvent["private"]){this.dragEvent=Ext.get(A);this.dragEvent.size=this.dragEvent.getSize();this.dragappointmentstartPos=this.dragEvent.getXY();this.dragXoffset=this.dragClickEventPosition[0]-this.dragappointmentstartPos[0];this.dragYoffset=this.dragClickEventPosition[1]-this.dragappointmentstartPos[1];this.lastDragX=this.dragappointmentstartPos[0];this.lastDragY=this.dragappointmentstartPos[1];this.dragSnap=this.getSnap();this.columnsContainerY=this.gridTable.getY()}}},onEventDragMouseMove:function(G){if(this.dragEvent){var F=G.getXY();var A=this.snapPos(this.dragappointmentstartPos[0],F[0]-this.dragXoffset,this.dragSnap.x,this.days);var H=this.snapPos(this.dragappointmentstartPos[1],F[1]-this.dragYoffset,this.dragSnap.y,48);var E=this.columnsContainerY-4;var B=this.gridCells[0][0].xy[0]-4;var D=this.columnsContainerY+this.gridTableHeight-this.dragEvent.size.height+5;var C=this.gridCells[this.days-1][47].xy[0]+4;if(A!=this.lastDragX&&A<C&&A>B){this.lastDragX=A;this.dragEvent.setX(A)}if(H!=this.lastDragY&&H<D&&H>E){this.lastDragY=H;this.dragEvent.setY(H)}}},onEventDragMouseUp:function(F){if(this.dragEvent){var G=this.dragEvent.getXY();if(G[0]!=this.dragappointmentstartPos[0]||G[1]!=this.dragappointmentstartPos[1]){var A=this.domToTimes(this.dragEvent.id,false);var H=A.startDate.format("U");var D=this.remoteEvents[this.dragEvent.id].startDate.format("U");var I={offset:H-D,dragDate:this.remoteEvents[this.dragEvent.id].startDate};var B=this.elementToEvent(this.dragEvent.id);var E=Ext.get(this.dragEvent.id);var C=E.select("span.x-calGrid-event-time");if(C){C.update(B.startDate.format(GO.settings.time_format))}if(this.remoteEvents[this.dragEvent.id]["repeats"]){B.oldPos=this.dragappointmentstartPos;B.newPos=G;this.handleRecurringEvent("move",B,I)}else{this.moveAppointment(this.dragEvent.id,this.dragappointmentstartPos,G);this.fireEvent("move",this,B,I)}}this.dragEvent=false}},findAppointment:function(A,C){for(var B=0;B<this.appointments[A].length;B++){if(this.appointments[A][B].id==C){return B}}},moveAppointment:function(G,B,D){var E=this.getDayByX(B[0]);var F=this.getDayByX(D[0]);var A=this.gridTable.getY();var C=this.findAppointment(E,G);this.appointments[E][C].xy=D;this.appointments[E][C].xy[1]-=A;this.appointments[E][C].size=this.appointments[E][C].getSize();this.remoteEvents[G].repeats=false;if(E!=F){if(!this.appointments[F]){this.appointments[F]=[]}this.appointments[F].push(this.appointments[E][C]);this.appointments[E].splice(C,1);this.calculateAppointments(E);this.calculateAppointments(F)}else{this.calculateAppointments(F)}},startAllDayEventDrag:function(B,A){if(!this.eventMouseUp&&this.writePermission){this.dragClickEventPosition=B.getXY();this.originalEvent=this.elementToEvent(A,true);this.allDayDragDate=this.originalEvent.startDate;if(!this.originalEvent["private"]){this.allDayDragEvent=Ext.get(A);this.allDayDragEvent.size=this.allDayDragEvent.getSize();this.dragappointmentstartPos=this.allDayDragEvent.getXY();this.dragXoffset=this.dragClickEventPosition[0]-this.dragappointmentstartPos[0];this.dragSnap=this.getSnap()}}},onAllDayEventDragMouseMove:function(D){if(this.allDayDragEvent){var C=D.getXY();var A=this.snapPos(this.dragappointmentstartPos[0],C[0]-this.dragXoffset,this.dragSnap.x,this.days);var B=this.getDayByX(C[0]+1);if(this.allDayColumns[B]){this.allDayColumns[B].appendChild(this.allDayDragEvent)}}},onAllDayEventDragMouseUp:function(F){if(this.allDayDragEvent){var C=F.getXY();if(C[0]!=this.dragappointmentstartPos[0]){var A=this.getDayByX(this.dragappointmentstartPos[0]+1);var B=this.getDayByX(C[0]+1);if(A!=B&&this.allDayColumns[B]){var G=B-A;var E=this.elementToEvent(this.allDayDragEvent.id,true);var D={offsetDays:G,dragDate:this.allDayDragDate};if(this.remoteEvents[this.allDayDragEvent.id]["repeats"]){this.handleRecurringEvent("move",E,D)}else{this.fireEvent("move",this,E,D);this.removeEvent(this.allDayDragEvent.id);this.addAllDayEvent(E,B,B+E.daySpan-1)}}}this.allDayDragEvent=false}}});GO.grid.MonthGrid=Ext.extend(Ext.Panel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,dragEvent:false,appointments:Array(),remoteEvents:Array(),domIds:Array(),days:1,selected:Array(),writePermission:false,initComponent:function(){GO.grid.MonthGrid.superclass.initComponent.call(this);this.addEvents({create:true,move:true,eventResize:true,eventDblClick:true});if(this.store){this.setStore(this.store,true)}if(!this.startDate){var A=new Date();this.startDate=Date.parseDate(A.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate},onRender:function(B,A){GO.grid.MonthGrid.superclass.onRender.apply(this,arguments);this.setDate(this.startDate,false);this.body.setStyle("overflow","hidden");this.body.unselectable();this.setStore(this.store);this.initDD()},renderMonthView:function(){this.body.update("");var J=this.configuredDate.format("Ym");var D=new Date();var G=D.format("Ymd");var L=this.container.getSize(true);this.monthGridTable=Ext.DomHelper.append(this.body,{tag:"table",id:Ext.id(),cls:"x-monthGrid-table",style:"width:"+L.width+"px;height:"+L.height+"px;"},true);this.tbody=Ext.DomHelper.append(this.monthGridTable,{tag:"tbody"});var P=Ext.DomHelper.append(this.tbody,{tag:"tr"});var K=0;var H="";var B;var A=100/(this.days/7);this.gridCells={};for(var M=0;M<this.days;M++){var E=this.startDate.add(Date.DAY,M);if(M==0||E.format("j")==1){B="j F"}else{B="j"}var I=E.format("w");var N=E.format("Ym");var F=E.format("Ymd");if(F==G){H="x-monthGrid-cell-today"}else{if(N==J&&(I==0||I==6)){H="x-monthGrid-cell-weekend"}else{if(N==J){H="x-monthGrid-cell-current"}else{H=""}}}var C="d"+F;var O=Ext.DomHelper.append(P,{tag:"td",id:C,cls:H,style:"height:"+A+"%",children:[{tag:"div",cls:"x-monthGrid-cell-day-text",html:E.format(B)}]},true);this.gridCells[F]=(O);K++;if(K==7){K=0;var P=Ext.DomHelper.append(this.tbody,{tag:"tr"},true)}}},initDD:function(){var A=new GO.calendar.dd.MonthDragZone(this.body,{ddGroup:"month-grid",scroll:false,monthGrid:this});var B=new GO.calendar.dd.MonthDropTarget(this.body,{ddGroup:"month-grid",onNotifyDrop:function(C,H,G){var I=G.dragDate.format("U");var F=G.dropDate.format("U");offsetDays=Math.round((F-I)/86400);var E={offsetDays:offsetDays,dragDate:G.dragDate};var D=this.elementToEvent(G.item.id);if(D.repeats){this.handleRecurringEvent("move",D,E)}else{this.fireEvent("move",this,D,E);this.removeEvent(D.domId);D.repeats=false;D.startDate=D.startDate.add(Date.DAY,offsetDays);D.endDate=D.endDate.add(Date.DAY,offsetDays);D.start_time=D.startDate.format("U");D.end_time=D.endDate.format("U");this.addMonthGridEvent(D)}},scope:this})},onResize:function(D,B,A,C){if(this.monthGridTable){this.monthGridTable.setSize(D,B)}},setStore:function(A,B){if(!B&&this.store){this.store.un("beforeload",this.reload);this.store.un("datachanged",this.reload);this.store.un("clear",this.reload)}if(A){A.on("beforeload",this.mask,this);A.on("datachanged",this.reload,this);A.on("clear",this.reload,this)}this.store=A},setStoreBaseParams:function(){this.store.baseParams.start_time=this.startDate.format(this.dateTimeFormat);this.store.baseParams.end_time=this.endDate.format(this.dateTimeFormat)},getFirstDateOfWeek:function(A){var B=A.getDay();return A.add(Date.DAY,this.firstWeekday-B)},mask:function(){if(this.rendered){this.body.mask(GO.lang.waitMsgLoad,"x-mask-loading")}},unmask:function(){if(this.rendered){this.body.unmask()}},getSelectedEvent:function(){if(this.selected){return this.elementToEvent(this.selected[0].id)}},isSelected:function(A){for(var B=0;B<this.selected.length;B++){if(this.selected[B].id==A){return true}}return false},clearSelection:function(){for(var A=0;A<this.selected.length;A++){this.selected[A].removeClass("x-calGrid-selected")}this.selected=[]},selectEventElement:function(A){if(!this.isSelected(A)){this.clearSelection();var D=this.getRelatedDomElements(A.id);for(var C=0;C<D.length;C++){var B=Ext.get(D[C]);B.addClass("x-calGrid-selected");this.selected.push(B)}}},addMonthGridEvent:function(J){var F=Date.parseDate(J.startDate.format("Ymd"),"Ymd");var B=Date.parseDate(J.endDate.format("Ymd"),"Ymd");var G=F.format("U");var I=B.format("U");var H=Math.round((I-G)/86400)+1;for(var E=0;E<H;E++){var D=F.add(Date.DAY,E);J.domId=Ext.id();if(H>1){if(!this.domIds[J.id]){this.domIds[J.id]=[]}this.domIds[J.id].push(J.domId)}var C=Ext.get("d"+D.format("Ymd"));if(C){var K=J.startDate.format("H:i")+" "+J.name;var A=Ext.DomHelper.append(C,{tag:"div",id:J.domId,cls:"x-calGrid-month-event-container",style:"background-color:#"+J.background,html:K,qtip:J.tooltip},true);this.registerEvent(J.domId,J);A.on("mousedown",function(M,L){L=Ext.get(L).findParent("div.x-calGrid-month-event-container",2,true);this.selectEventElement(L);this.clickedEventId=L.id},this);A.on("dblclick",function(N,L){L=Ext.get(L).findParent("div.x-calGrid-month-event-container",2,true);var M=this.elementToEvent(this.clickedEventId);if(M.repeats&&this.writePermission){this.handleRecurringEvent("eventDblClick",M,{})}else{this.fireEvent("eventDblClick",this,M,{singleInstance:this.writePermission})}},this)}}return J.domId},removeEvent:function(D){var C=this.getRelatedDomElements(D);if(C){for(var A=0;A<C.length;A++){var B=Ext.get(C[A]);B.removeAllListeners();B.remove();this.unregisterDomId(C[A])}}},unregisterDomId:function(D){delete this.remoteEvents[D];var B=false;for(var C in this.domIds){for(var A=0;A<this.domIds[C].length;A++){if(this.domIds[C][A]==D){this.domIds[C].splice(A,1);B=true;break}}if(B){break}}},setNewEventId:function(B,A){this.remoteEvents[B].event_id=A},handleRecurringEvent:function(A,C,B){this.currentRecurringEvent=C;this.currentFireEvent=A;this.currentActionData=B;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,title:GO.calendar.lang.recurringEvent,modal:false,html:GO.calendar.lang.editRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){this.currentActionData.singleInstance=true;var D=this.currentRecurringEvent;this.fireEvent(this.currentFireEvent,this,D,this.currentActionData);if(this.currentActionData.offsetDays){this.removeEvent(D.domId);D.repeats=false;D.startDate=D.startDate.add(Date.DAY,offsetDays);D.endDate=D.endDate.add(Date.DAY,offsetDays);D.start_time=D.startDate.format("U");D.end_time=D.endDate.format("U");this.addMonthGridEvent(D)}this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){this.currentActionData.singleInstance=false;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()},clearGrid:function(){this.appointments=Array();this.remoteEvents=Array();this.domIds=Array()},setDate:function(C,H){var D=this.startDate;var F=this.endDate;this.configuredDate=C;var I=C.getFirstDateOfMonth();var G=C.getLastDateOfMonth();this.startDate=this.getFirstDateOfWeek(I);var B=this.startDate.format("U");var E=G.format("U");var A=((E-B)/86400)+1;var J=Math.ceil(A/7);this.days=J*7;this.endDate=this.startDate.add(Date.DAY,this.days);this.setStoreBaseParams();if(!F||!D||F.getElapsed(this.endDate)!=0||D.getElapsed(this.startDate)!=0){if(H){this.store.reload()}else{this.loadRequired=true}}},reload:function(){this.load()},load:function(){if(this.rendered){this.clearGrid();this.renderMonthView();this.writePermission=this.store.reader.jsonData.write_permission;var C=this.store.getRange();for(var D=0,B=C.length;D<B;D++){var A=Date.parseDate(C[D].data.start_time,this.dateTimeFormat);var F=Date.parseDate(C[D].data.end_time,this.dateTimeFormat);var E=C[D].data;E.startDate=A;E.endDate=F;this.addMonthGridEvent(E)}this.unmask();this.loadRequired=false}},registerEvent:function(B,A){this.remoteEvents[B]=A},getEventDomElements:function(A){return GO.util.clone(this.domIds[A])},getRelatedDomElements:function(C){var B=this.remoteEvents[C];if(!B){return false}var A=this.getEventDomElements(B.id);if(!A){A=[C]}return A},elementToEvent:function(A,B){this.remoteEvents[A]["domId"]=A;return this.remoteEvents[A]}});GO.calendar.dd.MonthDragZone=function(B,A){A=A||{};Ext.apply(A,{ddel:document.createElement("div")});GO.calendar.dd.MonthDragZone.superclass.constructor.call(this,B,A)};Ext.extend(GO.calendar.dd.MonthDragZone,Ext.dd.DragZone,{onInitDrag:function(B){if(!this.monthGrid.writePermission||this.monthGrid.remoteEvents[this.dragData.item.id]["private"]){return false}else{this.ddel.innerHTML=this.dragData.item.dom.innerHTML;this.ddel.className=this.dragData.item.dom.className;this.ddel.style.width=this.dragData.item.getWidth()+"px";this.proxy.update(this.ddel);this.eventDomElements=this.monthGrid.getRelatedDomElements(this.dragData.item.id);var C=Ext.get(this.dragData.item).findParent("td",10,true);this.eventProxies=[];this.proxyDragPos=0;for(var A=0;A<this.eventDomElements.length;A++){this.eventProxies.push(Ext.DomHelper.append(document.body,{tag:"div",id:Ext.id(),cls:"x-calGrid-month-event-proxy",style:"width:"+this.ddel.style.width+"px;"},true));if(this.eventDomElements[A]==this.dragData.item.id){this.proxyDragPos=A}else{Ext.get(this.eventDomElements[A]).setStyle({position:"absolute",top:-10000,display:"none"})}}}},removeEventProxies:function(){var A=Ext.query("div.x-calGrid-month-event-proxy");for(var B=0;B<A.length;B++){Ext.get(A[B]).remove()}delete this.lastTdOverId;for(var B=0;B<this.eventDomElements.length;B++){Ext.get(this.eventDomElements[B]).setStyle({position:"static",top:"",display:"block"})}},afterRepair:function(){GO.calendar.dd.MonthDragZone.superclass.afterRepair.call(this);this.removeEventProxies()},getRepairXY:function(B,A){A.item.highlight("#e8edff");return A.item.getXY()},getDragData:function(C){if(!this.monthGrid.writePermission){return false}else{var B=Ext.get(C.getTarget());var D=B.parent();var A=Date.parseDate(D.id.substr(1),"Ymd");if(B.hasClass("x-calGrid-month-event-container")&&!this.monthGrid.remoteEvents[B.id]["private"]){return{ddel:this.ddel,item:B,dragDate:A}}else{return false}}}});GO.calendar.dd.MonthDropTarget=function(B,A){GO.calendar.dd.MonthDropTarget.superclass.constructor.call(this,B,A)};Ext.extend(GO.calendar.dd.MonthDropTarget,Ext.dd.DropTarget,{notifyDrop:function(A,E,C){if(!this.scope.writePermission){return false}else{var D=Ext.get(E.getTarget()).findParent("td",10,true);C.dropDate=Date.parseDate(D.id.substr(1),"Ymd");A.removeEventProxies();this.el.removeClass(this.overClass);D.appendChild(C.item);if(this.onNotifyDrop){if(!this.scope){this.scope=this}var B=this.onNotifyDrop.createDelegate(this.scope);B.call(this,A,E,C)}return true}},notifyOver:function(B,H,G){var F=Ext.get(H.getTarget()).findParent("td",10,true);if(F){if(B.lastTdOverId!=F.id){var A=F;for(var C=0;C<B.proxyDragPos;C++){if(A){var D=A.prev("td");if(!D){var E=A.parent();E=E.prev("tr");if(E){var D=E.last();if(D){D=Ext.get(D)}}}A=D}if(D){B.eventProxies[C].insertAfter(D.first());B.eventProxies[C].setStyle({position:"static",top:"",display:"block"})}else{B.eventProxies[C].setStyle({position:"absolute",top:-10000,display:"none"})}}B.eventProxies[C].insertAfter(F.first());var A=F;for(var C=B.proxyDragPos+1;C<B.eventProxies.length;C++){if(A){var D=A.next("td");if(!D){var E=A.parent();E=E.next("tr");if(E){var D=E.first();if(D){D=Ext.get(D)}}}A=D}if(D){B.eventProxies[C].insertAfter(D.first());B.eventProxies[C].setStyle({position:"static",top:"",display:"block"})}else{B.eventProxies[C].setStyle({position:"absolute",top:-10000,display:"none"})}}}B.lastTdOverId=F.id}return this.dropAllowed}});GO.calendar.ListGrid=function(B){if(!B){B={}}B.store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({totalProperty:"count",root:"results",id:"id",fields:["id","event_id","name","time","start_time","end_time","tooltip","private","repeats","background","day"]}),baseParams:{task:"events"},proxy:new Ext.data.HttpProxy({url:GO.settings.modules.calendar.url+"json.php"}),groupField:"day",sortInfo:{field:"start_time",direction:"ASC"},remoteGroup:true});B.paging=false,B.autoExpandColumn="summary-calendar-name-heading";B.autoExpandMax=2500;B.enableColumnHide=false;B.enableColumnMove=false;B.autoScroll=true;B.columns=[{header:GO.lang.strDay,dataIndex:"day"},{header:GO.lang.strTime,dataIndex:"time",width:60,renderer:function(D,E,C){return'<div style="border:1px solid #c0c0c0;padding:2px;margin:2px;background-color:#'+C.data.background+';">'+D+"</div>"}},{id:"summary-calendar-name-heading",header:GO.lang.strName,dataIndex:"name",renderer:this.renderName}];B.view=new Ext.grid.GroupingView({hideGroupedColumn:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})',emptyText:GO.calendar.lang.noAppointmentsToDisplay,showGroupName:false});B.sm=new Ext.grid.RowSelectionModel({singleSelect:true});B.loadMask=true;GO.calendar.ListGrid.superclass.constructor.call(this,B);if(!this.startDate){var A=new Date();this.startDate=Date.parseDate(A.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate};Ext.extend(GO.calendar.ListGrid,Ext.grid.GridPanel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,days:7,renderName:function(B,C,A){return'<div style="font-weight:bold;">'+A.data.name+"</div>"+A.data.tooltip},afterRender:function(){GO.calendar.ListGrid.superclass.afterRender.call(this);this.on("rowdblclick",function(B,D,C){var A=B.getStore().getAt(D);GO.calendar.eventDialog.show({event_id:A.data.event_id})},this)},getFirstDateOfWeek:function(A){var B=A.getDay();return A.add(Date.DAY,this.firstWeekday-B)},setDays:function(B,A){this.setDate(this.configuredDate,7,A)},getSelectedEvent:function(){var C=this.getSelectionModel();var A=C.getSelected();var B=A.data;B.startDate=Date.parseDate(B.start_time,this.dateTimeFormat);B.endDate=Date.parseDate(B.end_time,this.dateTimeFormat);return B},removeEvent:function(){var B=this.getSelectionModel();var A=B.getSelected();this.store.remove(A)},setDate:function(A,E,D){var C=this.startDate;var B=this.endDate;this.configuredDate=A;if(this.days>4){this.startDate=this.getFirstDateOfWeek(A)}else{this.startDate=A}this.endDate=this.startDate.add(Date.DAY,this.days);this.setStoreBaseParams();if(D){if(!B||!C||B.getElapsed(this.endDate)!=0||C.getElapsed(this.startDate)!=0){this.store.reload()}}},setStoreBaseParams:function(){this.store.baseParams.start_time=this.startDate.format(this.dateTimeFormat);this.store.baseParams.end_time=this.endDate.format(this.dateTimeFormat)}});GO.grid.ViewGrid=Ext.extend(Ext.Panel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,dragEvent:false,appointments:Array(),remoteEvents:Array(),domIds:Array(),days:1,selected:Array(),view_id:0,gridCells:Array(),initComponent:function(){GO.grid.ViewGrid.superclass.initComponent.call(this);this.addEvents({create:true,move:true,eventResize:true,eventDblClick:true});if(!this.startDate){var A=new Date();this.startDate=Date.parseDate(A.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate},setViewId:function(A){this.view_id=A},onRender:function(B,A){GO.grid.ViewGrid.superclass.onRender.apply(this,arguments);this.setDate(this.startDate,false);this.body.setStyle("overflow","hidden");this.body.unselectable();this.initDD()},renderView:function(){this.body.update("");var H=this.container.getSize(true);var C=(H.width-150)/this.days;this.headingsTable=Ext.DomHelper.append(this.body,{tag:"table",id:Ext.id(),cls:"x-calGrid-headings-table",style:"width:"+H.width+"px;"},true);var F=Ext.DomHelper.append(this.headingsTable,{tag:"tbody"},true);this.headingsRow=Ext.DomHelper.append(F,{tag:"tr",children:{tag:"td",style:"width:147px",cls:"x-calGrid-heading"}},true);var E=GO.settings.date_format.indexOf("Y");var B="D "+GO.settings.date_format.substring(0,E-1);for(var I=0;I<this.days;I++){var D=this.startDate.add(Date.DAY,I);var M=Ext.DomHelper.append(this.headingsRow,{tag:"td",cls:"x-calGrid-heading",style:"width:"+(C)+"px",html:D.format(B)})}Ext.DomHelper.append(this.headingsRow,{tag:"td",style:"width:"+(this.scrollOffset-3)+"px;height:0px",cls:"x-calGrid-heading"});this.gridContainer=Ext.DomHelper.append(this.body,{tag:"div",cls:"x-calGrid-grid-container"},true);var L=this.headingsTable.getHeight();var A=H.height-L;this.gridContainer.setSize(H.width,A);this.gridTable=Ext.DomHelper.append(this.gridContainer,{tag:"table",id:Ext.id(),cls:"x-viewGrid-table",style:"width:"+H.width-this.scrollWidth+"px;"},true);this.tbody=Ext.DomHelper.append(this.gridTable,{tag:"tbody"},true);this.gridCells={};for(var G in this.jsonData){var J=Ext.DomHelper.append(this.tbody,{tag:"tr"});var K=Ext.DomHelper.append(J,{tag:"td",cls:"x-viewGrid-calendar-name-cell",html:this.jsonData[G].name,style:"width:150px"},true);this.gridCells[G]={};for(var I=0;I<this.days;I++){var D=this.startDate.add(Date.DAY,I);this.gridCells[G][D.format("Ymd")]=Ext.DomHelper.append(J,{tag:"td",id:"cal"+this.jsonData[G].id+"_day"+D.format("Ymd"),cls:"x-viewGrid-cell",style:"width:"+C+"px"},true)}}},removeEvent:function(D){var C=this.getRelatedDomElements(D);if(C){for(var A=0;A<C.length;A++){var B=Ext.get(C[A]);B.removeAllListeners();B.remove();this.unregisterDomId(C[A])}}},unregisterDomId:function(D){delete this.remoteEvents[D];var B=false;for(var C in this.domIds){for(var A=0;A<this.domIds[C].length;A++){if(this.domIds[C][A]==D){this.domIds[C].splice(A,1);B=true;break}}if(B){break}}},setNewEventId:function(B,A){this.remoteEvents[B].event_id=A},initDD:function(){var A=new GO.calendar.dd.ViewDragZone(this.body,{ddGroup:"view-grid",scroll:false,viewGrid:this});var B=new GO.calendar.dd.ViewDropTarget(this.body,{ddGroup:"view-grid",onNotifyDrop:function(C,H,G){var I=G.dragDate.format("U");var F=G.dropDate.format("U");offsetDays=Math.round((F-I)/86400);var E={offsetDays:offsetDays,dragDate:G.dragDate,calendar_id:G.calendar_id};var D=this.elementToEvent(G.item.id);if(D.repeats){this.handleRecurringEvent("move",D,E)}else{this.fireEvent("move",this,D,E);this.removeEvent(D.domId);D.repeats=false;D.calendar_id=G.calendar_id;D.startDate=D.startDate.add(Date.DAY,offsetDays);D.endDate=D.endDate.add(Date.DAY,offsetDays);D.start_time=D.startDate.format("U");D.end_time=D.endDate.format("U");this.addViewGridEvent(D)}},scope:this})},onResize:function(D,B,A,C){if(this.viewGridTable){this.viewGridTable.setSize(D,B)}},getFirstDateOfWeek:function(A){var B=A.getDay();return A.add(Date.DAY,this.firstWeekday-B)},mask:function(){if(this.rendered){this.body.mask(GO.lang.waitMsgLoad,"x-mask-loading")}},unmask:function(){if(this.rendered){this.body.unmask()}},getSelectedEvent:function(){if(this.selected){return this.elementToEvent(this.selected[0].id)}},isSelected:function(A){for(var B=0;B<this.selected.length;B++){if(this.selected[B].id==A){return true}}return false},clearSelection:function(){for(var A=0;A<this.selected.length;A++){this.selected[A].removeClass("x-calGrid-selected")}this.selected=[]},selectEventElement:function(A){if(!this.isSelected(A)){this.clearSelection();var D=this.getRelatedDomElements(A.id);for(var C=0;C<D.length;C++){var B=Ext.get(D[C]);B.addClass("x-calGrid-selected");this.selected.push(B)}}},addViewGridEvent:function(K){var G=Date.parseDate(K.startDate.format("Ymd"),"Ymd");var B=Date.parseDate(K.endDate.format("Ymd"),"Ymd");var H=G.format("U");var J=B.format("U");var I=Math.round((J-H)/86400)+1;for(var F=0;F<I;F++){var D=G.add(Date.DAY,F);var E=K.domId?K.domId:Ext.id();if(I>1){if(!this.domIds[K.id]){this.domIds[K.id]=[]}this.domIds[K.id].push(E)}var C=this.gridCells[K.calendar_id][D.format("Ymd")];if(C){var L=K.startDate.format(GO.settings.time_format)+" "+K.name;var A=Ext.DomHelper.append(C,{tag:"div",id:E,cls:"x-viewGrid-event-container",style:"background-color:#"+K.background,html:L,qtip:K.tooltip},true);this.registerEvent(E,K);A.on("mousedown",function(N,M){M=Ext.get(M).findParent("div.x-viewGrid-event-container",2,true);this.selectEventElement(M);this.clickedEventId=M.id},this);A.on("dblclick",function(O,M){M=Ext.get(M).findParent("div.x-viewGrid-event-container",2,true);var N=this.elementToEvent(this.clickedEventId);if(N.repeats&&N.write_permission){this.handleRecurringEvent("eventDblClick",N,{})}else{this.fireEvent("eventDblClick",this,N,{singleInstance:N.write_permission})}},this)}}return E},removeEventFromArray:function(A,C){for(var B=0;B<this.appointments[A].length;B++){if(this.appointments[A][B].id==C){return this.appointments[A].splice(B,1)}}return false},inAppointmentsArray:function(C,B){for(var A=0;A<B.length;A++){if(B[A].id==C){return true}}return false},handleRecurringEvent:function(A,C,B){this.currentRecurringEvent=C;this.currentFireEvent=A;this.currentActionData=B;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,title:GO.calendar.lang.recurringEvent,modal:false,html:GO.calendar.lang.deleteRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){this.currentActionData.singleInstance=true;var D=this.currentRecurringEvent;this.fireEvent(this.currentFireEvent,this,D,this.currentActionData);this.removeEvent(D.domId);D.calendar_id=this.currentActionData.calendar_id;D.repeats=false;D.startDate=D.startDate.add(Date.DAY,offsetDays);D.endDate=D.endDate.add(Date.DAY,offsetDays);D.start_time=D.startDate.format("U");D.end_time=D.endDate.format("U");this.addViewGridEvent(D);this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){this.currentActionData.singleInstance=false;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()},clearGrid:function(){this.appointments=Array();this.remoteEvents=Array();this.domIds=Array()},setDays:function(B,A){this.setDate(this.configuredDate,B,A)},setDate:function(A,E,D){var C=this.startDate;var B=this.endDate;if(E){this.days=E}this.configuredDate=A;if(this.days>4){this.startDate=this.getFirstDateOfWeek(A)}else{this.startDate=A}this.endDate=this.startDate.add(Date.DAY,this.days);if(D){if(!B||!C||B.getElapsed(this.endDate)!=0||C.getElapsed(this.startDate)!=0){this.reload()}}},reload:function(){this.load()},load:function(A){if(!A){A={}}A.task="view_events";A.view_id=this.view_id;A.start_time=this.startDate.format(this.dateTimeFormat);A.end_time=this.endDate.format(this.dateTimeFormat);this.mask();Ext.Ajax.request({url:GO.settings.modules.calendar.url+"json.php",params:A,callback:function(C,H,B){if(!H){Ext.MessageBox.alert(GO.lang.strError,B.result.feedback)}else{this.jsonData=Ext.decode(B.responseText);this.clearGrid();this.renderView();for(var G in this.jsonData){var E=this.jsonData[G].events;for(var D=0;D<E.length;D++){var F=E[D];F.startDate=Date.parseDate(E[D]["start_time"],this.dateTimeFormat);F.endDate=Date.parseDate(E[D]["end_time"],this.dateTimeFormat);this.addViewGridEvent(F)}}}this.unmask()},scope:this})},registerEvent:function(B,A){this.remoteEvents[B]=A},getEventDomElements:function(A){return GO.util.clone(this.domIds[A])},getRelatedDomElements:function(C){var B=this.remoteEvents[C];if(!B){return false}var A=this.getEventDomElements(B.id);if(!A){A=[C]}return A},elementToEvent:function(A,B){this.remoteEvents[A].domId=A;return this.remoteEvents[A]}});GO.calendar.dd.ViewDragZone=function(B,A){A=A||{};Ext.apply(A,{ddel:document.createElement("div")});GO.calendar.dd.ViewDragZone.superclass.constructor.call(this,B,A)};Ext.extend(GO.calendar.dd.ViewDragZone,Ext.dd.DragZone,{onInitDrag:function(B){this.ddel.innerHTML=this.dragData.item.dom.innerHTML;this.ddel.className=this.dragData.item.dom.className;this.ddel.style.width=this.dragData.item.getWidth()+"px";this.proxy.update(this.ddel);this.eventDomElements=this.viewGrid.getRelatedDomElements(this.dragData.item.id);var C=Ext.get(this.dragData.item).findParent("td",10,true);this.eventProxies=[];this.proxyDragPos=0;for(var A=0;A<this.eventDomElements.length;A++){this.eventProxies.push(Ext.DomHelper.append(document.body,{tag:"div",id:Ext.id(),cls:"x-viewGrid-event-proxy",style:"width:"+this.ddel.style.width+"px;"},true));if(this.eventDomElements[A]==this.dragData.item.id){this.proxyDragPos=A}else{Ext.get(this.eventDomElements[A]).setStyle({position:"absolute",top:-10000,display:"none"})}}},removeEventProxies:function(){var A=Ext.query("div.x-viewGrid-event-proxy");for(var B=0;B<A.length;B++){Ext.get(A[B]).remove()}delete this.lastTdOverId;for(var B=0;B<this.eventDomElements.length;B++){Ext.get(this.eventDomElements[B]).setStyle({position:"static",top:"",display:"block"})}},afterRepair:function(){GO.calendar.dd.ViewDragZone.superclass.afterRepair.call(this);this.removeEventProxies()},getRepairXY:function(B,A){A.item.highlight("#e8edff");return A.item.getXY()},getDragData:function(F){var E=Ext.get(F.getTarget());if(E.hasClass("x-viewGrid-event-container")){var G=E.parent();var A=G.id.indexOf("_day")+4;var D=G.id.substr(3,A-7);if(!this.viewGrid.remoteEvents[E.id]["private"]&&this.viewGrid.jsonData[D].write_permission){var B=G.id.substr(A);var C=Date.parseDate(B,"Ymd");return{ddel:this.ddel,item:E,dragDate:C}}return false}}});GO.calendar.dd.ViewDropTarget=function(B,A){GO.calendar.dd.ViewDropTarget.superclass.constructor.call(this,B,A)};Ext.extend(GO.calendar.dd.ViewDropTarget,Ext.dd.DropTarget,{notifyDrop:function(B,G,F){var H=Ext.get(G.getTarget()).findParent("td",10,true);if(!H){return false}var A=H.id.indexOf("_day")+4;var D=H.id.substr(3,A-7);if(!this.scope.jsonData[D]||!this.scope.jsonData[D].write_permission){return false}var C=H.id.substr(A);F.dropDate=Date.parseDate(C,"Ymd");F.calendar_id=H.id.substr(3,A-7);B.removeEventProxies();this.el.removeClass(this.overClass);H.appendChild(F.item);if(this.onNotifyDrop){if(!this.scope){this.scope=this}var E=this.onNotifyDrop.createDelegate(this.scope);E.call(this,B,G,F)}return true},notifyOver:function(G,E,B){var F=Ext.get(E.getTarget()).findParent("td",10,true);if(F){var I=F.id.indexOf("_day");var D=F.id.substr(3,I-3);if(this.scope.jsonData[D].write_permission){if(G.lastTdOverId!=F.id){var H=F;for(var C=0;C<G.proxyDragPos;C++){if(H){var A=H.prev("td");H=A}if(A){A.insertFirst(G.eventProxies[C].id);G.eventProxies[C].setStyle({position:"static",top:"",display:"block"})}else{G.eventProxies[C].setStyle({position:"absolute",top:-10000,display:"none"})}}F.insertFirst(G.eventProxies[C].id);var H=F;for(var C=G.proxyDragPos+1;C<G.eventProxies.length;C++){if(H){var A=H.next("td");H=A}if(A){A.insertFirst(G.eventProxies[C].id);G.eventProxies[C].setStyle({position:"static",top:"",display:"block"})}else{G.eventProxies[C].setStyle({position:"absolute",top:-10000,display:"none"})}}}G.lastTdOverId=F.id;return this.dropAllowed}}return false}});GO.calendar.CalendarDialog=function(A){if(!A){A={}}this.propertiesTab=new Ext.Panel({title:GO.lang.strProperties,layout:"form",anchor:"100% 100%",defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,cls:"go-form-panel",waitMsgTarget:true,labelWidth:75,items:[this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.modules.email["write_permission"],value:GO.settings.user_id}),{fieldLabel:GO.lang.strName,name:"name",allowBlank:false}]});this.readPermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strReadPermissions});this.writePermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strWritePermissions});this.formPanel=new Ext.form.FormPanel({url:GO.settings.modules.calendar.url+"action.php",defaultType:"textfield",waitMsgTarget:true,border:false,items:[{hideLabel:true,deferredRender:false,xtype:"tabpanel",activeTab:0,border:false,anchor:"100% 100%",items:[this.propertiesTab,this.readPermissionsTab,this.writePermissionsTab]}]});GO.calendar.CalendarDialog.superclass.constructor.call(this,{title:GO.calendar.lang.calendar,layout:"fit",modal:false,height:500,width:400,items:this.formPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.calendar.CalendarDialog,Ext.Window,{initComponent:function(){this.addEvents({save:true});GO.calendar.CalendarDialog.superclass.initComponent.call(this)},show:function(A){if(!this.rendered){this.render(Ext.getBody())}if(A>0){if(A!=this.calendar_id){this.loadCalendar(A)}}else{this.calendar_id=0;this.formPanel.form.reset();this.propertiesTab.show();this.readPermissionsTab.setDisabled(true);this.writePermissionsTab.setDisabled(true);GO.calendar.CalendarDialog.superclass.show.call(this)}},loadCalendar:function(A){this.formPanel.form.load({url:GO.settings.modules.calendar.url+"json.php",params:{calendar_id:A,task:"calendar"},waitMsg:GO.lang.waitMsgLoad,success:function(B,C){this.calendar_id=A;this.selectUser.setRawValue(C.result.data.user_name);this.readPermissionsTab.setAcl(C.result.data.acl_read);this.writePermissionsTab.setAcl(C.result.data.acl_write);GO.calendar.CalendarDialog.superclass.show.call(this)},failure:function(B,C){Ext.Msg.alert(GO.lang.strError,C.result.feedback)},scope:this})},save:function(A){this.formPanel.form.submit({url:GO.settings.modules.calendar.url+"action.php",params:{task:"save_calendar",calendar_id:this.calendar_id},waitMsg:GO.lang.waitMsgSave,success:function(B,C){if(C.result.calendar_id){this.calendar_id=C.result.calendar_id;this.readPermissionsTab.setAcl(C.result.acl_read);this.writePermissionsTab.setAcl(C.result.acl_write)}this.fireEvent("save");if(A){this.hide()}},failure:function(C,D){var B="";if(D.failureType=="client"){B=GO.lang.strErrorsInForm}else{B=D.result.feedback}Ext.MessageBox.alert(GO.lang.strError,B)},scope:this})}});GO.calendar.ViewDialog=function(B){if(!B){B={}}var A=new GO.grid.CheckColumn({header:GO.lang.strSelected,dataIndex:"selected",width:55});this.calendarsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"view_calendars",view_id:this.view_id},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name","selected"],remoteSort:true});this.calendarsGrid=new GO.grid.GridPanel({region:"center",layout:"fit",paging:false,border:false,plugins:A,store:this.calendarsStore,columns:[A,{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name"}],view:new Ext.grid.GridView({autoFill:true,forceFit:true}),sm:new Ext.grid.RowSelectionModel(),loadMask:true});this.propertiesTab=new Ext.Panel({title:GO.lang.strProperties,layout:"border",items:[new Ext.Panel({layout:"form",region:"north",height:70,defaultType:"textfield",defaults:{anchor:"100%"},cls:"go-form-panel",waitMsgTarget:true,labelWidth:75,border:false,items:[this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.modules.email["write_permission"]}),{fieldLabel:GO.lang.strName,name:"name",allowBlank:false}]}),this.calendarsGrid]});this.readPermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strReadPermissions});this.writePermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strWritePermissions});this.formPanel=new Ext.form.FormPanel({url:GO.settings.modules.calendar.url+"action.php",defaultType:"textfield",waitMsgTarget:true,border:false,items:[{hideLabel:true,deferredRender:false,xtype:"tabpanel",activeTab:0,border:false,anchor:"100% 100%",items:[this.propertiesTab,this.readPermissionsTab,this.writePermissionsTab]}]});GO.calendar.ViewDialog.superclass.constructor.call(this,{title:GO.lang.strView,layout:"fit",modal:false,height:500,width:400,items:this.formPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.calendar.ViewDialog,Ext.Window,{initComponent:function(){this.addEvents({save:true});GO.calendar.ViewDialog.superclass.initComponent.call(this)},show:function(A){if(!this.rendered){this.render(Ext.getBody())}if(A>0){if(A!=this.view_id){this.loadView(A)}}else{this.view_id=0;this.formPanel.form.reset();this.propertiesTab.show();this.readPermissionsTab.setDisabled(true);this.writePermissionsTab.setDisabled(true);this.calendarsStore.baseParams.view_id=0;this.calendarsStore.reload();GO.calendar.ViewDialog.superclass.show.call(this)}},loadView:function(A){this.formPanel.form.load({url:GO.settings.modules.calendar.url+"json.php",params:{view_id:A,task:"view"},waitMsg:GO.lang.waitMsgLoad,success:function(B,C){this.view_id=A;this.selectUser.setRawValue(C.result.data.user_name);this.readPermissionsTab.setAcl(C.result.data.acl_read);this.writePermissionsTab.setAcl(C.result.data.acl_write);this.calendarsStore.baseParams.view_id=A;this.calendarsStore.reload();GO.calendar.ViewDialog.superclass.show.call(this)},failure:function(B,C){Ext.Msg.alert(GO.lang.strError,C.result.feedback)},scope:this})},save:function(B){var C=[];for(var A=0;A<this.calendarsStore.data.items.length;A++){if(this.calendarsStore.data.items[A].get("selected")=="1"){C.push(this.calendarsStore.data.items[A].get("id"))}}this.formPanel.form.submit({url:GO.settings.modules.calendar.url+"action.php",params:{task:"save_view",view_id:this.view_id,view_calendars:Ext.encode(C)},waitMsg:GO.lang.waitMsgSave,success:function(D,E){if(E.result.view_id){this.view_id=E.result.view_id;this.readPermissionsTab.setAcl(E.result.acl_read);this.writePermissionsTab.setAcl(E.result.acl_write)}this.fireEvent("save");if(B){this.hide()}},failure:function(E,F){var D="";if(F.failureType=="client"){D=GO.lang.strErrorsInForm}else{D=F.result.feedback}Ext.MessageBox.alert(GO.lang.strError,D)},scope:this})}});GO.calendar.MainPanel=function(A){if(!A){A={}}var B=new Ext.DatePicker();B.on("select",function(D,E){this.setDisplay({date:E})},this);this.calendarsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"calendars"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.viewsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"views"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.calendarList=new GO.calendar.CalendarList({store:this.calendarsStore});this.viewsList=new GO.calendar.ViewList({store:this.viewsStore});this.calendarList.on("click",function(D,E){this.viewsList.clearSelections();this.setDisplay({calendar_id:D.store.data.items[E].id,saveState:true})},this);this.viewsList.on("click",function(D,E){this.calendarList.clearSelections();this.setDisplay({view_id:D.store.data.items[E].id,saveState:true})},this);this.daysGridStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"events"},root:"results",id:"id",fields:["id","event_id","name","start_time","end_time","tooltip","repeats","private","location","background"]});this.monthGridStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"events"},root:"results",id:"id",fields:["id","event_id","name","start_time","end_time","tooltip","repeats","private","location","background"]});this.daysGrid=new GO.grid.CalendarGrid({id:"days-grid",store:this.daysGridStore,border:false,firstWeekday:parseInt(GO.settings.first_weekday)});this.monthGrid=new GO.grid.MonthGrid({id:"month-grid",store:this.monthGridStore,border:false,firstWeekday:parseInt(GO.settings.first_weekday)});this.viewGrid=new GO.grid.ViewGrid({id:"view-grid",border:false,firstWeekday:parseInt(GO.settings.first_weekday)});this.listGrid=new GO.calendar.ListGrid({id:"list-grid",border:false,firstWeekday:parseInt(GO.settings.first_weekday)});this.listStore=this.listGrid.store;var C=new Ext.Panel({region:"center",title:GO.calendar.lang.navigation,border:true,items:[this.calendarList,this.viewsList],autoScroll:true,split:true});this.displayPanel=new Ext.Panel({region:"center",titlebar:false,autoScroll:false,layout:"card",activeItem:0,border:true,split:true,cls:"cal-display-panel",tbar:[{iconCls:"btn-left-arrow",text:GO.lang.cmdPrevious,cls:"x-btn-text-icon",handler:function(){var D=this.getActivePanel().configuredDate;if(this.displayType=="month"){D=D.add(Date.MONTH,-1)}else{var E=this.days>4?7:1;D=D.add(Date.DAY,-E)}this.setDisplay({date:D})},scope:this},this.periodInfoPanel=new Ext.Panel({html:"",plain:true,border:true,cls:"cal-period"}),{iconCls:"btn-right-arrow",text:GO.lang.cmdNext,cls:"x-btn-text-icon",handler:function(){var D=this.getActivePanel().configuredDate;if(this.displayType=="month"){D=D.add(Date.MONTH,1)}else{var E=this.days>4?7:1;D=D.add(Date.DAY,E)}this.setDisplay({date:D})},scope:this}],keys:[{key:Ext.EventObject.DELETE,fn:this.deleteHandler,scope:this}],items:[this.daysGrid,this.monthGrid,this.viewGrid,this.listGrid]});A.keys=[{key:Ext.EventObject.DELETE,fn:this.deleteHandler,scope:this},{key:Ext.EventObject.ENTER,fn:function(){alert("hoi")}}];A.layout="border";A.border=false;A.items=[new Ext.Panel({region:"north",height:32,baseCls:"x-plain",tbar:new Ext.Toolbar({cls:"go-head-tb",items:[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){GO.calendar.eventDialog.show({calendar_id:this.calendar_id})},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:this.deleteHandler,scope:this},{iconCls:"btn-refresh",text:GO.lang.cmdRefresh,cls:"x-btn-text-icon",handler:this.refresh,scope:this},{iconCls:"btn-settings",text:GO.lang.cmdSettings,cls:"x-btn-text-icon",handler:function(){this.showAdminDialog()},scope:this},"-",this.dayButton=new Ext.Button({iconCls:"btn-one-day",text:GO.calendar.lang.oneDay,cls:"x-btn-text-icon",handler:function(){this.setDisplay({days:1,displayType:this.displayType=="view"?"view":"days",saveState:true})},scope:this}),this.workWeekButton=new Ext.Button({iconCls:"btn-five-days",text:GO.calendar.lang.fiveDays,cls:"x-btn-text-icon",handler:function(){this.setDisplay({days:5,displayType:this.displayType=="view"?"view":"days",saveState:true})},scope:this}),this.weekButton=new Ext.Button({iconCls:"btn-seven-days",text:GO.calendar.lang.sevenDays,cls:"x-btn-text-icon",handler:function(){this.setDisplay({days:7,displayType:this.displayType=="view"?"view":"days",saveState:true})},scope:this}),this.monthButton=new Ext.Button({iconCls:"btn-month",text:GO.calendar.lang.month,cls:"x-btn-text-icon",handler:function(){this.setDisplay({displayType:"month",saveState:true})},scope:this}),this.listButton=new Ext.Button({iconCls:"btn-list",text:GO.calendar.lang.list,cls:"x-btn-text-icon",handler:function(D,E){this.setDisplay({displayType:"list",saveState:true})},scope:this}),"-",this.printMessageButton=new Ext.Button({iconCls:"btn-print",text:GO.lang.cmdPrint,cls:"x-btn-text-icon",handler:function(){var D=window.open("about:blank");if(!D.opener){D.opener=self}D.document.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n<html>\n<head>\n<title>Group-Office</title><link href="'+GO.settings.config.theme_url+'images/favicon.ico" rel="shotcut icon" /><link href="'+BaseHref+'ext/resources/css/ext-all.css" type="text/css" rel="stylesheet" /><link href="'+GO.settings.config.theme_url+'style.css" type="text/css" rel="stylesheet" /><link href="'+GO.settings.modules.calendar.url+"themes/"+GO.settings.theme+'/style.css" type="text/css" rel="stylesheet" /><style>.x-calGrid-grid-container{overflow:visible !important}}</style></head><body>'+this.getActivePanel().body.dom.innerHTML+"</body></html>");D.document.close();D.focus()},scope:this})]})}),new Ext.Panel({region:"west",titlebar:false,autoScroll:false,closeOnTab:true,width:210,split:true,layout:"border",border:false,plain:true,items:[new Ext.Panel({region:"north",border:true,height:194,split:true,baseCls:"x-plain",items:B}),C]}),this.displayPanel];GO.calendar.MainPanel.superclass.constructor.call(this,A)};Ext.extend(GO.calendar.MainPanel,Ext.Panel,{displayType:"days",lastCalendarDisplayType:"days",state:{},calendarId:0,viewId:0,onShow:function(){GO.calendar.MainPanel.superclass.onShow.call(this);this.daysGrid.scrollToLastPosition()},afterRender:function(){GO.calendar.MainPanel.superclass.afterRender.call(this);GO.calendar.eventDialog.on("save",function(C,A){if(this.displayType=="list"){this.setDisplay()}else{var B=this.getActivePanel();if(C.repeats||(B.remoteEvents[A]&&B.remoteEvents[A].repeats&&B.remoteEvents[A].event_id==C.event_id)){B.store.reload()}else{B.removeEvent(A);switch(this.displayType){case"month":GO.calendar.eventDialog.oldDomId=this.monthGrid.addMonthGridEvent(C);break;case"days":GO.calendar.eventDialog.oldDomId=this.daysGrid.addDaysGridEvent(C,true);break;case"view":GO.calendar.eventDialog.oldDomId=this.viewGrid.addViewGridEvent(C);break}}}},this);this.state=Ext.state.Manager.get("calendar-state");if(!this.state){this.state={displayType:"days",days:5,calendar_id:0,view_id:0}}else{this.state=Ext.decode(this.state)}this.state.displayType="days";this.state.calendar_id=GO.calendar.defaultCalendar.id;this.state.view_id=0;this.calendarsStore.load({callback:function(){if(this.state.displayType!="view"){if(this.state.calendar_id==0){this.state.calendar_id=this.calendarsStore.data.items[0].id}this.calendarList.select("calendar-"+this.state.calendar_id);this.setDisplay(this.state)}},scope:this});this.viewsStore.load({callback:function(){if(this.state.displayType=="view"){this.viewsList.select("view-"+this.state.view_id);this.setDisplay(this.state)}},scope:this});this.createDaysGrid()},deleteHandler:function(){switch(this.displayType){case"days":var A=this.daysGrid.getSelectedEvent();var B=function(D,C){if(C){this.daysGrid.store.reload()}else{this.daysGrid.removeEvent(D.domId)}};break;case"month":var A=this.monthGrid.getSelectedEvent();var B=function(D,C){if(C){this.monthGrid.store.reload()}else{this.monthGrid.removeEvent(D.domId)}};break;case"view":var A=this.viewGrid.getSelectedEvent();var B=function(D,C){if(C){this.viewGrid.reload()}else{this.viewGrid.removeEvent(D.domId)}};break;case"list":var A=this.listGrid.getSelectedEvent();var B=function(D,C){if(C){this.listGrid.store.reload()}else{this.listGrid.removeEvent()}};break}if(A){this.deleteEvent(A,B)}},getActivePanel:function(){switch(this.displayType){case"days":return this.daysGrid;break;case"month":return this.monthGrid;break;case"view":return this.viewGrid;break;case"list":return this.listGrid;break}},updatePeriodInfoPanel:function(){var B="";var A=this.getActivePanel().configuredDate;if(this.displayType=="month"){B=A.format("F, Y")}else{B=GO.lang.strWeek+" "+A.format("W")}this.periodInfoPanel.body.update(B)},deleteEvent:function(A,B){if(A.repeats){this.currentDeleteEvent=A;this.currentDeleteCallback=B;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,closable:false,title:GO.calendar.lang.recurringEvent,modal:true,html:GO.calendar.lang.deleteRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){var C={task:"delete_event",create_exception:true,exception_date:this.currentDeleteEvent.startDate.format(this.daysGrid.dateTimeFormat),event_id:this.currentDeleteEvent.event_id};this.sendDeleteRequest(C,this.currentDeleteCallback,this.currentDeleteEvent);this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){var C={task:"delete_event",event_id:this.currentDeleteEvent.event_id};this.sendDeleteRequest(C,this.currentDeleteCallback,this.currentDeleteEvent,true);this.recurrenceDialog.hide()},scope:this},{text:GO.lang.cmdCancel,handler:function(){this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()}else{Ext.MessageBox.confirm(GO.lang.strConfirm,GO.lang.strDeleteSelectedItem,function(C){if(C=="yes"){var D={task:"delete_event",event_id:A.event_id};this.sendDeleteRequest(D,B,A)}},this)}},sendDeleteRequest:function(C,D,B,A){Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:C,callback:function(F,H,E){if(!H){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var G=Ext.decode(E.responseText);if(!G.success){Ext.MessageBox.alert(GO.lang.strError,G.feedback)}else{D.call(this,B,A)}}},scope:this})},setDisplay:function(A){if(!A){A={}}if(A.displayType){this.displayType=A.displayType}else{if(A.calendar_id){this.displayType=this.lastCalendarDisplayType}else{if(A.view_id){this.displayType="view"}}}var B="view";if(this.displayType!="view"){this.lastCalendarDisplayType=this.displayType}switch(this.displayType){case"month":this.displayPanel.getLayout().setActiveItem(1);break;case"days":this.displayPanel.getLayout().setActiveItem(0);break;case"view":this.displayPanel.getLayout().setActiveItem(2);break;case"list":this.displayPanel.getLayout().setActiveItem(3);break}this.monthButton.setDisabled(this.displayType=="view");this.listButton.setDisabled(this.displayType=="view");if(A.calendar_id){this.calendar_id=A.calendar_id;this.daysGridStore.baseParams.calendars=Ext.encode([A.calendar_id]);this.monthGridStore.baseParams.calendars=Ext.encode([A.calendar_id]);this.listGrid.store.baseParams.calendars=Ext.encode([A.calendar_id])}if(A.view_id){this.view_id=A.view_id;this.viewGrid.setViewId(A.view_id)}if(A.date){if(!A.days){A.days=this.type=="days"?this.daysGrid.days:this.viewGrid.days}this.daysGrid.setDate(A.date,A.days,this.displayType=="days");this.monthGrid.setDate(A.date,this.displayType=="month");this.viewGrid.setDate(A.date,A.days,this.displayType=="view");this.listGrid.setDate(A.date,A.days,this.displayType=="list");this.days=A.days}else{if(A.days&&this.displayType!="month"){this.daysGrid.setDays(A.days,this.displayType=="days");this.viewGrid.setDays(A.days,this.displayType=="view");this.listGrid.setDays(A.days,this.displayType=="list");this.days=A.days}else{if(A.days){this.days=A.days}switch(this.displayType){case"month":this.monthGridStore.reload();break;case"days":this.daysGridStore.reload();break;case"view":this.viewGrid.load();break;case"list":this.listGrid.store.reload();break}}}this.dayButton.toggle(this.displayType=="days"&&this.days==1);this.workWeekButton.toggle(this.displayType=="days"&&this.days==5);this.weekButton.toggle(this.displayType=="days"&&this.days==7);this.monthButton.toggle(this.displayType=="month");this.listButton.toggle(this.displayType=="list");this.updatePeriodInfoPanel();if(A.saveState){this.saveState()}},saveState:function(){var A={displayType:this.displayType,calendar_id:this.calendar_id,view_id:this.view_id,days:this.days};Ext.state.Manager.set("calendar-state",Ext.encode(A))},refresh:function(){this.setDisplay()},createDaysGrid:function(){this.daysGrid.on("eventResize",function(A,C,B){var D={task:"update_grid_event",update_event_id:C.event_id,duration:B.duration};if(C.repeats&&B.singleInstance){D.createException="true";D.exceptionDate=B.dragDate.format(A.dateTimeFormat);D.repeats="true"}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:D,callback:function(F,H,E){var G=Ext.decode(E.responseText);if(!G.success){Ext.MessageBox.alert(GO.lang.strError,G.feedback)}else{if(C.repeats&&!B.singleInstance){A.store.reload()}}}})},this);this.daysGrid.on("create",function(B,A){var C={};C.start_date=A.startDate;C.start_hour=A.startDate.format("H");C.start_min=A.startDate.format("i");C.end_date=A.endDate;C.end_hour=A.endDate.format("H");C.end_min=A.endDate.format("i");GO.calendar.eventDialog.show({values:C,calendar_id:this.calendar_id,calendar_name:this.calendar_name})},this);this.daysGrid.on("eventDblClick",this.onDblClick,this);this.monthGrid.on("eventDblClick",this.onDblClick,this);this.viewGrid.on("eventDblClick",this.onDblClick,this);this.monthGrid.on("move",this.onEventMove,this);this.daysGrid.on("move",this.onEventMove,this);this.viewGrid.on("move",function(A,C,B){var D={task:"update_grid_event",update_event_id:C.event_id};if(B.offset){D.offset=B.offset}if(B.offsetDays){D.offsetDays=B.offsetDays}if(C.repeats&&B.singleInstance){D.createException="true";D.exceptionDate=B.dragDate.format(A.dateTimeFormat);D.repeats="true"}if(B.calendar_id){D.update_calendar_id=B.calendar_id}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:D,callback:function(F,H,E){var G=Ext.decode(E.responseText);if(!G.success){Ext.MessageBox.alert(GO.lang.strError,G.feedback)}else{if(C.repeats&&!B.singleInstance){A.store.reload()}else{if(G.new_event_id){A.setNewEventId(C.domId,G.new_event_id)}}}}})},this)},onDblClick:function(A,C,B){if(C.repeats&&B.singleInstance){var D={};D.start_date=C.startDate.format(GO.settings.date_format);D.start_hour=C.startDate.format("H");D.start_min=C.startDate.format("i");D.end_date=C.endDate.format(GO.settings.date_format);D.end_hour=C.endDate.format("H");D.end_min=C.endDate.format("i");GO.calendar.eventDialog.show({values:D,exceptionDate:C.startDate.format(this.daysGrid.dateTimeFormat),exception_event_id:C.event_id,oldDomId:C.domId})}else{GO.calendar.eventDialog.show({event_id:C.event_id,oldDomId:C.domId})}},onEventMove:function(A,C,B){var D={task:"update_grid_event",update_event_id:C.event_id};if(B.offset){D.offset=B.offset}if(B.offsetDays){D.offsetDays=B.offsetDays}if(C.repeats&&B.singleInstance){D.createException="true";D.exceptionDate=B.dragDate.format(A.dateTimeFormat);D.repeats="true"}if(B.calendar_id){D.update_calendar_id=B.calendar_id}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:D,callback:function(F,H,E){var G=Ext.decode(E.responseText);if(!G.success){Ext.MessageBox.alert(GO.lang.strError,G.feedback)}else{if(C.repeats&&!B.singleInstance){A.store.reload()}else{if(G.new_event_id){A.setNewEventId(C.domId,G.new_event_id)}}}}})},showAdminDialog:function(){if(!this.adminDialog){this.writableCalendarsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_calendars"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.writableCalendarsStore.load();this.writableViewsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_views"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.calendarDialog=new GO.calendar.CalendarDialog();this.calendarDialog.on("save",function(){this.writableCalendarsStore.reload();this.calendarsStore.reload()},this);this.calendarsGrid=new GO.grid.GridPanel({title:GO.calendar.lang.calendars,paging:true,border:false,store:this.writableCalendarsStore,deleteConfig:{callback:function(){this.calendarsStore.reload()},scope:this},columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name"}],view:new Ext.grid.GridView({autoFill:true}),sm:new Ext.grid.RowSelectionModel(),loadMask:true,tbar:[{id:"addCalendar",iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.calendarDialog.show()},scope:this},{id:"delete",iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.calendarsGrid.deleteSelected()},scope:this}]});this.calendarsGrid.on("rowdblclick",function(A,B,C){this.calendarDialog.show(A.selModel.selections.keys[0])},this);this.viewDialog=new GO.calendar.ViewDialog();this.viewDialog.on("save",function(){this.writableViewsStore.reload();this.viewsStore.reload()},this);this.viewsGrid=new GO.grid.GridPanel({title:GO.calendar.lang.views,paging:true,border:false,store:this.writableViewsStore,deleteConfig:{callback:function(){this.viewsStore.reload()},scope:this},columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name"}],view:new Ext.grid.GridView({autoFill:true}),sm:new Ext.grid.RowSelectionModel(),loadMask:true,tbar:[{id:"addView",iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.viewDialog.show()},scope:this},{id:"delete",iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.viewsGrid.deleteSelected()},scope:this}]});this.viewsGrid.on("rowdblclick",function(A,B,C){this.viewDialog.show(A.selModel.selections.keys[0])},this);this.viewsGrid.on("show",function(){this.writableViewsStore.load()},this,{single:true});this.adminDialog=new Ext.Window({title:GO.calendar.lang.administration,layout:"fit",modal:false,minWidth:300,minHeight:300,height:400,width:600,closeAction:"hide",items:new Ext.TabPanel({border:false,activeTab:0,items:[this.calendarsGrid,this.viewsGrid]}),buttons:[{text:GO.lang.cmdClose,handler:function(){this.adminDialog.hide()},scope:this}]})}this.adminDialog.show()}});GO.calendar.CalendarList=function(B){Ext.apply(B);var A=new Ext.XTemplate("<b>"+GO.calendar.lang.calendars+"</b>",'<tpl for=".">','<div id="calendar-{id}" class="calendar-wrap">{name}</div>',"</tpl>");GO.calendar.CalendarList.superclass.constructor.call(this,{store:B.store,tpl:A,singleSelect:true,autoHeight:true,overClass:"x-view-over",itemSelector:"div.calendar-wrap"})};Ext.extend(GO.calendar.CalendarList,Ext.DataView,{onRender:function(B,A){this.el=B.createChild({tag:"div",id:"calendarList",cls:"calendar-list"});GO.calendar.CalendarList.superclass.onRender.apply(this,arguments)}});GO.calendar.ViewList=function(B){Ext.apply(B);var A=new Ext.XTemplate("<b>"+GO.calendar.lang.views+"</b>",'<tpl for=".">','<div id="view-{id}" class="view-wrap">{name}</div>',"</tpl>");GO.calendar.ViewList.superclass.constructor.call(this,{store:B.store,tpl:A,singleSelect:true,autoHeight:true,overClass:"x-view-over",itemSelector:"div.view-wrap"})};Ext.extend(GO.calendar.ViewList,Ext.DataView,{onRender:function(B,A){this.el=B.createChild({tag:"div",id:"viewList",cls:"view-list"});GO.calendar.ViewList.superclass.onRender.apply(this,arguments)}});GO.moduleManager.addModule("calendar",GO.calendar.MainPanel,{title:GO.calendar.lang.calendar,iconCls:"go-tab-icon-calendar"});GO.mainLayout.onReady(function(){GO.calendar.eventDialog=new GO.calendar.EventDialog()});GO.linkHandlers[1]=function(A){GO.calendar.eventDialog.show({event_id:A})};GO.newMenuItems.push({text:GO.calendar.lang.appointment,iconCls:"go-link-icon-1",handler:function(A,B){GO.calendar.eventDialog.show({link_config:A.parentMenu.link_config})}});GO.calendar.SummaryGroupPanel=function(A){if(!A){A={}}A.store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({totalProperty:"count",root:"results",id:"event_id",fields:["id","event_id","name","time","start_time","end_time","tooltip","private","repeats","day"]}),baseParams:{task:"summary"},proxy:new Ext.data.HttpProxy({url:GO.settings.modules.calendar.url+"json.php"}),groupField:"day",sortInfo:{field:"start_time",direction:"ASC"}});A.paging=false,A.autoExpandColumn="summary-calendar-name-heading";A.autoExpandMax=2500;A.enableColumnHide=false;A.enableColumnMove=false;A.columns=[{header:GO.lang.strDay,dataIndex:"day"},{header:GO.lang.strTime,dataIndex:"time",width:50},{id:"summary-calendar-name-heading",header:GO.lang.strName,dataIndex:"name",renderer:this.renderName}];A.view=new Ext.grid.GroupingView({hideGroupedColumn:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})',emptyText:GO.calendar.lang.noAppointmentsToDisplay,showGroupName:false});A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;A.autoHeight=true;GO.calendar.SummaryGroupPanel.superclass.constructor.call(this,A)};Ext.extend(GO.calendar.SummaryGroupPanel,Ext.grid.GridPanel,{renderName:function(B,C,A){return'<div style="font-weight:bold">'+A.data.name+"</div>"+A.data.tooltip},afterRender:function(){GO.calendar.SummaryGroupPanel.superclass.afterRender.call(this);GO.calendar.eventDialog.on("save",function(){this.store.reload()},this);this.on("rowdblclick",function(A,B,D){var C=A.selModel.selections.keys[0];GO.calendar.eventDialog.show({event_id:C})},this);this.store.load()}});GO.mainLayout.onReady(function(){if(GO.summary){var A=new GO.calendar.SummaryGroupPanel({id:"summary-calendar-grid"});GO.summary.portlets["portlet-calendar"]=new GO.summary.Portlet({id:"portlet-calendar",title:GO.calendar.lang.appointments,layout:"fit",tools:[{id:"close",handler:function(D,C,B){B.removePortlet()}}],items:A,autoHeight:true})}});