GO.cms.SitesDialog=function(a){if(!a){a={}}this.sitesGrid=new GO.cms.SitesGrid();a.layout="fit";a.modal=false;a.resizable=false;a.width=500;a.height=400;a.closeAction="hide";a.title=GO.cms.lang.sites;a.items=this.sitesGrid;a.buttons=[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.cms.SitesDialog.superclass.constructor.call(this,a)};Ext.extend(GO.cms.SitesDialog,Ext.Window,{show:function(){if(!this.sitesGrid.store.loaded){this.sitesGrid.store.load()}GO.cms.SitesDialog.superclass.show.call(this)}});GO.cms.SitesGrid=function(a){if(!a){a={}}a.border=false;a.layout="fit";a.autoScroll=true;a.split=true;a.store=new GO.data.JsonStore({url:GO.settings.modules.cms.url+"json.php",baseParams:{task:"sites"},root:"results",id:"id",totalProperty:"total",fields:["id","user_name","acl_write","allow_properties","domain","webmaster","publish_style","publish_path","template_id","root_folder_id","start_file_id","language","name"],remoteSort:true});a.paging=true;var b=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:GO.lang.strName,dataIndex:"name"}]});a.cm=b;a.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;this.siteDialog=new GO.cms.SiteDialog();this.siteDialog.on("save",function(){this.store.reload()},this);a.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.siteDialog.show()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected()},scope:this}];GO.cms.SitesGrid.superclass.constructor.call(this,a);this.on("rowdblclick",function(d,e){var c=d.getStore().getAt(e);this.siteDialog.show(c.data.id)},this)};Ext.extend(GO.cms.SitesGrid,GO.grid.GridPanel,{loaded:false,afterRender:function(){GO.cms.SitesGrid.superclass.afterRender.call(this);if(this.isVisible()){this.onGridShow()}},onGridShow:function(){if(!this.loaded&&this.rendered){this.store.load();this.loaded=true}}});GO.cms.SiteDialog=function(b){if(!b){b={}}this.buildForm();var a=function(){this.propertiesPanel.items.items[0].focus()};b.maximizable=true;b.layout="fit";b.modal=false;b.resizable=false;b.width=500;b.height=400;b.closeAction="hide";b.title=GO.cms.lang.site;b.items=this.formPanel;b.focus=a.createDelegate(this);b.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.cms.SiteDialog.superclass.constructor.call(this,b);this.addEvents({save:true})};Ext.extend(GO.cms.SiteDialog,Ext.Window,{show:function(a){if(!this.rendered){this.render(Ext.getBody())}this.tabPanel.setActiveTab(0);if(!a){a=0}this.setSiteId(a);if(this.site_id>0){this.formPanel.load({url:GO.settings.modules.cms.url+"json.php",success:function(b,c){this.writePermissionsTab.setAcl(c.result.data.acl_write);this.writePermissionsTab.aclUsersStore.load();this.writePermissionsTab.aclGroupsStore.load();GO.cms.SiteDialog.superclass.show.call(this)},failure:function(b,c){Ext.Msg.alert(GO.lang.strError,c.result.feedback)},scope:this})}else{this.formPanel.form.reset();this.writePermissionsTab.setAcl(0);GO.cms.SiteDialog.superclass.show.call(this)}},setSiteId:function(a){this.formPanel.form.baseParams.site_id=a;this.site_id=a;GO.cms.foldersDialog.site_id=a},submitForm:function(a){this.formPanel.form.submit({url:GO.settings.modules.cms.url+"action.php",params:{task:"save_site"},waitMsg:GO.lang.waitMsgSave,success:function(b,c){this.fireEvent("save",this);if(a){this.hide()}else{if(c.result.site_id){this.setSiteId(c.result.site_id);this.writePermissionsTab.setAcl(c.result.acl_write)}}},failure:function(b,c){if(c.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,c.result.feedback)}},scope:this})},buildForm:function(){this.propertiesPanel=new Ext.Panel({title:GO.lang.strProperties,cls:"go-form-panel",waitMsgTarget:true,layout:"form",autoScroll:true,items:[{xtype:"textfield",name:"name",anchor:"-20",allowBlank:false,fieldLabel:GO.lang.strName},{xtype:"textfield",name:"domain",anchor:"-20",allowBlank:false,fieldLabel:GO.cms.lang.domain},{xtype:"textfield",name:"webmaster",anchor:"-20",allowBlank:false,fieldLabel:GO.cms.lang.webmaster},new Ext.form.ComboBox({fieldLabel:GO.cms.lang.template,hiddenName:"template",store:new GO.data.JsonStore({fields:["name"],url:GO.settings.modules.cms.url+"json.php",root:"results",baseParams:{task:"templates"}}),valueField:"name",displayField:"name",mode:"remote",triggerAction:"all",editable:false,forceSelection:true,anchor:"-20",allowBlank:false}),new Ext.form.ComboBox({fieldLabel:GO.lang.strLanguage,name:"language",store:new Ext.data.SimpleStore({fields:["id","language"],data:GO.Languages}),displayField:"language",valueField:"id",hiddenName:"language",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,value:GO.settings.language}),{xtype:"plainfield",fieldLabel:GO.cms.lang.siteId,name:"id"}]});var a=[this.propertiesPanel];this.writePermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strWritePermissions});a.push(this.writePermissionsTab);GO.cms.writingUsersPanel=this.writingUsersPanel=new GO.cms.WritingUsersPanel({permissionsTab:this.writePermissionsTab});a.push(GO.cms.writingUsersPanel);this.tabPanel=new Ext.TabPanel({activeTab:0,deferredRender:false,border:false,items:a,anchor:"100% 100%"});this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,url:GO.settings.modules.cms.url+"action.php",border:false,baseParams:{task:"site"},items:this.tabPanel})}});GO.cms.FoldersGrid=function(a){if(!a){a={}}a.title=GO.cms.lang.folders;a.layout="fit";a.autoScroll=true;a.split=true;a.store=new GO.data.JsonStore({url:GO.settings.modules.cms.url+"json.php",baseParams:{task:"folders",site_id:0},root:"results",id:"id",totalProperty:"total",fields:["id","parent_id","ctime","mtime","name","disabled","priority","multipage","template_item_id","acl"],remoteSort:true});a.paging=true;var b=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:GO.cms.lang.parentId,dataIndex:"parent_id"},{header:GO.lang.strCtime,dataIndex:"ctime"},{header:GO.lang.strMtime,dataIndex:"mtime"},{header:GO.lang.strName,dataIndex:"name"},{header:GO.cms.lang.disabled,dataIndex:"disabled"},{header:GO.cms.lang.priority,dataIndex:"priority"},{header:GO.cms.lang.multipage,dataIndex:"multipage"},{header:GO.cms.lang.templateItemId,dataIndex:"template_item_id"},{header:GO.cms.lang.acl,dataIndex:"acl"}]});a.cm=b;a.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;this.folderDialog=new GO.cms.FolderDialog();this.folderDialog.on("save",function(){this.store.reload()},this);a.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.folderDialog.show();this.folderDialog.formPanel.form.setValues({site_id:this.store.baseParams.site_id})},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected()},scope:this}];GO.cms.FoldersGrid.superclass.constructor.call(this,a);this.on("rowdblclick",function(d,e){var c=d.getStore().getAt(e);this.folderDialog.show(c.data.id)},this)};Ext.extend(GO.cms.FoldersGrid,GO.grid.GridPanel,{});GO.cms.FolderDialog=function(b){if(!b){b={}}this.buildForm();var a=function(){this.propertiesPanel.items.items[0].focus()};b.maximizable=true;b.layout="fit";b.modal=false;b.resizable=false;b.width=400;b.height=500;b.closeAction="hide";b.title=GO.cms.lang.siteFolderAccess;b.items=this.formPanel;b.focus=a.createDelegate(this);b.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.cms.FolderDialog.superclass.constructor.call(this,b);this.addEvents({save:true})};Ext.extend(GO.cms.FolderDialog,Ext.Window,{nodeAttributes:[],show:function(a,c,b){if(!this.rendered){this.render(Ext.getBody())}this.tabPanel.setActiveTab(0);if(c){this.formPanel.baseParams.parent_id=c}else{delete this.formPanel.baseParams.parent_id}if(b){this.formPanel.baseParams.site_id=b}else{delete this.formPanel.baseParams.site_id}if(!a){a=0}this.setFolderId(a);if(this.folder_id==0){this.formPanel.form.reset();this.writePermissionsTab.setAcl(0)}this.formPanel.load({url:GO.settings.modules.cms.url+"json.php",success:function(d,e){this.formPanel.baseParams.parent_id=e.result.data.parent_id;this.writePermissionsTab.setAcl(e.result.data.acl);this.optionsPanel.loadConfig(e.result.data.config,e.result.data.option_values,e.result.data.type,e.result.data.default_template);GO.cms.FolderDialog.superclass.show.call(this)},failure:function(d,e){Ext.Msg.alert(GO.lang.strError,e.result.feedback)},scope:this})},setFolderId:function(a){this.formPanel.form.baseParams.folder_id=a;this.folder_id=a},submitForm:function(a){this.formPanel.form.submit({url:GO.settings.modules.cms.url+"action.php",params:{task:"save_folder"},waitMsg:GO.lang.waitMsgSave,success:function(b,c){if(c.result.folder_id){this.setFolderId(c.result.folder_id)}if(a){this.hide()}else{if(c.result.folder_id){this.writePermissionsTab.setAcl(c.result.acl)}}this.fireEvent("save",this.folder_id,this.formPanel.form.getValues(),this.formPanel.baseParams.parent_id)},failure:function(b,c){if(c.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,c.result.feedback)}},scope:this})},buildForm:function(){this.propertiesPanel=new Ext.Panel({title:GO.lang.strProperties,cls:"go-form-panel",waitMsgTarget:true,layout:"form",autoScroll:true,items:[{xtype:"textfield",name:"name",anchor:"-20",allowBlank:false,fieldLabel:GO.lang.strName},{xtype:"checkbox",name:"disabled",anchor:"-20",allowBlank:false,boxLabel:GO.cms.lang.disabled,hideLabel:true},{xtype:"checkbox",name:"authentication",anchor:"-20",allowBlank:false,boxLabel:GO.cms.lang.authentication,hideLabel:true},new Ext.form.FieldSet({title:GO.cms.lang.defaultTemplateOptions,autoHeight:true,items:[this.optionsPanel=new GO.cms.TemplateOptionsPanel({isFolder:true})]})]});var a=[this.propertiesPanel];this.writePermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strWritePermissions});a.push(this.writePermissionsTab);this.tabPanel=new Ext.TabPanel({activeTab:0,deferredRender:false,border:false,items:a,anchor:"100% 100%"});this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,url:GO.settings.modules.cms.url+"action.php",border:false,baseParams:{task:"folder"},items:this.tabPanel})}});GO.cms.CommentsGrid=function(a){if(!a){a={}}a.title=GO.cms.lang.comments;a.layout="fit";a.autoScroll=true;a.split=true;a.store=new GO.data.JsonStore({url:GO.settings.modules.cms.url+"json.php",baseParams:{task:"comments"},root:"results",id:"id",totalProperty:"total",fields:["id","file_id","user_name","name","comments","ctime"],remoteSort:true});a.paging=true;var b=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:GO.cms.lang.fileId,dataIndex:"file_id"},{header:GO.lang.strOwner,dataIndex:"user_name",sortable:false},{header:GO.lang.strName,dataIndex:"name"},{header:GO.cms.lang.comments,dataIndex:"comments"},{header:GO.lang.strCtime,dataIndex:"ctime"}]});a.cm=b;a.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;this.commentDialog=new GO.cms.CommentDialog();this.commentDialog.on("save",function(){this.store.reload()},this);a.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.commentDialog.show()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected()},scope:this}];GO.cms.CommentsGrid.superclass.constructor.call(this,a);this.on("rowdblclick",function(d,e){var c=d.getStore().getAt(e);this.commentDialog.show(c.data.id)},this)};Ext.extend(GO.cms.CommentsGrid,GO.grid.GridPanel,{});GO.cms.CommentDialog=function(b){if(!b){b={}}this.buildForm();var a=function(){this.propertiesPanel.items.items[0].focus()};b.maximizable=true;b.layout="fit";b.modal=false;b.resizable=false;b.width=700;b.height=500;b.closeAction="hide";b.title=GO.cms.lang.comment;b.items=this.formPanel;b.focus=a.createDelegate(this);b.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.cms.CommentDialog.superclass.constructor.call(this,b);this.addEvents({save:true})};Ext.extend(GO.cms.CommentDialog,Ext.Window,{show:function(a){if(!this.rendered){this.render(Ext.getBody())}this.tabPanel.setActiveTab(0);if(!a){a=0}this.setCommentId(a);if(this.comment_id>0){this.formPanel.load({url:GO.settings.modules.cms.url+"json.php",success:function(b,c){this.selectUser.setRemoteText(c.result.data.user_name);GO.cms.CommentDialog.superclass.show.call(this)},failure:function(b,c){Ext.Msg.alert(GO.lang.strError,c.result.feedback)},scope:this})}else{this.formPanel.form.reset();GO.cms.CommentDialog.superclass.show.call(this)}},setCommentId:function(a){this.formPanel.form.baseParams.comment_id=a;this.comment_id=a},submitForm:function(a){this.formPanel.form.submit({url:GO.settings.modules.cms.url+"action.php",params:{task:"save_comment"},waitMsg:GO.lang.waitMsgSave,success:function(b,c){this.fireEvent("save",this);if(a){this.hide()}else{if(c.result.comment_id){this.setCommentId(c.result.comment_id)}}},failure:function(b,c){if(c.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,c.result.feedback)}},scope:this})},buildForm:function(){this.propertiesPanel=new Ext.Panel({title:GO.lang.strProperties,cls:"go-form-panel",waitMsgTarget:true,layout:"form",autoScroll:true,items:[{xtype:"textfield",name:"file_id",anchor:"-20",allowBlank:false,fieldLabel:GO.cms.lang.fileId},this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.modules.cms["write_permission"],value:GO.settings.user_id,anchor:"-20"}),{xtype:"textfield",name:"name",anchor:"-20",allowBlank:false,fieldLabel:GO.lang.strName},{xtype:"textarea",name:"comments",anchor:"-20",allowBlank:true,fieldLabel:GO.cms.lang.comments}]});var a=[this.propertiesPanel];this.tabPanel=new Ext.TabPanel({activeTab:0,deferredRender:false,border:false,items:a,anchor:"100% 100%"});this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,url:GO.settings.modules.cms.url+"action.php",border:false,baseParams:{task:"comment"},items:this.tabPanel})}});GO.cms.TreePanel=function(a){if(!a){a={}}if(!a.rootNodeId){a.rootNodeId="root"}a.title=GO.cms.lang.categories;a.layout="fit";a.split=true;a.autoScroll=true;a.width=200;a.animate=true;a.loader=new Ext.tree.TreeLoader({dataUrl:GO.settings.modules.cms.url+"json.php",baseParams:{task:"tree"},preloadChildren:true});a.containerScroll=true;a.rootVisible=false;a.collapseFirst=false;a.containerScroll=true;a.enableDD=true;a.ddGroup="cmsDD";GO.cms.TreePanel.superclass.constructor.call(this,a);this.rootNode=new Ext.tree.AsyncTreeNode({text:GO.lang.root,id:a.rootNodeId,draggable:false,iconCls:"folder-default",expanded:false});this.setRootNode(this.rootNode);this.on("nodedrop",function(h){var l={};if(h.dropNode.attributes.file_id){l.task="move_file";l.file_id=h.dropNode.attributes.file_id;if(h.point=="append"){l.folder_id=h.target.attributes.folder_id}else{l.folder_id=h.target.parentNode.attributes.folder_id}h.dropNode.attributes.folder_id=h.target.attributes.folder_id;var g=this.getNodeById("folder_"+l.folder_id)}else{l.task="move_folder";l.folder_id=h.dropNode.attributes.folder_id;if(h.point=="append"){l.parent_id=h.target.attributes.folder_id}else{l.parent_id=h.target.parentNode.attributes.folder_id}var g=this.getNodeById("folder_"+l.parent_id)}h.dropNode.attributes.site_id=h.target.attributes.site_id;var c=[];for(var f=0;f<g.childNodes.length;f++){var d=g.childNodes[f];if(d.attributes.file_id){var j="file";var b=d.attributes.file_id}else{var j="folder";var b=d.attributes.folder_id}var k={fstype:j,id:b,sort_order:f};c.push(k)}l.sort_order=Ext.encode(c);Ext.Ajax.request({url:GO.settings.modules.cms.url+"action.php",params:l,callback:function(i,n,e){var m=Ext.decode(e.responseText);if(!n||!m.success){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strSaveError)}},scope:this})},this)};Ext.extend(GO.cms.TreePanel,Ext.tree.TreePanel,{resetRootNode:function(a){this.rootNode.id=a;this.rootNode.attributes.id=a;this.rootNode.reload()},getActivePath:function(){var a=this.getSelectionModel();if(a.selNodes[0]==null){return""}var b=a.selNodes[0];var c="/"+b.text;if(!b.parentNode||!b.parentNode.parentNode){return""}while(!b.parentNode.parentNode.isRoot){b=b.parentNode;c="/"+b.text+c}return c}});GO.cms.SelectFile=Ext.extend(function(a){this.treePanel=new GO.cms.TreePanel({region:"west",title:GO.lang.menu,autoScroll:true,width:250,split:true,rootNodeId:"site_"+GO.cms.site_id});var b={title:GO.cms.lang.selectPage,height:400,width:600,layout:"fit",border:false,closeAction:"hide",tbar:[{iconCls:"cms-folder-properties",text:GO.cms.lang.files,handler:function(){GO.cms.createFileBrowser(GO.cms.editorPanel.root_folder_id,"",function(){var c=GO.cms.fb.getSelectedGridRecords();GO.cms.popupWin.document.getElementById(GO.cms.popupField).value=GO.settings.modules.files.full_url+"download.php?id="+c[0].data.id;GO.cms.fileBrowserWindow.hide()},GO.cms.editorPanel.files_folder_id);this.hide()},scope:this}],items:this.treePanel,buttons:[{text:GO.lang.cmdOk,handler:function(){var c=this.treePanel.getSelectionModel();if(c.selNode==null){Ext.MessageBox.alert(GO.lang.strError,GO.lang.noItemSelected)}else{this.fireEvent("fileselected",c.selNode.attributes);this.hide()}},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]};Ext.apply(a,b);this.addEvents({fileselected:true});GO.cms.SelectFile.superclass.constructor.call(this,b)},Ext.Window,{show:function(){this.treePanel.resetRootNode("site_"+GO.cms.site_id);GO.cms.SelectFile.superclass.show.call(this)}});GO.cms.EditorPanel=Ext.extend(function(a){var e={};for(var c=0;c<GO.Languages.length;c++){e[GO.Languages[c][0]]=GO.Languages[c][1]}var f="+"+e[GO.settings.language]+"="+GO.settings.language;for(var d in e){if(d!=GO.settings.language){f+=","+e[d]+"="+d}}this.editor=new Ext.ux.TinyMCE({name:"content",tinymceSettings:{mode:"textareas",theme:"advanced",plugins:"spellchecker,safari,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",theme_advanced_buttons1:"bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,styleselect,formatselect",theme_advanced_buttons2:"cut,copy,paste,pastetext,pasteword,|,search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,cleanup,code,|,forecolor,backcolor",theme_advanced_buttons3:"tablecontrols,|,hr,removeformat,visualaid,|,sub,sup,|,charmap,spellchecker,media,advhr,|,ltr,rtl,|,fullscreen",file_browser_callback:"GO.cms.fileBrowser",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_resizing:false,convert_urls:false,relative_urls:false,spellchecker_languages:f,spellchecker_rpc_url:BaseHref+"javascript/tiny_mce/plugins/spellchecker/rpc.php"}});var b={disabled:true,waitMsgTarget:true,url:GO.settings.modules.cms.url+"json.php",baseParams:{task:"file"},region:"center",border:false,labelAlign:"top",items:{anchor:"100% 100%",layout:"border",border:false,items:[{region:"center",layout:"fit",border:false,items:this.editor},{region:"east",split:true,width:300,cls:"go-form-panel",waitMsgTarget:true,layout:"form",autoScroll:true,defaults:{anchor:"-20",listeners:{change:function(){this.dirty=true},scope:this}},defaultType:"textfield",items:[{fieldLabel:GO.lang.strName,name:"name",allowBlank:false},{xtype:"datefield",format:GO.settings.date_format,fieldLabel:GO.cms.lang.showUntil,name:"show_until",allowBlank:true,emptyText:GO.cms.lang.alwaysShow},{hideLabel:true,xtype:"checkbox",checked:true,name:"auto_meta",boxLabel:GO.cms.lang.autoMeta,listeners:{check:function(g,h){this.setAutoMeta(h)},scope:this}},{fieldLabel:GO.cms.lang.title,xtype:"textarea",name:"title",height:60},{fieldLabel:GO.lang.strDescription,xtype:"textarea",name:"description",height:80},{fieldLabel:GO.cms.lang.keywords,xtype:"textarea",name:"keywords",height:80},this.optionsPanel=new GO.cms.TemplateOptionsPanel()]}]}};this.optionsPanel.on("htmlTemplateSelected",function(g){tinyMCE.execCommand("mceInsertContent",false,g.get("html"))},this);Ext.apply(b,a);GO.cms.EditorPanel.superclass.constructor.call(this,b);this.addEvents({save:true,disabled:true,load:true})},Ext.FormPanel,{files_folder_id:0,root_folder_id:0,currentTemplate:"",dirty:false,file_id:0,loadFile:function(c,b){this.setDisabled(false);if(this.currentTemplate!=b){if(this.currentTemplate!=""){this.editor.reInit()}var a=tinyMCE.activeEditor.dom;this.currentTemplate=b;a.remove(a.select("link"));if(b!=""){a.add(a.select("head")[0],"link",{rel:"stylesheet",href:GO.settings.modules.cms.url+"templates/"+b+"/css/editor.css"})}}this.file_id=c;this.baseParams.file_id=c;if(c>0){this.baseParams.folder_id=0}this.dirty=false;this.load({success:function(d,e){this.root_folder_id=e.result.data.root_folder_id;this.files_folder_id=e.result.data.files_folder_id;if(e.result.data.folder_id){this.baseParams.folder_id=e.result.data.folder_id}this.setAutoMeta(e.result.data.auto_meta=="1");this.optionsPanel.loadConfig(e.result.data.config,e.result.data.option_values,e.result.data.type);this.fireEvent("load",this)},scope:this})},saveFile:function(){tinyMCE.triggerSave();GO.mainLayout.getModulePanel("cms").getEl().mask(GO.lang.waitMsgSave);this.form.submit({url:GO.settings.modules.cms.url+"action.php",params:{task:"save_file"},success:function(a,b){if(b.result.file_id){this.baseParams.file_id=b.result.file_id}if(b.result.title){this.form.findField("title").setValue(b.result.title)}if(b.result.keywords){this.form.findField("keywords").setValue(b.result.keywords)}if(b.result.description){this.form.findField("description").setValue(b.result.description)}if(b.result.files_folder_id){this.files_folder_id=b.result.files_folder_id}this.dirty=false;this.editor.ed.isNotDirty=1;this.fireEvent("save",this.baseParams.file_id,this.form.getValues(),this.baseParams.folder_id);GO.mainLayout.getModulePanel("cms").getEl().unmask()},failure:function(a,b){if(b.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,b.result.feedback)}GO.mainLayout.getModulePanel("cms").getEl().unmask()},scope:this})},newFile:function(a,b){this.form.reset();this.baseParams.folder_id=a;this.loadFile(0,b)},setDisabled:function(a){this.fireEvent("disabled",a);GO.cms.EditorPanel.superclass.setDisabled.call(this,a)},isDirty:function(){return this.dirty||this.editor.isDirty()},setAutoMeta:function(a){var b=this.form;b.findField("title").setDisabled(a);b.findField("description").setDisabled(a);b.findField("keywords").setDisabled(a)}});GO.cms.createFileBrowser=function(c,b,a,d){if(!GO.cms.fb){GO.cms.fb=new GO.files.FileBrowser({border:false,treeCollapsed:false});GO.cms.fileBrowserWindow=new Ext.Window({title:GO.lang.strSelectFiles,height:500,width:750,layout:"fit",border:false,collapsible:true,maximizable:true,closeAction:"hide",items:GO.cms.fb,buttons:[{text:GO.lang.cmdOk,handler:function(){GO.cms.fb.fileClickHandler()},scope:this},{text:GO.lang.cmdClose,handler:function(){GO.cms.fileBrowserWindow.hide()},scope:this}]})}GO.cms.fb.setFilesFilter(b);GO.cms.fb.setFileClickHandler(a,this);GO.cms.fileBrowserWindow.buttons[0].setVisible(a!=false);if(!d){d=c}GO.cms.fb.setRootID(c,d);GO.cms.fileBrowserWindow.show()};GO.cms.fileBrowser=function(c,a,b,d){GO.cms.popupWin=d;GO.cms.popupField=c;if(b=="image"){GO.cms.createFileBrowser(GO.cms.editorPanel.root_folder_id,"png,jpg,jpeg,gif,bmp",function(){var e=GO.cms.fb.getSelectedGridRecords();GO.cms.popupWin.document.getElementById(GO.cms.popupField).value=GO.settings.modules.files.full_url+"download.php?id="+e[0].data.id;GO.cms.fileBrowserWindow.hide()})}else{if(!GO.cms.selectFile){GO.cms.selectFile=new GO.cms.SelectFile();GO.cms.selectFile.on("fileselected",function(e){GO.cms.popupWin.document.getElementById(GO.cms.popupField).value="/{site_url}?site_id="+e.site_id+"&path="+e.path},this)}GO.cms.selectFile.show()}};GO.cms.TemplateOptionsPanel=Ext.extend(function(a){var b={layout:"form",border:false,bodyStyle:"padding:0px;",autoHeight:true};Ext.apply(b,a);GO.cms.TemplateOptionsPanel.superclass.constructor.call(this,b);this.addEvents({htmlTemplateSelected:true})},Ext.Panel,{templateConfig:false,options:[],loadConfig:function(b,a,e,d){var c,g;this.templateConfig=b;this.optionValues=a;if(this.items){this.items.each(function(i){var h=i.container.up("div.x-form-item");i.destroy();if(h){h.remove()}})}if(b.templates&&b.templates.length){var f={fieldLabel:GO.cms.lang.insertTemplate,store:new Ext.data.SimpleStore({fields:["name","html"],data:b.templates}),name:"default_template",displayField:"name",mode:"local",triggerAction:"all",editable:false,forceSelection:false,anchor:"-20"};if(!this.isFolder){f.listeners={select:function(j,h,i){this.fireEvent("htmlTemplateSelected",h);j.reset()},scope:this}}else{if(d){f.value=d}}this.add(new GO.form.ComboBoxReset(f))}if(b.types&&b.types.length){var f={fieldLabel:GO.lang.strType,store:new Ext.data.SimpleStore({fields:["name","options"],data:b.types}),name:"type",value:e,displayField:"name",mode:"local",triggerAction:"all",editable:false,forceSelection:false,anchor:"-20",listeners:{select:function(j,h,i){this.addOptions(h.get("name"))},scope:this}};this.add(new GO.form.ComboBoxReset(f));if(this.isFolder){this.add(new Ext.form.Checkbox({hideLabel:true,boxLabel:GO.cms.lang.applyRecursive,name:"recursive"}))}}this.addOptions(e)},removeOptions:function(){for(var b=0;b<this.options.length;b++){var a=this.options[b].container.up("div.x-form-item");this.options[b].destroy();if(a){a.remove()}}this.options=[]},addOptions:function(c){this.removeOptions();var a=[];for(var b=0;b<this.templateConfig.types.length;b++){if(this.templateConfig.types[b][0]==c){a=this.templateConfig.types[b][1];break}}var d;if(a.length){for(var b=0;b<a.length;b++){o=a[b];if(o.type=="select"){d=this.optionValues[o.name]?this.optionValues[o.name]:o.options[0][0];this.options.push(new GO.form.ComboBoxReset({fieldLabel:o.fieldLabel,hiddenName:o.name,store:new Ext.data.SimpleStore({fields:["value","text"],data:o.options}),value:d,valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,forceSelection:true,anchor:"-20"}))}else{if(o.type=="file"){d=this.optionValues[o.name]?this.optionValues[o.name]:"";this.options.push(new GO.files.SelectFile({fieldLabel:o.fieldLabel,root_folder_id:this.ownerCt.ownerCt.ownerCt.root_folder_id,name:o.name,value:d,anchor:"-20",filesFilter:o.files_filter}))}else{if(o.type=="checkbox"){d=this.optionValues[o.name]?this.optionValues[o.name]:"";this.options.push(new Ext.form.Checkbox({boxLabel:o.fieldLabel,hideLabel:true,name:o.name,checked:!GO.util.empty(d),anchor:"-20"}))}else{if(o.type=="textarea"){d=this.optionValues[o.name]?this.optionValues[o.name]:"";this.options.push(new Ext.form.TextArea({fieldLabel:o.fieldLabel,name:o.name,value:d,anchor:"-20"}))}else{d=this.optionValues[o.name]?this.optionValues[o.name]:"";this.options.push(new Ext.form.TextField({fieldLabel:o.fieldLabel,name:o.name,value:d,anchor:"-20"}))}}}}this.add(this.options[this.options.length-1])}}this.doLayout()}});GO.cms.MainPanel=function(a){if(!a){a={}}this.folderDialog=new GO.cms.FolderDialog();this.folderDialog.on("save",function(d,g,f){var c=this.treePanel.getNodeById("folder_"+d);if(c){c.setText(g.name)}else{var c=this.treePanel.getNodeById("folder_"+f);var e=new Ext.tree.AsyncTreeNode({text:g.name,id:"folder_"+d,iconCls:"filetype-folder",site_id:c.attributes.site_id,file_id:0,folder_id:d,template:c.attributes.template,expanded:true,children:[]});c.appendChild(e)}},this);this.treePanel=GO.cms.treePanel=new GO.cms.TreePanel({region:"west",title:GO.lang.menu,autoScroll:true,width:250,split:true,selModel:new Ext.tree.MultiSelectionModel()});this.treePanel.on("beforeclick",function(c){if(c.attributes.file==0){return false}},this);this.treePanel.on("click",function(c,d){if(!d.ctrlKey){if(!c.expanded){c.expand()}if(c.attributes.site_id){GO.cms.site_id=c.attributes.site_id}if(c.attributes.file_id>0){this.checkChanges.defer(100,this,[function(){this.getEl().mask(GO.lang.waitMsgLoad);this.editorPanel.loadFile(c.attributes.file_id,c.attributes.template)},this])}}},this);this.editorPanel=new GO.cms.EditorPanel();GO.cms.editorPanel=this.editorPanel;this.editorPanel.on("disabled",function(c){this.saveButton.setDisabled(c);this.viewButton.setDisabled(c);if(c){this.filesButton.setDisabled(true)}},this);this.editorPanel.on("save",function(g,h,d){var e=this.treePanel.getNodeById("file_"+g);if(e){e.setText(h.name)}else{var c=this.treePanel.getNodeById("folder_"+d);var f=new Ext.tree.AsyncTreeNode({text:h.name,id:"file_"+g,iconCls:"filetype-html",site_id:c.attributes.site_id,file_id:g,folder_id:c.attributes.folder_id,template:c.attributes.template,leaf:true});c.appendChild(f);this.treePanel.getSelectionModel().select(f)}},this);a.items=[this.treePanel,this.editorPanel];a.layout="border";var b=[{iconCls:"btn-add",text:GO.cms.lang.newPage,handler:function(){var c=this.treePanel.getSelectionModel();if(c.selNodes[0]==null){Ext.MessageBox.alert(GO.lang.strError,GO.cms.lang.selectFolderAdd)}else{this.checkChanges.defer(100,this,[function(){this.editorPanel.newFile(c.selNodes[0].attributes.folder_id,c.selNodes[0].attributes.template)},this])}},scope:this},{iconCls:"btn-add",text:GO.cms.lang.newFolder,handler:function(){var c=this.treePanel.getSelectionModel();if(c.selNodes[0]==null){Ext.MessageBox.alert(GO.lang.strError,GO.cms.lang.selectFolderAdd)}else{this.folderDialog.show(0,c.selNodes[0].attributes.folder_id,c.selNodes[0].attributes.site_id)}},scope:this},{iconCls:"cms-btn-copy",text:GO.lang.copy,handler:function(){var c=this.treePanel.getSelectionModel();if(c.selNodes[0]==null){Ext.MessageBox.alert(GO.lang.strError,GO.cms.lang.selectFolderAdd)}else{this.copyFolders=[];this.copyFiles=[];for(var d=0;d<c.selNodes.length;d++){if(c.selNodes[d].attributes.file_id>0){this.copyFiles.push(c.selNodes[d].attributes.file_id)}else{this.copyFolders.push(c.selNodes[d].attributes.folder_id)}}this.pasteButton.setDisabled(false)}},scope:this},this.pasteButton=new Ext.Button({disabled:true,iconCls:"cms-btn-paste",text:GO.lang.paste,handler:function(){var c=this.treePanel.getSelectionModel();if(c.selNodes[0]==null){Ext.MessageBox.alert(GO.lang.strError,GO.cms.lang.selectFolderAdd)}else{var e=c.selNodes[0].attributes.folder_id;var d={task:"copy",copy_folders:Ext.encode(this.copyFolders),copy_files:Ext.encode(this.copyFiles),destination_folder_id:c.selNodes[0].attributes.folder_id};Ext.Ajax.request({url:GO.settings.modules.cms.url+"action.php",params:d,callback:function(g,i,f){if(!i){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var h=Ext.decode(f.responseText);if(!h.success){Ext.MessageBox.alert(GO.lang.strError,h.feedback)}else{this.treePanel.rootNode.reload();this.copyFolders=[];this.copyFiles=[];this.pasteButton.setDisabled(true)}}},scope:this})}},scope:this}),{text:GO.lang.cmdDelete,iconCls:"btn-delete",handler:function(){var d=this.treePanel.getSelectionModel();var c=[];if(d.selNodes){for(var e=0;e<d.selNodes.length;e++){c.push(d.selNodes[e].id)}}GO.deleteItems({count:c.length,url:GO.settings.modules.cms.url+"action.php",params:{task:"delete",delete_items:Ext.encode(c)},callback:function(h){if(h.deleted_nodes){for(var f=0;f<h.deleted_nodes.length;f++){var g=this.treePanel.getNodeById(h.deleted_nodes[f]);if(g){if(g.attributes.file_id==this.editorPanel.baseParams.file_id){this.editorPanel.form.reset();this.editorPanel.setDisabled(true)}g.remove()}}}},scope:this})},scope:this},"-",this.saveButton=new Ext.Button({iconCls:"btn-save",text:GO.lang.cmdSave,handler:function(){this.editorPanel.saveFile()},scope:this,disabled:true}),this.viewButton=new Ext.Button({iconCls:"cms-btn-view",text:GO.cms.lang.view,handler:function(){window.open(GO.settings.modules.cms.url+"run.php?file_id="+this.editorPanel.baseParams.file_id+"&basehref="+encodeURIComponent(GO.settings.modules.cms.url))},scope:this,disabled:true}),"-",{iconCls:"cms-folder-properties",text:GO.cms.lang.folderProperties,handler:function(){var c=this.treePanel.getSelectionModel();if(c.selNodes[0]==null){Ext.MessageBox.alert(GO.lang.strError,GO.cms.lang.selectFolder)}else{this.folderDialog.show(c.selNodes[0].attributes.folder_id)}},scope:this}];if(GO.files){b.push(this.filesButton=new Ext.Button({iconCls:"cms-folder-properties",text:GO.cms.lang.files,disabled:true,handler:function(){GO.cms.createFileBrowser(GO.cms.editorPanel.root_folder_id,"",false,GO.cms.editorPanel.files_folder_id)},scope:this}));this.editorPanel.on("load",function(){this.filesButton.setDisabled(this.editorPanel.files_folder_id==0);this.getEl().unmask()},this);this.editorPanel.on("save",function(){this.filesButton.setDisabled(this.editorPanel.files_folder_id==0)},this)}if(GO.settings.modules.cms.write_permission){b.push("-");b.push({iconCls:"cms-btn-sites",text:GO.cms.lang.sites,handler:function(){if(!this.sitesDialog){this.sitesDialog=new GO.cms.SitesDialog();this.sitesDialog.sitesGrid.store.on("load",function(){this.sitesDialog.sitesGrid.store.on("load",function(){this.treePanel.rootNode.reload()},this)},this)}this.sitesDialog.show()},scope:this})}if(GO.webshop){b.push({iconCls:"ws-btn-webshop",text:GO.webshop.lang.webshops,handler:function(){if(!this.webshopsDialog){this.webshopsDialog=new Ext.Window({layout:"fit",width:500,height:400,closeAction:"hide",title:GO.webshop.lang.webshops,items:new GO.webshop.WebshopsGrid(),buttons:[{text:GO.lang.cmdClose,handler:function(){this.webshopsDialog.hide()},scope:this}]})}this.webshopsDialog.show()},scope:this})}if(GO.mailings){b.push({iconCls:"ml-btn-mailings",text:GO.addressbook.lang.sendMailing,cls:"x-btn-text-icon",handler:function(){if(!this.selectMailingGroupWindow){this.selectMailingGroupWindow=new GO.mailings.SelectMailingGroupWindow();this.selectMailingGroupWindow.on("select",function(d,c){GO.email.showComposer({loadUrl:GO.settings.modules.mailings.url+"json.php",loadParams:{task:"sendcmsfile",file_id:this.editorPanel.baseParams.file_id,mailing_group_id:c},mailing_group_id:c})},this)}this.selectMailingGroupWindow.show()},scope:this})}a.tbar=new Ext.Toolbar({cls:"go-head-tb",items:b});a.border=false;GO.cms.MainPanel.superclass.constructor.call(this,a)};Ext.extend(GO.cms.MainPanel,Ext.Panel,{copyFolders:[],copyFile:[],checkChanges:function(c,b){var a=this.editorPanel.isDirty();if(a&&confirm(GO.cms.lang.saveChanges)){this.editorPanel.saveFile();this.editorPanel.on("save",c,b,{single:true})}else{c.call(b)}}});GO.moduleManager.addModule("cms",GO.cms.MainPanel,{title:GO.cms.lang.cms,iconCls:"go-tab-icon-cms"});GO.cms.WritingUsersPanel=function(a){if(!a){a={}}a.title=GO.cms.lang.advancedPermissions;this.writingUsersStore=new Ext.data.SimpleStore({fields:["id","name"]});this.writingUsersGrid=new GO.grid.GridPanel({anchor:"100% 50%",store:this.writingUsersStore,border:false,columns:[{header:GO.lang.strName,dataIndex:"name",menuDisabled:true}],view:new Ext.grid.GridView({autoFill:true,forceFit:true}),loadMask:{msg:GO.lang.waitMsgLoad},sm:new Ext.grid.RowSelectionModel({}),layout:"fit"});GO.cms.foldersDialog=new GO.cms.FoldersDialog();a.items=[this.writingUsersGrid];a.layout="fit";GO.cms.WritingUsersPanel.superclass.constructor.call(this,a);this.on("show",function(e,d,f){this.setWritingUserIds()});this.writingUsersGrid.on("rowdblclick",function(b,d,c){GO.cms.foldersDialog.show(b.store.data.items[d].data.id,GO.cms.foldersDialog.site_id)})};Ext.extend(GO.cms.WritingUsersPanel,Ext.Panel,{contains:function(c,b){for(var a=0;a<c.length;a++){if(c[a]==b){return true}}return false},setWritingUserIds:function(){var c=this.permissionsTab.aclGroupsStore;var b=this.permissionsTab.aclUsersStore;this.writingUserIds=new Array();for(var a=0;a<b.data.items.length;a++){this.writingUserIds.push(b.data.items[a].data.id)}this.writingGroupIds=new Array();for(var a=0;a<c.data.items.length;a++){this.writingGroupIds.push(c.data.items[a].data.id)}if(GO.settings.modules.cms.write_permission){Ext.Ajax.request({url:GO.settings.modules.cms.url+"json.php",params:{task:"writing_users",group_ids:Ext.encode(this.writingGroupIds),user_ids:Ext.encode(this.writingUserIds)},success:function(d,e){var h=Ext.decode(d.responseText);if(!h.success){alert(h.feedback)}else{var g=new Array();for(var f in h.results){g[f]=[h.results[f].id,h.results[f].name]}GO.isAdmin=h.isAdmin;this.writingUsersStore.loadData(g)}},scope:this})}}});GO.cms.FoldersDialog=function(c){if(!c){c={}}Ext.apply(this,c);if(!c||!c.user_id){var a=0}if(!c||!c.site_id){var b=0}this.foldersTree=new Ext.tree.TreePanel({animate:true,border:false,autoScroll:true,rootVisible:false,height:200,loader:new Ext.tree.TreeLoader({dataUrl:GO.settings.modules.cms.url+"json.php",baseParams:{task:"tree-edit",user_id:a,site_id:b},preloadChildren:true,listeners:{beforeload:function(){this.body.mask(GO.lang.waitMsgLoad)},load:function(){this.body.unmask()},scope:this}})});this.rootNode=new Ext.tree.AsyncTreeNode({text:GO.cms.lang.root,draggable:false,id:"folder_root",folder_id:0,expanded:false,iconCls:"folder-default"});this.foldersTree.setRootNode(this.rootNode);this.foldersTree.on("checkchange",function(f,e){this.body.mask(GO.lang.waitMsgSave,"x-mask-loading");var d=e?"subscribe":"unsubscribe";Ext.Ajax.request({url:GO.settings.modules.cms.url+"action.php",params:{task:d,user_id:GO.cms.user_id,folder_id:f.attributes.folder_id},callback:function(h,i,g){if(!i){Ext.MessageBox.alert(GO.lang.strError,g.result.feedback)}this.body.unmask()},scope:this})},this);this.dummyForm=new Ext.form.FormPanel({waitMsgTarget:true,url:GO.settings.modules.cms.url+"json.php",border:false,cls:"go-form-panel",autoHeight:true,baseParams:{task:"filter",site_id:GO.cms.site_id,user_id:0},items:[this.checkFilter=new Ext.form.Checkbox({boxLabel:GO.cms.lang.enablePermissionsPerFolder,hideLabel:true,name:"filter",anchor:"100%"})]});GO.cms.FoldersDialog.superclass.constructor.call(this,{layout:"fit",modal:false,shadow:false,minWidth:300,minHeight:300,height:400,width:500,plain:true,closeAction:"hide",title:GO.cms.lang.folders,items:[this.dummyForm,this.foldersTree],buttons:[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});this.checkFilter.on("check",function(f,e){this.body.mask(GO.lang.waitMsgSave,"x-mask-loading");var d=e?"enable_filter":"disable_filter";Ext.Ajax.request({url:GO.settings.modules.cms.url+"action.php",params:{task:d,site_id:GO.cms.site_id,user_id:this.dummyForm.baseParams.user_id},callback:function(h,i,g){if(!i){Ext.MessageBox.alert(GO.lang.strError,g.result.feedback)}this.body.unmask()},scope:this})},this)};Ext.extend(GO.cms.FoldersDialog,Ext.Window,{show:function(a,b){this.site=b;this.foldersTree.loader.baseParams.user_id=GO.cms.user_id=a;this.foldersTree.loader.baseParams.site_id=this.dummyForm.baseParams.site_id=GO.cms.site_id=b;this.dummyForm.baseParams.user_id=a;this.dummyForm.form.load();if(!this.rendered){this.render(Ext.getBody())}else{this.rootNode.reload()}GO.cms.FoldersDialog.superclass.show.call(this)}});