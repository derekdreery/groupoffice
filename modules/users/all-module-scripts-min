GO.users.UserDialog=function(a){if(!a){a={}}this.buildForm();a.tbar=[this.linkBrowseButton=new Ext.Button({iconCls:"btn-link",cls:"x-btn-text-icon",text:GO.lang.cmdBrowseLinks,disabled:true,handler:function(){GO.linkBrowser.show({link_id:this.user_id,link_type:"8",folder_id:"0"})},scope:this})];if(GO.files){a.tbar.push(this.fileBrowseButton=new Ext.Button({iconCls:"btn-files",cls:"x-btn-text-icon",text:GO.files.lang.files,handler:function(){GO.files.openFolder(this.files_folder_id)},scope:this,disabled:true}))}a.layout="fit";a.modal=false;a.resizable=true;a.maximizable=true;a.width=750;a.collapsible=true;a.height=580;a.closeAction="hide";a.title=GO.users.lang.userSettings;a.items=this.formPanel;a.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdSavePlusNew,handler:function(){this.submitForm(false,true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.users.UserDialog.superclass.constructor.call(this,a);this.addEvents({save:true,set_id:true})};Ext.extend(GO.users.UserDialog,Ext.Window,{user_id:0,files_folder_id:"",setUserId:function(a){this.formPanel.form.baseParams.user_id=a;this.user_id=a;this.permissionsTab.setUserId(a);this.accountTab.setUserId(a);if(this.serverclientFieldSet){var b=a>0;this.serverclientFieldSet.setVisible(!b)}this.loginTab.setVisible(a>0);this.linkBrowseButton.setDisabled(!a);if(GO.files){this.fileBrowseButton.setDisabled(!a)}this.lookAndFeelTab.startModuleField.clearLastSearch();this.lookAndFeelTab.modulesStore.baseParams.user_id=a;this.fireEvent("set_id",this)},serverclientDomainCheckboxes:[],setDefaultEmail:function(){if(this.rendered){for(var b=0;b<this.serverclientDomainCheckboxes.length;b++){if(this.serverclientDomainCheckboxes[b].getValue()){var c=this.formPanel.form.findField("username").getValue();var a=this.formPanel.form.findField("email");if(a){this.formPanel.form.findField("email").setValue(c+"@"+GO.serverclient.domains[b])}break}}}},show:function(a){if(GO.mailings&&!GO.mailings.writableMailingsStore.loaded){GO.mailings.writableMailingsStore.load({callback:function(){this.show(a)},scope:this});return false}if(!this.rendered){if(GO.serverclient&&GO.serverclient.domains){this.serverclientFieldSet=new Ext.form.FieldSet({title:GO.serverclient.lang.mailboxes,autoHeight:true,items:new GO.form.HtmlComponent({html:'<p class="go-form-text">'+GO.serverclient.lang.createMailbox+":</p>"})});for(var b=0;b<GO.serverclient.domains.length;b++){this.serverclientDomainCheckboxes[b]=new Ext.form.Checkbox({checked:(b==0),name:"serverclient_domains[]",autoCreate:{tag:"input",type:"checkbox",value:GO.serverclient.domains[b]},hideLabel:true,boxLabel:GO.serverclient.domains[b]});this.serverclientDomainCheckboxes[b].on("check",this.setDefaultEmail,this);this.serverclientFieldSet.add(this.serverclientDomainCheckboxes[b])}this.rightCol.add(this.serverclientFieldSet)}this.render(Ext.getBody())}if(GO.serverclient&&GO.serverclient.domains){this.formPanel.form.findField("username").on("change",this.setDefaultEmail,this)}this.profileTab.show();this.formPanel.form.reset();this.setUserId(a);if(a>0){this.formPanel.load({url:GO.settings.modules.users.url+"json.php",success:function(c,d){this.loaded=true;GO.users.UserDialog.superclass.show.call(this);this.files_folder_id=d.result.data.files_folder_id;this.lookAndFeelTab.startModuleField.setRemoteText(d.result.data.start_module_name)},failure:function(c,d){Ext.Msg.alert(GO.lang.strError,d.result.feedback)},scope:this})}else{GO.users.UserDialog.superclass.show.call(this)}},submitForm:function(a,b){var c=this.permissionsTab.getPermissionParameters();c.task="save_user";this.formPanel.form.submit({url:GO.settings.modules.users.url+"action.php",params:c,waitMsg:GO.lang.waitMsgSave,success:function(f,g){this.fireEvent("save",this);this.permissionsTab.commit();if(a){this.hide()}else{if(b){this.setUserId(0);var d=["username","password1","password2","first_name","middle_name","last_name","title","initials","sex","birthday","address","address_no","city","zip","email","home_phone","fax","cellular","department","function"];for(var e=0;e<d.length;e++){this.formPanel.form.findField(d[e]).reset()}this.permissionsTab.onShow()}else{if(g.result.user_id){this.setUserId(g.result.user_id);this.files_folder_id=g.result.files_folder_id}}}},failure:function(d,e){if(e.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,e.result.feedback)}},scope:this})},buildForm:function(){this.accountTab=new GO.users.AccountPanel();this.personalTab=new Ext.form.FieldSet({title:GO.users.lang.personalProfile,items:new GO.users.PersonalPanel({cb_id:"users_countryCombo"}),autoHeight:true,layout:"fit"});this.companyTab=new GO.users.CompanyPanel({title:GO.users.lang.companyProfile,cls:"go-form-panel",cb_id:"users_work_countryCombo"});this.loginTab=new GO.users.LoginPanel();this.permissionsTab=new GO.users.PermissionsPanel();this.regionalSettingsTab=new GO.users.RegionalSettingsPanel();this.lookAndFeelTab=new GO.users.LookAndFeelPanel();this.profileTab=new Ext.Panel({title:GO.users.lang.account,autoScroll:true,layout:"column",bodyStyle:"padding:5px",items:[{columnWidth:0.5,items:[this.accountTab],bodyStyle:"padding-right:5px",border:false},this.rightCol=new Ext.Panel({columnWidth:0.5,bodyStyle:"padding-left:5px",items:[this.loginTab],border:false}),{columnWidth:1,items:[this.personalTab],border:false}]});var a=[this.profileTab,this.companyTab,this.permissionsTab,this.regionalSettingsTab,this.lookAndFeelTab];if(GO.mailings){a.push(new GO.mailings.SelectMailingsPanel({hideAllowCheck:true}))}if(GO.customfields&&GO.customfields.types["8"]){for(var b=0;b<GO.customfields.types["8"].panels.length;b++){a.push(GO.customfields.types["8"].panels[b])}}this.tabPanel=new Ext.TabPanel({deferredRender:false,anchor:"100% 100%",layoutOnTabChange:true,border:false,items:a});this.formPanel=new Ext.form.FormPanel({items:this.tabPanel,baseParams:{task:"user"},waitMsgTarget:true,border:false})}});GO.users.PermissionsPanel=function(d){if(!d){d={}}d.autoScroll=false;d.border=false;d.hideLabel=true;d.title=GO.lang.strPermissions;d.layout="columnfit";d.anchor="100% 100%";d.defaults={border:true,height:280,autoScroll:true};var f=new GO.grid.CheckColumn({header:GO.users.lang.useModule,dataIndex:"read_permission",width:55,disabled_field:"read_disabled",menuDisabled:true});var h=new GO.grid.CheckColumn({header:GO.users.lang.manageModule,dataIndex:"write_permission",width:55,disabled_field:"write_disabled",menuDisabled:true});this.modulePermissionsStore=new GO.data.JsonStore({url:GO.settings.modules.users.url+"json.php",baseParams:{user_id:-1,task:"modules"},fields:["id","name","read_disabled","write_disabled","read_permission","write_permission"],root:"results",menuDisabled:true});var c=new GO.grid.GridPanel({columnWidth:0.34,title:GO.users.lang.moduleAccess,layout:"fit",columns:[{id:"name",header:GO.users.lang.cmdHeaderColumnName,dataIndex:"name",renderer:this.iconRenderer,menuDisabled:true},f,h],ds:this.modulePermissionsStore,plugins:[f,h],autoExpandColumn:"name"});var a=new GO.grid.CheckColumn({header:"",dataIndex:"group_permission",width:55,menuDisabled:true});this.groupMemberStore=new GO.data.JsonStore({url:GO.settings.modules.users.url+"json.php",baseParams:{user_id:-1,task:"groups"},fields:["id","disabled","group","group_permission"],root:"results"});var b=new GO.grid.GridPanel({columnWidth:0.33,layout:"fit",title:GO.users.lang.userIsMemberOf,columns:[{id:"name",header:GO.users.lang.group,dataIndex:"group",menuDisabled:true},a],ds:this.groupMemberStore,plugins:a,autoExpandColumn:"name"});var g=new GO.grid.CheckColumn({header:"",dataIndex:"visible_permission",width:55,menuDisabled:true});this.groupVisibleStore=new GO.data.JsonStore({url:GO.settings.modules.users.url+"json.php",baseParams:{user_id:-1,task:"visible"},fields:["id","disabled","group","visible_permission"],root:"results"});var e=new GO.grid.GridPanel({columnWidth:0.33,layout:"fit",title:GO.users.lang.userVisibleTo,columns:[{id:"name",header:GO.users.lang.group,dataIndex:"group",menuDisabled:true},g],ds:this.groupVisibleStore,plugins:g,autoExpandColumn:"name"});d.items=[c,b,e];GO.users.PermissionsPanel.superclass.constructor.call(this,d)};Ext.extend(GO.users.PermissionsPanel,Ext.Panel,{iconRenderer:function(c,b,a){return'<div class="go-module-icon-'+a.data.id+'" style="height:16px;padding-left:22px;background-repeat:no-repeat;">'+c+"</div>"},setUserId:function(a,b){if(!this.isVisible()&&a!=this.user_id){this.groupMemberStore.removeAll();this.modulePermissionsStore.removeAll();this.groupVisibleStore.removeAll();this.modulePermissionsStore.baseParams.user_id=-1;this.groupMemberStore.baseParams.user_id=-1;this.groupVisibleStore.baseParams.user_id=-1}this.user_id=a},onShow:function(){GO.users.PermissionsPanel.superclass.onShow.call(this);if(this.groupMemberStore.baseParams.user_id!=this.user_id){this.modulePermissionsStore.baseParams.user_id=this.user_id;this.groupMemberStore.baseParams.user_id=this.user_id;this.groupVisibleStore.baseParams.user_id=this.user_id;this.groupMemberStore.load();this.modulePermissionsStore.load();this.groupVisibleStore.load()}},commit:function(){this.modulePermissionsStore.commitChanges();this.groupMemberStore.commitChanges();this.groupVisibleStore.commitChanges()},getPermissionParameters:function(){var d=new Array();var a=new Array();var b=new Array();for(var c=0;c<this.modulePermissionsStore.data.items.length;c++){d[c]={id:this.modulePermissionsStore.data.items[c].get("id"),name:this.modulePermissionsStore.data.items[c].get("name"),read_permission:this.modulePermissionsStore.data.items[c].get("read_permission"),write_permission:this.modulePermissionsStore.data.items[c].get("write_permission")}}for(var c=0;c<this.groupMemberStore.data.items.length;c++){a[c]={id:this.groupMemberStore.data.items[c].get("id"),group:this.groupMemberStore.data.items[c].get("name"),group_permission:this.groupMemberStore.data.items[c].get("group_permission")}}for(var c=0;c<this.groupVisibleStore.data.items.length;c++){b[c]={id:this.groupVisibleStore.data.items[c].get("id"),group:this.groupVisibleStore.data.items[c].get("name"),visible_permission:this.groupVisibleStore.data.items[c].get("visible_permission")}}return{modules:Ext.encode(d),groups_visible:Ext.encode(b),group_member:Ext.encode(a)}}});GO.users.LoginPanel=function(a){if(!a){a={}}a.autoHeight=true;a.border=true;a.hideLabel=true;a.title=GO.users.lang.loginInfo;a.layout="form";a.defaults={anchor:"100%"};a.defaultType="textfield";a.labelWidth=140;a.items=[{xtype:"plainfield",fieldLabel:GO.users.lang.cmdFormLabelRegistrationTime,name:"registration_time"},{xtype:"plainfield",fieldLabel:GO.users.lang.cmdFormLabelLastLogin,name:"lastlogin"},{xtype:"plainfield",fieldLabel:GO.users.lang.numberOfLogins,name:"logins"}];GO.users.LoginPanel.superclass.constructor.call(this,a)};Ext.extend(GO.users.LoginPanel,Ext.form.FieldSet,{});GO.users.AccountPanel=function(a){if(!a){a={}}a.autoHeight=true;a.border=true;a.hideLabel=true;a.title=GO.users.lang.account;a.layout="form";a.defaults={anchor:"100%"};a.defaultType="textfield";a.labelWidth=140;this.passwordField1=new Ext.form.TextField({inputType:"password",fieldLabel:GO.users.lang.cmdFormLabelPassword,name:"password1"});this.passwordField2=new Ext.form.TextField({inputType:"password",fieldLabel:GO.users.lang.confirmPassword,name:"password2"});this.usernameField=new Ext.form.TextField({fieldLabel:GO.lang.strUsername,name:"username"});this.enabledField=new Ext.form.Checkbox({boxLabel:GO.users.lang.cmdBoxLabelEnabled,name:"enabled",checked:true,hideLabel:true});this.invitationField=new Ext.form.Checkbox({boxLabel:GO.users.lang.sendInvitation,name:"send_invitation",checked:true,hideLabel:true});a.items=[this.usernameField,this.passwordField1,this.passwordField2,{xtype:"panel",hideLabel:true,border:false,bodyStyle:"padding:0",layout:"column",defaults:{bodyStyle:"padding:0",border:false,layout:"form",columnWidth:0.5},items:[{items:this.enabledField},{items:this.invitationField}]}];GO.users.AccountPanel.superclass.constructor.call(this,a)};Ext.extend(GO.users.AccountPanel,Ext.form.FieldSet,{setUserId:function(a){this.invitationField.getEl().up(".x-form-item").setDisplayed(!a);this.usernameField.setDisabled(a>0);this.passwordField2.allowBlank=(a>0);this.passwordField1.allowBlank=(a>0)}});GO.users.ImportDialog=Ext.extend(Ext.Window,{initComponent:function(){this.title=GO.lang.cmdImport;this.width=500;this.autoHeight=true;this.closeAction="hide";this.uploadFile=new GO.form.UploadFile({inputName:"importfile",max:1});this.upForm=new Ext.form.FormPanel({fileUpload:true,waitMsgTarget:true,items:[new GO.form.HtmlComponent({html:GO.users.lang.importText+"<br /><br />"}),this.uploadFile],cls:"go-form-panel"});this.items=[this.upForm];this.buttons=[{text:GO.lang.cmdOk,handler:this.uploadHandler,scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this},{text:GO.users.lang.downloadSampleCSV,handler:function(){window.open(GO.settings.modules.users.url+"download_importsample.php")},scope:this}];this.addEvents({"import":true});GO.users.ImportDialog.superclass.initComponent.call(this)},uploadHandler:function(){this.upForm.form.submit({waitMsg:GO.lang.waitMsgUpload,url:GO.settings.modules.users.url+"action.php",params:{task:"import"},success:function(b,c){this.uploadFile.clearQueue();this.hide();this.fireEvent("import");var a=c.result.feedback.replace(/BR/g,"<br />");Ext.MessageBox.alert(GO.lang.strSuccess,a)},failure:function(b,c){if(c.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{var a=c.result.feedback.replace(/BR/g,"<br />");Ext.MessageBox.alert(GO.lang.strError,a)}},scope:this})}});GO.users.SettingsDialog=function(a){if(!a){a={}}this.formPanel=new Ext.form.FormPanel({border:false,waitMsgTarget:true,cls:"go-form-panel",items:[{xtype:"textfield",fieldLabel:GO.lang.strSubject,name:"register_email_subject",anchor:"100%"},{hideLabel:true,xtype:"textarea",anchor:"100% -30",name:"register_email_body"}]});a.layout="fit";a.modal=false;a.resizable=false;a.width=750;a.height=500;a.closeAction="hide";a.title=GO.lang.cmdSettings;a.items=this.formPanel;a.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.users.SettingsDialog.superclass.constructor.call(this,a)};Ext.extend(GO.users.SettingsDialog,Ext.Window,{show:function(){if(!this.rendered){this.render(Ext.getBody())}this.formPanel.load({url:GO.settings.modules.users.url+"json.php",params:{task:"settings"},waitMsg:GO.lang.waitMsgLoad,success:function(a,b){GO.users.SettingsDialog.superclass.show.call(this)},failure:function(a,b){Ext.Msg.alert(GO.lang.strError,b.result.feedback)},scope:this})},submitForm:function(a){this.formPanel.form.submit({url:GO.settings.modules.users.url+"action.php",params:{task:"save_settings"},waitMsg:GO.lang.waitMsgSave,success:function(b,c){if(a){this.hide()}},failure:function(b,c){if(c.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,c.result.feedback)}},scope:this})}});GO.users.MainPanel=function(a){if(!a){a={}}a.store=new GO.data.JsonStore({url:GO.settings.modules.users.url+"non_admin_json.php",baseParams:{task:"users"},id:"id",totalProperty:"total",root:"results",fields:["id","username","name","company","logins","lastlogin","registration_time","address","zip","city","state","country","phone","email","waddress","wzip","wcity","wstate","wcountry","wphone","enabled"],remoteSort:true});a.store.setDefaultSort("username","ASC");this.searchField=new GO.form.SearchField({store:a.store,width:320});a.view=new Ext.grid.GridView({forceFit:true,autoFill:true,getRowClass:function(b,e,d,c){if(GO.util.empty(b.data.enabled)){return"user-disabled"}}});a.deleteConfig={extraWarning:GO.users.lang.deleteWarning+"\n\n"};a.cm=new Ext.grid.ColumnModel([{header:GO.lang.strUsername,dataIndex:"username"},{header:GO.lang.strName,dataIndex:"name",width:250},{header:GO.lang.strCompany,dataIndex:"company",width:200},{header:GO.users.lang.cmdFormLabelTotalLogins,dataIndex:"logins",width:100},{header:GO.users.lang.cmdFormLabelLastLogin,dataIndex:"lastlogin",width:100},{header:GO.users.lang.cmdFormLabelRegistrationTime,dataIndex:"registration_time",width:100},{header:GO.lang.strAddress,dataIndex:"address",width:100,hidden:true},{header:GO.lang.strZip,dataIndex:"zip",width:100,hidden:true},{header:GO.lang.strCity,dataIndex:"city",width:100,hidden:true},{header:GO.lang.strState,dataIndex:"state",width:100,hidden:true},{header:GO.lang.strCountry,dataIndex:"country",width:100,hidden:true},{header:GO.lang.strPhone,dataIndex:"phone",width:100,hidden:true},{header:GO.lang.strEmail,dataIndex:"email",width:100,hidden:true},{header:GO.lang.strWorkAddress,dataIndex:"waddress",width:100,hidden:true},{header:GO.lang.strWorkZip,dataIndex:"wzip",width:100,hidden:true},{header:GO.lang.strWorkCity,dataIndex:"wcity",width:100,hidden:true},{header:GO.lang.strWorkState,dataIndex:"wstate",width:100,hidden:true},{header:GO.lang.strWorkCountry,dataIndex:"wcountry",width:100,hidden:true},{header:GO.lang.strWorkPhone,dataIndex:"wphone",width:100,hidden:true}]);a.cm.defaultSortable=true;a.tbar=new Ext.Toolbar({cls:"go-head-tb",items:[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){if(GO.settings.config.max_users>0&&this.store.totalLength>=GO.settings.config.max_users){Ext.Msg.alert(GO.lang.strError,GO.users.lang.maxUsersReached)}else{GO.users.userDialog.show()}},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected()},scope:this},{iconCls:"btn-upload",text:GO.lang.cmdImport,handler:function(){if(!this.importDialog){this.importDialog=new GO.users.ImportDialog();this.importDialog.on("import",function(){this.store.reload()},this)}this.importDialog.show()},scope:this},{iconCls:"btn-settings",text:GO.lang.administration,handler:function(){if(!this.settingsDialog){this.settingsDialog=new GO.users.SettingsDialog()}this.settingsDialog.show()},scope:this},"-",GO.lang.strSearch+":",this.searchField]});if(GO.settings.config.max_users>0){a.bbar=new Ext.PagingToolbar({cls:"go-paging-tb",store:a.store,pageSize:parseInt(GO.settings.max_rows_list),displayInfo:true,displayMsg:GO.lang.displayingItems+". "+GO.lang.strMax+" "+GO.settings.config.max_users,emptyMsg:GO.lang.strNoItems})}a.sm=new Ext.grid.RowSelectionModel();a.paging=true;GO.users.MainPanel.superclass.constructor.call(this,a)};Ext.extend(GO.users.MainPanel,GO.grid.GridPanel,{afterRender:function(){GO.users.MainPanel.superclass.afterRender.call(this);this.on("rowdblclick",this.rowDoubleClick,this);this.store.load();if(!GO.users.userDialog.hasListener("save")){GO.users.userDialog.on("save",function(){this.store.reload()},this)}},rowDoubleClick:function(c,e,d){var a=c.getSelectionModel();var b=a.getSelected();GO.users.userDialog.show(b.data.id)}});GO.mainLayout.onReady(function(){GO.users.userDialog=new GO.users.UserDialog()});GO.linkHandlers[8]=function(a){GO.users.userDialog.show(a)};GO.moduleManager.addModule("users",GO.users.MainPanel,{title:GO.lang.users,iconCls:"go-tab-icon-users",admin:true});