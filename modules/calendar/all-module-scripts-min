GO.calendar.EventDialog=function(a){this.calendar=a;this.buildForm();this.beforeInit();this.tabPanel=new Ext.TabPanel({activeTab:0,deferredRender:false,border:false,anchor:"100% 100%",hideLabel:true,items:[this.propertiesPanel,this.descriptionPanel,this.recurrencePanel,this.optionsPanel,this.participantsPanel]});this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,url:GO.settings.modules.calendar.url+"action.php",border:false,baseParams:{task:"event"},items:this.tabPanel});this.initWindow();this.addEvents({save:true});this.win.render(Ext.getBody())};Ext.extend(GO.calendar.EventDialog,Ext.util.Observable,{beforeInit:function(){},initWindow:function(){var b=function(){this.subjectField.focus()};var a=[this.linkBrowseButton=new Ext.Button({iconCls:"btn-link",cls:"x-btn-text-icon",text:GO.lang.cmdBrowseLinks,disabled:true,handler:function(){GO.linkBrowser.show({link_id:this.event_id,link_type:"1",folder_id:"0"})},scope:this})];if(GO.files){a.push(this.fileBrowseButton=new Ext.Button({iconCls:"btn-files",cls:"x-btn-text-icon",text:GO.files.lang.files,handler:function(){GO.files.openFolder(this.files_folder_id)},scope:this,disabled:true}))}this.win=new Ext.Window({layout:"fit",modal:false,tbar:a,resizable:false,width:560,height:420,closeAction:"hide",title:GO.calendar.lang.appointment,items:this.formPanel,focus:b.createDelegate(this),buttons:[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.win.hide()},scope:this}]})},files_folder_id:0,show:function(b){if(b.oldDomId){this.oldDomId=b.oldDomId}else{this.oldDomId=false}delete this.link_config;this.formPanel.baseParams.tmp_files=b.tmp_files?Ext.encode(b.tmp_files):"";this.formPanel.form.reset();this.tabPanel.setActiveTab(0);if(!b.event_id){b.event_id=0}this.setEventId(b.event_id);if(b.event_id>0){this.formPanel.load({url:GO.settings.modules.calendar.url+"json.php",success:function(d,e){this.win.show();this.participantsPanel.setEventId(e.result.data.participants_event_id);this.formPanel.form.baseParams.calendar_id=e.result.data.calendar_id;this.changeRepeat(e.result.data.repeat_type);this.setValues(b.values);this.setWritePermission(e.result.data.write_permission);this.selectCalendar.setRemoteText(e.result.data.calendar_name);this.selectCalendar.container.up("div.x-form-item").setDisplayed(true);this.files_folder_id=e.result.data.files_folder_id},failure:function(d,e){Ext.Msg.alert(GO.lang.strError,e.result.feedback)},scope:this})}else{if(b.exception_event_id){this.formPanel.load({url:GO.settings.modules.calendar.url+"json.php",params:{event_id:b.exception_event_id},waitMsg:GO.lang.waitMsgLoad,success:function(d,e){this.win.show();this.participantsPanel.setEventId(e.result.data.participants_event_id);this.formPanel.form.baseParams.exception_event_id=b.exception_event_id;this.formPanel.form.baseParams.exceptionDate=b.exceptionDate;this.formPanel.form.findField("repeat_type").setValue(0);this.changeRepeat(0);this.setValues(b.values);this.selectCalendar.setRemoteText(e.result.data.calendar_name);this.selectCalendar.container.up("div.x-form-item").setDisplayed(true);this.setWritePermission(e.result.data.write_permission)},failure:function(d,e){Ext.Msg.alert(GO.lang.strError,e.result.feedback)},scope:this})}else{delete this.formPanel.form.baseParams.exception_event_id;delete this.formPanel.form.baseParams.exceptionDate;this.setWritePermission(true);this.win.show();b.values=b.values||{};var a=new Date();var c=parseInt(a.format("i"));if(c>45){c="45"}else{if(c>30){c="30"}else{if(c>15){c="15"}else{c="00"}}}if(!b.values.start_date){b.values.start_date=new Date()}if(!b.values.start_hour){b.values.start_hour=a.format("H")}if(!b.values.start_min){b.values.start_min=c}if(!b.values.end_date){b.values.end_date=new Date()}if(!b.values.end_hour){b.values.end_hour=a.add(Date.HOUR,1).format("H")}if(!b.values.end_min){b.values.end_min=c}this.setValues(b.values);if(GO.util.empty(b.calendar_id)){b.calendar_id=GO.calendar.defaultCalendar.id;b.calendar_name=GO.calendar.defaultCalendar.name}this.selectCalendar.setValue(b.calendar_id);if(b.calendar_name){this.selectCalendar.container.up("div.x-form-item").setDisplayed(true);this.selectCalendar.setRemoteText(b.calendar_name)}else{this.selectCalendar.container.up("div.x-form-item").setDisplayed(false)}}}if(b&&b.link_config){this.link_config=b.link_config;if(b.link_config.type_id){this.selectLinkField.setValue(b.link_config.type_id);this.selectLinkField.setRemoteText(b.link_config.text);if(this.subjectField.getValue()==""){this.subjectField.setValue(b.link_config.text)}}}},setWritePermission:function(a){this.win.buttons[0].setDisabled(!a);this.win.buttons[1].setDisabled(!a)},setValues:function(a){if(a){for(var b in a){var c=this.formPanel.form.findField(b);if(c){c.setValue(a[b])}}}},setEventId:function(a){this.formPanel.form.baseParams.event_id=a;this.event_id=a;this.participantsPanel.setEventId(a);this.selectLinkField.container.up("div.x-form-item").setDisplayed(a==0);this.linkBrowseButton.setDisabled(a<1);if(GO.files){this.fileBrowseButton.setDisabled(a<1)}},setCurrentDate:function(){var b={};var a=new Date();b.start_date=a.format(GO.settings.date_format);b.start_hour=a.format("H");b.start_min="00";b.end_date=a.format(GO.settings.date_format);b.end_hour=a.add(Date.HOUR,1).format("H");b.end_min="00";this.formPanel.form.setValues(b)},submitForm:function(b,a){var c={task:"save_event"};if(this.participantsPanel.store.loaded){c.participants=Ext.encode(this.participantsPanel.getGridData())}this.formPanel.form.submit({url:GO.settings.modules.calendar.url+"action.php",params:c,waitMsg:GO.lang.waitMsgSave,success:function(e,g){if(g.result.event_id){this.files_folder_id=g.result.files_folder_id;this.setEventId(g.result.event_id)}var d=this.formPanel.form.findField("start_date").getValue();if(!this.formPanel.form.findField("all_day_event").getValue()){d=d.add(Date.HOUR,this.formPanel.form.findField("start_hour").getValue());d=d.add(Date.MINUTE,this.formPanel.form.findField("start_min").getValue())}var h=this.formPanel.form.findField("end_date").getValue();if(!this.formPanel.form.findField("all_day_event").getValue()){h=h.add(Date.HOUR,this.formPanel.form.findField("end_hour").getValue());h=h.add(Date.MINUTE,this.formPanel.form.findField("end_min").getValue())}var f={calendar_id:this.selectCalendar.getValue(),event_id:this.event_id,name:Ext.util.Format.htmlEncode(this.subjectField.getValue()),start_time:d.format("Y-m-d H:i"),end_time:h.format("Y-m-d H:i"),startDate:d,endDate:h,description:Ext.util.Format.htmlEncode(GO.util.nl2br(this.formPanel.form.findField("description").getValue()).replace(/\n/g,"")),background:this.formPanel.form.findField("background").getValue(),location:this.formPanel.form.findField("location").getValue(),repeats:this.formPanel.form.findField("repeat_type").getValue()>0,"private":false};this.fireEvent("save",f,this.oldDomId);if(this.link_config&&this.link_config.callback){this.link_config.callback.call(this)}if(b){this.win.hide()}if(a&&a.callback){a.callback.call(this,this,true)}},failure:function(e,f){if(f.failureType=="client"){var d=GO.lang.strErrorsInForm}else{var d=f.result.feedback}if(a&&a.callback){a.callback.call(this,this,false)}Ext.MessageBox.alert(GO.lang.strError,d)},scope:this})},getStartDate:function(){var a=this.startDate.getValue();a=a.add(Date.HOUR,this.startHour.getValue());a=a.add(Date.MINUTE,this.startMin.getValue());return a},getEndDate:function(){var a=this.endDate.getValue();a=a.add(Date.HOUR,this.endHour.getValue());a=a.add(Date.MINUTE,this.endMin.getValue());return a},checkDateInput:function(){var a=this.endDate.getValue();var d=this.startDate.getValue();if(d>a){this.endDate.setValue(d)}if(d.getElapsed(a)==0){var c=parseInt(this.startHour.getValue());var e=parseInt(this.endHour.getValue());var f=parseInt(this.startMin.getValue());var b=parseInt(this.endMin.getValue());if(c>e){e=c;this.endHour.setValue(c)}if(c==e&&f>b){this.endMin.setValue(f)}}if(this.repeatType.getValue()>0){if(this.repeatEndDate.getValue()==""){this.repeatForever.setValue(true)}else{if(this.repeatEndDate.getValue()<a){this.repeatEndDate.setValue(a.add(Date.DAY,1))}}}this.participantsPanel.reloadAvailability()},buildForm:function(){this.selectLinkField=new GO.form.SelectLink({});var k=Array();if(GO.settings.time_format.substr(0,1)=="G"){var d=40;var a="G"}else{var d=60;var a="g a"}for(var f=0;f<24;f++){var g=Date.parseDate(f,"G");k.push([g.format("G"),g.format(a)])}var c=[["00","00"],["05","05"],["10","10"],["15","15"],["20","20"],["25","25"],["30","30"],["35","35"],["40","40"],["45","45"],["50","50"],["55","55"]];this.subjectField=new Ext.form.TextField({name:"subject",allowBlank:false,fieldLabel:GO.lang.strSubject});this.locationField=new Ext.form.TextField({name:"location",allowBlank:true,fieldLabel:GO.lang.strLocation});this.startDate=new Ext.form.DateField({name:"start_date",width:100,format:GO.settings.date_format,allowBlank:false,fieldLabel:GO.lang.strStart,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.startHour=new Ext.form.ComboBox({hiddenName:"start_hour",store:new Ext.data.SimpleStore({fields:["value","text"],data:k}),valueField:"value",displayField:"text",mode:"local",triggerAction:"all",selectOnFocus:true,width:d,labelSeparator:"",hideLabel:true,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.startMin=new Ext.form.ComboBox({name:"start_min",store:new Ext.data.SimpleStore({fields:["value","text"],data:c}),displayField:"text",mode:"local",triggerAction:"all",selectOnFocus:true,width:40,labelSeparator:"",hideLabel:true,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.endDate=new Ext.form.DateField({name:"end_date",width:100,format:GO.settings.date_format,allowBlank:false,fieldLabel:GO.lang.strEnd,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.endHour=new Ext.form.ComboBox({hiddenName:"end_hour",store:new Ext.data.SimpleStore({fields:["value","text"],data:k}),displayField:"text",valueField:"value",mode:"local",triggerAction:"all",selectOnFocus:true,width:d,labelSeparator:"",hideLabel:true,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.endMin=new Ext.form.ComboBox({name:"end_min",store:new Ext.data.SimpleStore({fields:["value","text"],data:c}),displayField:"text",mode:"local",triggerAction:"all",selectOnFocus:true,width:40,labelSeparator:"",hideLabel:true,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.allDayCB=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.allDay,name:"all_day_event",checked:false,width:"auto",labelSeparator:"",hideLabel:true});this.allDayCB.on("check",function(i,h){this.startHour.setDisabled(h);this.endHour.setDisabled(h);this.startMin.setDisabled(h);this.endMin.setDisabled(h)},this);this.eventStatus=new Ext.form.ComboBox({hiddenName:"status",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,fieldLabel:GO.calendar.lang.status,mode:"local",value:"ACCEPTED",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["NEEDS-ACTION",GO.calendar.lang.needsAction],["ACCEPTED",GO.calendar.lang.accepted],["DECLINED",GO.calendar.lang.declined],["TENTATIVE",GO.calendar.lang.tentative],["DELEGATED",GO.calendar.lang.delegated]]})});this.busy=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.busy,name:"busy",checked:true,width:"auto",labelSeparator:"",hideLabel:true});this.propertiesPanel=new Ext.Panel({hideMode:"offsets",title:GO.lang.strProperties,defaults:{anchor:"-20"},bodyStyle:"padding:5px",layout:"form",autoScroll:true,items:[this.subjectField,this.locationField,this.selectLinkField,{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.startDate},{items:this.startHour},{items:this.startMin},{bodyStyle:"white-space:nowrap;",items:this.allDayCB}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.endDate},{items:this.endHour},{items:this.endMin}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.eventStatus},{items:this.busy}]},this.selectCalendar=new GO.calendar.SelectCalendar({anchor:"-20",pageSize:parseInt(GO.settings.max_rows_list),valueField:"id",displayField:"name",typeAhead:true,mode:"remote",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,allowBlank:false})]});this.descriptionPanel=new Ext.Panel({title:GO.lang.strDescription,layout:"fit",border:false,items:[{xtype:"textarea",name:"description",anchor:"100% 100%",hideLabel:true}]});var e=new Array();for(var f=1;f<31;f++){e.push([f])}this.repeatEvery=new Ext.form.ComboBox({fieldLabel:GO.calendar.lang.repeatEvery,hiddenName:"repeat_every",triggerAction:"all",editable:false,selectOnFocus:true,width:50,forceSelection:true,mode:"local",value:"1",valueField:"value",displayField:"value",store:new Ext.data.SimpleStore({fields:["value"],data:e})});this.repeatType=new Ext.form.ComboBox({hiddenName:"repeat_type",triggerAction:"all",editable:false,selectOnFocus:true,width:200,forceSelection:true,mode:"local",value:"0",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["0",GO.calendar.lang.noRecurrence],["1",GO.calendar.lang.days],["2",GO.calendar.lang.weeks],["3",GO.calendar.lang.monthsByDate],["4",GO.calendar.lang.monthsByDay],["5",GO.calendar.lang.years]]}),hideLabel:true});this.repeatType.on("select",function(i,h){this.checkDateInput();this.changeRepeat(h.data.value)},this);this.monthTime=new Ext.form.ComboBox({hiddenName:"month_time",triggerAction:"all",selectOnFocus:true,disabled:true,width:80,forceSelection:true,fieldLabel:GO.calendar.lang.atDays,mode:"local",value:"1",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["1",GO.lang.strFirst],["2",GO.lang.strSecond],["3",GO.lang.strThird],["4",GO.lang.strFourth]]})});this.cb=[];for(var j=0;j<7;j++){this.cb[j]=new Ext.form.Checkbox({boxLabel:GO.lang.shortDays[j],id:"frm_repeat_days_"+j,name:"repeat_days_"+j,disabled:true,checked:false,width:"auto",hideLabel:true,laelSeperator:""})}this.repeatEndDate=new Ext.form.DateField({name:"repeat_end_date",width:100,disabled:true,format:GO.settings.date_format,allowBlank:true,fieldLabel:GO.calendar.lang.repeatUntil,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.repeatForever=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.repeatForever,name:"repeat_forever",checked:true,disabled:true,width:"auto",hideLabel:true,laelSeperator:""});this.recurrencePanel=new Ext.Panel({title:GO.calendar.lang.recurrence,bodyStyle:"padding: 5px",layout:"form",hideMode:"offsets",autoScroll:true,items:[{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.repeatEvery},{items:this.repeatType}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px;white-space:nowrap"},items:[{items:this.monthTime},{items:this.cb[0]},{items:this.cb[1]},{items:this.cb[2]},{items:this.cb[3]},{items:this.cb[4]},{items:this.cb[5]},{items:this.cb[6]}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.repeatEndDate},{items:this.repeatForever}]}]});var b=[["0",GO.calendar.lang.noReminder]];for(var f=1;f<60;f++){b.push([f,f])}this.reminderValue=new Ext.form.ComboBox({fieldLabel:GO.calendar.lang.reminder,hiddenName:"reminder_value",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,mode:"local",value:GO.calendar.defaultReminderValue,valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:b})});this.reminderMultiplier=new Ext.form.ComboBox({hiddenName:"reminder_multiplier",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,mode:"local",value:GO.calendar.defaultReminderMultiplier,valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["60",GO.lang.strMinutes],["3600",GO.lang.strHours],["86400",GO.lang.strDays]]}),hideLabel:true,labelSeperator:""});this.participantsPanel=new GO.calendar.ParticipantsPanel(this);this.privateCB=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.privateEvent,name:"private",checked:false,width:"auto",labelSeparator:"",hideLabel:true});this.optionsPanel=new Ext.Panel({title:GO.calendar.lang.options,bodyStyle:"padding:5px",layout:"form",hideMode:"offsets",autoScroll:true,items:[{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.reminderValue},{items:this.reminderMultiplier}]},this.colorField=new GO.form.ColorField({fieldLabel:GO.lang.color,value:GO.calendar.defaultBackground,name:"background",colors:["EBF1E2","95C5D3","FFFF99","A68340","82BA80","F0AE67","66FF99","CC0099","CC99FF","996600","999900","FF0000","FF6600","FFFF00","FF9966","FF9900","FB0467","D52A6F","CC3370","C43B72","BB4474","B34D75","AA5577","A25E79","FF00CC","D52AB3","CC33AD","C43BA8","BB44A3","B34D9E","AA5599","A25E94","CC00FF","B32AD5","AD33CC","A83BC4","A344BB","9E4DB3","9955AA","945EA2","6704FB","6E26D9","7033CC","723BC4","7444BB","754DB3","7755AA","795EA2","0404FB","2626D9","3333CC","3B3BC4","4444BB","4D4DB3","5555AA","5E5EA2","0066FF","2A6ED5","3370CC","3B72C4","4474BB","4D75B3","5577AA","5E79A2","00CCFF","2AB2D5","33ADCC","3BA8C4","44A3BB","4D9EB3","5599AA","5E94A2","00FFCC","2AD5B2","33CCAD","3BC4A8","44BBA3","4DB39E","55AA99","5EA294","00FF66","2AD56F","33CC70","3BC472","44BB74","4DB375","55AA77","5EA279","00FF00","2AD52A","33CC33","3BC43B","44BB44","4DB34D","55AA55","5EA25E","66FF00","6ED52A","70CC33","72C43B","74BB44","75B34D","77AA55","79A25E","CCFF00","B2D52A","ADCC33","A8C43B","A3BB44","9EB34D","99AA55","94A25E","FFCC00","D5B32A","CCAD33","C4A83B","BBA344","B39E4D","AA9955","A2945E","FF6600","D56F2A","CC7033","C4723B","BB7444","B3754D","AA7755","A2795E","FB0404","D52A2A","CC3333","C43B3B","BB4444","B34D4D","AA5555","A25E5E","FFFFFF","949494","808080","6B6B6B","545454","404040","292929","000000"]}),this.privateCB]})},changeRepeat:function(b){var a=this.formPanel.form;switch(b){case"0":this.disableDays(true);a.findField("month_time").setDisabled(true);a.findField("repeat_forever").setDisabled(true);a.findField("repeat_end_date").setDisabled(true);a.findField("repeat_every").setDisabled(true);break;case"1":this.disableDays(true);a.findField("month_time").setDisabled(true);a.findField("repeat_forever").setDisabled(false);a.findField("repeat_end_date").setDisabled(false);a.findField("repeat_every").setDisabled(false);break;case"2":this.disableDays(false);a.findField("month_time").setDisabled(true);a.findField("repeat_forever").setDisabled(false);a.findField("repeat_end_date").setDisabled(false);a.findField("repeat_every").setDisabled(false);break;case"3":this.disableDays(true);a.findField("month_time").setDisabled(true);a.findField("repeat_forever").setDisabled(false);a.findField("repeat_end_date").setDisabled(false);a.findField("repeat_every").setDisabled(false);break;case"4":this.disableDays(false);a.findField("month_time").setDisabled(false);a.findField("repeat_forever").setDisabled(false);a.findField("repeat_end_date").setDisabled(false);a.findField("repeat_every").setDisabled(false);break;case"5":this.disableDays(true);a.findField("month_time").setDisabled(true);a.findField("repeat_forever").setDisabled(false);a.findField("repeat_end_date").setDisabled(false);a.findField("repeat_every").setDisabled(false);break}},disableDays:function(b){for(var a=0;a<7;a++){this.formPanel.form.findField("repeat_days_"+a).setDisabled(b)}}});GO.grid.CalendarGrid=Ext.extend(Ext.Panel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,dragEvent:false,appointments:Array(),appointmentsMap:{},allDayAppointments:Array(),allDayAppointmentsMap:[],allDayEventRows:0,allDayColumns:Array(),remoteEvents:Array(),domIds:Array(),days:1,scale:96,hourHeight:40,loaded:false,minRows:2,writePermission:false,scrollOffset:19,selected:Array(),initComponent:function(){this.cls="x-calGrid-panel";GO.grid.CalendarGrid.superclass.initComponent.call(this);this.addEvents({create:true,move:true,eventResize:true,eventDblClick:true});if(this.store){this.setStore(this.store,true)}if(!this.startDate){var a=new Date();this.startDate=Date.parseDate(a.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate;this.rowsPerHour=this.scale/24;this.rowHeight=this.hourHeight/this.rowsPerHour},doLayout:function(){GO.grid.CalendarGrid.superclass.doLayout.call(this);if(this.rendered){this.setDate(this.startDate,this.days,false);this.body.setStyle("overflow","hidden");this.body.unselectable();if(this.daysGridRendered){this.cacheGridCells()}this.setStore(this.store)}},renderDaysGrid:function(){this.daysGridRendered=true;this.body.update("");var n=this.container.getSize(true);var l=((n.width-40-this.scrollOffset)/this.days);l=Math.floor(l);this.headingsTable=Ext.DomHelper.append(this.body,{tag:"table",id:Ext.id(),cls:"x-calGrid-headings-table",style:"width:"+(n.width)+"px;"},true);var a=Ext.DomHelper.append(this.headingsTable,{tag:"tbody"},true);this.headingsRow=Ext.DomHelper.append(a,{tag:"tr",children:{tag:"td",style:"width:37px",cls:"x-calGrid-heading"}},true);this.allDayTableContainer=Ext.DomHelper.append(this.body,{tag:"div",cls:"x-calGrid-all-day-table-container"},true);this.allDayTable=Ext.DomHelper.append(this.allDayTableContainer,{tag:"table",id:Ext.id(),cls:"x-calGrid-all-day-table",style:"width:"+(n.width-this.scrollOffset)+"px;"},true);var a=Ext.DomHelper.append(this.allDayTable,{tag:"tbody"},true);this.allDayRow=Ext.DomHelper.append(a,{tag:"tr",children:{tag:"td",style:"width:40px",cls:"x-calGrid-all-day-first-col"}},true);var x=GO.settings.date_format.indexOf("Y");var t="D "+GO.settings.date_format.substring(0,x-1);var f=new Date();var s=f.format(t);var q,w,j,p,d;this.allDayColumns=Array();for(var v=0;v<this.days;v++){q=this.startDate.add(Date.DAY,v);w=q.format(t);d=w==s?"x-calGrid-heading x-calGrid-heading-today":"x-calGrid-heading";j=Ext.DomHelper.append(this.headingsRow,{tag:"td",children:[{tag:"div",cls:d,style:"width:"+(l-3)+"px",html:q.format(t)}]});p=Ext.DomHelper.append(this.allDayRow,{tag:"td",id:"all_day_"+v,cls:"x-calGrid-all-day-container",style:"width:"+(l-3)+"px;height:0px"},true);this.allDayColumns.push(p)}Ext.DomHelper.append(this.headingsRow,{tag:"td",style:"width:"+(this.scrollOffset)+"px;height:0px",cls:"x-calGrid-heading"});this.gridContainer=Ext.DomHelper.append(this.body,{tag:"div",cls:"x-calGrid-grid-container"},true);var o=this.headingsTable.getHeight();this.gridTable=Ext.DomHelper.append(this.gridContainer,{tag:"table",id:Ext.id(),cls:"x-calGrid-table",style:"width:"+n.width-this.scrollWidth+"px;"},true);this.tbody=Ext.DomHelper.append(this.gridTable,{tag:"tbody"},true);this.gridTable.on("mousedown",this.startSelection,this);this.gridContainer.on("mousemove",this.onEventDragMouseMove,this);this.body.on("mouseup",this.onEventDragMouseUp,this);this.allDayTable.on("mousemove",this.onAllDayEventDragMouseMove,this);this.body.on("mouseup",this.onAllDayEventDragMouseUp,this);var h=Ext.DomHelper.append(this.tbody,{tag:"tr"});var k=Ext.DomHelper.append(h,{tag:"td",style:"width:40px"},true);var e;var c=(((this.rowHeight+1)*this.rowsPerHour)-1);for(var u=0;u<this.scale;u+=this.rowsPerHour){timeformat=GO.settings.time_format.substr(0,1)=="G"?"G:i":"g a";Ext.DomHelper.append(k,{tag:"div",id:"head"+u,cls:"x-calGrid-timeHead",html:Date.parseDate(u/this.rowsPerHour,"G").format(timeformat),style:"width:40px;height:"+c+"px"},true)}this.gridCells=[];var m,g,b;var y=Ext.isIE6?'<p style="line-height:0px;"></p>':"";for(var v=0;v<this.days;v++){this.gridCells[v]=[];m=Ext.DomHelper.append(h,{tag:"td",id:"dayCol"+v,style:"width:"+l+"px"},true);g="x-calGrid-hourRow";var r=0;for(var u=0;u<this.scale;u++){if(r==0){g="x-calGrid-hourRow"}else{if(this.rowsPerHour/r==2){g="x-calGrid-halfhourRow"}else{g="x-calGrid-blankRow"}}b=Ext.DomHelper.append(m,{tag:"div",id:"day"+v+"_row"+u,cls:g,style:"height:"+(this.rowHeight)+"px;",html:y},true);this.gridCells[v].push(b);r++;if(r==this.rowsPerHour){r=0}}}this.gridX=0;this.gridY=0;this.gridContainer.on("scroll",this.storeScrollPosition,this);this.daysRendered=this.days;this.selector=Ext.DomHelper.append(this.body,{tag:"div",id:Ext.id(),cls:"x-calGrid-selector"},true);this.cacheGridCells();this.gridTableHeight=this.gridTable.getHeight()},cacheGridCells:function(){this.gridTable.xy=this.gridTable.getXY();var a=this.gridTable.getY();var b=this.gridCells[0][0].getSize();var k=this.gridCells[0][0].getXY();var j=k[0];var g=k[1]-a;for(var h=0;h<this.days;h++){var d=j+(h*b.width);for(var f=0;f<this.scale;f++){var c=g+(f*b.height);if(this.gridCells[h]){this.gridCells[h][f].xy=[d,c];this.gridCells[h][f].size=b}else{alert("error")}}}var e=this.gridCells[0][0];this.snapCol={x:e.size["width"],y:e.size["height"]}},autoSizeGrid:function(){var b=this.ownerCt.body.getHeight();var d=this.headingsTable.getHeight();var c=this.allDayTableContainer.getHeight();if(c>(b/2)){c=b/2;this.allDayTableContainer.setHeight(c)}var a=b-d-c-2;this.gridContainer.setHeight(a)},onResize:function(d,b,a,c){if(this.daysRendered==this.days){if(this.loaded){this.store.reload()}}},setStore:function(a,b){if(!b&&this.store){this.store.un("beforeload",this.mask,this);this.store.un("datachanged",this.reload)}if(a){a.on("beforeload",this.mask,this);a.on("datachanged",this.reload,this)}this.store=a},setStoreBaseParams:function(){this.store.baseParams.start_time=this.startDate.format(this.dateTimeFormat);this.store.baseParams.end_time=this.endDate.format(this.dateTimeFormat)},getFirstDateOfWeek:function(a){var b=a.getDay();var c=this.firstWeekday-b;if(c>0){c-=7}return a.add(Date.DAY,c)},mask:function(){if(this.rendered){this.body.mask(GO.lang.waitMsgLoad,"x-mask-loading")}},unmask:function(){if(this.rendered){this.body.unmask()}},getSnap:function(){return this.snapCol},getGridXY:function(){var a=Ext.get("day0_row0");return a.getXY()},getRowIdByXY:function(b,e){var a=this.getSnap();var c=(b-this.gridX)/a.x;var d=(e-this.gridY)/a.y;return"day"+c+"_row"+d},getRowNumberByY:function(c){var a=this.getSnap();var b=this.gridTable.getXY();return Math.floor((c-b[1])/a.y)},getDayByX:function(b){var a=this.getSnap();var c=this.gridTable.getXY();return Math.floor((b-c[0]-40)/a.x)},startSelection:function(d){if(this.writePermission&&!this.dragEvent){var c=d.getXY();this.clickedDay=this.getDayByX(c[0]);this.clickedRow=this.getRowNumberByY(c[1]);this.dragSnap=this.getSnap();this.selectorStartRow=this.gridCells[this.clickedDay][this.clickedRow];if(this.selectorStartRow){var b=this.gridTable.getY();var a=[this.selectorStartRow.xy[0],this.selectorStartRow.xy[1]+b];if(!this.overlay){this.overlay=this.body.createProxy({tag:"div",cls:"x-resizable-overlay",html:"&#160;"});this.overlay.unselectable();this.overlay.enableDisplayMode("block");this.overlay.on("mousemove",this.onSelectionMouseMove,this);this.overlay.on("mouseup",this.onSelectionMouseUp,this)}this.overlay.setSize(Ext.lib.Dom.getViewWidth(true),Ext.lib.Dom.getViewHeight(true));this.overlay.show();this.selector.setXY(a);this.selector.setSize(this.snapCol.x-3,this.snapCol.y);this.selector.setVisible(true,false)}}},onSelectionMouseMove:function(c){var d=c.getXY();var b=this.selector.getXY();var a=this.snap(d[1]-b[1],this.dragSnap.y,0);this.selector.setHeight(a)},onSelectionMouseUp:function(a){this.overlay.hide();this.fireEvent("create",this,this.domToTimes(this.selector.id));this.clearSelection()},getDayIndex:function(a){},addDaysGridEvent:function(q,c){var h=Date.parseDate(q.startDate.format("Ymd"),"Ymd");var a=Date.parseDate(q.endDate.format("Ymd"),"Ymd");var e=this.startDate.format("U");var j=h.format("U");var l,i,b,k;l=i=Math.round((j-e)/86400);if(l<0){l=0}var o=a.format("U");b=k=Math.round((o-e)/86400);if(b>this.days){b=this.days-1}if(l<this.days&&b>-1){var p=q.startDate.getHours()*this.rowsPerHour;var g=q.endDate.getHours()*this.rowsPerHour-1;var n=60/this.rowsPerHour;var d=q.startDate.getMinutes();p+=Math.ceil(d/n);var m=q.endDate.getMinutes();g+=Math.ceil(m/n);var f=p+this.minRows-1;if(g<f){g=f}if(p&&g&&(i==k)){return this.addGridEvent(q,l,p,g,c)}else{return this.addAllDayEvent(q,l,b)}}},getSelectedEvent:function(){if(this.selected){return this.elementToEvent(this.selected[0].id)}},isSelected:function(a){for(var b=0;b<this.selected.length;b++){if(this.selected[b].id==a){return true}}return false},clearEventSelection:function(){for(var a=0;a<this.selected.length;a++){this.selected[a].removeClass("x-calGrid-selected")}this.selected=[]},selectEventElement:function(a){if(!this.isSelected(a)){this.clearEventSelection();var d=this.getRelatedDomElements(a.id);for(var c=0;c<d.length;c++){var b=Ext.get(d[c]);b.addClass("x-calGrid-selected");this.selected.push(b)}}},removeEvent:function(e){if(this.appointmentsMap[e]&&this.appointments[this.appointmentsMap[e].day]){var a=this.appointmentsMap[e].day;var f=[];for(var b=0;b<this.appointments[a].length;b++){if(this.appointments[a][b].id!=e){f.push(this.appointments[a][b])}}this.appointments[a]=f}else{if(this.allDayAppointmentsMap[e]&&this.appointments[this.allDayAppointmentsMap[e].day]){var a=this.allDayAppointmentsMap[e];var f=[];for(var b=0;b<this.appointments[a].length;b++){if(this.appointments[a][b].id!=e){f.push(this.appointments[a][b])}}this.allDayAppointmentsMap[a]=f}}var d=this.getRelatedDomElements(e);if(d){for(var b=0;b<d.length;b++){var c=Ext.get(d[b]);if(c){c.removeAllListeners();c.remove()}this.unregisterDomId(d[b])}}if(a){this.calculateAppointments(a)}},unregisterDomId:function(d){delete this.remoteEvents[d];delete this.appointmentsMap[d];var b=false;for(var c in this.domIds){for(var a=0;a<this.domIds[c].length;a++){if(this.domIds[c][a]==d){this.domIds[c].splice(a,1);b=true;break}}if(b){break}}},addAllDayEvent:function(h,e,b){h.allDay=true;h.daySpan=b-e+1;if(e<0){e=0}if(b>this.days-1){b=this.days-1}var j="";if(e!=b){var g=GO.settings.date_format+" "+GO.settings.time_format;j=h.startDate.format(g)+"&nbsp;"+h.name}else{j=h.name}var f=b-e;for(var d=e;d<=b;d++){var c=Ext.id();this.registerEvent(c,h);if(f>0){if(!this.domIds[h.id]){this.domIds[h.id]=[]}this.domIds[h.id].push(c)}var a=Ext.DomHelper.append(this.allDayColumns[d],{tag:"div",id:c,cls:"x-calGrid-all-day-event-container",style:"background-color:#"+h.background,html:j,qtip:GO.calendar.formatQtip(h),qtitle:h.name},true);if(typeof(this.allDayAppointments[d])=="undefined"){this.allDayAppointments[d]=Array()}this.allDayAppointments[d].push(a);this.allDayAppointmentsMap[c]=d;a.on("mousedown",function(k,i){i=Ext.get(i).findParent("div.x-calGrid-all-day-event-container",2,true);this.selectEventElement(i);this.clickedEventId=i.id;this.eventMouseUp=false;this.startAllDayEventDrag(k,i.id)},this);a.on("dblclick",function(m,i){var k={};var l=this.elementToEvent(this.clickedEventId);if(this.remoteEvents[this.clickedEventId]["repeats"]&&this.writePermission){this.handleRecurringEvent("eventDblClick",l,k)}else{this.fireEvent("eventDblClick",this,l,k)}},this);a.on("mouseup",function(){this.eventMouseUp=true},this)}return c},addGridEvent:function(l,j,m,h,b){var o='<span class="x-calGrid-event-time">'+l.startDate.format(GO.settings.time_format)+"</span>&nbsp;"+l.name;if(l.location!=""){o+=" @ "+l.location}var e=Ext.id();this.registerEvent(e,l);var f=this.getSnap();if(h>(this.scale-1)){h=this.scale-1}var a=this.gridContainer.insertFirst({tag:"div",id:e,cls:"x-calGrid-event-container",style:"background-color:#"+l.background,qtip:GO.calendar.formatQtip(l),qtitle:l.name,html:o});a.repeats=l.repeats;var i=Ext.get("day"+j+"_row"+m);var c=Ext.get("day"+j+"_row"+h);var d=i.getXY();var g=c.getXY();var n=g[1]-d[1]+f.y;a.setXY(d);a.setSize(f.x-2,n);a.on("mousedown",function(q,p){p=Ext.get(p).findParent("div.x-calGrid-event-container",4,true);this.selectEventElement(p);this.clickedEventId=p.id;this.eventMouseUp=false;this.startEventDrag(q,p.id)},this);a.on("dblclick",function(s,p){var q={};var r=this.elementToEvent(this.clickedEventId);if(this.remoteEvents[this.clickedEventId]["repeats"]&&this.writePermission){this.handleRecurringEvent("eventDblClick",r,q)}else{this.fireEvent("eventDblClick",this,r,q)}},this);a.on("mouseup",function(){this.eventMouseUp=true},this);if(typeof(this.appointments[j])=="undefined"){this.appointments[j]=Array()}this.appointments[j].push(a);this.appointmentsMap[e]={day:j};if(this.writePermission&&!l["private"]){var k=new Ext.Resizable(a,{handles:"s",minHeight:f.y,maxWidth:a.getWidth(),heightIncrement:f.y,draggable:false,pinned:true});k.on("resize",function(r,t,x,y,u){if(x>0){var q=this.domToTimes(r.el.id,false);var s=q.startDate.format("U");var w=q.endDate.format("U");var z={duration:w-s,dragDate:this.remoteEvents[r.el.id].startDate};var p=this.elementToEvent(r.el.id);var v=r.el.getX();this.clickedDay=this.getDayByX(v);if(this.remoteEvents[r.el.id]["repeats"]){p.day=this.clickedDay;this.handleRecurringEvent("eventResize",p,z)}else{this.resizeAppointment(r.el.id,this.clickedDay);this.fireEvent("eventResize",this,p,z)}}},this)}if(b){this.calculateAppointments(j)}return e},resizeAppointment:function(c,a){var b=this.findAppointment(a,c);this.appointments[a][b].size=this.appointments[a][b].getSize();this.remoteEvents[c].repeats=false;this.calculateAppointments(a)},calculateAppointments:function(o){if(typeof(this.appointments[o])!="undefined"){var k=this.getSnap();var q=this.gridTable.getY();var h=0;var e=Array();var h=0;this.appointments[o].sort(function(n,i){return n.getY()-i.getY()});var g=0;this.rows=Array();for(var f=0;f<this.scale;f++){var c=this.gridCells[o][f];var t=c.xy[1];if(f==0){g=c.xy[0]}if(typeof(this.rows[f])=="undefined"){this.rows[f]=Array()}for(var p=0;p<this.appointments[o].length;p++){if(!this.appointments[o][p].xy){this.appointments[o][p].xy=this.appointments[o][p].getXY();this.appointments[o][p].xy[1]-=q}if(!this.appointments[o][p].size){this.appointments[o][p].size=this.appointments[o][p].getSize()}var r=this.appointments[o][p].xy;var d=this.appointments[o][p].size;if((c.xy[0]+c.size.width)>=r[0]&&c.xy[0]<=r[0]+d.width&&t+c.size.height<=r[1]+d.height&&t+c.size.height>r[1]){if(typeof(e[this.appointments[o][p].id])=="undefined"){var s=0;while(typeof(this.rows[f][s])!="undefined"){s++}eventRowId=f;for(var l=t;l<r[1]+d.height-3;l+=k.y){if(typeof(this.rows[eventRowId])=="undefined"){this.rows[eventRowId]=Array()}this.rows[eventRowId][s]=this.appointments[o][p].id;eventRowId++}this.rows[f][s]=this.appointments[o][p].id;e[this.appointments[o][p].id]=s}}}if(s>h){h=s}}var b=k.x/(h+1);for(var p=0;p<this.appointments[o].length;p++){if(!this.appointments[o][p].xy){this.appointments[o][p].xy=this.appointments[o][p].getXY();this.appointments[o][p].xy[1]-=q}if(!this.appointments[o][p].size){this.appointments[o][p].size=this.appointments[o][p].getSize()}var r=this.appointments[o][p].xy;var d=this.appointments[o][p].size;var f=Math.floor(r[1]/k.y);var m=(d.height-2)/k.y;var j=this.getEventWidth(e[this.appointments[o][p].id],h,f,m,b);this.appointments[o][p].setWidth(j);var a=e[this.appointments[o][p].id]*b;this.appointments[o][p].setX(g+a)}}},getEventWidth:function(e,b,a,g,d){var h=d;var c=e+1;while(c<=b){for(var f=0;f<g;f++){if(typeof(this.rows[a+f][c])!="undefined"){return h-2}}h+=d;c++}return h-2},inAppointmentsArray:function(c,b){for(var a=0;a<b.length;a++){if(b[a].id==c){return true}}return false},clearSelection:function(){this.selector.setVisible(false)},handleRecurringEvent:function(a,c,b){this.currentRecurringEvent=c;this.currentFireEvent=a;this.currentActionData=b;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,closable:false,title:GO.calendar.lang.recurringEvent,modal:false,html:GO.calendar.lang.editRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){this.currentActionData.singleInstance=true;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);if(!this.currentRecurringEvent.allDay){if(this.currentFireEvent=="eventResize"){this.resizeAppointment(this.currentRecurringEvent.domId,this.currentRecurringEvent.day)}else{if(this.currentFireEvent=="move"){this.moveAppointment(this.currentRecurringEvent.domId,this.currentRecurringEvent.oldPos,this.currentRecurringEvent.newPos)}}}this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){this.currentActionData.singleInstance=false;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()},snapPos:function(d,e,b){var f=e-d;var c=Math.floor(f/b);var g=f-(c*b);var a=b/2;if(g>a){c++}return d+(c*b)},snap:function(c,e,b){if(!e||!c){return c}var d=c;var a=c%e;if(a>0){if(a>(e/2)){d=c+(e-a)}else{d=c-a}}return Math.max(b,d)},clearGrid:function(){this.allDayAppointmentsMap={};this.appointmentsMap={};this.appointments={};this.allDayAppointments=Array();this.remoteEvents=Array();this.domIds=Array()},next:function(a){if(!a){a=this.days}this.setDate(this.startDate.add(Date.DAY,a))},setDays:function(b,a){this.setDate(this.configuredDate,b,a)},setDate:function(a,e,d){var c=this.startDate;var b=this.endDate;if(e){this.days=e}this.configuredDate=a;if(this.days>4){this.startDate=this.getFirstDateOfWeek(a)}else{this.startDate=a}this.endDate=this.startDate.add(Date.DAY,this.days);this.setStoreBaseParams();if(d){this.store.reload()}},reload:function(){this.load()},load:function(){var c=this.store.getRange();this.writePermission=this.store.reader.jsonData.write_permission;this.clearGrid();this.renderDaysGrid();for(var d=0,b=c.length;d<b;d++){var a=Date.parseDate(c[d].data.start_time,this.dateTimeFormat);var f=Date.parseDate(c[d].data.end_time,this.dateTimeFormat);var e=c[d].data;e.startDate=a;e.endDate=f;this.addDaysGridEvent(e)}this.autoSizeGrid();this.scrollToLastPosition();for(var d=0;d<this.days;d++){this.calculateAppointments(d)}this.unmask();this.loaded=true},registerEvent:function(b,a){this.remoteEvents[b]=a},setNewEventId:function(b,a){this.remoteEvents[b].event_id=a},getEventDomElements:function(a){return GO.util.clone(this.domIds[a])},getRelatedDomElements:function(c){var b=this.remoteEvents[c];if(!b){return false}var a=this.getEventDomElements(b.id);if(!a){a=[c]}return a},elementToEvent:function(a,b){var c=this.domToTimes(a,b);this.remoteEvents[a]["domId"]=a;this.remoteEvents[a]["startDate"]=c.startDate;this.remoteEvents[a]["endDate"]=c.endDate;return this.remoteEvents[a]},domToTimes:function(d,k){if(!k){k=false}var b=Ext.get(d);if(!b){return false}var f=b.getXY();if(!k){var l=b.getSize();var j=this.getRowNumberByY(f[1]);if(j<0){j=0}var e=this.getRowNumberByY(f[1]+l.height);if(e<=j){e=j+1}}else{j=0;e=0}var h=this.getDayByX(f[0]);var c=this.startDate.add(Date.DAY,h);var i=60/this.rowsPerHour;var a=c.add(Date.MINUTE,j*i);var g=c.add(Date.MINUTE,e*i);return{startDate:a,endDate:g,day:h}},scrollToRow:function(b){var a=this.getSnap();if(!a){return false}this.gridContainer.scrollTo("top",a.y*b)},scrollToLastPosition:function(){if(this.gridContainer){if(this.scrollPosition&&this.scrollPosition.top>0){this.gridContainer.scrollTo("top",this.scrollPosition.top)}else{this.scrollToRow(7*this.rowsPerHour)}}},storeScrollPosition:function(b,a){var c=Ext.get(a).getScroll();if(c.top>0){this.scrollPosition=Ext.get(a).getScroll()}},onShow:function(){GO.grid.CalendarGrid.superclass.onShow.call(this);this.scrollToLastPosition()},startEventDrag:function(b,a){if(this.writePermission&&!this.eventMouseUp){this.dragClickEventPosition=b.getXY();this.originalEvent=this.elementToEvent(a);if(!this.originalEvent["private"]){this.dragEvent=Ext.get(a);this.dragEvent.size=this.dragEvent.getSize();this.dragappointmentstartPos=this.dragEvent.getXY();this.dragXoffset=this.dragClickEventPosition[0]-this.dragappointmentstartPos[0];this.dragYoffset=this.dragClickEventPosition[1]-this.dragappointmentstartPos[1];this.lastDragX=this.dragappointmentstartPos[0];this.lastDragY=this.dragappointmentstartPos[1];this.dragSnap=this.getSnap();this.columnsContainerY=this.gridTable.getY()}}},onEventDragMouseMove:function(h){if(this.dragEvent){var g=h.getXY();var a=this.snapPos(this.dragappointmentstartPos[0],g[0]-this.dragXoffset,this.dragSnap.x,this.days);var i=this.snapPos(this.dragappointmentstartPos[1],g[1]-this.dragYoffset,this.dragSnap.y,this.scale);var f=this.columnsContainerY-4;var b=this.gridCells[0][0].xy[0]-4;var d=this.columnsContainerY+this.gridTableHeight-this.dragEvent.size.height+5;var c=this.gridCells[this.days-1][47].xy[0]+4;if(a!=this.lastDragX&&a<c&&a>b){this.lastDragX=a;this.dragEvent.setX(a)}if(i!=this.lastDragY&&i<d&&i>f){this.lastDragY=i;this.dragEvent.setY(i)}}},onEventDragMouseUp:function(g){if(this.dragEvent){var h=this.dragEvent.getXY();if(h[0]!=this.dragappointmentstartPos[0]||h[1]!=this.dragappointmentstartPos[1]){var a=this.domToTimes(this.dragEvent.id,false);var i=a.startDate.format("U");var d=this.remoteEvents[this.dragEvent.id].startDate.format("U");var j={offset:i-d,dragDate:this.remoteEvents[this.dragEvent.id].startDate};var b=this.elementToEvent(this.dragEvent.id);var f=Ext.get(this.dragEvent.id);var c=f.select("span.x-calGrid-event-time");if(c){c.update(b.startDate.format(GO.settings.time_format));f.set({"ext:qtip":GO.calendar.formatQtip(b)})}if(this.remoteEvents[this.dragEvent.id]["repeats"]){b.oldPos=this.dragappointmentstartPos;b.newPos=h;this.handleRecurringEvent("move",b,j)}else{this.moveAppointment(this.dragEvent.id,this.dragappointmentstartPos,h);this.fireEvent("move",this,b,j)}}this.dragEvent=false}},findAppointment:function(a,c){for(var b=0;b<this.appointments[a].length;b++){if(this.appointments[a][b].id==c){return b}}},moveAppointment:function(g,b,d){var e=this.getDayByX(b[0]);var f=this.getDayByX(d[0]);var a=this.gridTable.getY();var c=this.findAppointment(e,g);this.appointments[e][c].xy=d;this.appointments[e][c].xy[1]-=a;this.appointments[e][c].size=this.appointments[e][c].getSize();this.remoteEvents[g].repeats=false;if(e!=f){if(!this.appointments[f]){this.appointments[f]=[]}this.appointments[f].push(this.appointments[e][c]);this.appointments[e].splice(c,1);this.calculateAppointments(e);this.calculateAppointments(f)}else{this.calculateAppointments(f)}},startAllDayEventDrag:function(b,a){if(!this.eventMouseUp&&this.writePermission){this.dragClickEventPosition=b.getXY();this.originalEvent=this.elementToEvent(a,true);this.allDayDragDate=this.originalEvent.startDate;if(!this.originalEvent["private"]){this.allDayDragEvent=Ext.get(a);this.allDayDragEvent.size=this.allDayDragEvent.getSize();this.dragappointmentstartPos=this.allDayDragEvent.getXY();this.currentDragDay=this.getDayByX(this.dragappointmentstartPos[0]+1);this.dragXoffset=this.dragClickEventPosition[0]-this.dragappointmentstartPos[0];this.dragSnap=this.getSnap()}}},currentDragDay:false,onAllDayEventDragMouseMove:function(d){if(this.allDayDragEvent){var c=d.getXY();var a=this.snapPos(this.dragappointmentstartPos[0],c[0]-this.dragXoffset,this.dragSnap.x,this.days);var b=this.getDayByX(c[0]+1);if(this.currentDragDay!=b&&this.allDayColumns[b]){this.currentDragDay=b;this.allDayColumns[b].appendChild(this.allDayDragEvent)}}},onAllDayEventDragMouseUp:function(g){if(this.allDayDragEvent){var c=g.getXY();if(c[0]!=this.dragappointmentstartPos[0]){var a=this.getDayByX(this.dragappointmentstartPos[0]+1);var b=this.getDayByX(c[0]+1);if(a!=b&&this.allDayColumns[b]){var h=b-a;var f=this.elementToEvent(this.allDayDragEvent.id,true);var d={offsetDays:h,dragDate:this.allDayDragDate};if(this.remoteEvents[this.allDayDragEvent.id]["repeats"]){this.handleRecurringEvent("move",f,d)}else{this.fireEvent("move",this,f,d);this.removeEvent(this.allDayDragEvent.id);f.startDate=Date.parseDate(f.start_time,this.dateTimeFormat).add(Date.DAY,h);f.endDate=Date.parseDate(f.end_time,this.dateTimeFormat).add(Date.DAY,h);f.start_time=f.startDate.format(this.dateTimeFormat);f.end_time=f.endDate.format(this.dateTimeFormat);this.addDaysGridEvent(f)}}this.autoSizeGrid()}this.allDayDragEvent=false}}});GO.grid.MonthGrid=Ext.extend(Ext.Panel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,dragEvent:false,appointments:Array(),remoteEvents:Array(),domIds:Array(),days:1,selected:Array(),writePermission:false,scrollOffset:22,gridEvents:{},weekNumberWidth:16,initComponent:function(){this.autoScroll=true;this.addEvents({showday:true,create:true,move:true,eventResize:true,eventDblClick:true});if(this.store){this.setStore(this.store,true)}if(!this.startDate){var a=new Date();this.startDate=Date.parseDate(a.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate;GO.grid.MonthGrid.superclass.initComponent.call(this)},afterRender:function(){GO.grid.MonthGrid.superclass.afterRender.call(this);this.setDate(this.startDate,false);this.body.unselectable();this.setStore(this.store);this.initDD()},renderMonthView:function(){this.body.update("");var k=this.configuredDate.format("Ym");var d=new Date();var g=d.format("Ymd");var l=0;var h="";var a;this.cellWrap=Ext.DomHelper.append(this.body,{tag:"div"},true);this.gridCells={};this.weekNumberCells=[];for(var n=0;n<this.days;n++){var e=this.startDate.add(Date.DAY,n);if(n==0||e.format("j")==1){a="j F"}else{a="j"}var j=e.format("w");var o=e.format("Ym");var f=e.format("Ymd");if(j==this.firstWeekday){var m=e.format("W");var p=Ext.DomHelper.append(this.cellWrap,{tag:"div",style:"width:"+(this.weekNumberWidth-1)+"px",cls:"cal-monthgrid-week-no"},true);var c=Ext.DomHelper.append(p,{tag:"a",cls:"x-monthGrid-cell-day-text",href:"#",id:"wl-"+f,html:m},true);c.on("click",this.onWeekClick,this);this.weekNumberCells.push(p)}if(f==g){h="cal-monthGrid-cell x-monthGrid-cell-today"}else{if(o==k&&(j==0||j==6)){h="cal-monthGrid-cell x-monthGrid-cell-weekend"}else{if(o==k){h="cal-monthGrid-cell x-monthGrid-cell-current"}else{h="cal-monthGrid-cell"}}}var b="d"+f;var p=Ext.DomHelper.append(this.cellWrap,{tag:"div",id:b,cls:h},true);var i=Ext.DomHelper.append(p,{tag:"a",cls:"x-monthGrid-cell-day-text",href:"#",html:e.format(a)},true);i.on("click",this.onAddClick,this);this.gridCells[f]=p}this.syncSize()},onMoreClick:function(d,c){var a=Ext.get(c).findParent("div.cal-monthGrid-cell",3);var b=Date.parseDate(a.id.substring(1,a.id.length),"Ymd");this.fireEvent("changeview",this,1,b)},onWeekClick:function(c,b){var a=Date.parseDate(b.id.substring(3,b.id.length),"Ymd");this.fireEvent("changeview",this,7,a)},onAddClick:function(d,c){var a=Ext.get(c).findParent("div.cal-monthGrid-cell",3);var b=Date.parseDate(a.id.substring(1,a.id.length),"Ymd");this.fireEvent("create",this,b)},onResize:function(d,b,a,c){Ext.grid.GridPanel.superclass.onResize.apply(this,arguments);this.syncSize();this.checkOverflow()},calcCellSize:function(b,a){this.cellHeight=(b.height/(this.days/7));if(this.cellHeight<100){this.cellHeight=100;if(!a){b.width-=this.scrollOffset}}this.cellWidth=((b.width-this.weekNumberWidth)/7);if(this.cellWidth<100){this.cellWidth=100;b.height-=this.scrollOffset;if(!a){this.calcCellSize(b,true)}}this.cellHeight=Math.floor(this.cellHeight);this.cellWidth=Math.floor(this.cellWidth)},checkOverflow:function(){if(this.overflowIndicators){for(var a=0;a<this.overflowIndicators.length;a++){this.overflowIndicators[a].remove()}}this.overflowIndicators=[];for(var a in this.gridCells){if(this.gridCells[a].dom.scrollHeight>this.gridCells[a].dom.clientHeight){var b=Ext.DomHelper.append(this.gridCells[a],{tag:"a",cls:"cal-overflow-indicator",href:"#",html:GO.lang.more+"..."},true);b.on("click",this.onMoreClick,this);var c=this.gridCells[a].getXY();b.setXY(c);this.overflowIndicators.push(b)}}},syncSize:function(){if(this.cellWrap){var b=this.container.getSize(true);this.calcCellSize(b);this.cellWrap.setSize(this.cellWidth*7+this.weekNumberWidth,this.cellHeight*(this.days/7));for(var a in this.gridCells){this.gridCells[a].setSize(this.cellWidth,this.cellHeight)}for(var a=0;a<this.weekNumberCells.length;a++){this.weekNumberCells[a].setHeight(this.cellHeight)}for(var c in this.gridEvents){for(var a=0;a<this.gridEvents[c].length;a++){this.gridEvents[c][a].setWidth(this.cellWidth-3)}}}},initDD:function(){var a=new GO.calendar.dd.MonthDragZone(this.body,{ddGroup:"month-grid",scroll:false,monthGrid:this});var b=new GO.calendar.dd.MonthDropTarget(this.body,{ddGroup:"month-grid",onNotifyDrop:function(c,i,h){var j=h.dragDate.format("U");var g=h.dropDate.format("U");offsetDays=Math.round((g-j)/86400);var f={offsetDays:offsetDays,dragDate:h.dragDate};var d=this.elementToEvent(h.item.id);if(d.repeats){this.handleRecurringEvent("move",d,f)}else{this.fireEvent("move",this,d,f);this.removeEvent(d.domId);delete d.domId;d.repeats=false;d.startDate=d.startDate.add(Date.DAY,offsetDays);d.endDate=d.endDate.add(Date.DAY,offsetDays);d.start_time=d.startDate.format("U");d.end_time=d.endDate.format("U");this.addMonthGridEvent(d)}},scope:this})},setStore:function(a,b){if(!b&&this.store){this.store.un("beforeload",this.reload);this.store.un("datachanged",this.reload);this.store.un("clear",this.reload)}if(a){a.on("beforeload",this.mask,this);a.on("datachanged",this.reload,this);a.on("clear",this.reload,this)}this.store=a},setStoreBaseParams:function(){this.store.baseParams.start_time=this.startDate.format(this.dateTimeFormat);this.store.baseParams.end_time=this.endDate.format(this.dateTimeFormat)},getFirstDateOfWeek:function(a){var b=a.getDay();if(b<this.firstWeekday){b=7}return a.add(Date.DAY,this.firstWeekday-b)},mask:function(){if(this.rendered){this.body.mask(GO.lang.waitMsgLoad,"x-mask-loading")}},unmask:function(){if(this.rendered){this.body.unmask()}},getSelectedEvent:function(){if(this.selected){return this.elementToEvent(this.selected[0].id)}},isSelected:function(a){for(var b=0;b<this.selected.length;b++){if(this.selected[b].id==a){return true}}return false},clearSelection:function(){for(var a=0;a<this.selected.length;a++){this.selected[a].removeClass("x-calGrid-selected")}this.selected=[]},selectEventElement:function(a){if(!this.isSelected(a)){this.clearSelection();var d=this.getRelatedDomElements(a.id);for(var c=0;c<d.length;c++){var b=Ext.get(d[c]);if(b){b.addClass("x-calGrid-selected");this.selected.push(b)}}}},addMonthGridEvent:function(l){var g=Date.parseDate(l.startDate.format("Ymd"),"Ymd");var b=Date.parseDate(l.endDate.format("Ymd"),"Ymd");var h=g.format("U");var k=b.format("U");var j=Math.round((k-h)/86400)+1;for(var f=0;f<j;f++){var e=g.add(Date.DAY,f);l.domId=Ext.id();if(j>1){if(!this.domIds[l.id]){this.domIds[l.id]=[]}this.domIds[l.id].push(l.domId)}var c=Ext.get("d"+e.format("Ymd"));if(c){var m="";if(l.startDate.format("G")!="0"){m+=l.startDate.format(GO.settings.time_format)+"&nbsp;"}m+=l.name;var a=Ext.DomHelper.append(c,{tag:"div",id:l.domId,cls:"x-calGrid-month-event-container",style:"background-color:#"+l.background+";width:"+(this.eventWidth)+"px",html:m,qtip:GO.calendar.formatQtip(l),qtitle:l.name},true);var d=e.format("Ymd");if(!this.gridEvents[d]){this.gridEvents[d]=[]}this.gridEvents[d].push(a);this.registerEvent(l.domId,l);a.on("mousedown",function(n,i){i=Ext.get(i).findParent("div.x-calGrid-month-event-container",2,true);this.selectEventElement(i);this.clickedEventId=i.id},this);a.on("dblclick",function(o,i){i=Ext.get(i).findParent("div.x-calGrid-month-event-container",2,true);var n=this.elementToEvent(this.clickedEventId);if(n.repeats&&this.writePermission){this.handleRecurringEvent("eventDblClick",n,{})}else{this.fireEvent("eventDblClick",this,n,{singleInstance:this.writePermission})}},this)}}if(!this.loading){this.checkOverflow()}return l.domId},removeEvent:function(d){var c=this.getRelatedDomElements(d);if(c){for(var a=0;a<c.length;a++){var b=Ext.get(c[a]);if(b){b.removeAllListeners();b.remove()}this.unregisterDomId(c[a])}}this.checkOverflow()},unregisterDomId:function(d){delete this.remoteEvents[d];var b=false;for(var c in this.domIds){for(var a=0;a<this.domIds[c].length;a++){if(this.domIds[c][a]==d){this.domIds[c].splice(a,1);b=true;break}}if(b){break}}},setNewEventId:function(b,a){this.remoteEvents[b].event_id=a},handleRecurringEvent:function(a,c,b){this.currentRecurringEvent=c;this.currentFireEvent=a;this.currentActionData=b;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,title:GO.calendar.lang.recurringEvent,modal:false,html:GO.calendar.lang.editRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){this.currentActionData.singleInstance=true;var d=this.currentRecurringEvent;this.fireEvent(this.currentFireEvent,this,d,this.currentActionData);if(this.currentActionData.offsetDays){this.removeEvent(d.domId);d.repeats=false;d.startDate=d.startDate.add(Date.DAY,offsetDays);d.endDate=d.endDate.add(Date.DAY,offsetDays);d.start_time=d.startDate.format("U");d.end_time=d.endDate.format("U");this.addMonthGridEvent(d)}this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){this.currentActionData.singleInstance=false;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()},clearGrid:function(){this.gridEvents={};this.appointments=Array();this.remoteEvents=Array();this.domIds=Array()},setDate:function(c,h){var d=this.startDate;var f=this.endDate;this.configuredDate=c;var i=c.getFirstDateOfMonth();var g=c.getLastDateOfMonth();this.startDate=this.getFirstDateOfWeek(i);var b=this.startDate.format("U");var e=g.format("U");var a=((e-b)/86400)+1;var j=Math.ceil(a/7);this.days=j*7;this.endDate=this.startDate.add(Date.DAY,this.days);this.setStoreBaseParams();if(!f||!d||f.getElapsed(this.endDate)!=0||d.getElapsed(this.startDate)!=0){if(h){this.store.reload()}else{this.loadRequired=true}}},reload:function(){this.load()},load:function(){if(this.rendered){this.loading=true;this.clearGrid();this.renderMonthView();this.writePermission=this.store.reader.jsonData.write_permission;var c=this.store.getRange();for(var d=0,b=c.length;d<b;d++){var a=Date.parseDate(c[d].data.start_time,this.dateTimeFormat);var f=Date.parseDate(c[d].data.end_time,this.dateTimeFormat);var e=c[d].data;e.startDate=a;e.endDate=f;this.addMonthGridEvent(e)}this.checkOverflow();this.unmask();this.loading=false;this.loadRequired=false}},registerEvent:function(b,a){this.remoteEvents[b]=a},getEventDomElements:function(a){return GO.util.clone(this.domIds[a])},getRelatedDomElements:function(c){var b=this.remoteEvents[c];if(!b){return false}var a=this.getEventDomElements(b.id);if(!a){a=[c]}return a},elementToEvent:function(a,b){this.remoteEvents[a]["domId"]=a;return this.remoteEvents[a]}});GO.calendar.dd.MonthDragZone=function(b,a){a=a||{};Ext.apply(a,{ddel:document.createElement("div")});GO.calendar.dd.MonthDragZone.superclass.constructor.call(this,b,a)};Ext.extend(GO.calendar.dd.MonthDragZone,Ext.dd.DragZone,{onInitDrag:function(c){if(!this.monthGrid.writePermission||this.monthGrid.remoteEvents[this.dragData.item.id]["private"]){return false}else{this.ddel.innerHTML=this.dragData.item.dom.innerHTML;this.ddel.className=this.dragData.item.dom.className;this.ddel.style.width=this.dragData.item.getWidth()+"px";this.proxy.update(this.ddel);this.eventDomElements=this.monthGrid.getRelatedDomElements(this.dragData.item.id);var d=Ext.get(this.dragData.item).findParent("div.cal-monthGrid-cell",3,true);this.eventProxies=[];this.proxyDragPos=0;for(var a=0;a<this.eventDomElements.length;a++){this.eventProxies.push(Ext.DomHelper.append(document.body,{tag:"div",id:Ext.id(),cls:"x-calGrid-month-event-proxy",style:"width:"+this.ddel.style.width+"px;"},true));if(this.eventDomElements[a]==this.dragData.item.id){this.proxyDragPos=a}else{var b=Ext.get(this.eventDomElements[a]);if(b){b.setStyle({position:"absolute",top:-10000,display:"none"})}}}}},removeEventProxies:function(){var a=Ext.query("div.x-calGrid-month-event-proxy");for(var b=0;b<a.length;b++){Ext.get(a[b]).remove()}delete this.lastTdOverId;for(var b=0;b<this.eventDomElements.length;b++){var c=Ext.get(this.eventDomElements[b]);if(c){c.setStyle({position:"static",top:"",display:"block"})}}},afterRepair:function(){GO.calendar.dd.MonthDragZone.superclass.afterRepair.call(this);this.removeEventProxies()},getRepairXY:function(b,a){a.item.highlight("#e8edff");return a.item.getXY()},getDragData:function(c){if(!this.monthGrid.writePermission){return false}else{var b=Ext.get(c.getTarget());var d=b.parent();var a=Date.parseDate(d.id.substr(1),"Ymd");if(b.hasClass("x-calGrid-month-event-container")&&!this.monthGrid.remoteEvents[b.id]["private"]){return{ddel:this.ddel,item:b,dragDate:a}}else{return false}}}});GO.calendar.dd.MonthDropTarget=function(b,a){GO.calendar.dd.MonthDropTarget.superclass.constructor.call(this,b,a)};Ext.extend(GO.calendar.dd.MonthDropTarget,Ext.dd.DropTarget,{notifyDrop:function(a,f,c){if(!this.scope.writePermission){return false}else{var d=Ext.get(f.getTarget()).findParent("div.cal-monthGrid-cell",3,true);c.dropDate=Date.parseDate(d.id.substr(1),"Ymd");a.removeEventProxies();this.el.removeClass(this.overClass);d.appendChild(c.item);if(this.onNotifyDrop){if(!this.scope){this.scope=this}var b=this.onNotifyDrop.createDelegate(this.scope);b.call(this,a,f,c)}return true}},notifyOver:function(b,h,g){var f=Ext.get(h.getTarget()).findParent("div.cal-monthGrid-cell",3,true);if(f){if(b.lastTdOverId!=f.id){var a=f;for(var c=0;c<b.proxyDragPos;c++){if(a){var d=a.prev("div.cal-monthGrid-cell");a=d}if(d){b.eventProxies[c].insertAfter(d.first());b.eventProxies[c].setStyle({position:"static",top:"",display:"block"})}else{b.eventProxies[c].setStyle({position:"absolute",top:-10000,display:"none"})}}b.eventProxies[c].insertAfter(f.first());var a=f;for(var c=b.proxyDragPos+1;c<b.eventProxies.length;c++){if(a){var d=a.next("div.cal-monthGrid-cell");a=d}if(d){b.eventProxies[c].insertAfter(d.first());b.eventProxies[c].setStyle({position:"static",top:"",display:"block"})}else{b.eventProxies[c].setStyle({position:"absolute",top:-10000,display:"none"})}}}b.lastTdOverId=f.id}return this.dropAllowed}});GO.calendar.ListGrid=function(b){if(!b){b={}}b.store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({totalProperty:"count",root:"results",id:"id",fields:["id","event_id","name","time","start_time","end_time","description","location","private","repeats","background","day"]}),baseParams:{task:"events"},proxy:new Ext.data.HttpProxy({url:GO.settings.modules.calendar.url+"json.php"}),groupField:"day",sortInfo:{field:"start_time",direction:"ASC"},remoteGroup:true});b.paging=false,b.autoExpandColumn="listview-calendar-name-heading";b.autoExpandMax=2500;b.enableColumnHide=false;b.enableColumnMove=false;b.autoScroll=true;b.columns=[{header:GO.lang.strDay,dataIndex:"day"},{header:GO.lang.strTime,dataIndex:"time",width:80,renderer:function(d,e,c){return'<div style="border:1px solid #c0c0c0;padding:2px;margin:2px;background-color:#'+c.data.background+';">'+d+"</div>"}},{id:"listview-calendar-name-heading",header:GO.lang.strName,dataIndex:"name",renderer:this.renderName}];b.view=new Ext.grid.GroupingView({hideGroupedColumn:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "'+GO.lang.items+'" : "'+GO.lang.item+'"]})',emptyText:GO.calendar.lang.noAppointmentsToDisplay,showGroupName:false});b.sm=new Ext.grid.RowSelectionModel({singleSelect:true});b.loadMask=true;GO.calendar.ListGrid.superclass.constructor.call(this,b);if(!this.startDate){var a=new Date();this.startDate=Date.parseDate(a.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate};Ext.extend(GO.calendar.ListGrid,Ext.grid.GridPanel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,days:7,renderName:function(b,c,a){return'<div style="font-weight:bold;">'+a.data.name+"</div>"+GO.calendar.formatQtip(a.data)},afterRender:function(){GO.calendar.ListGrid.superclass.afterRender.call(this);this.on("rowdblclick",function(b,d,c){var a=b.getStore().getAt(d);GO.calendar.eventDialog.show({event_id:a.data.event_id})},this)},getFirstDateOfWeek:function(a){var b=a.getDay();var c=this.firstWeekday-b;if(c>0){c-=7}return a.add(Date.DAY,c)},setDays:function(b,a){this.setDate(this.configuredDate,7,a)},getSelectedEvent:function(){var c=this.getSelectionModel();var a=c.getSelected();var b=a.data;b.startDate=Date.parseDate(b.start_time,this.dateTimeFormat);b.endDate=Date.parseDate(b.end_time,this.dateTimeFormat);return b},removeEvent:function(){var b=this.getSelectionModel();var a=b.getSelected();this.store.remove(a)},setDate:function(a,e,d){var c=this.startDate;var b=this.endDate;this.configuredDate=a;if(this.days>4){this.startDate=this.getFirstDateOfWeek(a)}else{this.startDate=a}this.endDate=this.startDate.add(Date.DAY,this.days);this.setStoreBaseParams();if(d){this.store.reload()}},setStoreBaseParams:function(){this.store.baseParams.start_time=this.startDate.format(this.dateTimeFormat);this.store.baseParams.end_time=this.endDate.format(this.dateTimeFormat)}});GO.grid.ViewGrid=Ext.extend(Ext.Panel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,dragEvent:false,appointments:Array(),remoteEvents:Array(),domIds:Array(),days:1,selected:Array(),view_id:0,gridCells:Array(),initComponent:function(){GO.grid.ViewGrid.superclass.initComponent.call(this);this.addEvents({create:true,move:true,eventResize:true,eventDblClick:true,zoom:true});if(!this.startDate){var a=new Date();this.startDate=Date.parseDate(a.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate},setViewId:function(a){this.view_id=a},onRender:function(b,a){GO.grid.ViewGrid.superclass.onRender.apply(this,arguments);this.setDate(this.startDate,false);this.body.setStyle("overflow","hidden");this.body.unselectable();this.initDD()},renderView:function(){this.body.update("");var h=this.container.getSize(true);var c=(h.width-150)/this.days;this.headingsTable=Ext.DomHelper.append(this.body,{tag:"table",id:Ext.id(),cls:"x-calGrid-headings-table",style:"width:"+h.width+"px;"},true);var f=Ext.DomHelper.append(this.headingsTable,{tag:"tbody"},true);this.headingsRow=Ext.DomHelper.append(f,{tag:"tr",children:{tag:"td",style:"width:147px",cls:"x-calGrid-heading"}},true);var e=GO.settings.date_format.indexOf("Y");var b="D "+GO.settings.date_format.substring(0,e-1);for(var j=0;j<this.days;j++){var d=this.startDate.add(Date.DAY,j);var n=Ext.DomHelper.append(this.headingsRow,{tag:"td",cls:"x-calGrid-heading",style:"width:"+(c)+"px",html:d.format(b)})}Ext.DomHelper.append(this.headingsRow,{tag:"td",style:"width:"+(this.scrollOffset-3)+"px;height:0px",cls:"x-calGrid-heading"});this.gridContainer=Ext.DomHelper.append(this.body,{tag:"div",cls:"x-calGrid-grid-container"},true);var m=this.headingsTable.getHeight();var a=h.height-m;this.gridContainer.setSize(h.width,a);this.gridTable=Ext.DomHelper.append(this.gridContainer,{tag:"table",id:Ext.id(),cls:"x-viewGrid-table",style:"width:"+h.width-this.scrollWidth+"px;"},true);this.tbody=Ext.DomHelper.append(this.gridTable,{tag:"tbody"},true);this.gridCells={};for(var g in this.jsonData){var k=Ext.DomHelper.append(this.tbody,{tag:"tr"});var l=Ext.DomHelper.append(k,{tag:"td",cls:"x-viewGrid-calendar-name-cell",style:"width:150px"},true);var i=Ext.DomHelper.append(l,{tag:"a",id:"view_cal_"+g,href:"#",cls:"normal-link",html:this.jsonData[g].name},true);i.on("click",function(p,o){p.preventDefault();this.fireEvent("zoom",{calendar_id:o.id.substring(9)})},this);this.gridCells[g]={};for(var j=0;j<this.days;j++){var d=this.startDate.add(Date.DAY,j);this.gridCells[g][d.format("Ymd")]=Ext.DomHelper.append(k,{tag:"td",id:"cal"+this.jsonData[g].id+"_day"+d.format("Ymd"),cls:"x-viewGrid-cell",style:"width:"+c+"px"},true)}}},removeEvent:function(d){var c=this.getRelatedDomElements(d);if(c){for(var a=0;a<c.length;a++){var b=Ext.get(c[a]);if(b){b.removeAllListeners();b.remove()}this.unregisterDomId(c[a])}}},unregisterDomId:function(d){delete this.remoteEvents[d];var b=false;for(var c in this.domIds){for(var a=0;a<this.domIds[c].length;a++){if(this.domIds[c][a]==d){this.domIds[c].splice(a,1);b=true;break}}if(b){break}}},setNewEventId:function(b,a){this.remoteEvents[b].event_id=a},initDD:function(){var a=new GO.calendar.dd.ViewDragZone(this.body,{ddGroup:"view-grid",scroll:false,viewGrid:this});var b=new GO.calendar.dd.ViewDropTarget(this.body,{ddGroup:"view-grid",onNotifyDrop:function(c,i,h){var k=h.dragDate.format("U");var g=h.dropDate.format("U");var j=Math.round((g-k)/86400);var f={offsetDays:j,dragDate:h.dragDate,calendar_id:h.calendar_id};var d=this.elementToEvent(h.item.id);if(d.repeats){this.handleRecurringEvent("move",d,f)}else{this.fireEvent("move",this,d,f);this.removeEvent(d.domId);delete d.domId;d.repeats=false;d.calendar_id=h.calendar_id;d.startDate=d.startDate.add(Date.DAY,j);d.endDate=d.endDate.add(Date.DAY,j);d.start_time=d.startDate.format("U");d.end_time=d.endDate.format("U");this.addViewGridEvent(d)}},scope:this})},onResize:function(d,b,a,c){if(this.viewGridTable){this.viewGridTable.setSize(d,b)}},getFirstDateOfWeek:function(a){var b=a.getDay();var c=this.firstWeekday-b;if(c>0){c-=7}return a.add(Date.DAY,c)},mask:function(){if(this.rendered){this.body.mask(GO.lang.waitMsgLoad,"x-mask-loading")}},unmask:function(){if(this.rendered){this.body.unmask()}},getSelectedEvent:function(){if(this.selected){return this.elementToEvent(this.selected[0].id)}},isSelected:function(a){for(var b=0;b<this.selected.length;b++){if(this.selected[b].id==a){return true}}return false},clearSelection:function(){for(var a=0;a<this.selected.length;a++){this.selected[a].removeClass("x-calGrid-selected")}this.selected=[]},selectEventElement:function(a){if(!this.isSelected(a)){this.clearSelection();var d=this.getRelatedDomElements(a.id);for(var c=0;c<d.length;c++){var b=Ext.get(d[c]);if(b){b.addClass("x-calGrid-selected");this.selected.push(b)}}}},addViewGridEvent:function(l){var g=Date.parseDate(l.startDate.format("Ymd"),"Ymd");var b=Date.parseDate(l.endDate.format("Ymd"),"Ymd");var h=g.format("U");var k=b.format("U");var j=Math.round((k-h)/86400)+1;for(var f=0;f<j;f++){var d=g.add(Date.DAY,f);var e=l.domId?l.domId:Ext.id();if(j>1){if(!this.domIds[l.id]){this.domIds[l.id]=[]}this.domIds[l.id].push(e)}var c=this.gridCells[l.calendar_id][d.format("Ymd")];if(c){var m="";if(l.startDate.format("G")!="0"){m+=l.startDate.format(GO.settings.time_format)+"&nbsp;"}m+=l.name;var a=Ext.DomHelper.append(c,{tag:"div",id:e,cls:"x-viewGrid-event-container",style:"background-color:#"+l.background,html:m,qtitle:l.name,qtip:GO.calendar.formatQtip(l)},true);this.registerEvent(e,l);a.on("mousedown",function(n,i){i=Ext.get(i).findParent("div.x-viewGrid-event-container",2,true);this.selectEventElement(i);this.clickedEventId=i.id},this);a.on("dblclick",function(o,i){i=Ext.get(i).findParent("div.x-viewGrid-event-container",2,true);var n=this.elementToEvent(this.clickedEventId);if(n.repeats&&n.write_permission){this.handleRecurringEvent("eventDblClick",n,{})}else{this.fireEvent("eventDblClick",this,n,{singleInstance:n.write_permission})}},this)}}return e},removeEventFromArray:function(a,c){for(var b=0;b<this.appointments[a].length;b++){if(this.appointments[a][b].id==c){return this.appointments[a].splice(b,1)}}return false},inAppointmentsArray:function(c,b){for(var a=0;a<b.length;a++){if(b[a].id==c){return true}}return false},handleRecurringEvent:function(a,c,b){this.currentRecurringEvent=c;this.currentFireEvent=a;this.currentActionData=b;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,title:GO.calendar.lang.recurringEvent,modal:false,html:GO.calendar.lang.deleteRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){this.currentActionData.singleInstance=true;var d=this.currentRecurringEvent;this.fireEvent(this.currentFireEvent,this,d,this.currentActionData);this.removeEvent(d.domId);d.calendar_id=this.currentActionData.calendar_id;d.repeats=false;d.startDate=d.startDate.add(Date.DAY,offsetDays);d.endDate=d.endDate.add(Date.DAY,offsetDays);d.start_time=d.startDate.format("U");d.end_time=d.endDate.format("U");this.addViewGridEvent(d);this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){this.currentActionData.singleInstance=false;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()},clearGrid:function(){this.appointments=Array();this.remoteEvents=Array();this.domIds=Array()},setDays:function(b,a){this.setDate(this.configuredDate,b,a)},setDate:function(a,e,d){var c=this.startDate;var b=this.endDate;if(e){this.days=e}this.configuredDate=a;if(this.days>4){this.startDate=this.getFirstDateOfWeek(a)}else{this.startDate=a}this.endDate=this.startDate.add(Date.DAY,this.days);if(d){this.reload()}},reload:function(){this.load()},load:function(a){if(!a){a={}}a.task="view_events";a.view_id=this.view_id;a.start_time=this.startDate.format(this.dateTimeFormat);a.end_time=this.endDate.format(this.dateTimeFormat);this.mask();Ext.Ajax.request({url:GO.settings.modules.calendar.url+"json.php",params:a,callback:function(c,h,b){if(!h){Ext.MessageBox.alert(GO.lang.strError,b.result.feedback)}else{this.jsonData=Ext.decode(b.responseText);this.clearGrid();this.renderView();for(var g in this.jsonData){var e=this.jsonData[g].events;for(var d=0;d<e.length;d++){var f=e[d];f.startDate=Date.parseDate(e[d]["start_time"],this.dateTimeFormat);f.endDate=Date.parseDate(e[d]["end_time"],this.dateTimeFormat);this.addViewGridEvent(f)}}}this.unmask()},scope:this})},registerEvent:function(b,a){this.remoteEvents[b]=a},getEventDomElements:function(a){return GO.util.clone(this.domIds[a])},getRelatedDomElements:function(c){var b=this.remoteEvents[c];if(!b){return false}var a=this.getEventDomElements(b.id);if(!a){a=[c]}return a},elementToEvent:function(a,b){this.remoteEvents[a].domId=a;return this.remoteEvents[a]}});GO.calendar.dd.ViewDragZone=function(b,a){a=a||{};Ext.apply(a,{ddel:document.createElement("div")});GO.calendar.dd.ViewDragZone.superclass.constructor.call(this,b,a)};Ext.extend(GO.calendar.dd.ViewDragZone,Ext.dd.DragZone,{onInitDrag:function(c){this.ddel.innerHTML=this.dragData.item.dom.innerHTML;this.ddel.className=this.dragData.item.dom.className;this.ddel.style.width=this.dragData.item.getWidth()+"px";this.proxy.update(this.ddel);this.eventDomElements=this.viewGrid.getRelatedDomElements(this.dragData.item.id);this.eventProxies=[];this.proxyDragPos=0;for(var a=0;a<this.eventDomElements.length;a++){this.eventProxies.push(Ext.DomHelper.append(document.body,{tag:"div",id:Ext.id(),cls:"x-viewGrid-event-proxy",style:"width:"+this.ddel.style.width+"px;"},true));if(this.eventDomElements[a]==this.dragData.item.id){this.proxyDragPos=a}else{var b=Ext.get(this.eventDomElements[a]);if(b){b.setStyle({position:"absolute",top:-10000,display:"none"})}}}},removeEventProxies:function(){var a=Ext.query("div.x-viewGrid-event-proxy");for(var b=0;b<a.length;b++){Ext.get(a[b]).remove()}delete this.lastTdOverId;for(var b=0;b<this.eventDomElements.length;b++){var c=Ext.get(this.eventDomElements[b]);if(c){c.setStyle({position:"static",top:"",display:"block"})}}},afterRepair:function(){GO.calendar.dd.ViewDragZone.superclass.afterRepair.call(this);this.removeEventProxies()},getRepairXY:function(b,a){a.item.highlight("#e8edff");return a.item.getXY()},getDragData:function(g){var f=Ext.get(g.getTarget());if(f.hasClass("x-viewGrid-event-container")){var h=f.parent();var a=h.id.indexOf("_day")+4;var d=h.id.substr(3,a-7);if(!this.viewGrid.remoteEvents[f.id]["private"]&&this.viewGrid.jsonData[d].write_permission){var b=h.id.substr(a);var c=Date.parseDate(b,"Ymd");return{ddel:this.ddel,item:f,dragDate:c}}return false}}});GO.calendar.dd.ViewDropTarget=function(b,a){GO.calendar.dd.ViewDropTarget.superclass.constructor.call(this,b,a)};Ext.extend(GO.calendar.dd.ViewDropTarget,Ext.dd.DropTarget,{notifyDrop:function(b,h,g){var i=Ext.get(h.getTarget()).findParent("td",10,true);if(!i){return false}var a=i.id.indexOf("_day")+4;var d=i.id.substr(3,a-7);if(!this.scope.jsonData[d]||!this.scope.jsonData[d].write_permission){return false}var c=i.id.substr(a);g.dropDate=Date.parseDate(c,"Ymd");g.calendar_id=i.id.substr(3,a-7);b.removeEventProxies();this.el.removeClass(this.overClass);i.appendChild(g.item);if(this.onNotifyDrop){if(!this.scope){this.scope=this}var f=this.onNotifyDrop.createDelegate(this.scope);f.call(this,b,h,g)}return true},notifyOver:function(h,f,b){var g=Ext.get(f.getTarget()).findParent("td.x-viewGrid-cell",10,true);if(g){var k=g.id.indexOf("_day");var d=g.id.substr(3,k-3);if(this.scope.jsonData[d]&&this.scope.jsonData[d].write_permission){if(h.lastTdOverId!=g.id){var j=g;for(var c=0;c<h.proxyDragPos;c++){if(j){var a=j.prev("td.x-viewGrid-cell");j=a}if(a){a.insertFirst(h.eventProxies[c].id);h.eventProxies[c].setStyle({position:"static",top:"",display:"block"})}else{h.eventProxies[c].setStyle({position:"absolute",top:-10000,display:"none"})}}g.insertFirst(h.eventProxies[c]);var j=g;for(var c=h.proxyDragPos+1;c<h.eventProxies.length;c++){if(j){var a=j.next("td.x-viewGrid-cell");j=a}if(a){a.insertFirst(h.eventProxies[c].id);h.eventProxies[c].setStyle({position:"static",top:"",display:"block"})}else{h.eventProxies[c].setStyle({position:"absolute",top:-10000,display:"none"})}}}h.lastTdOverId=g.id;return this.dropAllowed}}return false}});GO.calendar.CalendarDialog=function(a){if(!a){a={}}this.propertiesTab=new Ext.form.FormPanel({url:GO.settings.modules.calendar.url+"action.php",defaultType:"textfield",waitMsgTarget:true,title:GO.lang.strProperties,layout:"form",anchor:"100% 100%",defaultType:"textfield",autoHeight:true,cls:"go-form-panel",waitMsgTarget:true,labelWidth:75,items:[this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.modules.calendar["write_permission"],value:GO.settings.user_id,anchor:"100%"}),{fieldLabel:GO.lang.strName,name:"name",allowBlank:false,anchor:"100%"},this.exportButton=new Ext.Button({text:GO.lang.cmdExport,disabled:true,handler:function(){document.location=GO.settings.modules.calendar.url+"export.php?calendar_id="+this.calendar_id},scope:this})]});this.readPermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strReadPermissions});this.writePermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strWritePermissions});var b=new GO.form.UploadFile({inputName:"ical_file",max:1});b.on("filesChanged",function(d,c){this.importButton.setDisabled(c.getCount()==1)},this);this.importTab=new Ext.form.FormPanel({fileUpload:true,waitMsgTarget:true,disabled:true,title:GO.lang.cmdImport,items:[{xtype:"panel",html:GO.calendar.lang.selectIcalendarFile,border:false},b,this.importButton=new Ext.Button({xtype:"button",disabled:true,text:GO.lang.cmdImport,handler:function(){this.importTab.form.submit({waitMsg:GO.lang.waitMsgUpload,url:GO.settings.modules.calendar.url+"action.php",params:{task:"import",calendar_id:this.calendar_id},success:function(c,d){b.clearQueue();if(d.result.success){Ext.MessageBox.alert(GO.lang.strSuccess,d.result.feedback)}else{Ext.MessageBox.alert(GO.lang.strError,d.result.feedback)}},failure:function(c,d){Ext.MessageBox.alert(GO.lang.strError,d.result.feedback)},scope:this})},scope:this})],cls:"go-form-panel"});this.tabPanel=new Ext.TabPanel({hideLabel:true,deferredRender:false,xtype:"tabpanel",activeTab:0,border:false,anchor:"100% 100%",items:[this.propertiesTab,this.readPermissionsTab,this.writePermissionsTab,this.importTab]});GO.calendar.CalendarDialog.superclass.constructor.call(this,{title:GO.calendar.lang.calendar,layout:"fit",modal:false,height:500,width:450,closeAction:"hide",items:this.tabPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.calendar.CalendarDialog,Ext.Window,{initComponent:function(){this.addEvents({save:true});GO.calendar.CalendarDialog.superclass.initComponent.call(this)},show:function(a){if(!this.rendered){this.render(Ext.getBody())}this.propertiesTab.show();if(a>0){if(a!=this.calendar_id){this.loadCalendar(a)}else{GO.calendar.CalendarDialog.superclass.show.call(this)}}else{this.calendar_id=0;this.propertiesTab.form.reset();this.exportButton.setDisabled(true);this.importTab.setDisabled(true);this.readPermissionsTab.setDisabled(true);this.writePermissionsTab.setDisabled(true);GO.calendar.CalendarDialog.superclass.show.call(this)}},loadCalendar:function(a){this.propertiesTab.form.load({url:GO.settings.modules.calendar.url+"json.php",params:{calendar_id:a,task:"calendar"},waitMsg:GO.lang.waitMsgLoad,success:function(b,c){this.calendar_id=a;this.selectUser.setRawValue(c.result.data.user_name);this.readPermissionsTab.setAcl(c.result.data.acl_read);this.writePermissionsTab.setAcl(c.result.data.acl_write);this.exportButton.setDisabled(false);this.importTab.setDisabled(false);GO.calendar.CalendarDialog.superclass.show.call(this)},failure:function(b,c){Ext.Msg.alert(GO.lang.strError,c.result.feedback)},scope:this})},save:function(a){this.propertiesTab.form.submit({url:GO.settings.modules.calendar.url+"action.php",params:{task:"save_calendar",calendar_id:this.calendar_id},waitMsg:GO.lang.waitMsgSave,success:function(b,c){if(c.result.calendar_id){this.calendar_id=c.result.calendar_id;this.readPermissionsTab.setAcl(c.result.acl_read);this.writePermissionsTab.setAcl(c.result.acl_write);this.exportButton.setDisabled(false);this.importTab.setDisabled(false)}this.fireEvent("save");if(a){this.hide()}},failure:function(c,d){var b="";if(d.failureType=="client"){b=GO.lang.strErrorsInForm}else{b=d.result.feedback}Ext.MessageBox.alert(GO.lang.strError,b)},scope:this})}});GO.calendar.ViewDialog=function(b){if(!b){b={}}var a=new GO.grid.CheckColumn({header:GO.lang.strSelected,dataIndex:"selected",width:55});this.calendarsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"view_calendars",view_id:this.view_id},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name","selected"],remoteSort:true});this.calendarsGrid=new GO.grid.GridPanel({region:"center",layout:"fit",paging:false,border:false,plugins:a,store:this.calendarsStore,columns:[a,{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name"}],view:new Ext.grid.GridView({autoFill:true,forceFit:true}),sm:new Ext.grid.RowSelectionModel(),loadMask:true});this.propertiesTab=new Ext.Panel({title:GO.lang.strProperties,layout:"border",items:[new Ext.Panel({layout:"form",region:"north",height:70,defaultType:"textfield",defaults:{anchor:"100%"},cls:"go-form-panel",waitMsgTarget:true,labelWidth:75,border:false,items:[this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.modules.calendar["write_permission"]}),{fieldLabel:GO.lang.strName,name:"name",allowBlank:false}]}),this.calendarsGrid]});this.readPermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strReadPermissions});this.writePermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strWritePermissions});this.formPanel=new Ext.form.FormPanel({url:GO.settings.modules.calendar.url+"action.php",defaultType:"textfield",waitMsgTarget:true,border:false,items:[{hideLabel:true,deferredRender:false,xtype:"tabpanel",activeTab:0,border:false,anchor:"100% 100%",items:[this.propertiesTab,this.readPermissionsTab,this.writePermissionsTab]}]});GO.calendar.ViewDialog.superclass.constructor.call(this,{title:GO.lang.strView,layout:"fit",modal:false,height:500,width:400,closeAction:"hide",items:this.formPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.calendar.ViewDialog,Ext.Window,{initComponent:function(){this.addEvents({save:true});GO.calendar.ViewDialog.superclass.initComponent.call(this)},show:function(a){if(!this.rendered){this.render(Ext.getBody())}if(a>0){if(a!=this.view_id){this.loadView(a)}else{GO.calendar.ViewDialog.superclass.show.call(this)}}else{this.view_id=0;this.formPanel.form.reset();this.propertiesTab.show();this.readPermissionsTab.setDisabled(true);this.writePermissionsTab.setDisabled(true);this.calendarsStore.baseParams.view_id=0;this.calendarsStore.reload();GO.calendar.ViewDialog.superclass.show.call(this)}},loadView:function(a){this.formPanel.form.load({url:GO.settings.modules.calendar.url+"json.php",params:{view_id:a,task:"view"},waitMsg:GO.lang.waitMsgLoad,success:function(b,c){this.view_id=a;this.selectUser.setRawValue(c.result.data.user_name);this.readPermissionsTab.setAcl(c.result.data.acl_read);this.writePermissionsTab.setAcl(c.result.data.acl_write);this.calendarsStore.baseParams.view_id=a;this.calendarsStore.reload();GO.calendar.ViewDialog.superclass.show.call(this)},failure:function(b,c){Ext.Msg.alert(GO.lang.strError,c.result.feedback)},scope:this})},save:function(b){var c=[];for(var a=0;a<this.calendarsStore.data.items.length;a++){if(this.calendarsStore.data.items[a].get("selected")=="1"){c.push(this.calendarsStore.data.items[a].get("id"))}}this.formPanel.form.submit({url:GO.settings.modules.calendar.url+"action.php",params:{task:"save_view",view_id:this.view_id,view_calendars:Ext.encode(c)},waitMsg:GO.lang.waitMsgSave,success:function(d,e){if(e.result.view_id){this.view_id=e.result.view_id;this.readPermissionsTab.setAcl(e.result.acl_read);this.writePermissionsTab.setAcl(e.result.acl_write)}this.fireEvent("save");if(b){this.hide()}},failure:function(e,f){var d="";if(f.failureType=="client"){d=GO.lang.strErrorsInForm}else{d=f.result.feedback}Ext.MessageBox.alert(GO.lang.strError,d)},scope:this})}});GO.calendar.formatQtip=function(b){var d="Y-m-d H:i";if(!b.startDate){b.startDate=Date.parseDate(b.start_time,d)}if(!b.endDate){b.endDate=Date.parseDate(b.end_time,d)}var a=GO.settings.time_format;if(b.startDate.format("Ymd")!=b.endDate.format("Ymd")){a=GO.settings.date_format+" "+GO.settings.time_format}var c=GO.calendar.lang.startsAt+": "+b.startDate.format(a)+"<br />"+GO.calendar.lang.endsAt+": "+b.endDate.format(a);if(b.location!=""){c+="<br />"+GO.calendar.lang.location+": "+b.location}if(b.description!=""){c+="<br /><br />"+b.description}return c};GO.calendar.MainPanel=function(a){if(!a){a={}}var c=new Ext.DatePicker();c.on("select",function(f,g){this.setDisplay({date:g})},this);this.calendarsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"calendars"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.calendarsStore.on("load",function(){if(this.state.displayType!="view"){if(!this.calendarsStore.getById(this.state.calendar_id)){this.state.calendar_id=this.calendarsStore.data.items[0].id}this.calendarList.select("calendar-"+this.state.calendar_id);this.setDisplay(this.state)}},this);this.viewsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"views"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.viewsStore.on("load",function(){if(this.state.displayType=="view"){this.viewsList.select("view-"+this.state.view_id);this.setDisplay(this.state)}},this);this.calendarList=new GO.calendar.CalendarList({store:this.calendarsStore});this.viewsList=new GO.calendar.ViewList({store:this.viewsStore});this.calendarList.on("click",function(f,g){this.viewsList.clearSelections();this.setDisplay({calendar_id:f.store.data.items[g].id,saveState:true})},this);this.calendarList.on("selectionchange",function(f,g){if(g.length){if(this.calendarTitle.td){this.calendarTitle.td.innerHTML=g[0].innerHTML}else{this.calendarTitle.setText(g[0].innerHTML)}}},this);this.viewsList.on("click",function(f,g){this.calendarList.clearSelections();this.setDisplay({view_id:f.store.data.items[g].id,saveState:true})},this);this.viewsList.on("selectionchange",function(f,g){if(g.length){this.calendarTitle.td.innerHTML=g[0].innerHTML}},this);this.daysGridStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"events"},root:"results",id:"id",fields:["id","event_id","name","start_time","end_time","description","repeats","private","location","background"]});this.monthGridStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"events"},root:"results",id:"id",fields:["id","event_id","name","start_time","end_time","description","repeats","private","location","background"]});this.daysGrid=new GO.grid.CalendarGrid({id:"days-grid",store:this.daysGridStore,border:false,firstWeekday:parseInt(GO.settings.first_weekday),keys:[{key:Ext.EventObject.DELETE,fn:function(){},scope:this}]});this.monthGrid=new GO.grid.MonthGrid({id:"month-grid",store:this.monthGridStore,border:false,layout:"fit",firstWeekday:parseInt(GO.settings.first_weekday)});this.viewGrid=new GO.grid.ViewGrid({id:"view-grid",border:false,firstWeekday:parseInt(GO.settings.first_weekday)});this.viewGrid.on("zoom",function(f){this.viewsList.clearSelections();this.calendarList.select("calendar-"+f.calendar_id);this.setDisplay(f)},this);this.listGrid=new GO.calendar.ListGrid({id:"list-grid",border:false,firstWeekday:parseInt(GO.settings.first_weekday)});this.listStore=this.listGrid.store;var d=new Ext.Panel({region:"center",title:GO.calendar.lang.navigation,border:true,items:[this.calendarList,this.viewsList],autoScroll:true,split:true});this.displayPanel=new Ext.Panel({region:"center",titlebar:false,autoScroll:false,layout:"card",activeItem:0,border:true,split:true,cls:"cal-display-panel",tbar:[this.calendarTitle=new Ext.Toolbar.TextItem({text:"Calendar"}),"-",{iconCls:"btn-left-arrow",text:GO.lang.cmdPrevious,cls:"x-btn-text-icon",handler:function(){var f=this.getActivePanel().configuredDate;if(this.displayType=="month"){f=f.add(Date.MONTH,-1)}else{var g=this.days>4?7:1;f=f.add(Date.DAY,-g)}this.setDisplay({date:f})},scope:this},this.periodInfoPanel=new Ext.Panel({html:"",plain:true,border:true,cls:"cal-period"}),{iconCls:"btn-right-arrow",text:GO.lang.cmdNext,cls:"x-btn-text-icon",handler:function(){var f=this.getActivePanel().configuredDate;if(this.displayType=="month"){f=f.add(Date.MONTH,1)}else{var g=this.days>4?7:1;f=f.add(Date.DAY,g)}this.setDisplay({date:f})},scope:this}],items:[this.daysGrid,this.monthGrid,this.viewGrid,this.listGrid]});var e=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){GO.calendar.eventDialog.show({calendar_id:this.displayType!="view"?this.calendar_id:0})},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:this.deleteHandler,scope:this},{iconCls:"btn-refresh",text:GO.lang.cmdRefresh,cls:"x-btn-text-icon",handler:function(){this.init()},scope:this},{iconCls:"btn-settings",text:GO.lang.administration,cls:"x-btn-text-icon",handler:function(){this.showAdminDialog()},scope:this},"-",this.dayButton=new Ext.Button({iconCls:"btn-one-day",text:GO.calendar.lang.oneDay,cls:"x-btn-text-icon",handler:function(){this.setDisplay({days:1,displayType:this.displayType=="view"?"view":"days",saveState:true})},scope:this}),this.workWeekButton=new Ext.Button({iconCls:"btn-five-days",text:GO.calendar.lang.fiveDays,cls:"x-btn-text-icon",handler:function(){this.setDisplay({days:5,displayType:this.displayType=="view"?"view":"days",saveState:true})},scope:this}),this.weekButton=new Ext.Button({iconCls:"btn-seven-days",text:GO.calendar.lang.sevenDays,cls:"x-btn-text-icon",handler:function(){this.setDisplay({days:7,displayType:this.displayType=="view"?"view":"days",saveState:true})},scope:this}),this.monthButton=new Ext.Button({iconCls:"btn-month",text:GO.calendar.lang.month,cls:"x-btn-text-icon",handler:function(){this.setDisplay({displayType:"month",saveState:true})},scope:this}),this.listButton=new Ext.Button({iconCls:"btn-list",text:GO.calendar.lang.list,cls:"x-btn-text-icon",handler:function(f,g){this.setDisplay({displayType:"list",saveState:true})},scope:this}),"-",this.printMessageButton=new Ext.Button({iconCls:"btn-print",text:GO.lang.cmdPrint,cls:"x-btn-text-icon",handler:function(){var h=this.getActivePanel().startDate;var g=this.getActivePanel().endDate;var f=GO.settings.modules.calendar.url+"print.php?start_time="+h.format("Y-m-d")+"&end_time="+g.format("Y-m-d");if(this.displayType=="view"){f+="&view_id="+this.view_id}else{f+="&calendar_id="+this.calendar_id}document.location=f},scope:this})];for(var b=0;b<GO.calendar.extraToolbarItems.length;b++){e.push(GO.calendar.extraToolbarItems[b])}a.layout="border";a.border=false;a.items=[new Ext.Panel({region:"north",height:32,baseCls:"x-plain",tbar:new Ext.Toolbar({cls:"go-head-tb",items:e})}),new Ext.Panel({region:"west",titlebar:false,autoScroll:false,closeOnTab:true,width:210,split:true,layout:"border",border:false,plain:true,items:[new Ext.Panel({region:"north",border:true,height:194,split:true,baseCls:"x-plain",items:c}),d]}),this.displayPanel];GO.calendar.MainPanel.superclass.constructor.call(this,a)};Ext.extend(GO.calendar.MainPanel,Ext.Panel,{displayType:"days",lastCalendarDisplayType:"days",state:{},calendarId:0,viewId:0,onShow:function(){GO.calendar.MainPanel.superclass.onShow.call(this);this.daysGrid.scrollToLastPosition()},afterRender:function(){GO.calendar.MainPanel.superclass.afterRender.call(this);GO.calendar.eventDialog.on("save",function(c,a){if(this.displayType=="list"){this.setDisplay()}else{var b=this.getActivePanel();if(c.repeats||(b.remoteEvents[a]&&b.remoteEvents[a].repeats&&b.remoteEvents[a].event_id==c.event_id)){b.store.reload()}else{b.removeEvent(a);switch(this.displayType){case"month":if(c.calendar_id==this.calendar_id){GO.calendar.eventDialog.oldDomId=this.monthGrid.addMonthGridEvent(c)}break;case"days":if(c.calendar_id==this.calendar_id){GO.calendar.eventDialog.oldDomId=this.daysGrid.addDaysGridEvent(c,true)}break;case"view":GO.calendar.eventDialog.oldDomId=this.viewGrid.addViewGridEvent(c);break}}}},this);this.state=Ext.state.Manager.get("calendar-state");if(!this.state){this.state={displayType:"days",days:5,calendar_id:0,view_id:0}}else{this.state=Ext.decode(this.state)}if(this.state.displayType=="view"){this.state.displayType="days"}this.state.calendar_id=GO.calendar.defaultCalendar.id;this.state.view_id=0;this.init();this.createDaysGrid()},init:function(){this.calendarsStore.load();this.viewsStore.load()},deleteHandler:function(){switch(this.displayType){case"days":var a=this.daysGrid.getSelectedEvent();var b=function(d,c){if(c){this.daysGrid.store.reload()}else{this.daysGrid.removeEvent(d.domId)}};break;case"month":var a=this.monthGrid.getSelectedEvent();var b=function(d,c){if(c){this.monthGrid.store.reload()}else{this.monthGrid.removeEvent(d.domId)}};break;case"view":var a=this.viewGrid.getSelectedEvent();var b=function(d,c){if(c){this.viewGrid.reload()}else{this.viewGrid.removeEvent(d.domId)}};break;case"list":var a=this.listGrid.getSelectedEvent();var b=function(d,c){if(c){this.listGrid.store.reload()}else{this.listGrid.removeEvent()}};break}if(a){this.deleteEvent(a,b)}},getActivePanel:function(){switch(this.displayType){case"days":return this.daysGrid;break;case"month":return this.monthGrid;break;case"view":return this.viewGrid;break;case"list":return this.listGrid;break}},updatePeriodInfoPanel:function(){var b="";var a=this.getActivePanel().configuredDate;if(this.displayType=="month"){b=a.format("F, Y")}else{b=GO.lang.strWeek+" "+a.format("W")}this.periodInfoPanel.body.update(b)},deleteEvent:function(a,b){if(a.repeats){this.currentDeleteEvent=a;this.currentDeleteCallback=b;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,closable:false,title:GO.calendar.lang.recurringEvent,modal:true,html:GO.calendar.lang.deleteRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){var c={task:"delete_event",create_exception:true,exception_date:this.currentDeleteEvent.startDate.format(this.daysGrid.dateTimeFormat),event_id:this.currentDeleteEvent.event_id};this.sendDeleteRequest(c,this.currentDeleteCallback,this.currentDeleteEvent);this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){var c={task:"delete_event",event_id:this.currentDeleteEvent.event_id};this.sendDeleteRequest(c,this.currentDeleteCallback,this.currentDeleteEvent,true);this.recurrenceDialog.hide()},scope:this},{text:GO.lang.cmdCancel,handler:function(){this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()}else{Ext.MessageBox.confirm(GO.lang.strConfirm,GO.lang.strDeleteSelectedItem,function(c){if(c=="yes"){var d={task:"delete_event",event_id:a.event_id};this.sendDeleteRequest(d,b,a)}},this)}},sendDeleteRequest:function(c,d,b,a){Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:c,callback:function(f,h,e){if(!h){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var g=Ext.decode(e.responseText);if(!g.success){Ext.MessageBox.alert(GO.lang.strError,g.feedback)}else{d.call(this,b,a)}}},scope:this})},setDisplay:function(a){if(!a){a={}}Ext.apply(this.state,a);delete this.state.saveState;if(a.displayType){this.displayType=a.displayType}else{if(a.calendar_id){this.displayType=this.lastCalendarDisplayType}else{if(a.view_id){this.displayType="view"}}}this.state.displayType=this.displayType;var b="view";if(this.displayType!="view"){this.lastCalendarDisplayType=this.displayType}switch(this.displayType){case"month":this.displayPanel.getLayout().setActiveItem(1);break;case"days":this.displayPanel.getLayout().setActiveItem(0);break;case"view":this.displayPanel.getLayout().setActiveItem(2);break;case"list":this.displayPanel.getLayout().setActiveItem(3);break}this.monthButton.setDisabled(this.displayType=="view");this.listButton.setDisabled(this.displayType=="view");if(a.calendar_id){this.calendar_id=a.calendar_id;this.daysGridStore.baseParams.calendars=Ext.encode([a.calendar_id]);this.monthGridStore.baseParams.calendars=Ext.encode([a.calendar_id]);this.listGrid.store.baseParams.calendars=Ext.encode([a.calendar_id])}if(a.view_id){this.view_id=a.view_id;this.viewGrid.setViewId(a.view_id)}if(a.date){if(!a.days){a.days=this.type=="days"?this.daysGrid.days:this.viewGrid.days}this.daysGrid.setDate(a.date,a.days,this.displayType=="days");this.monthGrid.setDate(a.date,this.displayType=="month");this.viewGrid.setDate(a.date,a.days,this.displayType=="view");this.listGrid.setDate(a.date,a.days,this.displayType=="list");this.days=a.days}else{if(a.days&&this.displayType!="month"){this.daysGrid.setDays(a.days,this.displayType=="days");this.viewGrid.setDays(a.days,this.displayType=="view");this.listGrid.setDays(a.days,this.displayType=="list");this.days=a.days}else{if(a.days){this.days=a.days}switch(this.displayType){case"month":this.monthGridStore.reload();break;case"days":this.daysGridStore.reload();break;case"view":this.viewGrid.load();break;case"list":this.listGrid.store.reload();break}}}this.dayButton.toggle(this.displayType=="days"&&this.days==1);this.workWeekButton.toggle(this.displayType=="days"&&this.days==5);this.weekButton.toggle(this.displayType=="days"&&this.days==7);this.monthButton.toggle(this.displayType=="month");this.listButton.toggle(this.displayType=="list");this.updatePeriodInfoPanel();if(a.saveState){this.saveState()}},saveState:function(){var a={displayType:this.displayType,calendar_id:this.calendar_id,view_id:this.view_id,days:this.days};Ext.state.Manager.set("calendar-state",Ext.encode(a))},refresh:function(){this.setDisplay()},createDaysGrid:function(){this.daysGrid.on("eventResize",function(a,c,b){var d={task:"update_grid_event",update_event_id:c.event_id,duration:b.duration};if(c.repeats&&b.singleInstance){d.createException="true";d.exceptionDate=b.dragDate.format(a.dateTimeFormat);d.repeats="true"}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:d,callback:function(f,h,e){var g=Ext.decode(e.responseText);if(!g.success){Ext.MessageBox.alert(GO.lang.strError,g.feedback)}else{if(c.repeats&&!b.singleInstance){a.store.reload()}}}})},this);this.daysGrid.on("create",function(b,a){var c={};c.start_date=a.startDate;c.start_hour=a.startDate.format("H");c.start_min=a.startDate.format("i");c.end_date=a.endDate;c.end_hour=a.endDate.format("H");c.end_min=a.endDate.format("i");GO.calendar.eventDialog.show({values:c,calendar_id:this.calendar_id,calendar_name:this.calendar_name})},this);this.monthGrid.on("create",function(c,b){var a=new Date();var d={start_date:b,end_date:b,start_hour:a.format("H"),end_hour:a.add(Date.HOUR,1).format("H"),start_min:"00",end_min:"00"};GO.calendar.eventDialog.show({values:d,calendar_id:this.calendar_id,calendar_name:this.calendar_name})},this);this.monthGrid.on("changeview",function(b,c,a){this.setDisplay({displayType:"days",days:c,date:a})},this);this.daysGrid.on("eventDblClick",this.onDblClick,this);this.monthGrid.on("eventDblClick",this.onDblClick,this);this.viewGrid.on("eventDblClick",this.onDblClick,this);this.monthGrid.on("move",this.onEventMove,this);this.daysGrid.on("move",this.onEventMove,this);this.viewGrid.on("move",function(a,c,b){var d={task:"update_grid_event",update_event_id:c.event_id};if(b.offset){d.offset=b.offset}if(b.offsetDays){d.offsetDays=b.offsetDays}if(c.repeats&&b.singleInstance){d.createException="true";d.exceptionDate=b.dragDate.format(a.dateTimeFormat);d.repeats="true"}if(b.calendar_id){d.update_calendar_id=b.calendar_id}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:d,callback:function(f,h,e){var g=Ext.decode(e.responseText);if(!g.success){Ext.MessageBox.alert(GO.lang.strError,g.feedback)}else{if(c.repeats&&!b.singleInstance){a.store.reload()}else{if(g.new_event_id){a.setNewEventId(c.domId,g.new_event_id)}}}}})},this)},onDblClick:function(a,c,b){if(c.repeats&&b.singleInstance){var d={};d.start_date=c.startDate.format(GO.settings.date_format);d.start_hour=c.startDate.format("H");d.start_min=c.startDate.format("i");d.end_date=c.endDate.format(GO.settings.date_format);d.end_hour=c.endDate.format("H");d.end_min=c.endDate.format("i");GO.calendar.eventDialog.show({values:d,exceptionDate:c.startDate.format(this.daysGrid.dateTimeFormat),exception_event_id:c.event_id,oldDomId:c.domId})}else{GO.calendar.eventDialog.show({event_id:c.event_id,oldDomId:c.domId})}},onEventMove:function(a,c,b){var d={task:"update_grid_event",update_event_id:c.event_id};if(b.offset){d.offset=b.offset}if(b.offsetDays){d.offsetDays=b.offsetDays}if(c.repeats&&b.singleInstance){d.createException="true";d.exceptionDate=b.dragDate.format(a.dateTimeFormat);d.repeats="true"}if(b.calendar_id){d.update_calendar_id=b.calendar_id}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:d,callback:function(f,h,e){var g=Ext.decode(e.responseText);if(!g.success){Ext.MessageBox.alert(GO.lang.strError,g.feedback)}else{if(c.repeats&&!b.singleInstance){a.store.reload()}else{if(g.new_event_id){a.setNewEventId(c.domId,g.new_event_id)}}}}})},showAdminDialog:function(){if(!this.adminDialog){this.writableCalendarsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_calendars"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.writableCalendarsStore.load();this.writableViewsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_views"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.calendarDialog=new GO.calendar.CalendarDialog();this.calendarDialog.on("save",function(){this.writableCalendarsStore.reload();this.calendarsStore.reload()},this);this.calendarsGrid=new GO.grid.GridPanel({title:GO.calendar.lang.calendars,paging:true,border:false,store:this.writableCalendarsStore,deleteConfig:{callback:function(){this.calendarsStore.reload()},scope:this},columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name"}],view:new Ext.grid.GridView({autoFill:true}),sm:new Ext.grid.RowSelectionModel(),loadMask:true,tbar:[{id:"addCalendar",iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.calendarDialog.show()},scope:this},{id:"delete",iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.calendarsGrid.deleteSelected()},scope:this}]});this.calendarsGrid.on("rowdblclick",function(a,b,c){this.calendarDialog.show(a.selModel.selections.keys[0])},this);this.viewDialog=new GO.calendar.ViewDialog();this.viewDialog.on("save",function(){this.writableViewsStore.reload();this.viewsStore.reload()},this);this.viewsGrid=new GO.grid.GridPanel({title:GO.calendar.lang.views,paging:true,border:false,store:this.writableViewsStore,deleteConfig:{callback:function(){this.viewsStore.reload()},scope:this},columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name"}],view:new Ext.grid.GridView({autoFill:true}),sm:new Ext.grid.RowSelectionModel(),loadMask:true,tbar:[{id:"addView",iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.viewDialog.show()},scope:this},{id:"delete",iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.viewsGrid.deleteSelected()},scope:this}]});this.viewsGrid.on("rowdblclick",function(a,b,c){this.viewDialog.show(a.selModel.selections.keys[0])},this);this.viewsGrid.on("show",function(){this.writableViewsStore.load()},this,{single:true});this.adminDialog=new Ext.Window({title:GO.calendar.lang.administration,layout:"fit",modal:false,minWidth:300,minHeight:300,height:400,width:600,closeAction:"hide",items:new Ext.TabPanel({border:false,activeTab:0,items:[this.calendarsGrid,this.viewsGrid]}),buttons:[{text:GO.lang.cmdClose,handler:function(){this.adminDialog.hide()},scope:this}]})}this.adminDialog.show()}});GO.calendar.CalendarList=function(b){Ext.apply(b);var a=new Ext.XTemplate("<b>"+GO.calendar.lang.calendars+"</b>",'<tpl for=".">','<div id="calendar-{id}" class="calendar-wrap">{name}</div>',"</tpl>");GO.calendar.CalendarList.superclass.constructor.call(this,{store:b.store,tpl:a,singleSelect:true,autoHeight:true,overClass:"x-view-over",itemSelector:"div.calendar-wrap"})};Ext.extend(GO.calendar.CalendarList,Ext.DataView,{onRender:function(b,a){this.el=b.createChild({tag:"div",id:"calendarList",cls:"calendar-list"});GO.calendar.CalendarList.superclass.onRender.apply(this,arguments)}});GO.calendar.ViewList=function(b){Ext.apply(b);var a=new Ext.XTemplate("<b>"+GO.calendar.lang.views+"</b>",'<tpl for=".">','<div id="view-{id}" class="view-wrap">{name}</div>',"</tpl>");GO.calendar.ViewList.superclass.constructor.call(this,{store:b.store,tpl:a,singleSelect:true,autoHeight:true,overClass:"x-view-over",itemSelector:"div.view-wrap"})};Ext.extend(GO.calendar.ViewList,Ext.DataView,{onRender:function(b,a){this.el=b.createChild({tag:"div",id:"viewList",cls:"view-list"});GO.calendar.ViewList.superclass.onRender.apply(this,arguments)}});GO.calendar.extraToolbarItems=[];GO.moduleManager.addModule("calendar",GO.calendar.MainPanel,{title:GO.calendar.lang.calendar,iconCls:"go-tab-icon-calendar"});GO.mainLayout.onReady(function(){GO.calendar.eventDialog=new GO.calendar.EventDialog()});GO.linkHandlers[1]=function(a){GO.calendar.eventDialog.show({event_id:a})};GO.newMenuItems.push({text:GO.calendar.lang.appointment,iconCls:"go-link-icon-1",handler:function(b,c){var a=b.parentMenu.eventShowConfig||{};a.link_config=b.parentMenu.link_config;GO.calendar.eventDialog.show(a)}});GO.calendar.SummaryGroupPanel=function(a){if(!a){a={}}a.store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({totalProperty:"count",root:"results",id:"event_id",fields:["id","event_id","name","time","start_time","end_time","description","location","private","repeats","day"]}),baseParams:{task:"summary"},proxy:new Ext.data.HttpProxy({url:GO.settings.modules.calendar.url+"json.php"}),groupField:"day",sortInfo:{field:"start_time",direction:"ASC"}});a.paging=false,a.autoExpandColumn="summary-calendar-name-heading";a.enableColumnHide=false;a.enableColumnMove=false;a.columns=[{header:GO.lang.strDay,dataIndex:"day"},{header:GO.lang.strTime,dataIndex:"time",width:70},{id:"summary-calendar-name-heading",header:GO.lang.strName,dataIndex:"name",renderer:this.renderName}];a.view=new Ext.grid.GroupingView({hideGroupedColumn:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "'+GO.lang.items+'" : "'+GO.lang.item+'"]})',emptyText:GO.calendar.lang.noAppointmentsToDisplay,showGroupName:false});a.sm=new Ext.grid.RowSelectionModel();a.loadMask=true;a.autoHeight=true;GO.calendar.SummaryGroupPanel.superclass.constructor.call(this,a);this.store.on("load",function(){this.addClass("go-grid3-hide-headers")},this,{single:true})};Ext.extend(GO.calendar.SummaryGroupPanel,Ext.grid.GridPanel,{renderName:function(b,c,a){return'<div style="font-weight:bold">'+a.data.name+"</div>"+GO.calendar.formatQtip(a.data)},afterRender:function(){GO.calendar.SummaryGroupPanel.superclass.afterRender.call(this);GO.calendar.eventDialog.on("save",function(){this.store.reload()},this);this.on("rowdblclick",function(a,b,d){var c=a.selModel.selections.keys[0];GO.calendar.eventDialog.show({event_id:c})},this);Ext.TaskMgr.start({run:this.store.load,scope:this.store,interval:900000})}});GO.mainLayout.onReady(function(){if(GO.summary){var a=new GO.calendar.SummaryGroupPanel({id:"summary-calendar-grid"});GO.summary.portlets["portlet-calendar"]=new GO.summary.Portlet({id:"portlet-calendar",title:GO.calendar.lang.appointments,layout:"fit",tools:[{id:"close",handler:function(d,c,b){b.removePortlet()}}],items:a,autoHeight:true})}});GO.calendar.Participant=Ext.data.Record.create([{name:"id",type:"string"},{name:"name",type:"string"},{name:"email",type:"string"},{name:"available",type:"string"},{name:"status",type:"string"}]);GO.calendar.ParticipantsPanel=function(a,b){this.eventDialog=a;if(!b){b={}}b.hideMode="offsets";b.store=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"participants"},root:"results",id:"id",fields:["id","name","email","available","status"]});var c=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.showAddParticipantsDialog()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){var e=this.gridPanel.selModel.getSelections();for(var d=0;d<e.length;d++){e[d].commit();this.store.remove(e[d])}},scope:this},{iconCls:"btn-availability",text:GO.calendar.lang.checkAvailability,cls:"x-btn-text-icon",handler:function(){this.checkAvailability()},scope:this}];this.inviteCheckbox=new Ext.form.Checkbox({name:"invitation",boxLabel:GO.calendar.lang.sendInvitation,hideLabel:true});this.importCheckbox=new Ext.form.Checkbox({name:"import",boxLabel:GO.calendar.lang.importToCalendar,hideLabel:true});this.checkPanel=new Ext.Panel({border:true,region:"north",height:40,layout:"column",defaults:{border:false,bodyStyle:"padding:5px"},items:[{columnWidth:0.5,items:[this.inviteCheckbox]},{columnWidth:0.5,items:[this.importCheckbox]}]});this.gridPanel=new GO.grid.GridPanel({layout:"fit",split:true,store:b.store,border:true,region:"center",columns:[{header:GO.lang.strName,dataIndex:"name",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",sortable:true},{header:GO.lang.strStatus,dataIndex:"status",sortable:true,renderer:function(d){switch(d){case"2":return GO.calendar.lang.declined;break;case"1":return GO.calendar.lang.accepted;break;case"0":return GO.calendar.lang.notRespondedYet;break}}},{header:GO.lang.strAvailable,dataIndex:"available",sortable:false,renderer:function(d){var e="img-unknown";switch(d){case"1":e="img-available";break;case"0":e="img-unavailable";break}return'<div class="'+e+'"></div>'}}],view:new Ext.grid.GridView({autoFill:true,forceFit:true}),loadMask:{msg:GO.lang.waitMsgLoad},sm:new Ext.grid.RowSelectionModel()});Ext.apply(b,{title:GO.calendar.lang.participants,border:false,tbar:c,layout:"border",items:[this.checkPanel,this.gridPanel]});b.store.setDefaultSort("name","ASC");GO.calendar.ParticipantsPanel.superclass.constructor.call(this,b)};Ext.extend(GO.calendar.ParticipantsPanel,Ext.Panel,{event_id:0,newId:0,loaded:false,getGridData:function(){return this.gridPanel.getGridData()},setEventId:function(a){this.event_id=this.store.baseParams.event_id=a;this.store.loaded=false;if(this.event_id==0){this.store.removeAll()}this.newId=0;this.inviteCheckbox.setValue(false);this.importCheckbox.setValue(false)},onShow:function(){if(!this.store.loaded){if(this.store.baseParams.event_id>0){this.store.load()}else{this.addDefaultParticipant()}}GO.calendar.ParticipantsPanel.superclass.onShow.call(this)},showAddParticipantsDialog:function(){if(!GO.addressbook){var a=new Ext.XTemplate(GO.lang.moduleRequired);Ext.Msg.alert(GO.lang.strError,a.apply({module:GO.calendar.lang.addressbook}));return false}if(!this.addParticipantsDialog){this.addParticipantsDialog=new GO.dialog.SelectEmail({handler:function(d){if(d.selModel.selections.keys.length>0){var e=d.selModel.getSelections();var b=[];for(var c=0;c<e.length;c++){b.push(e[c].get("email"))}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"json.php",params:{task:"check_availability",emails:b.join(","),start_time:this.eventDialog.getStartDate().format("U"),end_time:this.eventDialog.getEndDate().format("U")},callback:function(h,l,g){if(!l){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var k=Ext.decode(g.responseText);for(var j=0;j<e.length;j++){var f=this.store.findBy(function(i,m){if(i.get("email")==e[j].get("email")){return true}else{return false}});if(f==-1){this.addParticipant({name:e[j].get("name"),email:e[j].get("email"),status:"0",user_id:e[j].get("id"),available:k[e[j].get("email")]})}}}},scope:this})}},scope:this})}this.addParticipantsDialog.show()},addDefaultParticipant:function(){this.body.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.calendar.url+"json.php",params:{task:"get_default_participant",calendar_id:this.eventDialog.calendar_id,start_time:this.eventDialog.getStartDate().format("U"),end_time:this.eventDialog.getEndDate().format("U")},callback:function(b,d,a){this.body.unmask();if(!d){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var c=Ext.decode(a.responseText);this.addParticipant({name:c.name,email:c.email,status:c.status,user_id:c.user_id,available:c.available})}},scope:this})},addParticipant:function(a){a.id="new_"+this.newId;var b=new GO.calendar.Participant(a);this.store.insert(this.store.getCount(),b);this.newId++;this.store.loaded=true},reloadAvailability:function(){var c=this.store.getRange();if(c.length){var a=[];for(var b=0;b<c.length;b++){a.push(c[b].get("email"))}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"json.php",params:{task:"check_availability",emails:a.join(","),start_time:this.eventDialog.getStartDate().format("U"),end_time:this.eventDialog.getEndDate().format("U")},callback:function(e,h,d){if(!h){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var g=Ext.decode(d.responseText);for(var f=0;f<c.length;f++){c[f].set("available",g[c[f].get("email")])}this.store.commitChanges()}},scope:this})}},checkAvailability:function(){if(!this.availabilityWindow){this.availabilityWindow=new GO.calendar.AvailabilityCheckWindow();this.availabilityWindow.on("select",function(h,i,f){var m=this.eventDialog;var e=f.id.substr(4);var l=e.indexOf(":");var g=e.substr(l+1);var o=e.substr(0,l);var k=parseInt(m.endHour.getValue())-parseInt(m.startHour.getValue());var p=parseInt(m.endMin.getValue())-parseInt(m.startMin.getValue());if(p<0){p+=60;k--}g=g+"";if(g.length==1){g="0"+g}m.startHour.setValue(o);m.startMin.setValue(g);m.startDate.setValue(Date.parseDate(h.store.baseParams.date,GO.settings.date_format));var j=parseInt(o)+k;var n=parseInt(g)+p;if(n>=60){n-=60;j++}n=n+"";if(n.length==1){n="0"+n}m.endHour.setValue(j);m.endMin.setValue(n);m.endDate.setValue(Date.parseDate(h.store.baseParams.date,GO.settings.date_format));m.tabPanel.setActiveTab(0);this.reloadAvailability();this.availabilityWindow.hide()},this)}var a=this.store.getRange();var d=[];var c=[];for(var b=0;b<a.length;b++){d.push(a[b].get("email"));c.push(a[b].get("name"))}this.availabilityWindow.show({date:this.eventDialog.startDate.getRawValue(),event_id:this.event_id,emails:Ext.encode(d),names:Ext.encode(c)})}});GO.calendar.AvailabilityCheckWindow=function(b){b=b||{};var a=new Ext.XTemplate('<div id="availability_date"></div>','<table class="availability">',"<tr><td></td>",'<td colspan="4" class="availability_time">'+Date.parseDate("0","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("1","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("2","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("3","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("4","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("5","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("6","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("7","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("8","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("9","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("10","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("11","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("12","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("13","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("14","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("15","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("16","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("17","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("18","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("19","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("20","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("21","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("22","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("23","G").format(GO.settings.time_format)+"</td>",'<tpl for=".">',"<tr>","<td>{name}</td>",'<tpl if="this.hasFreeBusy(freebusy)">','<tpl for="freebusy">','<td id="time{time}"class="time {[values.busy == 1 ? "busy" : "free"]}"></td>',"</tpl>","</tpl>",'<tpl if="!this.hasFreeBusy(freebusy)">','<td colspan="96">'+GO.calendar.lang.noInformationAvailable+"</td>","</tpl>","</tr>","</tpl>","</table>",{hasFreeBusy:function(c){return c.length>0}});this.dataView=new Ext.DataView({store:new Ext.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",root:"participants",fields:["name","email","freebusy"],baseParams:{task:"availability",emails:"",names:"",event_id:0,date:""}}),tpl:a,autoHeight:true,emptyText:GO.calendar.lang.noParticipantsToDisplay,itemSelector:"td.time",overClass:"time-over"});this.dataView.on("click",function(c,d,e){this.fireEvent("select",c,d,e)},this);this.dataView.store.on("load",function(){Ext.get("availability_date").update(this.dataView.store.baseParams.date)},this);Ext.apply(b,{layout:"fit",modal:false,height:400,width:800,closeAction:"hide",title:GO.lang.strAvailability,items:{layout:"fit",cls:"go-form-panel",waitMsgTarget:true,items:this.dataView,autoScroll:true},tbar:[{iconCls:"btn-left-arrow",text:GO.calendar.lang.previousDay,cls:"x-btn-text-icon",handler:function(){var c=Date.parseDate(this.dataView.store.baseParams.date,GO.settings.date_format).add(Date.DAY,-1);this.dataView.store.baseParams.date=c.format(GO.settings.date_format);this.dataView.store.load()},scope:this},{iconCls:"btn-right-arrow",text:GO.calendar.lang.nextDay,cls:"x-btn-text-icon",handler:function(){var c=Date.parseDate(this.dataView.store.baseParams.date,GO.settings.date_format).add(Date.DAY,1);this.dataView.store.baseParams.date=c.format(GO.settings.date_format);this.dataView.store.load()},scope:this}],buttons:[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});GO.calendar.AvailabilityCheckWindow.superclass.constructor.call(this,b);this.addEvents({select:true})};Ext.extend(GO.calendar.AvailabilityCheckWindow,GO.Window,{show:function(a){this.dataView.store.baseParams.date=a.date;this.dataView.store.baseParams.event_id=a.event_id;this.dataView.store.baseParams.emails=a.emails;this.dataView.store.baseParams.names=a.names;this.dataView.store.load();GO.calendar.AvailabilityCheckWindow.superclass.show.call(this)}});GO.calendar.SettingsPanel=function(a){if(!a){a={}}var c=[["0",GO.calendar.lang.noReminder]];for(var b=1;b<60;b++){c.push([b,b])}this.reminderValue=new Ext.form.ComboBox({fieldLabel:GO.calendar.lang.reminder,hiddenName:"reminder_value",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,mode:"local",value:"0",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:c})});this.reminderMultiplier=new Ext.form.ComboBox({hiddenName:"reminder_multiplier",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,mode:"local",value:"60",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["60",GO.lang.strMinutes],["3600",GO.lang.strHours],["86400",GO.lang.strDays]]}),hideLabel:true,labelSeperator:""});a.autoScroll=true;a.border=false;a.hideLabel=true;a.title=GO.calendar.lang.calendar;a.hideMode="offsets";a.layout="form";a.labelWidth=140;a.bodyStyle="padding:5px";a.items=[{xtype:"fieldset",autoHeight:true,layout:"form",title:GO.calendar.lang.eventDefaults,items:[{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.reminderValue},{items:this.reminderMultiplier}]},this.colorField=new GO.form.ColorField({fieldLabel:GO.lang.color,value:"EBF1E2",name:"background",colors:["EBF1E2","95C5D3","FFFF99","A68340","82BA80","F0AE67","66FF99","CC0099","CC99FF","996600","999900","FF0000","FF6600","FFFF00","FF9966","FF9900","FB0467","D52A6F","CC3370","C43B72","BB4474","B34D75","AA5577","A25E79","FF00CC","D52AB3","CC33AD","C43BA8","BB44A3","B34D9E","AA5599","A25E94","CC00FF","B32AD5","AD33CC","A83BC4","A344BB","9E4DB3","9955AA","945EA2","6704FB","6E26D9","7033CC","723BC4","7444BB","754DB3","7755AA","795EA2","0404FB","2626D9","3333CC","3B3BC4","4444BB","4D4DB3","5555AA","5E5EA2","0066FF","2A6ED5","3370CC","3B72C4","4474BB","4D75B3","5577AA","5E79A2","00CCFF","2AB2D5","33ADCC","3BA8C4","44A3BB","4D9EB3","5599AA","5E94A2","00FFCC","2AD5B2","33CCAD","3BC4A8","44BBA3","4DB39E","55AA99","5EA294","00FF66","2AD56F","33CC70","3BC472","44BB74","4DB375","55AA77","5EA279","00FF00","2AD52A","33CC33","3BC43B","44BB44","4DB34D","55AA55","5EA25E","66FF00","6ED52A","70CC33","72C43B","74BB44","75B34D","77AA55","79A25E","CCFF00","B2D52A","ADCC33","A8C43B","A3BB44","9EB34D","99AA55","94A25E","FFCC00","D5B32A","CCAD33","C4A83B","BBA344","B39E4D","AA9955","A2945E","FF6600","D56F2A","CC7033","C4723B","BB7444","B3754D","AA7755","A2795E","FB0404","D52A2A","CC3333","C43B3B","BB4444","B34D4D","AA5555","A25E5E","FFFFFF","949494","808080","6B6B6B","545454","404040","292929","000000"]}),this.selectCalendar=new GO.form.ComboBox({fieldLabel:GO.calendar.lang.default_calendar,hiddenName:"default_calendar_id",anchor:"-20",emptyText:GO.lang.strPleaseSelect,store:new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_calendars"},root:"results",id:"id",totalProperty:"total",fields:["id","name"],remoteSort:true}),pageSize:parseInt(GO.settings.max_rows_list),valueField:"id",displayField:"name",typeAhead:true,mode:"remote",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,allowBlank:false})]}];GO.calendar.SettingsPanel.superclass.constructor.call(this,a)};Ext.extend(GO.calendar.SettingsPanel,Ext.Panel,{onLoadSettings:function(a){this.selectCalendar.setRemoteText(a.result.data.default_calendar_name)},onSaveSettings:function(){GO.calendar.eventDialog.reminderValue.originalValue=this.reminderValue.getValue();GO.calendar.eventDialog.reminderMultiplier.originalValue=this.reminderMultiplier.getValue();GO.calendar.eventDialog.colorField.originalValue=this.colorField.getValue()}});GO.mainLayout.onReady(function(){GO.moduleManager.addSettingsPanel("calendar",GO.calendar.SettingsPanel)});GO.calendar.SelectCalendar=function(a){a=a||{};if(!a.hiddenName){a.hiddenName="calendar_id"}if(!a.fieldLabel){a.fieldLabel=GO.calendar.lang.calendar}Ext.apply(this,a);this.store=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_calendars"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});GO.calendar.SelectCalendar.superclass.constructor.call(this,{displayField:"name",valueField:"id",triggerAction:"all",mode:"remote",editable:true,selectOnFocus:true,forceSelection:true,typeAhead:true,emptyText:GO.lang.strPleaseSelect,pageSize:parseInt(GO.settings.max_rows_list)})};Ext.extend(GO.calendar.SelectCalendar,GO.form.ComboBox,{});